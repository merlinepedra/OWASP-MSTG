
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/logo_circle.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.9">
    
    
      
        <title>Android Platform APIs - OWASP Mobile Security Project</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#android-platform-apis" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OWASP Mobile Security Project" class="md-header__button md-logo" aria-label="OWASP Mobile Security Project" data-md-component="logo">
      
  <img src="../../assets/logo_circle.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OWASP Mobile Security Project
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Android Platform APIs
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/OWASP/owasp-mstg" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    OWASP/owasp-mstg
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Welcome
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../donate/" class="md-tabs__link">
      ♡ Donations
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../news/" class="md-tabs__link">
      News
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../talks/" class="md-tabs__link">
      Talks
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../0x01-Foreword/" class="md-tabs__link md-tabs__link--active">
        MSTG
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../contributing/1_How_Can_You_Contribute/" class="md-tabs__link">
        Contributing
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OWASP Mobile Security Project" class="md-nav__button md-logo" aria-label="OWASP Mobile Security Project" data-md-component="logo">
      
  <img src="../../assets/logo_circle.png" alt="logo">

    </a>
    OWASP Mobile Security Project
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/OWASP/owasp-mstg" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    OWASP/owasp-mstg
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../donate/" class="md-nav__link">
        ♡ Donations
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../news/" class="md-nav__link">
        News
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../talks/" class="md-nav__link">
        Talks
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          MSTG
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="MSTG" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          MSTG
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x01-Foreword/" class="md-nav__link">
        Foreword
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x02a-Frontispiece/" class="md-nav__link">
        Frontispiece
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x02b-MASVS-MSTG-Adoption/" class="md-nav__link">
        OWASP MASVS and MSTG Adoption
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x02c-Acknowledgements/" class="md-nav__link">
        Acknowledgments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x03-Overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04a-Mobile-App-Taxonomy/" class="md-nav__link">
        Mobile App Taxonomy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04b-Mobile-App-Security-Testing/" class="md-nav__link">
        Mobile App Security Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04c-Tampering-and-Reverse-Engineering/" class="md-nav__link">
        Mobile App Tampering and Reverse Engineering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04e-Testing-Authentication-and-Session-Management/" class="md-nav__link">
        Mobile App Authentication Architectures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04f-Testing-Network-Communication/" class="md-nav__link">
        Mobile App Network Communication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04g-Testing-Cryptography/" class="md-nav__link">
        Mobile App Cryptography
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04h-Testing-Code-Quality/" class="md-nav__link">
        Mobile App Code Quality
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04i-Testing-User-Privacy-Protection/" class="md-nav__link">
        Mobile App User Privacy Protection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05a-Platform-Overview/" class="md-nav__link">
        Android Platform Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05b-Basic-Security_Testing/" class="md-nav__link">
        Android Basic Security Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05c-Reverse-Engineering-and-Tampering/" class="md-nav__link">
        Android Tampering and Reverse Engineering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05d-Testing-Data-Storage/" class="md-nav__link">
        Android Data Storage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05e-Testing-Cryptography/" class="md-nav__link">
        Android Cryptographic APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05f-Testing-Local-Authentication/" class="md-nav__link">
        Android Local Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05g-Testing-Network-Communication/" class="md-nav__link">
        Android Network APIs
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Android Platform APIs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Android Platform APIs
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#testing-app-permissions-mstg-platform-1" class="md-nav__link">
    Testing App Permissions (MSTG-PLATFORM-1)
  </a>
  
    <nav class="md-nav" aria-label="Testing App Permissions (MSTG-PLATFORM-1)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#android-80-api-level-26-changes" class="md-nav__link">
    Android 8.0 (API level 26) Changes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-9-api-level-28-changes" class="md-nav__link">
    Android 9 (API Level 28) Changes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-10-changes-beta" class="md-nav__link">
    Android 10 Changes (Beta)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activity-permission-enforcement" class="md-nav__link">
    Activity Permission Enforcement
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-permission-enforcement" class="md-nav__link">
    Service Permission Enforcement
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#broadcast-permission-enforcement" class="md-nav__link">
    Broadcast Permission Enforcement
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#content-provider-permission-enforcement" class="md-nav__link">
    Content Provider Permission Enforcement
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#content-provider-uri-permissions" class="md-nav__link">
    Content Provider URI Permissions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#documentation-for-uri-permissions" class="md-nav__link">
    Documentation for URI Permissions
  </a>
  
    <nav class="md-nav" aria-label="Documentation for URI Permissions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#custom-permissions" class="md-nav__link">
    Custom Permissions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis" class="md-nav__link">
    Static Analysis
  </a>
  
    <nav class="md-nav" aria-label="Static Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#android-permissions" class="md-nav__link">
    Android Permissions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-permissions_1" class="md-nav__link">
    Custom Permissions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#requesting-permissions" class="md-nav__link">
    Requesting Permissions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-responses-to-permission-requests" class="md-nav__link">
    Handling Responses to Permission Requests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#permission-analysis" class="md-nav__link">
    Permission Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis" class="md-nav__link">
    Dynamic Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-for-injection-flaws-mstg-platform-2" class="md-nav__link">
    Testing for Injection Flaws (MSTG-PLATFORM-2)
  </a>
  
    <nav class="md-nav" aria-label="Testing for Injection Flaws (MSTG-PLATFORM-2)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_1" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_1" class="md-nav__link">
    Dynamic Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-for-fragment-injection-mstg-platform-2" class="md-nav__link">
    Testing for Fragment Injection (MSTG-PLATFORM-2)
  </a>
  
    <nav class="md-nav" aria-label="Testing for Fragment Injection (MSTG-PLATFORM-2)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_2" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_1" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-of-vulnerable-app-and-exploitation" class="md-nav__link">
    Example of Vulnerable App and Exploitation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-for-url-loading-in-webviews-mstg-platform-2" class="md-nav__link">
    Testing for URL Loading in WebViews (MSTG-PLATFORM-2)
  </a>
  
    <nav class="md-nav" aria-label="Testing for URL Loading in WebViews (MSTG-PLATFORM-2)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_3" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safebrowsing-api" class="md-nav__link">
    SafeBrowsing API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#virus-total-api" class="md-nav__link">
    Virus Total API
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_2" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_2" class="md-nav__link">
    Dynamic Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-deep-links-mstg-platform-3" class="md-nav__link">
    Testing Deep Links (MSTG-PLATFORM-3)
  </a>
  
    <nav class="md-nav" aria-label="Testing Deep Links (MSTG-PLATFORM-3)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_4" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deep-link-collision" class="md-nav__link">
    Deep Link Collision
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-app-links" class="md-nav__link">
    Android App Links
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-deep-links" class="md-nav__link">
    Testing Deep Links
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_3" class="md-nav__link">
    Static Analysis
  </a>
  
    <nav class="md-nav" aria-label="Static Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enumerate-deep-links" class="md-nav__link">
    Enumerate Deep Links
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-for-correct-website-association" class="md-nav__link">
    Check for Correct Website Association
  </a>
  
    <nav class="md-nav" aria-label="Check for Correct Website Association">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#automatic-verification" class="md-nav__link">
    Automatic Verification
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-verification" class="md-nav__link">
    Manual Verification
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-the-handler-method" class="md-nav__link">
    Check the Handler Method
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_3" class="md-nav__link">
    Dynamic Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-for-sensitive-functionality-exposure-through-ipc-mstg-platform-4" class="md-nav__link">
    Testing for Sensitive Functionality Exposure Through IPC (MSTG-PLATFORM-4)
  </a>
  
    <nav class="md-nav" aria-label="Testing for Sensitive Functionality Exposure Through IPC (MSTG-PLATFORM-4)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_5" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_4" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activities" class="md-nav__link">
    Activities
  </a>
  
    <nav class="md-nav" aria-label="Activities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inspect-the-androidmanifest" class="md-nav__link">
    Inspect the AndroidManifest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inspect-the-source-code" class="md-nav__link">
    Inspect the source code
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    Services
  </a>
  
    <nav class="md-nav" aria-label="Services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inspect-the-androidmanifest_1" class="md-nav__link">
    Inspect the AndroidManifest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inspect-the-source-code_1" class="md-nav__link">
    Inspect the source code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#broadcast-receivers" class="md-nav__link">
    Broadcast Receivers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inspect-the-androidmanifest_2" class="md-nav__link">
    Inspect the AndroidManifest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inspect-the-source-code_2" class="md-nav__link">
    Inspect the source code
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_4" class="md-nav__link">
    Dynamic Analysis
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#content-providers" class="md-nav__link">
    Content Providers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activities_1" class="md-nav__link">
    Activities
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services_1" class="md-nav__link">
    Services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#broadcast-receivers_1" class="md-nav__link">
    Broadcast Receivers
  </a>
  
    <nav class="md-nav" aria-label="Broadcast Receivers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sniffing-intents" class="md-nav__link">
    Sniffing Intents
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-javascript-execution-in-webviews-mstg-platform-5" class="md-nav__link">
    Testing JavaScript Execution in WebViews (MSTG-PLATFORM-5)
  </a>
  
    <nav class="md-nav" aria-label="Testing JavaScript Execution in WebViews (MSTG-PLATFORM-5)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_6" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_5" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_5" class="md-nav__link">
    Dynamic Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-webview-protocol-handlers-mstg-platform-6" class="md-nav__link">
    Testing WebView Protocol Handlers (MSTG-PLATFORM-6)
  </a>
  
    <nav class="md-nav" aria-label="Testing WebView Protocol Handlers (MSTG-PLATFORM-6)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_7" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_6" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_6" class="md-nav__link">
    Dynamic Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#determining-whether-java-objects-are-exposed-through-webviews-mstg-platform-7" class="md-nav__link">
    Determining Whether Java Objects Are Exposed Through WebViews (MSTG-PLATFORM-7)
  </a>
  
    <nav class="md-nav" aria-label="Determining Whether Java Objects Are Exposed Through WebViews (MSTG-PLATFORM-7)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_8" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_7" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_7" class="md-nav__link">
    Dynamic Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-object-persistence-mstg-platform-8" class="md-nav__link">
    Testing Object Persistence (MSTG-PLATFORM-8)
  </a>
  
    <nav class="md-nav" aria-label="Testing Object Persistence (MSTG-PLATFORM-8)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_9" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#object-serialization" class="md-nav__link">
    Object Serialization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#json" class="md-nav__link">
    JSON
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xml" class="md-nav__link">
    XML
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orm" class="md-nav__link">
    ORM
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parcelable" class="md-nav__link">
    Parcelable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocol-buffers" class="md-nav__link">
    Protocol Buffers
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_8" class="md-nav__link">
    Static Analysis
  </a>
  
    <nav class="md-nav" aria-label="Static Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#object-serialization_1" class="md-nav__link">
    Object Serialization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#json_1" class="md-nav__link">
    JSON
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orm_1" class="md-nav__link">
    ORM
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parcelable_1" class="md-nav__link">
    Parcelable
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_8" class="md-nav__link">
    Dynamic Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-for-overlay-attacks-mstg-platform-9" class="md-nav__link">
    Testing for Overlay Attacks (MSTG-PLATFORM-9)
  </a>
  
    <nav class="md-nav" aria-label="Testing for Overlay Attacks (MSTG-PLATFORM-9)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_10" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_9" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_9" class="md-nav__link">
    Dynamic Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-enforced-updating-mstg-arch-9" class="md-nav__link">
    Testing enforced updating (MSTG-ARCH-9)
  </a>
  
    <nav class="md-nav" aria-label="Testing enforced updating (MSTG-ARCH-9)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-analysis_10" class="md-nav__link">
    Static analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_10" class="md-nav__link">
    Dynamic analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
    <nav class="md-nav" aria-label="References">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#android-app-bundles-and-updates" class="md-nav__link">
    Android App Bundles and updates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-fragment-injection" class="md-nav__link">
    Android Fragment Injection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-permissions-documentation" class="md-nav__link">
    Android Permissions Documentation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-bundles-and-instant-apps" class="md-nav__link">
    Android Bundles and Instant Apps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-permissions-changes-in-android-8" class="md-nav__link">
    Android permissions changes in Android 8
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-webviews-and-safebrowsing" class="md-nav__link">
    Android WebViews and SafeBrowsing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-custom-url-schemes" class="md-nav__link">
    Android Custom URL Schemes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#android-app-notifications" class="md-nav__link">
    Android App Notifications
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#owasp-masvs" class="md-nav__link">
    OWASP MASVS
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05i-Testing-Code-Quality-and-Build-Settings/" class="md-nav__link">
        Android Code Quality and Build Settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05j-Testing-Resiliency-Against-Reverse-Engineering/" class="md-nav__link">
        Android Anti-Reversing Defenses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06a-Platform-Overview/" class="md-nav__link">
        iOS Platform Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06b-Basic-Security-Testing/" class="md-nav__link">
        iOS Basic Security Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06c-Reverse-Engineering-and-Tampering/" class="md-nav__link">
        iOS Tampering and Reverse Engineering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06d-Testing-Data-Storage/" class="md-nav__link">
        iOS Data Storage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06e-Testing-Cryptography/" class="md-nav__link">
        iOS Cryptographic APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06f-Testing-Local-Authentication/" class="md-nav__link">
        iOS Local Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06g-Testing-Network-Communication/" class="md-nav__link">
        iOS Network APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06h-Testing-Platform-Interaction/" class="md-nav__link">
        iOS Platform APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06i-Testing-Code-Quality-and-Build-Settings/" class="md-nav__link">
        iOS Code Quality and Build Settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06j-Testing-Resiliency-Against-Reverse-Engineering/" class="md-nav__link">
        iOS Anti-Reversing Defenses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x07-Appendix/" class="md-nav__link">
        Appendix
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x08-Testing-Tools/" class="md-nav__link">
        Testing Tools
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x09-Suggested-Reading/" class="md-nav__link">
        Suggested Reading
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Contributing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Contributing" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Contributing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/1_How_Can_You_Contribute/" class="md-nav__link">
        How Can You Contribute?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/2_Getting_Started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/3_PRs_and_Reviews/" class="md-nav__link">
        Pull Requests & Reviews
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/4_Add_new_Language/" class="md-nav__link">
        Add a New Language
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/5_Style_Guide/" class="md-nav__link">
        Style Guide
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/OWASP/owasp-mstg/edit/master/docs/MSTG/0x05h-Testing-Platform-Interaction.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="android-platform-apis">Android Platform APIs<a class="headerlink" href="#android-platform-apis" title="Permanent link">&para;</a></h1>
<h2 id="testing-app-permissions-mstg-platform-1">Testing App Permissions (MSTG-PLATFORM-1)<a class="headerlink" href="#testing-app-permissions-mstg-platform-1" title="Permanent link">&para;</a></h2>
<h3 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h3>
<p>Android assigns a distinct system identity (Linux user ID and group ID) to every installed app. Because each Android app operates in a process sandbox, apps must explicitly request access to resources and data that are outside their sandbox. They request this access by declaring the permissions they need to use system data and features. Depending on how sensitive or critical the data or feature is, the Android system will grant the permission automatically or ask the user to approve the request.</p>
<p>Android permissions are classified into four different categories on the basis of the protection level they offer:</p>
<ul>
<li><strong>Normal</strong>: This permission gives apps access to isolated application-level features with minimal risk to other apps, the user, and the system. For apps targeting Android 6.0 (API level 23) or higher, these permissions are granted automatically at installation time. For apps targeting a lower API level, the user needs to approve them at installation time. Example: <code>android.permission.INTERNET</code>.</li>
<li><strong>Dangerous</strong>: This permission usually gives the app control over user data or control over the device in a way that impacts the user. This type of permission may not be granted at installation time; whether the app should have the permission may be left for the user to decide. Example: <code>android.permission.RECORD_AUDIO</code>.</li>
<li><strong>Signature</strong>: This permission is granted only if the requesting app was signed with the same certificate used to sign the app that declared the permission. If the signature matches, the permission will be granted automatically. This permission is granted at installation time. Example: <code>android.permission.ACCESS_MOCK_LOCATION</code>.</li>
<li><strong>SystemOrSignature</strong>: This permission is granted only to applications embedded in the system image or signed with the same certificate used to sign the application that declared the permission. Example: <code>android.permission.ACCESS_DOWNLOAD_MANAGER</code>.</li>
</ul>
<p>A list of all permissions can be found in the <a href="https://developer.android.com/guide/topics/permissions/overview.html" title="Permissions overview">Android developer documentation</a> as well as concrete steps on how to:</p>
<ul>
<li><a href="https://developer.android.com/training/permissions/declaring">Declare app permissions</a> in your app's manifest file.</li>
<li><a href="https://developer.android.com/training/permissions/requesting">Request app permissions</a> programmatically.</li>
<li><a href="https://developer.android.com/guide/topics/permissions/defining">Define a Custom App Permission</a> to share your app resources and capabilities with other apps.</li>
</ul>
<h4 id="android-80-api-level-26-changes">Android 8.0 (API level 26) Changes<a class="headerlink" href="#android-80-api-level-26-changes" title="Permanent link">&para;</a></h4>
<p>The <a href="https://developer.android.com/about/versions/oreo/android-8.0-changes#atap" title="Android 8.0 (API level 26) - Changes for all apps">following changes</a> affect all apps running on Android 8.0 (API level 26), even to those apps targeting lower API levels.</p>
<ul>
<li><strong>Contacts provider usage stats change</strong>: when an app requests the <a href="https://developer.android.com/reference/android/Manifest.permission.html#READ_CONTACTS" title="READ_CONTACTS"><code>READ_CONTACTS</code></a> permission, queries for contact's usage data will return approximations rather than exact values (the auto-complete API is not affected by this change).</li>
</ul>
<p>Apps targeting Android 8.0 (API level 26) or higher <a href="https://developer.android.com/about/versions/oreo/android-8.0-changes#o-apps" title="Apps targeting Android 8.0">are affected</a> by the following:</p>
<ul>
<li><strong>Account access and discoverability improvements</strong>: Apps can no longer get access to user accounts only by having the <a href="https://developer.android.com/reference/android/Manifest.permission.html#GET_ACCOUNTS" title="GET_ACCOUNTS"><code>GET_ACCOUNTS</code></a> permission granted, unless the authenticator owns the accounts or the user grants that access.</li>
<li><strong>New telephony permissions</strong>: the following permissions (classified as dangerous) are now part of the <code>PHONE</code> permissions group:</li>
<li>The <code>ANSWER_PHONE_CALLS</code> permission allows to answer incoming phone calls programmatically (via <code>acceptRingingCall</code>).</li>
<li>The <code>READ_PHONE_NUMBERS</code> permission grants read access to the phone numbers stored in the device.</li>
<li>
<p><strong>Restrictions when granting dangerous permissions</strong>: Dangerous permissions are classified into permission groups (e.g. the <code>STORAGE</code> group contains <code>READ_EXTERNAL_STORAGE</code> and <code>WRITE_EXTERNAL_STORAGE</code>). Before Android 8.0 (API level 26), it was sufficient to request one permission of the group in order to get all permissions of that group also granted at the same time. This has changed <a href="https://developer.android.com/about/versions/oreo/android-8.0-changes#rmp" title="Android 8 Permissions Changes">starting at Android 8.0 (API level 26)</a>: whenever an app requests a permission at runtime, the system will grant exclusively that specific permission. However, note that <strong>all subsequent requests for permissions in that permission group will be automatically granted</strong> without showing the permissions dialog to the user. See this example from the Android developer documentation:</p>
<blockquote>
<p>Suppose an app lists both READ_EXTERNAL_STORAGE and WRITE_EXTERNAL_STORAGE in its manifest. The app requests READ_EXTERNAL_STORAGE and the user grants it. If the app targets API level 25 or lower, the system also grants WRITE_EXTERNAL_STORAGE at the same time, because it belongs to the same STORAGE permission group and is also registered in the manifest. If the app targets Android 8.0 (API level 26), the system grants only READ_EXTERNAL_STORAGE at that time; however, if the app later requests WRITE_EXTERNAL_STORAGE, the system immediately grants that privilege without prompting the user.</p>
</blockquote>
<p>You can see the list of permission groups in the <a href="https://developer.android.com/guide/topics/permissions/overview.html#permission-groups" title="Permission groups">Android developer documentation</a>. To make this a bit more confusing, <a href="https://developer.android.com/guide/topics/permissions/overview.html#perm-groups" title="Permission groups">Google also warns</a> that particular permissions might be moved from one group to another in future versions of the Android SDK and therefore, the logic of the app shouldn't rely on the structure of these permission groups. The best practice is to explicitly request every permission whenever it's needed.</p>
</li>
</ul>
<h4 id="android-9-api-level-28-changes">Android 9 (API Level 28) Changes<a class="headerlink" href="#android-9-api-level-28-changes" title="Permanent link">&para;</a></h4>
<p>The <a href="https://developer.android.com/about/versions/pie/android-9.0-changes-all" title="Behavior changes: all apps">following changes</a> affect all apps running on Android 9, even to those apps targeting API levels lower than 28.</p>
<ul>
<li><strong>Restricted access to call logs</strong>: <code>READ_CALL_LOG</code>, <code>WRITE_CALL_LOG</code>, and <code>PROCESS_OUTGOING_CALLS</code> (dangerous) permissions are moved from <code>PHONE</code> to the new <code>CALL_LOG</code> permission group. This means that being able to make phone calls (e.g. by having the permissions of the <code>PHONE</code> group granted) is not sufficient to get access to the call logs.</li>
<li><strong>Restricted access to phone numbers</strong>: apps wanting to read the phone number require the <code>READ_CALL_LOG</code> permission when running on Android 9 (API level 28).</li>
<li><strong>Restricted access to Wi-Fi location and connection information</strong>: SSID and BSSID values cannot be retrieved (e.g. via <a href="https://developer.android.com/reference/android/net/wifi/WifiManager#getConnectionInfo%28%29" title="WifiManager.getConnectionInfo"><code>WifiManager.getConnectionInfo</code></a> unless <em>all</em> of the following is true:</li>
<li>The <code>ACCESS_FINE_LOCATION</code> or <code>ACCESS_COARSE_LOCATION</code> permission.</li>
<li>The <code>ACCESS_WIFI_STATE</code> permission.</li>
<li>Location services are enabled (under <strong>Settings</strong> -&gt; <strong>Location</strong>).</li>
</ul>
<p>Apps targeting Android 9 (API level 28) or higher <a href="https://developer.android.com/about/versions/pie/android-9.0-changes-28" title="Behavior changes: apps targeting API level 28+">are affected</a> by the following:</p>
<ul>
<li><strong>Build serial number deprecation</strong>: device's hardware serial number cannot be read (e.g. via <a href="https://developer.android.com/reference/android/os/Build.html#getSerial%28%29" title="getSerial"><code>Build.getSerial</code></a>) unless the <code>READ_PHONE_STATE</code> (dangerous) permission is granted.</li>
</ul>
<h4 id="android-10-changes-beta">Android 10 Changes (Beta)<a class="headerlink" href="#android-10-changes-beta" title="Permanent link">&para;</a></h4>
<p>Android 10 Beta introduces several <a href="https://developer.android.com/preview/privacy/permissions" title="Android Q privacy: Changes to permissions">user privacy enhancements</a>. The changes regarding permissions affect to all apps running on Android 10, including those targeting lower API levels.</p>
<ul>
<li><strong>Restricted access to screen contents</strong>: <code>READ_FRAME_BUFFER</code>, <code>CAPTURE_VIDEO_OUTPUT</code>, and <code>CAPTURE_SECURE_VIDEO_OUTPUT</code> permissions are now signature-access only, which prevents silent access to the device's screen contents.</li>
<li><strong>User-facing permission check on legacy apps</strong>: when running an app targeting Android 5.1 (API level 22) or lower for the first time, users will be prompted with a permissions screen where they can revoke access to specific <em>legacy permissions</em> (which previously would be automatically granted at installation time).</li>
</ul>
<h3 id="activity-permission-enforcement">Activity Permission Enforcement<a class="headerlink" href="#activity-permission-enforcement" title="Permanent link">&para;</a></h3>
<p>Permissions are applied via <code>android:permission</code> attribute within the <code>&lt;activity&gt;</code> tag in the manifest. These permissions restrict which applications can start that Activity. The permission is checked during <code>Context.startActivity</code> and <code>Activity.startActivityForResult</code>. Not holding the required permission results in a <code>SecurityException</code> being thrown from the call.</p>
<h3 id="service-permission-enforcement">Service Permission Enforcement<a class="headerlink" href="#service-permission-enforcement" title="Permanent link">&para;</a></h3>
<p>Permissions applied via <code>android:permission</code> attribute within the <code>&lt;service&gt;</code> tag in the manifest restrict who can start or bind to the associated Service. The permission is checked during <code>Context.startService</code>, <code>Context.stopService</code> and <code>Context.bindService</code>. Not holding the required permission results in a <code>SecurityException</code> being thrown from the call.</p>
<h3 id="broadcast-permission-enforcement">Broadcast Permission Enforcement<a class="headerlink" href="#broadcast-permission-enforcement" title="Permanent link">&para;</a></h3>
<p>Permissions applied via <code>android:permission</code> attribute within the <code>&lt;receiver&gt;</code> tag restrict access to send broadcasts to the associated <code>BroadcastReceiver</code>. The held permissions are checked after <code>Context.sendBroadcast</code> returns, while trying to deliver the sent broadcast to the given receiver. Not holding the required permissions doesn't throw an exception, the result is an unsent broadcast.</p>
<p>A permission can be supplied to <code>Context.registerReceiver</code> to control who can broadcast to a programmatically registered receiver. Going the other way, a permission can be supplied when calling <code>Context.sendBroadcast</code> to restrict which broadcast receivers are allowed to receive the broadcast.</p>
<p>Note that both a receiver and a broadcaster can require a permission. When this happens, both permission checks must pass for the intent to be delivered to the associated target. For more information, please reference the section "<a href="https://developer.android.com/guide/components/broadcasts#restrict-broadcasts-permissions" title="Restricting broadcasts with permissions">Restricting broadcasts with permissions</a>" in the Android Developers Documentation.</p>
<h3 id="content-provider-permission-enforcement">Content Provider Permission Enforcement<a class="headerlink" href="#content-provider-permission-enforcement" title="Permanent link">&para;</a></h3>
<p>Permissions applied via <code>android:permission</code> attribute within the <code>&lt;provider&gt;</code> tag restrict access to data in a ContentProvider. Content providers have an important additional security facility called URI permissions which is described next. Unlike the other components, ContentProviders have two separate permission attributes that can be set, <code>android:readPermission</code> restricts who can read from the provider, and <code>android:writePermission</code> restricts who can write to it. If a ContentProvider is protected with both read and write permissions, holding only the write permission does not also grant read permissions.</p>
<p>Permissions are checked when you first retrieve a provider and as operations are performed using the ContentProvider. Using <code>ContentResolver.query</code> requires holding the read permission; using <code>ContentResolver.insert</code>, <code>ContentResolver.update</code>, <code>ContentResolver.delete</code> requires the write permission. A <code>SecurityException</code> will be thrown from the call if proper permissions are not held in all these cases.</p>
<h3 id="content-provider-uri-permissions">Content Provider URI Permissions<a class="headerlink" href="#content-provider-uri-permissions" title="Permanent link">&para;</a></h3>
<p>The standard permission system is not sufficient when being used with content providers. For example a content provider may want to limit permissions to READ permissions in order to protect itself, while using custom URIs to retrieve information. An application should only have the permission for that specific URI.</p>
<p>The solution is per-URI permissions. When starting or returning a result from an activity, the method can set <code>Intent.FLAG_GRANT_READ_URI_PERMISSION</code> and/or <code>Intent.FLAG_GRANT_WRITE_URI_PERMISSION</code>. This grants permission to the activity for
the specific URI regardless if it has permissions to access to data from the content provider.</p>
<p>This allows a common capability-style model where user interaction drives ad-hoc granting of fine-grained permission. This can be a key facility for reducing the permissions needed by apps to only those directly related to their behavior. Without this model in place malicious users may access other member's email attachments or harvest contact lists for future use via unprotected URIs. In the manifest the <a href="https://developer.android.com/guide/topics/manifest/provider-element#gprmsn" title="android:grantUriPermissions"><code>android:grantUriPermissions</code></a> attribute or the node help restrict the URIs.</p>
<h3 id="documentation-for-uri-permissions">Documentation for URI Permissions<a class="headerlink" href="#documentation-for-uri-permissions" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://developer.android.com/reference/android/content/Context.html#grantUriPermission%28java.lang.String,%20android.net.Uri,%20int%29" title="grantUriPermission">grantUriPermission</a></li>
<li><a href="https://developer.android.com/reference/android/content/Context#revokeUriPermission%28android.net.Uri,%20int%29" title="revokeUriPermission">revokeUriPermission</a></li>
<li><a href="https://developer.android.com/reference/android/content/Context#checkUriPermission%28android.net.Uri,%20int,%20int,%20int%29" title="checkUriPermission">checkUriPermission</a></li>
</ul>
<h4 id="custom-permissions">Custom Permissions<a class="headerlink" href="#custom-permissions" title="Permanent link">&para;</a></h4>
<p>Android allows apps to expose their services/components to other apps. Custom permissions are required for app access to the exposed components. You can define <a href="https://developer.android.com/guide/topics/permissions/defining.html" title="Custom Permissions">custom permissions</a> in <code>AndroidManifest.xml</code> by creating a permission tag with two mandatory attributes: <code>android:name</code> and <code>android:protectionLevel</code>.</p>
<p>It is crucial to create custom permissions that adhere to the <em>Principle of Least Privilege</em>: permission should be defined explicitly for its purpose, with a meaningful and accurate label and description.</p>
<p>Below is an example of a custom permission called <code>START_MAIN_ACTIVITY</code>, which is required when launching the <code>TEST_ACTIVITY</code> Activity.</p>
<p>The first code block defines the new permission, which is self-explanatory. The label tag is a summary of the permission, and the description is a more detailed version of the summary. You can set the protection level according to the types of permissions that will be granted. Once you've defined your permission, you can enforce it by adding it to the application's manifest. In our example, the second block represents the component that we are going to restrict with the permission we created. It can be enforced by adding the <code>android:permission</code> attributes.</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;permission</span> <span class="na">android:name=</span><span class="s">&quot;com.example.myapp.permission.START_MAIN_ACTIVITY&quot;</span>
        <span class="na">android:label=</span><span class="s">&quot;Start Activity in myapp&quot;</span>
        <span class="na">android:description=</span><span class="s">&quot;Allow the app to launch the activity of myapp app, any app you grant this permission will be able to launch main activity by myapp app.&quot;</span>
        <span class="na">android:protectionLevel=</span><span class="s">&quot;normal&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">&quot;TEST_ACTIVITY&quot;</span>
    <span class="na">android:permission=</span><span class="s">&quot;com.example.myapp.permission.START_MAIN_ACTIVITY&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.action.MAIN&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.category.LAUNCHER&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/activity&gt;</span>
</code></pre></div>
<p>Once the permission <code>START_MAIN_ACTIVITY</code> has been created, apps can request it via the <code>uses-permission</code> tag in the <code>AndroidManifest.xml</code> file. Any application granted the custom permission <code>START_MAIN_ACTIVITY</code> can then launch the <code>TEST_ACTIVITY</code>. Please note <code>&lt;uses-permission android:name="myapp.permission.START_MAIN_ACTIVITY" /&gt;</code> must be declared before the <code>&lt;application&gt;</code> or an exception will occur at runtime. Please see the example below that is based on the <a href="https://developer.android.com/guide/topics/permissions/overview" title="permission overview">permission overview</a> and <a href="https://developer.android.com/guide/topics/manifest/manifest-intro#filestruct" title="manifest-intro">manifest-intro</a>.</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;manifest&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;com.example.myapp.permission.START_MAIN_ACTIVITY&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;application&gt;</span>
            <span class="nt">&lt;activity&gt;</span>
            <span class="nt">&lt;/activity&gt;</span>
        <span class="nt">&lt;/application&gt;</span>
<span class="nt">&lt;/manifest&gt;</span>
</code></pre></div>
<p>We recommend using a reverse-domain annotation when registering a permission, as in the example above (e.g. <code>com.domain.application.permission</code>) in order to avoid collisions with other applications.</p>
<h3 id="static-analysis">Static Analysis<a class="headerlink" href="#static-analysis" title="Permanent link">&para;</a></h3>
<h4 id="android-permissions">Android Permissions<a class="headerlink" href="#android-permissions" title="Permanent link">&para;</a></h4>
<p>Check permissions to make sure that the app really needs them and remove unnecessary permissions. For example, the <code>INTERNET</code> permission in the AndroidManifest.xml file is necessary for an Activity to load a web page into a WebView. Because a user can revoke an application's right to use a dangerous permission, the developer should check whether the application has the appropriate permission each time an action is performed that would require that permission.</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.INTERNET&quot;</span> <span class="nt">/&gt;</span>
</code></pre></div>
<p>Go through the permissions with the developer to identify the purpose of every permission set and remove unnecessary permissions.</p>
<p>Besides going through the AndroidManifest.xml file manually, you can also use the Android Asset Packaging tool (aapt) to examine the permissions of an APK file.</p>
<blockquote>
<p>aapt comes with the Android SDK within the build-tools folder. It requires an APK file as input. You may list the APKs in the device by running <code>adb shell pm list packages -f | grep -i &lt;keyword&gt;</code> as seen in "<a href="../0x05b-Basic-Security_Testing/#listing-installed-apps" title="Listing Installed Apps">Listing Installed Apps</a>".</p>
</blockquote>
<div class="highlight"><pre><span></span><code>$ aapt d permissions app-x86-debug.apk
package: sg.vp.owasp_mobile.omtg_android
uses-permission: <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;android.permission.WRITE_EXTERNAL_STORAGE&#39;</span>
uses-permission: <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;android.permission.INTERNET&#39;</span>
</code></pre></div>
<p>Alternatively you may obtain a more detailed list of permissions via adb and the dumpsys tool:</p>
<div class="highlight"><pre><span></span><code>$ adb shell dumpsys package sg.vp.owasp_mobile.omtg_android <span class="p">|</span> grep permission
    requested permissions:
      android.permission.WRITE_EXTERNAL_STORAGE
      android.permission.INTERNET
      android.permission.READ_EXTERNAL_STORAGE
    install permissions:
      android.permission.INTERNET: <span class="nv">granted</span><span class="o">=</span><span class="nb">true</span>
      runtime permissions:
</code></pre></div>
<p>Please reference this <a href="https://developer.android.com/guide/topics/permissions/overview#permission-groups" title="Table 1. Dangerous permissions and permission groups.">permissions overview</a> for descriptions of the listed permissions that are considered dangerous.</p>
<div class="highlight"><pre><span></span><code>READ_CALENDAR
WRITE_CALENDAR
READ_CALL_LOG
WRITE_CALL_LOG
PROCESS_OUTGOING_CALLS
CAMERA
READ_CONTACTS
WRITE_CONTACTS
GET_ACCOUNTS
ACCESS_FINE_LOCATION
ACCESS_COARSE_LOCATION
RECORD_AUDIO
READ_PHONE_STATE
READ_PHONE_NUMBERS
CALL_PHONE
ANSWER_PHONE_CALLS
ADD_VOICEMAIL
USE_SIP
BODY_SENSORS
SEND_SMS
RECEIVE_SMS
READ_SMS
RECEIVE_WAP_PUSH
RECEIVE_MMS
READ_EXTERNAL_STORAGE
WRITE_EXTERNAL_STORAGE
</code></pre></div>
<h4 id="custom-permissions_1">Custom Permissions<a class="headerlink" href="#custom-permissions_1" title="Permanent link">&para;</a></h4>
<p>Apart from enforcing custom permissions via the application manifest file, you can also check permissions programmatically. This is not recommended, however, because it is more error-prone and can be bypassed more easily with, e.g., runtime instrumentation. It is recommended that the <code>ContextCompat.checkSelfPermission</code> method is called to check if an activity has a specified permission. Whenever you see code like the following snippet, make sure that the same permissions are enforced in the manifest file.</p>
<div class="highlight"><pre><span></span><code><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">TAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;LOG&quot;</span><span class="p">;</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">canProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkCallingOrSelfPermission</span><span class="p">(</span><span class="s">&quot;com.example.perm.READ_INCOMING_MSG&quot;</span><span class="p">);</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">canProcess</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"></span>
<span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>Or with <code>ContextCompat.checkSelfPermission</code> which compares it to the manifest file.</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ContextCompat</span><span class="p">.</span><span class="na">checkSelfPermission</span><span class="p">(</span><span class="n">secureActivity</span><span class="p">.</span><span class="na">this</span><span class="p">,</span><span class="w"> </span><span class="n">Manifest</span><span class="p">.</span><span class="na">READ_INCOMING_MSG</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">//!= stands for not equals PERMISSION_GRANTED</span><span class="w"></span>
<span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Permission denied&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3 id="requesting-permissions">Requesting Permissions<a class="headerlink" href="#requesting-permissions" title="Permanent link">&para;</a></h3>
<p>If your application has permissions that need to be requested at runtime, the application must call the <code>requestPermissions</code> method in order to obtain them. The app passes the permissions needed and an integer request code you have specified to the user asynchronously, returning once the user chooses to accept or deny the request in the same thread. After the response is returned the same request code is passed to the app's callback method.</p>
<div class="highlight"><pre><span></span><code><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">TAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;LOG&quot;</span><span class="p">;</span><span class="w"></span>
<span class="c1">// We start by checking the permission of the current Activity</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ContextCompat</span><span class="p">.</span><span class="na">checkSelfPermission</span><span class="p">(</span><span class="n">secureActivity</span><span class="p">.</span><span class="na">this</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">WRITE_EXTERNAL_STORAGE</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Permission is not granted</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Should we show an explanation?</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ActivityCompat</span><span class="p">.</span><span class="na">shouldShowRequestPermissionRationale</span><span class="p">(</span><span class="n">secureActivity</span><span class="p">.</span><span class="na">this</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="c1">//Gets whether you should show UI with rationale for requesting permission.</span><span class="w"></span>
<span class="w">        </span><span class="c1">//You should do this only if you do not have permission and the permission requested rationale is not communicated clearly to the user.</span><span class="w"></span>
<span class="w">            </span><span class="n">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">WRITE_EXTERNAL_STORAGE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Asynchronous thread waits for the users response.</span><span class="w"></span>
<span class="w">        </span><span class="c1">// After the user sees the explanation try requesting the permission again.</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Request a permission that doesn&#39;t need to be explained.</span><span class="w"></span>
<span class="w">        </span><span class="n">ActivityCompat</span><span class="p">.</span><span class="na">requestPermissions</span><span class="p">(</span><span class="n">secureActivity</span><span class="p">.</span><span class="na">this</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="n">Manifest</span><span class="p">.</span><span class="na">permission</span><span class="p">.</span><span class="na">WRITE_EXTERNAL_STORAGE</span><span class="p">},</span><span class="w"></span>
<span class="w">                </span><span class="n">MY_PERMISSIONS_REQUEST_WRITE_EXTERNAL_STORAGE</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// MY_PERMISSIONS_REQUEST_WRITE_EXTERNAL_STORAGE will be the app-defined int constant.</span><span class="w"></span>
<span class="w">        </span><span class="c1">// The callback method gets the result of the request.</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Permission already granted debug message printed in terminal.</span><span class="w"></span>
<span class="w">    </span><span class="n">Log</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Permission already granted.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Please note that if you need to provide any information or explanation to the user it needs to be done before the call to <code>requestPermissions</code>, since the system dialog box can not be altered once called.</p>
<h3 id="handling-responses-to-permission-requests">Handling Responses to Permission Requests<a class="headerlink" href="#handling-responses-to-permission-requests" title="Permanent link">&para;</a></h3>
<p>Now your app has to override the system method <code>onRequestPermissionsResult</code> to see if the permission was granted. This method receives the <code>requestCode</code> integer as input parameter (which is the same request code that was created in <code>requestPermissions</code>).</p>
<p>The following callback method may be used for <code>WRITE_EXTERNAL_STORAGE</code>.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Override</span><span class="w"> </span><span class="c1">//Needed to override system method onRequestPermissionsResult()</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onRequestPermissionsResult</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">requestCode</span><span class="p">,</span><span class="w"> </span><span class="c1">//requestCode is what you specified in requestPermissions()</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">permissions</span><span class="o">[]</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">permissionResults</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">requestCode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">MY_PERMISSIONS_WRITE_EXTERNAL_STORAGE</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">grantResults</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">permissionResults</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="na">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// 0 is a canceled request, if int array equals requestCode permission is granted.</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// permission denied code goes here.</span><span class="w"></span>
<span class="w">                </span><span class="n">Log</span><span class="p">.</span><span class="na">v</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Permission denied&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Other switch cases can be added here for multiple permission checks.</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Permissions should be explicitly requested for every needed permission, even if a similar permission from the same group has already been requested. For applications targeting Android 7.1 (API level 25) and older, Android will automatically give an application all the permissions from a permission group, if the user grants one of the requested permissions of that group. Starting with Android 8.0 (API level 26), permissions will still automatically be granted if a user has already granted a permission from the same permission group, but the application still needs to explicitly request the permission. In this case, the <code>onRequestPermissionsResult</code> handler will automatically be triggered without any user interaction.</p>
<p>For example if both <code>READ_EXTERNAL_STORAGE</code> and <code>WRITE_EXTERNAL_STORAGE</code> are listed in the Android Manifest but only permissions are granted for <code>READ_EXTERNAL_STORAGE</code>, then requesting <code>WRITE_EXTERNAL_STORAGE</code> will automatically have permissions without user interaction because they are in the same group and not explicitly requested.</p>
<h3 id="permission-analysis">Permission Analysis<a class="headerlink" href="#permission-analysis" title="Permanent link">&para;</a></h3>
<p>Always check whether the application is requesting permissions it actually requires. Make sure that no permissions are requested which are not related to the goal of the app, especially <code>DANGEROUS</code> and <code>SIGNATURE</code> permissions, since they can affect both the user and the application if mishandled. For instance, it should be suspicious if a single-player game app requires access to <code>android.permission.WRITE_SMS</code>.</p>
<p>When analyzing permissions, you should investigate the concrete use case scenarios of the app and always check if there are replacement APIs for any <code>DANGEROUS</code> permissions in use. A good example is the <a href="https://developers.google.com/identity/sms-retriever/overview">SMS Retriever API</a> which streamlines the usage of SMS permissions when performing SMS-based user verification. By using this API an application does not have to declare <code>DANGEROUS</code> permissions which is a benefit to both the user and developers of the application, who doesn't have to submit the <a href="https://support.google.com/googleplay/android-developer/answer/9214102?hl=en">Permissions Declaration Form</a>.</p>
<h3 id="dynamic-analysis">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis" title="Permanent link">&para;</a></h3>
<p>Permissions for installed applications can be retrieved with <code>adb</code>. The following extract demonstrates how to examine the permissions used by an application.</p>
<div class="highlight"><pre><span></span><code>$ adb shell dumpsys package com.google.android.youtube
...
declared permissions:
  com.google.android.youtube.permission.C2D_MESSAGE: <span class="nv">prot</span><span class="o">=</span>signature, INSTALLED
requested permissions:
  android.permission.INTERNET
  android.permission.ACCESS_NETWORK_STATE
install permissions:
  com.google.android.c2dm.permission.RECEIVE: <span class="nv">granted</span><span class="o">=</span><span class="nb">true</span>
  android.permission.USE_CREDENTIALS: <span class="nv">granted</span><span class="o">=</span><span class="nb">true</span>
  com.google.android.providers.gsf.permission.READ_GSERVICES: <span class="nv">granted</span><span class="o">=</span><span class="nb">true</span>  
...
</code></pre></div>
<p>The output shows all permissions using the following categories:</p>
<ul>
<li><strong>declared permissions</strong>: list of all <em>custom</em> permissions.</li>
<li><strong>requested and install permissions</strong>: list of all install-time permissions including <em>normal</em> and <em>signature</em> permissions.</li>
<li><strong>runtime permissions</strong>: list of all <em>dangerous</em> permissions.</li>
</ul>
<p>When doing the dynamic analysis:</p>
<ul>
<li><a href="https://developer.android.com/training/permissions/evaluating">Evaluate</a> whether the app really needs the requested permissions. For instance: a single-player game that requires access to <code>android.permission.WRITE_SMS</code>, might not be a good idea.</li>
<li>In many cases the app could opt for <a href="https://developer.android.com/training/permissions/evaluating#alternatives">alternatives to declaring permissions</a>, such as:</li>
<li>requesting the <code>ACCESS_COARSE_LOCATION</code> permission instead of <code>ACCESS_FINE_LOCATION</code>. Or even better not requesting the permission at all, and instead ask the user to enter a postal code.</li>
<li>invoking the <code>ACTION_IMAGE_CAPTURE</code> or <code>ACTION_VIDEO_CAPTURE</code> intent action instead of requesting the <code>CAMERA</code> permission.</li>
<li>using <a href="https://developer.android.com/guide/topics/connectivity/companion-device-pairing">Companion Device Pairing</a> (Android 8.0 (API level 26) and higher) when pairing with a Bluetooth device instead of declaring the <code>ACCESS_FINE_LOCATION</code>, <code>ACCESS_COARSE_LOCATIION</code>, or <code>BLUETOOTH_ADMIN</code> permissions.</li>
<li>Use the <a href="https://developer.android.com/training/permissions/explaining-access#privacy-dashboard">Privacy Dashboard</a> (Android 12 (API level 31) and higher) to verify how the app <a href="https://developer.android.com/training/permissions/explaining-access">explains access to sensitive information</a>.</li>
</ul>
<p>To obtain detail about a specific permission you can refer to the <a href="https://developer.android.com/reference/android/Manifest.permission">Android Documentation</a>.</p>
<h2 id="testing-for-injection-flaws-mstg-platform-2">Testing for Injection Flaws (MSTG-PLATFORM-2)<a class="headerlink" href="#testing-for-injection-flaws-mstg-platform-2" title="Permanent link">&para;</a></h2>
<h3 id="overview_1">Overview<a class="headerlink" href="#overview_1" title="Permanent link">&para;</a></h3>
<p>Android apps can expose functionality through deep links (which are a part of Intents). They can expose functionality to:</p>
<ul>
<li>other apps (via deep links or other IPC mechanisms, such as Intents or BroadcastReceivers).</li>
<li>the user (via the user interface).</li>
</ul>
<p>None of the input from these sources can be trusted; it must be validated and/or sanitized. Validation ensures processing of data that the app is expecting only. If validation is not enforced, any input can be sent to the app, which may allow an attacker or malicious app to exploit app functionality.</p>
<p>The following portions of the source code should be checked if any app functionality has been exposed:</p>
<ul>
<li>Deep Links. Check the test case <a href="#testing-deep-links-mstg-platform-3">"Testing Deep Links"</a> as well for further test scenarios.</li>
<li>IPC Mechanisms (Intents, Binders, Android Shared Memory, or BroadcastReceivers). Check the test case <a href="#testing-for-sensitive-functionality-exposure-through-ipc-mstg-platform-4">"Testing for Sensitive Functionality Exposure Through IPC"</a> as well for further test scenarios.</li>
<li>User interface. Check the test case <a href="#testing-for-overlay-attacks-mstg-platform-9">"Testing for Overlay Attacks"</a>.</li>
</ul>
<p>An example of a vulnerable IPC mechanism is shown below.</p>
<p>You can use <em>ContentProviders</em> to access database information, and you can probe services to see if they return data. If data is not validated properly, the content provider may be prone to SQL injection while other apps are interacting with it. See the following vulnerable implementation of a <em>ContentProvider</em>.</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;provider</span>
    <span class="na">android:name=</span><span class="s">&quot;.OMTG_CODING_003_SQL_Injection_Content_Provider_Implementation&quot;</span>
    <span class="na">android:authorities=</span><span class="s">&quot;sg.vp.owasp_mobile.provider.College&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/provider&gt;</span>
</code></pre></div>
<p>The <code>AndroidManifest.xml</code> above defines a content provider that's exported and therefore available to all other apps. The <code>query</code> function in the <code>OMTG_CODING_003_SQL_Injection_Content_Provider_Implementation.java</code> class should be inspected.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Override</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="n">Cursor</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="n">Uri</span><span class="w"> </span><span class="n">uri</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">projection</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">selection</span><span class="p">,</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">selectionArgs</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">sortOrder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SQLiteQueryBuilder</span><span class="w"> </span><span class="n">qb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SQLiteQueryBuilder</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">qb</span><span class="p">.</span><span class="na">setTables</span><span class="p">(</span><span class="n">STUDENTS_TABLE_NAME</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">uriMatcher</span><span class="p">.</span><span class="na">match</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">STUDENTS</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">qb</span><span class="p">.</span><span class="na">setProjectionMap</span><span class="p">(</span><span class="n">STUDENTS_PROJECTION_MAP</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">STUDENT_ID</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="c1">// SQL Injection when providing an ID</span><span class="w"></span>
<span class="w">            </span><span class="n">qb</span><span class="p">.</span><span class="na">appendWhere</span><span class="p">(</span><span class="w"> </span><span class="n">_ID</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">uri</span><span class="p">.</span><span class="na">getPathSegments</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="s">&quot;appendWhere&quot;</span><span class="p">,</span><span class="n">uri</span><span class="p">.</span><span class="na">getPathSegments</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">default</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;Unknown URI &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">uri</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sortOrder</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">sortOrder</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="cm">/**</span>
<span class="cm">         * By default sort on student names</span>
<span class="cm">         */</span><span class="w"></span>
<span class="w">        </span><span class="n">sortOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NAME</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">Cursor</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qb</span><span class="p">.</span><span class="na">query</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="w"> </span><span class="n">projection</span><span class="p">,</span><span class="w"> </span><span class="n">selection</span><span class="p">,</span><span class="w"> </span><span class="n">selectionArgs</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">sortOrder</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * register to watch a content URI for changes</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="na">setNotificationUri</span><span class="p">(</span><span class="n">getContext</span><span class="p">().</span><span class="na">getContentResolver</span><span class="p">(),</span><span class="w"> </span><span class="n">uri</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>While the user is providing a STUDENT_ID at <code>content://sg.vp.owasp_mobile.provider.College/students</code>, the query statement is prone to SQL injection. Obviously <a href="https://www.owasp.org/index.php/SQL_Injection_Prevention_Cheat_Sheet" title="OWASP SQL Injection Cheat Sheet">prepared statements</a> must be used to avoid SQL injection, but <a href="https://www.owasp.org/index.php/Input_Validation_Cheat_Sheet" title="OWASP Input Validation Cheat Sheet">input validation</a> should also be applied so that only input that the app is expecting is processed.</p>
<p>All app functions that process data coming in through the UI should implement input validation:</p>
<ul>
<li>For user interface input, <a href="https://github.com/ragunathjawahar/android-saripaar" title="Android Saripaar v2">Android Saripaar v2</a> can be used.</li>
<li>For input from IPC or URL schemes, a validation function should be created. For example, the following determines whether the <a href="https://stackoverflow.com/questions/11241690/regex-for-checking-if-a-string-is-strictly-alphanumeric" title="Input Validation">string is alphanumeric</a>:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAlphaNumeric</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">pattern</span><span class="o">=</span><span class="w"> </span><span class="s">&quot;^[a-zA-Z0-9]*$&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">matches</span><span class="p">(</span><span class="n">pattern</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>An alternative to validation functions is type conversion, with, for example, <code>Integer.parseInt</code> if only integers are expected. The <a href="https://www.owasp.org/index.php/Input_Validation_Cheat_Sheet" title="OWASP Input Validation Cheat Sheet">OWASP Input Validation Cheat Sheet</a> contains more information about this topic.</p>
<h3 id="dynamic-analysis_1">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_1" title="Permanent link">&para;</a></h3>
<p>The tester should manually test the input fields with strings like <code>OR 1=1--</code> if, for example, a local SQL injection vulnerability has been identified.</p>
<p>On a rooted device, the command content can be used to query the data from a content provider. The following command queries the vulnerable function described above.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># content query --uri content://sg.vp.owasp_mobile.provider.College/students</span>
</code></pre></div>
<p>SQL injection can be exploited with the following command. Instead of getting the record for Bob only, the user can retrieve all data.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># content query --uri content://sg.vp.owasp_mobile.provider.College/students --where &quot;name=&#39;Bob&#39;) OR 1=1--&#39;&#39;&quot;</span>
</code></pre></div>
<h2 id="testing-for-fragment-injection-mstg-platform-2">Testing for Fragment Injection (MSTG-PLATFORM-2)<a class="headerlink" href="#testing-for-fragment-injection-mstg-platform-2" title="Permanent link">&para;</a></h2>
<h3 id="overview_2">Overview<a class="headerlink" href="#overview_2" title="Permanent link">&para;</a></h3>
<p>Android SDK offers developers a way to present a <a href="https://developer.android.com/reference/android/preference/PreferenceActivity.html" title="Preference Activity"><code>Preferences activity</code></a> to users, allowing the developers to extend and adapt this abstract class.</p>
<p>This abstract class parses the extra data fields of an Intent, in particular, the <code>PreferenceActivity.EXTRA_SHOW_FRAGMENT(:android:show_fragment)</code> and <code>Preference Activity.EXTRA_SHOW_FRAGMENT_ARGUMENTS(:android:show_fragment_arguments)</code> fields.</p>
<p>The first field is expected to contain the <code>Fragment</code> class name, and the second one is expected to contain the input bundle passed to the <code>Fragment</code>.</p>
<p>Because the <code>PreferenceActivity</code> uses reflection to load the fragment, an arbitrary class may be loaded inside the package or the Android SDK. The loaded class runs in the context of the application that exports this activity.</p>
<p>With this vulnerability, an attacker can call fragments inside the target application or run the code present in other classes' constructors. Any class that's passed in the Intent and does not extend the Fragment class will cause a <code>java.lang.CastException</code>, but the empty constructor will be executed before the exception is thrown, allowing the code present in the class constructor run.</p>
<p>To prevent this vulnerability, a new method called <code>isValidFragment</code> was added in Android 4.4 (API level 19). It allows developers to override this method and define the fragments that may be used in this context.</p>
<p>The default implementation returns <code>true</code> on versions older than Android 4.4 (API level 19); it will throw an exception on later versions.</p>
<h3 id="static-analysis_1">Static Analysis<a class="headerlink" href="#static-analysis_1" title="Permanent link">&para;</a></h3>
<p>Steps:</p>
<ul>
<li>Check if <code>android:targetSdkVersion</code> less than 19.</li>
<li>Find exported Activities that extend the <code>PreferenceActivity</code> class.</li>
<li>Determine whether the method <code>isValidFragment</code> has been overridden.</li>
<li>If the app currently sets its <code>android:targetSdkVersion</code> in the manifest to a value less than 19 and the vulnerable class does not contain any implementation of <code>isValidFragment</code> then, the vulnerability is inherited from the <code>PreferenceActivity</code>.</li>
<li>In order to fix, developers should either update the <code>android:targetSdkVersion</code> to 19 or higher. Alternatively, if the <code>android:targetSdkVersion</code> cannot be updated, then developers should implement <code>isValidFragment</code> as described.</li>
</ul>
<p>The following example shows an Activity that extends this activity:</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyPreferences</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">PreferenceActivity</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span><span class="w"> </span><span class="n">savedInstanceState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The following examples show the <code>isValidFragment</code> method being overridden with an implementation that allows the loading of <code>MyPreferenceFragment</code> only:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Override</span><span class="w"></span>
<span class="kd">protected</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isValidFragment</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">fragmentName</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="k">return</span><span class="w"> </span><span class="s">&quot;com.fullpackage.MyPreferenceFragment&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">fragmentName</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3 id="example-of-vulnerable-app-and-exploitation">Example of Vulnerable App and Exploitation<a class="headerlink" href="#example-of-vulnerable-app-and-exploitation" title="Permanent link">&para;</a></h3>
<p>MainActivity.class</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MainActivity</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">PreferenceActivity</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span><span class="w"> </span><span class="n">savedInstanceState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>MyFragment.class</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyFragment</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Fragment</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="w"> </span><span class="p">(</span><span class="n">Bundle</span><span class="w"> </span><span class="n">savedInstanceState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">View</span><span class="w"> </span><span class="nf">onCreateView</span><span class="p">(</span><span class="n">LayoutInflater</span><span class="w"> </span><span class="n">inflater</span><span class="p">,</span><span class="w"> </span><span class="n">ViewGroup</span><span class="w"> </span><span class="n">container</span><span class="p">,</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">savedInstanceState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">View</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inflater</span><span class="p">.</span><span class="na">inflate</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">layout</span><span class="p">.</span><span class="na">fragmentLayout</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">WebView</span><span class="w"> </span><span class="n">myWebView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WebView</span><span class="p">)</span><span class="w"> </span><span class="n">wv</span><span class="p">.</span><span class="na">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">webview</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">myWebView</span><span class="p">.</span><span class="na">getSettings</span><span class="p">().</span><span class="na">setJavaScriptEnabled</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">myWebView</span><span class="p">.</span><span class="na">loadUrl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getActivity</span><span class="p">().</span><span class="na">getIntent</span><span class="p">().</span><span class="na">getDataString</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>To exploit this vulnerable Activity, you can create an application with the following code:</p>
<div class="highlight"><pre><span></span><code><span class="n">Intent</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">();</span><span class="w"></span>
<span class="n">i</span><span class="p">.</span><span class="na">setFlags</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="na">FLAG_ACTIVITY_CLEAR_TASK</span><span class="p">);</span><span class="w"></span>
<span class="n">i</span><span class="p">.</span><span class="na">setClassName</span><span class="p">(</span><span class="s">&quot;pt.claudio.insecurefragment&quot;</span><span class="p">,</span><span class="s">&quot;pt.claudio.insecurefragment.MainActivity&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">i</span><span class="p">.</span><span class="na">putExtra</span><span class="p">(</span><span class="s">&quot;:android:show_fragment&quot;</span><span class="p">,</span><span class="s">&quot;pt.claudio.insecurefragment.MyFragment&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">i</span><span class="p">.</span><span class="na">setData</span><span class="p">(</span><span class="n">Uri</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="s">&quot;https://security.claudio.pt&quot;</span><span class="p">));</span><span class="w"></span>
<span class="n">startActivity</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>The <a href="https://github.com/clviper/android-fragment-injection/raw/master/vulnerableapp.apk" title="Vulnerable App Fragment Injection">Vulnerable App</a> and <a href="https://github.com/clviper/android-fragment-injection/blob/master/exploit.apk" title="PoC App to exploit Fragment Injection">Exploit PoC App</a> are available for downloading.</p>
<h2 id="testing-for-url-loading-in-webviews-mstg-platform-2">Testing for URL Loading in WebViews (MSTG-PLATFORM-2)<a class="headerlink" href="#testing-for-url-loading-in-webviews-mstg-platform-2" title="Permanent link">&para;</a></h2>
<h3 id="overview_3">Overview<a class="headerlink" href="#overview_3" title="Permanent link">&para;</a></h3>
<p>WebViews are Android's embedded components which allow your app to open web pages within your application. In addition to mobile apps related threats, WebViews may expose your app to common web threats (e.g. XSS, Open Redirect, etc.).</p>
<p>One of the most important things to do when testing WebViews is to make sure that only trusted content can be loaded in it. Any newly loaded page could be potentially malicious, try to exploit any WebView bindings or try to phish the user. Unless you're developing a browser app, usually you'd like to restrict the pages being loaded to the domain of your app. A good practice is to prevent the user from even having the chance to input any URLs inside WebViews (which is the default on Android) nor navigate outside the trusted domains. Even when navigating on trusted domains there's still the risk that the user might encounter and click on other links to untrustworthy content (e.g. if the page allows for other users to post comments). In addition, some developers might even override some default behavior which can be potentially dangerous for the user. See the Static Analysis section below for more details.</p>
<h4 id="safebrowsing-api">SafeBrowsing API<a class="headerlink" href="#safebrowsing-api" title="Permanent link">&para;</a></h4>
<p>To provide a safer web browsing experience, Android 8.1 (API level 27) introduces the <a href="https://developers.google.com/safe-browsing/v4"><code>SafeBrowsing API</code></a>, which allows your application to detect URLs that Google has classified as a known threat.</p>
<p>By default, WebViews show a warning to users about the security risk with the option to load the URL or stop the page from loading. With the SafeBrowsing API you can customize your application's behavior by either reporting the threat to SafeBrowsing or performing a particular action such as returning back to safety each time it encounters a known threat. Please check the <a href="https://developer.android.com/about/versions/oreo/android-8.1#safebrowsing">Android Developers documentation</a> for usage examples.</p>
<p>You can use the SafeBrowsing API independently from WebViews using the <a href="https://developer.android.com/training/safetynet/safebrowsing">SafetyNet library</a>, which implements a client for Safe Browsing Network Protocol v4. SafetyNet allows you to analyze all the URLs that your app is supposed load. You can check URLs with different schemes (e.g. http, file) since SafeBrowsing is agnostic to URL schemes, and against <code>TYPE_POTENTIALLY_HARMFUL_APPLICATION</code> and <code>TYPE_SOCIAL_ENGINEERING</code> threat types.</p>
<h4 id="virus-total-api">Virus Total API<a class="headerlink" href="#virus-total-api" title="Permanent link">&para;</a></h4>
<p>Virus Total provides an API for analyzing URLs and local files for known threats. The API Reference is available on <a href="https://developers.virustotal.com/reference#getting-started" title="Getting Started">Virus Total developers page</a>.</p>
<blockquote>
<p>When sending URLs or files to be checked for known threats make sure they don't contain sensitive data which could compromise a user's privacy, or expose sensitive content from your application.</p>
</blockquote>
<h3 id="static-analysis_2">Static Analysis<a class="headerlink" href="#static-analysis_2" title="Permanent link">&para;</a></h3>
<p>As we mentioned before, <a href="https://developer.android.com/guide/webapps/webview#HandlingNavigation" title="Handling page navigation">handling page navigation</a> should be analyzed carefully, especially when users might be able to navigate away from a trusted environment. The default and safest behavior on Android is to let the default web browser open any link that the user might click inside the WebView. However, this default logic can be modified by configuring a <code>WebViewClient</code> which allows navigation requests to be handled by the app itself. If this is the case, be sure to search for and inspect the following interception callback functions:</p>
<ul>
<li><code>shouldOverrideUrlLoading</code> allows your application to either abort loading WebViews with suspicious content by returning <code>true</code> or allow the WebView to load the URL by returning <code>false</code>. Considerations:</li>
<li>This method is not called for POST requests.</li>
<li>This method is not called for XmlHttpRequests, iFrames, "src" attributes included in HTML or <code>&lt;script&gt;</code> tags. Instead, <code>shouldInterceptRequest</code> should take care of this.</li>
<li><code>shouldInterceptRequest</code> allows the application to return the data from resource requests. If the return value is null, the WebView will continue to load the resource as usual. Otherwise, the data returned by the <code>shouldInterceptRequest</code> method is used. Considerations:</li>
<li>This callback is invoked for a variety of URL schemes (e.g., <code>http(s):</code>, <code>data:</code>, <code>file:</code>, etc.), not only those schemes which send requests over the network.</li>
<li>This is not called for <code>javascript:</code> or <code>blob:</code> URLs, or for assets accessed via <code>file:///android_asset/</code> or <code>file:///android_res/</code> URLs.
In the case of redirects, this is only called for the initial resource URL, not any subsequent redirect URLs.</li>
<li>When Safe Browsing is enabled, these URLs still undergo Safe Browsing checks but the developer can allow the URL with <code>setSafeBrowsingWhitelist</code> or even ignore the warning via the <code>onSafeBrowsingHit</code> callback.</li>
</ul>
<p>As you can see there are a lot of points to consider when testing the security of WebViews that have a WebViewClient configured, so be sure to carefully read and understand all of them by checking the <a href="https://developer.android.com/reference/android/webkit/WebViewClient" title="WebViewClient"><code>WebViewClient</code> Documentation</a>.</p>
<p>While the default value of <code>EnableSafeBrowsing</code> is <code>true</code>, some applications might opt to disable it. To verify that SafeBrowsing is enabled, inspect the AndroidManifest.xml file and make sure that the configuration below is not present:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;manifest&gt;</span>
    <span class="nt">&lt;application&gt;</span>
        <span class="nt">&lt;meta-data</span> <span class="na">android:name=</span><span class="s">&quot;android.webkit.WebView.EnableSafeBrowsing&quot;</span>
                   <span class="na">android:value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
        ...
    <span class="nt">&lt;/application&gt;</span>
<span class="nt">&lt;/manifest&gt;</span>
</code></pre></div>
<h3 id="dynamic-analysis_2">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_2" title="Permanent link">&para;</a></h3>
<p>A convenient way to dynamically test deep linking is to use Frida or frida-trace and hook the <code>shouldOverrideUrlLoading</code>, <code>shouldInterceptRequest</code> methods while using the app and clicking on links within the WebView. Be sure to also hook other related <a href="https://developer.android.com/reference/android/net/Uri" title="Uri class"><code>Uri</code></a> methods such as <code>getHost</code>, <code>getScheme</code> or <code>getPath</code> which are typically used to inspect the requests and match known patterns or deny lists.</p>
<h2 id="testing-deep-links-mstg-platform-3">Testing Deep Links (MSTG-PLATFORM-3)<a class="headerlink" href="#testing-deep-links-mstg-platform-3" title="Permanent link">&para;</a></h2>
<h3 id="overview_4">Overview<a class="headerlink" href="#overview_4" title="Permanent link">&para;</a></h3>
<p><em>Deep links</em> are URIs of any scheme that take users directly to specific content in an app. An app can <a href="https://developer.android.com/training/app-links/deep-linking">set up deep links</a> by adding <em>intent filters</em> on the Android Manifest and extracting data from incoming intents to navigate users to the correct activity.</p>
<p>Android supports two types of deep links:</p>
<ul>
<li><strong>Custom URL Schemes</strong>, which are deep links that use any custom URL scheme, e.g. <code>myapp://</code> (not verified by the OS).</li>
<li><strong>Android App Links</strong> (Android 6.0 (API level 23) and higher), which are deep links that use the <code>http://</code> and <code>https://</code> schemes and contain the <code>autoVerify</code> attribute (which triggers OS verification).</li>
</ul>
<h4 id="deep-link-collision">Deep Link Collision<a class="headerlink" href="#deep-link-collision" title="Permanent link">&para;</a></h4>
<p>Using unverified deep links can cause a significant issue- any other apps installed on a user's device can declare and try to handle the same intent, which is known as <strong>deep link collision</strong>. Any arbitrary application can declare control over the exact same deep link belonging to another application.</p>
<p>In recent versions of Android this results in a so-called <em>disambiguation dialog</em> shown to the user that asks them to select the application that should handle the deep link. The user could make the mistake of choosing a malicious application instead of the legitimate one.</p>
<p><img alt="OWASP_MSTG" src="https://developer.android.com/training/app-links/images/app-disambiguation_2x.png" /></p>
<h4 id="android-app-links">Android App Links<a class="headerlink" href="#android-app-links" title="Permanent link">&para;</a></h4>
<p>In order to solve the deep link collision issue, Android 6.0 (API Level 23) introduced <a href="https://developer.android.com/training/app-links"><strong>Android App Links</strong></a>, which are <a href="https://developer.android.com/training/app-links/verify-site-associations" title="Verify Android App Links">verified deep links</a> based on a website URL explicitly registered by the developer. Clicking on an App Link will immediately open the app if it's installed.</p>
<p>There are some key differences from unverified deep links:</p>
<ul>
<li>App Links only use <code>http://</code> and <code>https://</code> schemes, any other custom URL schemes are not allowed.</li>
<li>App Links require a live domain to serve a <a href="https://developers.google.com/digital-asset-links/v1/getting-started" title="Digital Asset Link">Digital Asset Links file</a> via HTTPS.</li>
<li>App Links do not suffer from deep link collision since they don't show a disambiguation dialog when a user opens them.</li>
</ul>
<h4 id="testing-deep-links">Testing Deep Links<a class="headerlink" href="#testing-deep-links" title="Permanent link">&para;</a></h4>
<p>Any existing deep links (including App Links) can potentially increase the app attack surface. This <a href="https://people.cs.vt.edu/gangwang/deep17.pdf">includes many risks</a> such as link hijacking, sensitive functionality exposure, etc. The Android version in which the app runs also influences the risk:</p>
<ul>
<li>Before Android 12 (API level 31), if the app has any <a href="https://developer.android.com/training/app-links/verify-site-associations#fix-errors">non-verifiable links</a>, it can cause the system to not verify all Android App Links for that app.</li>
<li>Starting on Android 12 (API level 31), apps benefit from a <a href="https://developer.android.com/training/app-links/deep-linking">reduced attack surface</a>. A generic web intent resolves to the user's default browser app unless the target app is approved for the specific domain contained in that web intent.</li>
</ul>
<p>All deep links must be enumerated and verified for correct website association. The actions they perform must be well tested, especially all input data, which should be deemed untrustworthy and thus should always be validated.</p>
<h3 id="static-analysis_3">Static Analysis<a class="headerlink" href="#static-analysis_3" title="Permanent link">&para;</a></h3>
<h4 id="enumerate-deep-links">Enumerate Deep Links<a class="headerlink" href="#enumerate-deep-links" title="Permanent link">&para;</a></h4>
<p><strong>Inspecting the Android Manifest:</strong></p>
<p>You can easily determine whether deep links (with or without custom URL schemes) are defined by <a href="../0x05b-Basic-Security_Testing/#exploring-the-app-package">decoding the app using apktool</a> and inspecting the Android Manifest file looking for <a href="https://developer.android.com/guide/components/intents-filters.html#DataTest" title="intent-filters - DataTest"><code>&lt;intent-filter&gt;</code> elements</a>.</p>
<ul>
<li><strong>Custom Url Schemes</strong>: The following example specifies a deep link with a custom URL scheme called <code>myapp://</code>.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">&quot;.MyUriActivity&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;intent-filter&gt;</span>
      <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.action.VIEW&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.category.DEFAULT&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.category.BROWSABLE&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">&quot;myapp&quot;</span> <span class="na">android:host=</span><span class="s">&quot;path&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/activity&gt;</span>
</code></pre></div>
<ul>
<li><strong>Deep Links</strong>: The following example specifies a deep Link using both the <code>http://</code> and <code>https://</code> schemes, along with the host and path that will activate it (in this case, the full URL would be <code>https://www.myapp.com/my/app/path</code>):</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;intent-filter&gt;</span>
  ...
  <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">&quot;http&quot;</span> <span class="na">android:host=</span><span class="s">&quot;www.myapp.com&quot;</span> <span class="na">android:path=</span><span class="s">&quot;/my/app/path&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">&quot;https&quot;</span> <span class="na">android:host=</span><span class="s">&quot;www.myapp.com&quot;</span> <span class="na">android:path=</span><span class="s">&quot;/my/app/path&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/intent-filter&gt;</span>
</code></pre></div>
<ul>
<li><strong>App Links</strong>: If the <code>&lt;intent-filter&gt;</code> includes the flag <code>android:autoVerify="true"</code>, this causes the Android system to reach out to the declared <code>android:host</code> in an attempt to access the <a href="https://developers.google.com/digital-asset-links/v1/getting-started" title="Digital Asset Link">Digital Asset Links file</a> in order to <a href="https://developer.android.com/training/app-links/verify-site-associations" title="Verify Android App Links">verify the App Links</a>. <strong>A deep link can be considered an App Link only if the verification is successful.</strong></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;intent-filter</span> <span class="na">android:autoVerify=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</code></pre></div>
<p>When listing deep links remember that <code>&lt;data&gt;</code> elements within the same <code>&lt;intent-filter&gt;</code> are actually merged together to account for all variations of their combined attributes.</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;intent-filter&gt;</span>
  ...
  <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">&quot;https&quot;</span> <span class="na">android:host=</span><span class="s">&quot;www.example.com&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">&quot;app&quot;</span> <span class="na">android:host=</span><span class="s">&quot;open.my.app&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/intent-filter&gt;</span>
</code></pre></div>
<p>It might seem as though this supports only <code>https://www.example.com</code> and <code>app://open.my.app</code>. However, it actually supports:</p>
<ul>
<li><code>https://www.example.com</code></li>
<li><code>app://open.my.app</code></li>
<li><code>app://www.example.com</code></li>
<li><code>https://open.my.app</code></li>
</ul>
<p><strong>Using Dumpsys:</strong></p>
<p>Use <a href="../0x08-Testing-Tools/#adb">adb</a> to run the following command that will show all schemes:</p>
<div class="highlight"><pre><span></span><code>adb shell dumpsys package com.example.package
</code></pre></div>
<p><strong>Using Android "App Link Verification" Tester:</strong></p>
<p>Use the <a href="https://github.com/inesmartins/Android-App-Link-Verification-Tester">Android "App Link Verification" Tester</a> script to list all deep links (<code>list-all</code>) or only app links (<code>list-applinks</code>):</p>
<div class="highlight"><pre><span></span><code>python3 deeplink_analyser.py -op list-all -apk ~/Downloads/example.apk

.MainActivity

app://open.my.app
app://www.example.com
https://open.my.app
https://www.example.com
</code></pre></div>
<h4 id="check-for-correct-website-association">Check for Correct Website Association<a class="headerlink" href="#check-for-correct-website-association" title="Permanent link">&para;</a></h4>
<p>Even if deep links contain the <code>android:autoVerify="true"</code> attribute, they must be <em>actually</em> verified in order to be considered App Links. You should test for any possible misconfigurations that might prevent full verification.</p>
<h5 id="automatic-verification">Automatic Verification<a class="headerlink" href="#automatic-verification" title="Permanent link">&para;</a></h5>
<p>Use the <a href="https://github.com/inesmartins/Android-App-Link-Verification-Tester">Android "App Link Verification" Tester</a> script to get the verification status for all app links (<code>verify-applinks</code>). See an example <a href="https://github.com/inesmartins/Android-App-Link-Verification-Tester#use-an-apk-to-check-for-dals-for-all-app-links">here</a>.</p>
<p><strong>Only on Android 12 (API level 31) or higher:</strong></p>
<p>You can use <a href="../0x08-Testing-Tools/#adb">adb</a> to test the verification logic regardless of whether the app targets Android 12 (API level 31) or not. This feature allows you to:</p>
<ul>
<li><a href="https://developer.android.com/training/app-links/verify-site-associations#manual-verification">invoke the verification process manually</a>.</li>
<li><a href="https://developer.android.com/training/app-links/verify-site-associations#reset-state">reset the state of the target app's Android App Links on your device</a>.</li>
<li><a href="https://developer.android.com/training/app-links/verify-site-associations#invoke-domain-verification">invoke the domain verification process</a>.</li>
</ul>
<p>You can also <a href="https://developer.android.com/training/app-links/verify-site-associations#review-results">review the verification results</a>. For example:</p>
<div class="highlight"><pre><span></span><code>adb shell pm get-app-links com.example.package

com.example.package:
    ID: <span class="m">01234567</span>-89ab-cdef-0123-456789abcdef
    Signatures: <span class="o">[</span>***<span class="o">]</span>
    Domain verification state:
      example.com: verified
      sub.example.com: legacy_failure
      example.net: verified
      example.org: <span class="m">1026</span>
</code></pre></div>
<blockquote>
<p>The same information can be found by running <code>adb shell dumpsys package com.example.package</code> (only on Android 12 (API level 31) or higher).</p>
</blockquote>
<h5 id="manual-verification">Manual Verification<a class="headerlink" href="#manual-verification" title="Permanent link">&para;</a></h5>
<p>This section details a few, of potentially many, reasons why the verification process failed or was not actually triggered. See more information in the <a href="https://developer.android.com/training/app-links/verify-site-associations#fix-errors">Android Developers Documentation</a> and in the white paper <a href="https://people.cs.vt.edu/gangwang/deep17.pdf">"Measuring the Insecurity of Mobile Deep Links of Android"</a>.</p>
<p><strong>Check the <a href="https://developers.google.com/digital-asset-links/v1/getting-started" title="Digital Asset Link">Digital Asset Links file</a>:</strong></p>
<ul>
<li>Check for <strong>missing</strong> Digital Asset Links file:</li>
<li>try to find it in the domain's <code>/.well-known/</code> path. Example: <code>https://www.example.com/.well-known/assetlinks.json</code></li>
<li>or try <code>https://digitalassetlinks.googleapis.com/v1/statements:list?source.web.site=www.example.com</code></li>
<li>Check for valid Digital Asset Links file <strong>served via HTTP</strong>.</li>
<li>Check for <strong>invalid</strong> Digital Asset Links files served via HTTPS. For example:</li>
<li>the file contains invalid JSON.</li>
<li>the file doesn't include the target app's package.</li>
</ul>
<p><strong>Check for Redirects:</strong></p>
<p>To enhance the app security, the system <a href="https://developer.android.com/training/app-links/verify-site-associations#fix-errors">doesn't verify any Android App Links</a> for an app if the server sets a redirect such as <code>http://example.com</code> to <code>https://example.com</code> or <code>example.com</code> to <code>www.example.com</code>.</p>
<p><strong>Check for Subdomains:</strong></p>
<p>If an intent filter lists multiple hosts with different subdomains, there must be a valid Digital Asset Links file on each domain. For example, the following intent filter includes <code>www.example.com</code> and <code>mobile.example.com</code> as accepted intent URL hosts.</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;application&gt;</span>
  <span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">”MainActivity”</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter</span> <span class="na">android:autoVerify=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.action.VIEW&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.category.DEFAULT&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.category.BROWSABLE&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">&quot;https&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">&quot;https&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;data</span> <span class="na">android:host=</span><span class="s">&quot;www.example.com&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;data</span> <span class="na">android:host=</span><span class="s">&quot;mobile.example.com&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
  <span class="nt">&lt;/activity&gt;</span>
<span class="nt">&lt;/application&gt;</span>
</code></pre></div>
<p>In order for the deep links to correctly register, a valid Digital Asset Links file must be published at both <code>https://www.example.com/.well-known/assetlinks.json</code> and <code>https://mobile.example.com/.well-known/assetlinks.json</code>.</p>
<p><strong>Check for Wildcards:</strong></p>
<p>If the hostname includes a wildcard (such as <code>*.example.com</code>), you should be able to find a valid Digital Asset Links file at the root hostname: <code>https://example.com/.well-known/assetlinks.json</code>.</p>
<h4 id="check-the-handler-method">Check the Handler Method<a class="headerlink" href="#check-the-handler-method" title="Permanent link">&para;</a></h4>
<p>Even if the deep link is correctly verified, the logic of the handler method should be carefully analyzed. Pay special attention to <strong>deep links being used to transmit data</strong> (which is controlled externally by the user or any other app).</p>
<p>First, obtain the name of the Activity from the Android Manifest <code>&lt;activity&gt;</code> element which defines the target <code>&lt;intent-filter&gt;</code> and search for usage of <a href="https://developer.android.com/reference/android/content/Intent#getIntent(java.lang.String)" title="getIntent()"><code>getIntent</code></a> and <a href="https://developer.android.com/reference/android/content/Intent#getData%28%29" title="getData()"><code>getData</code></a>. This general approach of locating these methods can be used across most applications when performing reverse engineering and is key when trying to understand how the application uses deep links and handles any externally provided input data and if it could be subject to any kind of abuse.</p>
<p>The following example is a snippet from an exemplary Kotlin app <a href="../0x05c-Reverse-Engineering-and-Tampering/#decompiling-java-code">decompiled with jadx</a>. From the <a href="#enumerate-deep-links">static analysis</a> we know that it supports the deep link <code>deeplinkdemo://load.html/</code> as part of <code>com.mstg.deeplinkdemo.WebViewActivity</code>.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// snippet edited for simplicity</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebViewActivity</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AppCompatActivity</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ActivityWebViewBinding</span><span class="w"> </span><span class="n">binding</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span><span class="w"> </span><span class="n">savedInstanceState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Uri</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIntent</span><span class="p">().</span><span class="na">getData</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">getQueryParameter</span><span class="p">(</span><span class="s">&quot;html&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Uri</span><span class="w"> </span><span class="n">data2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIntent</span><span class="p">().</span><span class="na">getData</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">deeplink_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">data2</span><span class="p">.</span><span class="na">getQueryParameter</span><span class="p">(</span><span class="s">&quot;url&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">View</span><span class="w"> </span><span class="n">findViewById</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">webView</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">findViewById</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">WebView</span><span class="w"> </span><span class="n">wv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WebView</span><span class="p">)</span><span class="w"> </span><span class="n">findViewById</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">wv</span><span class="p">.</span><span class="na">getSettings</span><span class="p">().</span><span class="na">setJavaScriptEnabled</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deeplink_url</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">wv</span><span class="p">.</span><span class="na">loadUrl</span><span class="p">(</span><span class="n">deeplink_url</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">...</span><span class="w"></span>
</code></pre></div>
<p>You can simply follow the <code>deeplink_url</code> String variable and see the result from the <code>wv.loadUrl</code> call. This means the attacker has full control of the URL being loaded to the WebView (as shown above has <a href="#testing-javascript-execution-in-webviews-mstg-platform-5">JavaScript enabled</a>.</p>
<p>The same WebView might be also rendering an attacker controlled parameter. In that case, the following deep link payload would trigger <a href="../0x04h-Testing-Code-Quality/#cross-site-scripting-flaws-mstg-platform-2">Reflected Cross-Site Scripting (XSS)</a> within the context of the WebView:</p>
<div class="highlight"><pre><span></span><code>deeplinkdemo://load.html?attacker_controlled=&lt;svg onload=alert(1)&gt;
</code></pre></div>
<p>But there are many other possibilities. Be sure to check the following sections to learn more about what to expect and how to test different scenarios:</p>
<ul>
<li><a href="../0x04h-Testing-Code-Quality/#cross-site-scripting-flaws-mstg-platform-2">"Cross-Site Scripting Flaws (MSTG-PLATFORM-2)"</a>.</li>
<li><a href="../0x04h-Testing-Code-Quality/#injection-flaws-mstg-arch-2-and-mstg-platform-2">"Injection Flaws (MSTG-ARCH-2 and MSTG-PLATFORM-2)"</a>.</li>
<li><a href="#testing-object-persistence-mstg-platform-8">"Testing Object Persistence (MSTG-PLATFORM-8)"</a>.</li>
<li><a href="#testing-for-url-loading-in-webviews-mstg-platform-2">"Testing for URL Loading in WebViews (MSTG-PLATFORM-2)"</a></li>
<li><a href="#testing-javascript-execution-in-webviews-mstg-platform-5">"Testing JavaScript Execution in WebViews (MSTG-PLATFORM-5)"</a></li>
<li><a href="#testing-webview-protocol-handlers-mstg-platform-6">"Testing WebView Protocol Handlers (MSTG-PLATFORM-6)"</a></li>
</ul>
<p>In addition, we recommend to search and read public reports (search term: <code>"deep link*"|"deeplink*" site:https://hackerone.com/reports/</code>). For example:</p>
<ul>
<li><a href="https://hackerone.com/reports/1372667">"[HackerOne#1372667] Able to steal bearer token from deep link"</a></li>
<li><a href="https://hackerone.com/reports/401793">"[HackerOne#401793] Insecure deeplink leads to sensitive information disclosure"</a></li>
<li><a href="https://hackerone.com/reports/583987">"[HackerOne#583987] Android app deeplink leads to CSRF in follow action"</a></li>
<li><a href="https://hackerone.com/reports/637194">"[HackerOne#637194] Bypass of biometrics security functionality is possible in Android application"</a></li>
<li><a href="https://hackerone.com/reports/341908">"[HackerOne#341908] XSS via Direct Message deeplinks"</a></li>
</ul>
<h3 id="dynamic-analysis_3">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_3" title="Permanent link">&para;</a></h3>
<p>Here you will use the list of deep links from the static analysis to iterate and determine each handler method and the processed data, if any. You will first start a <a href="../0x08-Testing-Tools/#frida">Frida</a> hook and then begin invoking the deep links.</p>
<p>The following example assumes a target app that accepts this deep link: <code>deeplinkdemo://load.html</code>. However, we don't know the corresponding handler method yet, nor the parameters it potentially accepts.</p>
<p><strong>[Step 1] Frida Hooking:</strong></p>
<p>You can use the script <a href="https://codeshare.frida.re/@leolashkevych/android-deep-link-observer/">"Android Deep Link Observer"</a> from <a href="../0x08-Testing-Tools/#frida-codeshare">Frida CodeShare</a> to monitor all invoked deep links triggering a call to <code>Intent.getData</code>. You can also use the script as a base to include your own modifications depending on the use case at hand. In this case we <a href="https://github.com/FrenchYeti/frida-trick/blob/master/README.md">included the stack trace</a> in the script since we are interested in the method which calls <code>Intent.getData</code>.</p>
<p><strong>[Step 2] Invoking Deep Links:</strong></p>
<p>Now you can invoke any of the deep links using <a href="../0x08-Testing-Tools/#adb">adb</a> and the <a href="https://developer.android.com/training/app-links/deep-linking#testing-filters" title="Activity Manager">Activity Manager (am)</a> which will send intents within the Android device. For example:</p>
<div class="highlight"><pre><span></span><code>adb shell am start -W -a android.intent.action.VIEW -d <span class="s2">&quot;deeplinkdemo://load.html/?message=ok#part1&quot;</span>

Starting: Intent <span class="o">{</span> <span class="nv">act</span><span class="o">=</span>android.intent.action.VIEW <span class="nv">dat</span><span class="o">=</span>deeplinkdemo://load.html/?message<span class="o">=</span>ok <span class="o">}</span>
Status: ok
LaunchState: WARM
Activity: com.mstg.deeplinkdemo/.WebViewActivity
TotalTime: <span class="m">210</span>
WaitTime: <span class="m">217</span>
Complete
</code></pre></div>
<blockquote>
<p>This might trigger the disambiguation dialog when using the "http/https" schema or if other installed apps support the same custom URL schema. You can include the package name to make it an explicit intent.</p>
</blockquote>
<p>This invocation will log the following:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>*<span class="o">]</span> Intent.getData<span class="o">()</span> was called
<span class="o">[</span>*<span class="o">]</span> Activity: com.mstg.deeplinkdemo.WebViewActivity
<span class="o">[</span>*<span class="o">]</span> Action: android.intent.action.VIEW

<span class="o">[</span>*<span class="o">]</span> Data
- Scheme: deeplinkdemo://
- Host: /load.html
- Params: <span class="nv">message</span><span class="o">=</span>ok
- Fragment: part1

<span class="o">[</span>*<span class="o">]</span> Stacktrace:

android.content.Intent.getData<span class="o">(</span>Intent.java<span class="o">)</span>
com.mstg.deeplinkdemo.WebViewActivity.onCreate<span class="o">(</span>WebViewActivity.kt<span class="o">)</span>
android.app.Activity.performCreate<span class="o">(</span>Activity.java<span class="o">)</span>
...
com.android.internal.os.ZygoteInit.main<span class="o">(</span>ZygoteInit.java<span class="o">)</span>
</code></pre></div>
<p>In this case we've crafted the deep link including arbitrary parameters (<code>?message=ok</code>) and fragment (<code>#part1</code>). We still don't know if they are being used. The information above reveals useful information that you can use now to reverse engineer the app. See the section <a href="#check-the-handler-method">"Check the Handler Method"</a> to learn about things you should consider.</p>
<ul>
<li>File: <code>WebViewActivity.kt</code></li>
<li>Class: <code>com.mstg.deeplinkdemo.WebViewActivity</code></li>
<li>Method: <code>onCreate</code></li>
</ul>
<blockquote>
<p>Sometimes you can even take advantage of other applications that you know interact with your target app. You can reverse engineer the app, (e.g. to extract all strings and filter those which include the target deep links, <code>deeplinkdemo:///load.html</code> in the previous case), or use them as triggers, while hooking the app as previously discussed.</p>
</blockquote>
<h2 id="testing-for-sensitive-functionality-exposure-through-ipc-mstg-platform-4">Testing for Sensitive Functionality Exposure Through IPC (MSTG-PLATFORM-4)<a class="headerlink" href="#testing-for-sensitive-functionality-exposure-through-ipc-mstg-platform-4" title="Permanent link">&para;</a></h2>
<h3 id="overview_5">Overview<a class="headerlink" href="#overview_5" title="Permanent link">&para;</a></h3>
<p>During implementation of a mobile application, developers may apply traditional techniques for IPC (such as using shared files or network sockets). The IPC system functionality offered by mobile application platforms should be used because it is much more mature than traditional techniques. Using IPC mechanisms with no security in mind may cause the application to leak or expose sensitive data.</p>
<p>The following is a list of Android IPC Mechanisms that may expose sensitive data:</p>
<ul>
<li><a href="https://developer.android.com/reference/android/os/Binder.html" title="IPCBinder">Binders</a></li>
<li><a href="https://developer.android.com/guide/components/services.html" title="IPCServices">Services</a></li>
<li><a href="https://developer.android.com/guide/components/bound-services.html" title="BoundServices">Bound Services</a></li>
<li><a href="https://developer.android.com/guide/components/aidl.html" title="AIDL">AIDL</a></li>
<li><a href="https://developer.android.com/reference/android/content/Intent.html" title="IPCIntent">Intents</a></li>
<li><a href="https://developer.android.com/reference/android/content/ContentProvider.html" title="IPCContentProviders">Content Providers</a></li>
</ul>
<h3 id="static-analysis_4">Static Analysis<a class="headerlink" href="#static-analysis_4" title="Permanent link">&para;</a></h3>
<p>We start by looking at the AndroidManifest.xml, where all activities, services, and content providers included in the source code must be declared (otherwise the system won't recognize them and they won't run). Broadcast receivers can be declared in the manifest or created dynamically. You will want to identify elements such as</p>
<ul>
<li><a href="https://developer.android.com/guide/topics/manifest/intent-filter-element.html" title="IntentFilterElement"><code>&lt;intent-filter&gt;</code></a></li>
<li><a href="https://developer.android.com/guide/topics/manifest/service-element.html" title="ServiceElement"><code>&lt;service&gt;</code></a></li>
<li><a href="https://developer.android.com/guide/topics/manifest/provider-element.html" title="ProviderElement"><code>&lt;provider&gt;</code></a></li>
<li><a href="https://developer.android.com/guide/topics/manifest/receiver-element.html" title="ReceiverElement"><code>&lt;receiver&gt;</code></a></li>
</ul>
<p>An "exported" activity, service, or content can be accessed by other apps. There are two common ways to designate a component as exported. The obvious one is setting the export tag to true <code>android:exported="true"</code>. The second way involves defining an <code>&lt;intent-filter&gt;</code> within the component element (<code>&lt;activity&gt;</code>, <code>&lt;service&gt;</code>, <code>&lt;receiver&gt;</code>). When this is done, the export tag is automatically set to "true". To prevent all other Android apps from interacting with the IPC component element, be sure that the <code>android:exported="true"</code> value and an <code>&lt;intent-filter&gt;</code> aren't in their <code>AndroidManifest.xml</code> files unless this is necessary.</p>
<p>Remember that using the permission tag (<code>android:permission</code>) will also limit other applications' access to a component. If your IPC is intended to be accessible to other applications, you can apply a security policy with the <code>&lt;permission&gt;</code> element and set a proper <code>android:protectionLevel</code>. When <code>android:permission</code> is used in a service declaration, other applications must declare a corresponding <code>&lt;uses-permission&gt;</code> element in their own manifest to start, stop, or bind to the service.</p>
<p>For more information about the content providers, please refer to the test case "Testing Whether Stored Sensitive Data Is Exposed via IPC Mechanisms" in chapter "Testing Data Storage".</p>
<p>Once you identify a list of IPC mechanisms, review the source code to see whether sensitive data is leaked when the mechanisms are used. For example, content providers can be used to access database information, and services can be probed to see if they return data. Broadcast receivers can leak sensitive information if probed or sniffed.</p>
<p>In the following, we use two example apps and give examples of identifying vulnerable IPC components:</p>
<ul>
<li><a href="https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk" title="Sieve: Vulnerable Password Manager">"Sieve"</a></li>
<li><a href="https://github.com/dineshshetty/Android-InsecureBankv2" title="Android Insecure Bank V2">"Android Insecure Bank"</a></li>
</ul>
<h3 id="activities">Activities<a class="headerlink" href="#activities" title="Permanent link">&para;</a></h3>
<h4 id="inspect-the-androidmanifest">Inspect the AndroidManifest<a class="headerlink" href="#inspect-the-androidmanifest" title="Permanent link">&para;</a></h4>
<p>In the "Sieve" app, we find three exported activities, identified by <code>&lt;activity&gt;</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;activity</span> <span class="na">android:excludeFromRecents=</span><span class="s">&quot;true&quot;</span> <span class="na">android:label=</span><span class="s">&quot;@string/app_name&quot;</span> <span class="na">android:launchMode=</span><span class="s">&quot;singleTask&quot;</span> <span class="na">android:name=</span><span class="s">&quot;.MainLoginActivity&quot;</span> <span class="na">android:windowSoftInputMode=</span><span class="s">&quot;adjustResize|stateVisible&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.action.MAIN&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.category.LAUNCHER&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/activity&gt;</span>
<span class="nt">&lt;activity</span> <span class="na">android:clearTaskOnLaunch=</span><span class="s">&quot;true&quot;</span> <span class="na">android:excludeFromRecents=</span><span class="s">&quot;true&quot;</span> <span class="na">android:exported=</span><span class="s">&quot;true&quot;</span> <span class="na">android:finishOnTaskLaunch=</span><span class="s">&quot;true&quot;</span> <span class="na">android:label=</span><span class="s">&quot;@string/title_activity_file_select&quot;</span> <span class="na">android:name=</span><span class="s">&quot;.FileSelectActivity&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;activity</span> <span class="na">android:clearTaskOnLaunch=</span><span class="s">&quot;true&quot;</span> <span class="na">android:excludeFromRecents=</span><span class="s">&quot;true&quot;</span> <span class="na">android:exported=</span><span class="s">&quot;true&quot;</span> <span class="na">android:finishOnTaskLaunch=</span><span class="s">&quot;true&quot;</span> <span class="na">android:label=</span><span class="s">&quot;@string/title_activity_pwlist&quot;</span> <span class="na">android:name=</span><span class="s">&quot;.PWList&quot;</span> <span class="nt">/&gt;</span>
</code></pre></div>
<h4 id="inspect-the-source-code">Inspect the source code<a class="headerlink" href="#inspect-the-source-code" title="Permanent link">&para;</a></h4>
<p>By inspecting the <code>PWList.java</code> activity, we see that it offers options to list all keys, add, delete, etc. If we invoke it directly, we will be able to bypass the LoginActivity. More on this can be found in the dynamic analysis below.</p>
<h3 id="services">Services<a class="headerlink" href="#services" title="Permanent link">&para;</a></h3>
<h4 id="inspect-the-androidmanifest_1">Inspect the AndroidManifest<a class="headerlink" href="#inspect-the-androidmanifest_1" title="Permanent link">&para;</a></h4>
<p>In the "Sieve" app, we find two exported services, identified by <code>&lt;service&gt;</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;service</span> <span class="na">android:exported=</span><span class="s">&quot;true&quot;</span> <span class="na">android:name=</span><span class="s">&quot;.AuthService&quot;</span> <span class="na">android:process=</span><span class="s">&quot;:remote&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;service</span> <span class="na">android:exported=</span><span class="s">&quot;true&quot;</span> <span class="na">android:name=</span><span class="s">&quot;.CryptoService&quot;</span> <span class="na">android:process=</span><span class="s">&quot;:remote&quot;</span> <span class="nt">/&gt;</span>
</code></pre></div>
<h4 id="inspect-the-source-code_1">Inspect the source code<a class="headerlink" href="#inspect-the-source-code_1" title="Permanent link">&para;</a></h4>
<p>Check the source code for the class <code>android.app.Service</code>:</p>
<p>By reversing the target application, we can see that the service <code>AuthService</code> provides functionality for changing the password and PIN-protecting the target app.</p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleMessage</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">AuthService</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">responseHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">replyTo</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">Bundle</span><span class="w"> </span><span class="n">returnBundle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">obj</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">responseCode</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">returnVal</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">what</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="p">...</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="n">AuthService</span><span class="p">.</span><span class="na">MSG_SET</span><span class="w"> </span><span class="cm">/*6345*/</span><span class="p">:</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">arg1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AuthService</span><span class="p">.</span><span class="na">TYPE_KEY</span><span class="p">)</span><span class="w"> </span><span class="cm">/*7452*/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AuthService</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">setKey</span><span class="p">(</span><span class="n">returnBundle</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;com.mwr.example.sieve.PASSWORD&quot;</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="n">returnVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="n">returnVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">arg1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AuthService</span><span class="p">.</span><span class="na">TYPE_PIN</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">responseCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">41</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AuthService</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">setPin</span><span class="p">(</span><span class="n">returnBundle</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;com.mwr.example.sieve.PIN&quot;</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="n">returnVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="n">returnVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">sendUnrecognisedMessage</span><span class="p">();</span><span class="w"></span>
<span class="w">                        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">           </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h4 id="broadcast-receivers">Broadcast Receivers<a class="headerlink" href="#broadcast-receivers" title="Permanent link">&para;</a></h4>
<h4 id="inspect-the-androidmanifest_2">Inspect the AndroidManifest<a class="headerlink" href="#inspect-the-androidmanifest_2" title="Permanent link">&para;</a></h4>
<p>In the "Android Insecure Bank" app, we find a broadcast receiver in the manifest, identified by <code>&lt;receiver&gt;</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;receiver</span> <span class="na">android:exported=</span><span class="s">&quot;true&quot;</span> <span class="na">android:name=</span><span class="s">&quot;com.android.insecurebankv2.MyBroadCastReceiver&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;theBroadcast&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/receiver&gt;</span>
</code></pre></div>
<h4 id="inspect-the-source-code_2">Inspect the source code<a class="headerlink" href="#inspect-the-source-code_2" title="Permanent link">&para;</a></h4>
<p>Search the source code for strings like <code>sendBroadcast</code>, <code>sendOrderedBroadcast</code>, and <code>sendStickyBroadcast</code>. Make sure that the application doesn't send any sensitive data.</p>
<p>If an Intent is broadcasted and received within the application only, <code>LocalBroadcastManager</code> can be used to prevent other apps from receiving the broadcast message. This reduces the risk of leaking sensitive information.</p>
<p>To understand more about what the receiver is intended to do, we have to go deeper in our static analysis and search for usage of the class <code>android.content.BroadcastReceiver</code> and the <code>Context.registerReceiver</code> method, which is used to dynamically create receivers.</p>
<p>The following extract of the target application's source code shows that the broadcast receiver triggers transmission of an SMS message containing the user's decrypted password.</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyBroadCastReceiver</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">String</span><span class="w"> </span><span class="n">usernameBase64ByteString</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">MYPREFS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mySharedPreferences&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onReceive</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// TODO Auto-generated method stub</span><span class="w"></span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">phn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getStringExtra</span><span class="p">(</span><span class="s">&quot;phonenumber&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">newpass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getStringExtra</span><span class="p">(</span><span class="s">&quot;newpass&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">phn</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">SharedPreferences</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getSharedPreferences</span><span class="p">(</span><span class="n">MYPREFS</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">MODE_WORLD_READABLE</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;EncryptedUsername&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">usernameBase64Byte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decode</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">usernameBase64ByteString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">usernameBase64Byte</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UTF-8&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;superSecurePassword&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">CryptoClass</span><span class="w"> </span><span class="n">crypt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CryptoClass</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">decryptedPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crypt</span><span class="p">.</span><span class="na">aesDeccryptedString</span><span class="p">(</span><span class="n">password</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">textPhoneno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phn</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">textMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Updated Password from: &quot;</span><span class="o">+</span><span class="n">decryptedPassword</span><span class="o">+</span><span class="s">&quot; to: &quot;</span><span class="o">+</span><span class="n">newpass</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">SmsManager</span><span class="w"> </span><span class="n">smsManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SmsManager</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;For the changepassword - phonenumber: &quot;</span><span class="o">+</span><span class="n">textPhoneno</span><span class="o">+</span><span class="s">&quot; password is: &quot;</span><span class="o">+</span><span class="n">textMessage</span><span class="p">);</span><span class="w"></span>
<span class="n">smsManager</span><span class="p">.</span><span class="na">sendTextMessage</span><span class="p">(</span><span class="n">textPhoneno</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">textMessage</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>BroadcastReceivers should use the <code>android:permission</code> attribute;  otherwise, other applications can invoke them. You can use <code>Context.sendBroadcast(intent, receiverPermission);</code> to specify permissions a receiver must have to <a href="https://developer.android.com/reference/android/content/Context#sendBroadcast%28android.content.Intent,%20java.lang.String%29" title="SendBroadcast">read the broadcast</a>. You can also set an explicit application package name that limits the components this Intent will resolve to. If left as the default value (null), all components in all applications will be considered. If non-null, the Intent can match only the components in the given application package.</p>
<h3 id="dynamic-analysis_4">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_4" title="Permanent link">&para;</a></h3>
<p>You can enumerate IPC components with <a href="../0x08-Testing-Tools/#mobsf" title="MobSF">MobSF</a>. To list all exported IPC components, upload the APK file and the components collection will be displayed in the following screen:</p>
<p><img src="../../assets/Images/Chapters/0x05h/MobSF_Show_Components.png" width="100%" /></p>
<h4 id="content-providers">Content Providers<a class="headerlink" href="#content-providers" title="Permanent link">&para;</a></h4>
<p>The "Sieve" application implements a vulnerable content provider. To list the content providers exported by the Sieve app, execute the following command:</p>
<div class="highlight"><pre><span></span><code>$ adb shell dumpsys package com.mwr.example.sieve <span class="p">|</span> grep -Po <span class="s2">&quot;Provider{[\w\d\s\./]+}&quot;</span> <span class="p">|</span> sort -u
Provider<span class="o">{</span>34a20d5 com.mwr.example.sieve/.FileBackupProvider<span class="o">}</span>
Provider<span class="o">{</span>64f10ea com.mwr.example.sieve/.DBContentProvider<span class="o">}</span>
</code></pre></div>
<p>Once identified, you can use <a href="../0x08-Testing-Tools/#jadx" title="jadx">jadx</a> to reverse engineer the app and analyze the source code of the exported content providers to identify potential vulnerabilities.</p>
<p>To identify the corresponding class of a content provider, use the following information:</p>
<ul>
<li>Package Name: <code>com.mwr.example.sieve</code>.</li>
<li>Content Provider Class Name: <code>DBContentProvider</code>.</li>
</ul>
<p>When analyzing the class <code>com.mwr.example.sieve.DBContentProvider</code>, you'll see that it contains several URIs:</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.mwr.example.sieve</span><span class="p">;</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DBContentProvider</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ContentProvider</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Uri</span><span class="w"> </span><span class="n">KEYS_URI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uri</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="s">&quot;content://com.mwr.example.sieve.DBContentProvider/Keys&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Uri</span><span class="w"> </span><span class="n">PASSWORDS_URI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uri</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="s">&quot;content://com.mwr.example.sieve.DBContentProvider/Passwords&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Use the following commands to call the content provider using the identified URIs:</p>
<div class="highlight"><pre><span></span><code>$ adb shell content query --uri content://com.mwr.example.sieve.DBContentProvider/Keys/
Row: <span class="m">0</span> <span class="nv">Password</span><span class="o">=</span>1234567890AZERTYUIOPazertyuiop, <span class="nv">pin</span><span class="o">=</span><span class="m">1234</span>

$ adb shell content query --uri content://com.mwr.example.sieve.DBContentProvider/Passwords/
Row: <span class="m">0</span> <span class="nv">_id</span><span class="o">=</span><span class="m">1</span>, <span class="nv">service</span><span class="o">=</span>test, <span class="nv">username</span><span class="o">=</span>test, <span class="nv">password</span><span class="o">=</span>BLOB, <span class="nv">email</span><span class="o">=</span>t@tedt.com
Row: <span class="m">1</span> <span class="nv">_id</span><span class="o">=</span><span class="m">2</span>, <span class="nv">service</span><span class="o">=</span>bank, <span class="nv">username</span><span class="o">=</span>owasp, <span class="nv">password</span><span class="o">=</span>BLOB, <span class="nv">email</span><span class="o">=</span>user@tedt.com

$ adb shell content query --uri content://com.mwr.example.sieve.DBContentProvider/Passwords/ --projection email:username:password --where <span class="s1">&#39;service=\&quot;bank\&quot;&#39;</span>
Row: <span class="m">0</span> <span class="nv">email</span><span class="o">=</span>user@tedt.com, <span class="nv">username</span><span class="o">=</span>owasp, <span class="nv">password</span><span class="o">=</span>BLOB
</code></pre></div>
<p>You are able now to retrieve all database entries (see all lines starting with "Row:" in the output).</p>
<h4 id="activities_1">Activities<a class="headerlink" href="#activities_1" title="Permanent link">&para;</a></h4>
<p>To list activities exported by an application, you can use the following command and focus on <code>activity</code> elements:</p>
<div class="highlight"><pre><span></span><code>$ aapt d xmltree sieve.apk AndroidManifest.xml
...
E: activity <span class="o">(</span><span class="nv">line</span><span class="o">=</span><span class="m">32</span><span class="o">)</span>
  A: android:label<span class="o">(</span>0x01010001<span class="o">)=</span>@0x7f05000f
  A: android:name<span class="o">(</span>0x01010003<span class="o">)=</span><span class="s2">&quot;.FileSelectActivity&quot;</span> <span class="o">(</span>Raw: <span class="s2">&quot;.FileSelectActivity&quot;</span><span class="o">)</span>
  A: android:exported<span class="o">(</span>0x01010010<span class="o">)=(</span><span class="nb">type</span> 0x12<span class="o">)</span>0xffffffff
  A: android:finishOnTaskLaunch<span class="o">(</span>0x01010014<span class="o">)=(</span><span class="nb">type</span> 0x12<span class="o">)</span>0xffffffff
  A: android:clearTaskOnLaunch<span class="o">(</span>0x01010015<span class="o">)=(</span><span class="nb">type</span> 0x12<span class="o">)</span>0xffffffff
  A: android:excludeFromRecents<span class="o">(</span>0x01010017<span class="o">)=(</span><span class="nb">type</span> 0x12<span class="o">)</span>0xffffffff
E: activity <span class="o">(</span><span class="nv">line</span><span class="o">=</span><span class="m">40</span><span class="o">)</span>
  A: android:label<span class="o">(</span>0x01010001<span class="o">)=</span>@0x7f050000
  A: android:name<span class="o">(</span>0x01010003<span class="o">)=</span><span class="s2">&quot;.MainLoginActivity&quot;</span> <span class="o">(</span>Raw: <span class="s2">&quot;.MainLoginActivity&quot;</span><span class="o">)</span>
  A: android:excludeFromRecents<span class="o">(</span>0x01010017<span class="o">)=(</span><span class="nb">type</span> 0x12<span class="o">)</span>0xffffffff
  A: android:launchMode<span class="o">(</span>0x0101001d<span class="o">)=(</span><span class="nb">type</span> 0x10<span class="o">)</span>0x2
  A: android:windowSoftInputMode<span class="o">(</span>0x0101022b<span class="o">)=(</span><span class="nb">type</span> 0x11<span class="o">)</span>0x14
  E: intent-filter <span class="o">(</span><span class="nv">line</span><span class="o">=</span><span class="m">46</span><span class="o">)</span>
    E: action <span class="o">(</span><span class="nv">line</span><span class="o">=</span><span class="m">47</span><span class="o">)</span>
      A: android:name<span class="o">(</span>0x01010003<span class="o">)=</span><span class="s2">&quot;android.intent.action.MAIN&quot;</span> <span class="o">(</span>Raw: <span class="s2">&quot;android.intent.action.MAIN&quot;</span><span class="o">)</span>
    E: category <span class="o">(</span><span class="nv">line</span><span class="o">=</span><span class="m">49</span><span class="o">)</span>
      A: android:name<span class="o">(</span>0x01010003<span class="o">)=</span><span class="s2">&quot;android.intent.category.LAUNCHER&quot;</span> <span class="o">(</span>Raw: <span class="s2">&quot;android.intent.category.LAUNCHER&quot;</span><span class="o">)</span>
E: activity <span class="o">(</span><span class="nv">line</span><span class="o">=</span><span class="m">52</span><span class="o">)</span>
  A: android:label<span class="o">(</span>0x01010001<span class="o">)=</span>@0x7f050009
  A: android:name<span class="o">(</span>0x01010003<span class="o">)=</span><span class="s2">&quot;.PWList&quot;</span> <span class="o">(</span>Raw: <span class="s2">&quot;.PWList&quot;</span><span class="o">)</span>
  A: android:exported<span class="o">(</span>0x01010010<span class="o">)=(</span><span class="nb">type</span> 0x12<span class="o">)</span>0xffffffff
  A: android:finishOnTaskLaunch<span class="o">(</span>0x01010014<span class="o">)=(</span><span class="nb">type</span> 0x12<span class="o">)</span>0xffffffff
  A: android:clearTaskOnLaunch<span class="o">(</span>0x01010015<span class="o">)=(</span><span class="nb">type</span> 0x12<span class="o">)</span>0xffffffff
  A: android:excludeFromRecents<span class="o">(</span>0x01010017<span class="o">)=(</span><span class="nb">type</span> 0x12<span class="o">)</span>0xffffffff
E: activity <span class="o">(</span><span class="nv">line</span><span class="o">=</span><span class="m">60</span><span class="o">)</span>
  A: android:label<span class="o">(</span>0x01010001<span class="o">)=</span>@0x7f05000a
  A: android:name<span class="o">(</span>0x01010003<span class="o">)=</span><span class="s2">&quot;.SettingsActivity&quot;</span> <span class="o">(</span>Raw: <span class="s2">&quot;.SettingsActivity&quot;</span><span class="o">)</span>
  A: android:finishOnTaskLaunch<span class="o">(</span>0x01010014<span class="o">)=(</span><span class="nb">type</span> 0x12<span class="o">)</span>0xffffffff
  A: android:clearTaskOnLaunch<span class="o">(</span>0x01010015<span class="o">)=(</span><span class="nb">type</span> 0x12<span class="o">)</span>0xffffffff
  A: android:excludeFromRecents<span class="o">(</span>0x01010017<span class="o">)=(</span><span class="nb">type</span> 0x12<span class="o">)</span>0xffffffff
...
</code></pre></div>
<p>You can identify an exported activity using one of the following properties:</p>
<ul>
<li>It have an <code>intent-filter</code> sub declaration.</li>
<li>It have the attribute <code>android:exported</code> to <code>0xffffffff</code>.</li>
</ul>
<p>You can also use <a href="../0x08-Testing-Tools/#jadx" title="jadx">jadx</a> to identify exported activities in the file <code>AndroidManifest.xml</code> using the criteria described above:</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="na">package=</span><span class="s">&quot;com.mwr.example.sieve&quot;</span><span class="nt">&gt;</span>
...
  <span class="cm">&lt;!-- This activity is exported via the attribute &quot;exported&quot; --&gt;</span>
  <span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">&quot;.FileSelectActivity&quot;</span> <span class="na">android:exported=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
   <span class="cm">&lt;!-- This activity is exported via the &quot;intent-filter&quot; declaration  --&gt;</span>
  <span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">&quot;.MainLoginActivity&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter&gt;</span>
      <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.action.MAIN&quot;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.category.LAUNCHER&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
  <span class="nt">&lt;/activity&gt;</span>
  <span class="cm">&lt;!-- This activity is exported via the attribute &quot;exported&quot; --&gt;</span>
  <span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">&quot;.PWList&quot;</span> <span class="na">android:exported=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
  <span class="cm">&lt;!-- Activities below are not exported --&gt;</span>
  <span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">&quot;.SettingsActivity&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">&quot;.AddEntryActivity&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">&quot;.ShortLoginActivity&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">&quot;.WelcomeActivity&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">&quot;.PINActivity&quot;</span> <span class="nt">/&gt;</span>
...
<span class="nt">&lt;/manifest&gt;</span>
</code></pre></div>
<p>Enumerating activities in the vulnerable password manager "Sieve" shows that the following activities are exported:</p>
<ul>
<li><code>.MainLoginActivity</code></li>
<li><code>.PWList</code></li>
<li><code>.FileSelectActivity</code></li>
</ul>
<p>Use the command below to launch an activity:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Start the activity without specifying an action or an category</span>
$ adb shell am start -n com.mwr.example.sieve/.PWList
Starting: Intent <span class="o">{</span> <span class="nv">cmp</span><span class="o">=</span>com.mwr.example.sieve/.PWList <span class="o">}</span>

<span class="c1"># Start the activity indicating an action (-a) and an category (-c)</span>
$ adb shell am start -n <span class="s2">&quot;com.mwr.example.sieve/.MainLoginActivity&quot;</span> -a android.intent.action.MAIN -c android.intent.category.LAUNCHER
Starting: Intent <span class="o">{</span> <span class="nv">act</span><span class="o">=</span>android.intent.action.MAIN <span class="nv">cat</span><span class="o">=[</span>android.intent.category.LAUNCHER<span class="o">]</span> <span class="nv">cmp</span><span class="o">=</span>com.mwr.example.sieve/.MainLoginActivity <span class="o">}</span>
</code></pre></div>
<p>Since the activity <code>.PWList</code> is called directly in this example, you can use it to bypass the login form protecting the password manager, and access the data contained within the password manager.</p>
<h4 id="services_1">Services<a class="headerlink" href="#services_1" title="Permanent link">&para;</a></h4>
<p>Services can be enumerated with the Drozer module <code>app.service.info</code>:</p>
<div class="highlight"><pre><span></span><code>dz&gt; run app.service.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
  com.mwr.example.sieve.AuthService
    Permission: null
  com.mwr.example.sieve.CryptoService
    Permission: null
</code></pre></div>
<p>To communicate with a service, you must first use static analysis to identify the required inputs.</p>
<p>Because this service is exported, you can use the module <code>app.service.send</code> to communicate with the service and change the password stored in the target application:</p>
<div class="highlight"><pre><span></span><code>dz&gt; run app.service.send com.mwr.example.sieve com.mwr.example.sieve.AuthService --msg <span class="m">6345</span> <span class="m">7452</span> <span class="m">1</span> --extra string com.mwr.example.sieve.PASSWORD <span class="s2">&quot;abcdabcdabcdabcd&quot;</span> --bundle-as-obj
Got a reply from com.mwr.example.sieve/com.mwr.example.sieve.AuthService:
  what: <span class="m">4</span>
  arg1: <span class="m">42</span>
  arg2: <span class="m">0</span>
  Empty
</code></pre></div>
<h4 id="broadcast-receivers_1">Broadcast Receivers<a class="headerlink" href="#broadcast-receivers_1" title="Permanent link">&para;</a></h4>
<p>To list broadcast receivers exported by an application, you can use the following command and focus on <code>receiver</code> elements:</p>
<div class="highlight"><pre><span></span><code>$ aapt d xmltree InsecureBankv2.apk AndroidManifest.xml
...
E: receiver <span class="o">(</span><span class="nv">line</span><span class="o">=</span><span class="m">88</span><span class="o">)</span>
  A: android:name<span class="o">(</span>0x01010003<span class="o">)=</span><span class="s2">&quot;com.android.insecurebankv2.MyBroadCastReceiver&quot;</span> <span class="o">(</span>Raw: <span class="s2">&quot;com.android.insecurebankv2.MyBroadCastReceiver&quot;</span><span class="o">)</span>
  A: android:exported<span class="o">(</span>0x01010010<span class="o">)=(</span><span class="nb">type</span> 0x12<span class="o">)</span>0xffffffff
  E: intent-filter <span class="o">(</span><span class="nv">line</span><span class="o">=</span><span class="m">91</span><span class="o">)</span>
    E: action <span class="o">(</span><span class="nv">line</span><span class="o">=</span><span class="m">92</span><span class="o">)</span>
      A: android:name<span class="o">(</span>0x01010003<span class="o">)=</span><span class="s2">&quot;theBroadcast&quot;</span> <span class="o">(</span>Raw: <span class="s2">&quot;theBroadcast&quot;</span><span class="o">)</span>
E: receiver <span class="o">(</span><span class="nv">line</span><span class="o">=</span><span class="m">119</span><span class="o">)</span>
  A: android:name<span class="o">(</span>0x01010003<span class="o">)=</span><span class="s2">&quot;com.google.android.gms.wallet.EnableWalletOptimizationReceiver&quot;</span> <span class="o">(</span>Raw: <span class="s2">&quot;com.google.android.gms.wallet.EnableWalletOptimizationReceiver&quot;</span><span class="o">)</span>
  A: android:exported<span class="o">(</span>0x01010010<span class="o">)=(</span><span class="nb">type</span> 0x12<span class="o">)</span>0x0
  E: intent-filter <span class="o">(</span><span class="nv">line</span><span class="o">=</span><span class="m">122</span><span class="o">)</span>
    E: action <span class="o">(</span><span class="nv">line</span><span class="o">=</span><span class="m">123</span><span class="o">)</span>
      A: android:name<span class="o">(</span>0x01010003<span class="o">)=</span><span class="s2">&quot;com.google.android.gms.wallet.ENABLE_WALLET_OPTIMIZATION&quot;</span> <span class="o">(</span>Raw: <span class="s2">&quot;com.google.android.gms.wallet.ENABLE_WALLET_OPTIMIZATION&quot;</span><span class="o">)</span>
...
</code></pre></div>
<p>You can identify an exported broadcast receiver using one of the following properties:</p>
<ul>
<li>It has an <code>intent-filter</code> sub declaration.</li>
<li>It has the attribute <code>android:exported</code> set to <code>0xffffffff</code>.</li>
</ul>
<p>You can also use <a href="../0x08-Testing-Tools/#jadx" title="jadx">jadx</a> to identify exported broadcast receivers in the file <code>AndroidManifest.xml</code> using the criteria described above:</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="na">package=</span><span class="s">&quot;com.android.insecurebankv2&quot;</span><span class="nt">&gt;</span>
...
  <span class="cm">&lt;!-- This broadcast receiver is exported via the attribute &quot;exported&quot; as well as the &quot;intent-filter&quot; declaration --&gt;</span>
  <span class="nt">&lt;receiver</span> <span class="na">android:name=</span><span class="s">&quot;com.android.insecurebankv2.MyBroadCastReceiver&quot;</span> <span class="na">android:exported=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter&gt;</span>
      <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;theBroadcast&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
  <span class="nt">&lt;/receiver&gt;</span>
  <span class="cm">&lt;!-- This broadcast receiver is NOT exported because the attribute &quot;exported&quot; is explicitly set to false --&gt;</span>
  <span class="nt">&lt;receiver</span> <span class="na">android:name=</span><span class="s">&quot;com.google.android.gms.wallet.EnableWalletOptimizationReceiver&quot;</span> <span class="na">android:exported=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter&gt;</span>
      <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;com.google.android.gms.wallet.ENABLE_WALLET_OPTIMIZATION&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
  <span class="nt">&lt;/receiver&gt;</span>
...
<span class="nt">&lt;/manifest&gt;</span>
</code></pre></div>
<p>The above example from the vulnerable banking application <a href="../0x08-Testing-Tools/#android" title="Vulnerable applications for Android">InsecureBankv2</a> shows that only the broadcast receiver named <code>com.android.insecurebankv2.MyBroadCastReceiver</code> is exported.</p>
<p>Now that you know that there is an exported broadcast receiver, you can dive deeper and reverse engineer the app using <a href="../0x08-Testing-Tools/#jadx" title="jadx">jadx</a>. This will allow you to analyze the source code searching for potential vulnerabilities that you could later try to exploit. The source code of the exported broadcast receiver is the following:</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.android.insecurebankv2</span><span class="p">;</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyBroadCastReceiver</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BroadcastReceiver</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">MYPREFS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mySharedPreferences&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">usernameBase64ByteString</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onReceive</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">intent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">phn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getStringExtra</span><span class="p">(</span><span class="s">&quot;phonenumber&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">newpass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">intent</span><span class="p">.</span><span class="na">getStringExtra</span><span class="p">(</span><span class="s">&quot;newpass&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">phn</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">SharedPreferences</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getSharedPreferences</span><span class="p">(</span><span class="s">&quot;mySharedPreferences&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="na">usernameBase64ByteString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">Base64</span><span class="p">.</span><span class="na">decode</span><span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;EncryptedUsername&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="kc">null</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;UTF-8&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">decryptedPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CryptoClass</span><span class="p">().</span><span class="na">aesDeccryptedString</span><span class="p">(</span><span class="n">settings</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;superSecurePassword&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="kc">null</span><span class="p">));</span><span class="w"></span>
<span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">textPhoneno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phn</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">textMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Updated Password from: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">decryptedPassword</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; to: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">newpass</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="n">SmsManager</span><span class="w"> </span><span class="n">smsManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SmsManager</span><span class="p">.</span><span class="na">getDefault</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;For the changepassword - phonenumber: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">textPhoneno</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; password is: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">textMessage</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">smsManager</span><span class="p">.</span><span class="na">sendTextMessage</span><span class="p">(</span><span class="n">textPhoneno</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">textMessage</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">PendingIntent</span><span class="p">)</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">PendingIntent</span><span class="p">)</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Phone number is null&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>As you can see in the source code, this broadcast receiver expects two parameters named <code>phonenumber</code> and <code>newpass</code>. With this information you can now try to exploit this broadcast receiver by sending events to it using custom values:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Send an event with the following properties:</span>
<span class="c1"># Action is set to &quot;theBroadcast&quot;</span>
<span class="c1"># Parameter &quot;phonenumber&quot; is set to the string &quot;07123456789&quot;</span>
<span class="c1"># Parameter &quot;newpass&quot; is set to the string &quot;12345&quot;</span>
$ adb shell am broadcast -a theBroadcast --es phonenumber <span class="s2">&quot;07123456789&quot;</span> --es newpass <span class="s2">&quot;12345&quot;</span>
Broadcasting: Intent <span class="o">{</span> <span class="nv">act</span><span class="o">=</span>theBroadcast <span class="nv">flg</span><span class="o">=</span>0x400000 <span class="o">(</span>has extras<span class="o">)</span> <span class="o">}</span>
Broadcast completed: <span class="nv">result</span><span class="o">=</span><span class="m">0</span>
</code></pre></div>
<p>This generates the following SMS:</p>
<div class="highlight"><pre><span></span><code>Updated Password from: SecretPassword@ to: <span class="m">12345</span>
</code></pre></div>
<h5 id="sniffing-intents">Sniffing Intents<a class="headerlink" href="#sniffing-intents" title="Permanent link">&para;</a></h5>
<p>If an Android application broadcasts intents without setting a required permission or specifying the destination package, the intents can be monitored by any application that runs on the device.</p>
<p>To register a broadcast receiver to sniff intents, use the Drozer module <code>app.broadcast.sniff</code> and specify the action to monitor with the <code>--action</code> parameter:</p>
<div class="highlight"><pre><span></span><code>dz&gt; run app.broadcast.sniff  --action theBroadcast
<span class="o">[</span>*<span class="o">]</span> Broadcast receiver registered to sniff matching intents
<span class="o">[</span>*<span class="o">]</span> Output is updated once a second. Press Control+C to exit.

Action: theBroadcast
Raw: Intent <span class="o">{</span> <span class="nv">act</span><span class="o">=</span>theBroadcast <span class="nv">flg</span><span class="o">=</span>0x10 <span class="o">(</span>has extras<span class="o">)</span> <span class="o">}</span>
Extra: <span class="nv">phonenumber</span><span class="o">=</span><span class="m">07123456789</span> <span class="o">(</span>java.lang.String<span class="o">)</span>
Extra: <span class="nv">newpass</span><span class="o">=</span><span class="m">12345</span> <span class="o">(</span>java.lang.String<span class="o">)</span><span class="sb">`</span>
</code></pre></div>
<p>You can also use the following command to sniff the intents. However, the content of the extras passed will not be displayed:</p>
<div class="highlight"><pre><span></span><code>$ adb shell dumpsys activity broadcasts <span class="p">|</span> grep <span class="s2">&quot;theBroadcast&quot;</span>
BroadcastRecord<span class="o">{</span>fc2f46f u0 theBroadcast<span class="o">}</span> to user <span class="m">0</span>
Intent <span class="o">{</span> <span class="nv">act</span><span class="o">=</span>theBroadcast <span class="nv">flg</span><span class="o">=</span>0x400010 <span class="o">(</span>has extras<span class="o">)</span> <span class="o">}</span>
BroadcastRecord<span class="o">{</span>7d4f24d u0 theBroadcast<span class="o">}</span> to user <span class="m">0</span>
Intent <span class="o">{</span> <span class="nv">act</span><span class="o">=</span>theBroadcast <span class="nv">flg</span><span class="o">=</span>0x400010 <span class="o">(</span>has extras<span class="o">)</span> <span class="o">}</span>
<span class="m">45</span>: <span class="nv">act</span><span class="o">=</span>theBroadcast <span class="nv">flg</span><span class="o">=</span>0x400010 <span class="o">(</span>has extras<span class="o">)</span>
<span class="m">46</span>: <span class="nv">act</span><span class="o">=</span>theBroadcast <span class="nv">flg</span><span class="o">=</span>0x400010 <span class="o">(</span>has extras<span class="o">)</span>
<span class="m">121</span>: <span class="nv">act</span><span class="o">=</span>theBroadcast <span class="nv">flg</span><span class="o">=</span>0x400010 <span class="o">(</span>has extras<span class="o">)</span>
<span class="m">144</span>: <span class="nv">act</span><span class="o">=</span>theBroadcast <span class="nv">flg</span><span class="o">=</span>0x400010 <span class="o">(</span>has extras<span class="o">)</span>
</code></pre></div>
<h2 id="testing-javascript-execution-in-webviews-mstg-platform-5">Testing JavaScript Execution in WebViews (MSTG-PLATFORM-5)<a class="headerlink" href="#testing-javascript-execution-in-webviews-mstg-platform-5" title="Permanent link">&para;</a></h2>
<h3 id="overview_6">Overview<a class="headerlink" href="#overview_6" title="Permanent link">&para;</a></h3>
<p>JavaScript can be injected into web applications via reflected, stored, or DOM-based Cross-Site Scripting (XSS). Mobile apps are executed in a sandboxed environment and don't have this vulnerability when implemented natively. Nevertheless, WebViews may be part of a native app to allow web page viewing. Every app has its own WebView cache, which isn't shared with the native Browser or other apps. On Android, WebViews use the WebKit rendering engine to display web pages, but the pages are stripped down to minimal functions, for example, pages don't have address bars. If the WebView implementation is too lax and allows usage of JavaScript, JavaScript can be used to attack the app and gain access to its data.</p>
<h3 id="static-analysis_5">Static Analysis<a class="headerlink" href="#static-analysis_5" title="Permanent link">&para;</a></h3>
<p>The source code must be checked for usage and implementations of the WebView class. To create and use a WebView, you must create an instance of the WebView class.</p>
<div class="highlight"><pre><span></span><code><span class="n">WebView</span><span class="w"> </span><span class="n">webview</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">WebView</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="n">setContentView</span><span class="p">(</span><span class="n">webview</span><span class="p">);</span><span class="w"></span>
<span class="n">webview</span><span class="p">.</span><span class="na">loadUrl</span><span class="p">(</span><span class="s">&quot;https://www.owasp.org/&quot;</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>Various settings can be applied to the WebView (activating/deactivating JavaScript is one example). JavaScript is disabled by default for WebViews and must be explicitly enabled. Look for the method <a href="https://developer.android.com/reference/android/webkit/WebSettings#setJavaScriptEnabled%28boolean%29" title="setJavaScriptEnabled in WebViews"><code>setJavaScriptEnabled</code></a> to check for JavaScript activation.</p>
<div class="highlight"><pre><span></span><code><span class="n">webview</span><span class="p">.</span><span class="na">getSettings</span><span class="p">().</span><span class="na">setJavaScriptEnabled</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>This allows the WebView to interpret JavaScript. It should be enabled only if necessary to reduce the attack surface to the app. If JavaScript is necessary, you should make sure that</p>
<ul>
<li>The communication to the endpoints consistently relies on HTTPS (or other protocols that allow encryption) to protect HTML and JavaScript from tampering during transmission.</li>
<li>JavaScript and HTML are loaded locally, from within the app data directory or from trusted web servers only.</li>
<li>The user cannot define which sources to load by means of loading different resources based on a user provided input.</li>
</ul>
<p>To remove all JavaScript source code and locally stored data, clear the WebView's cache with <a href="https://developer.android.com/reference/android/webkit/WebView#clearCache%28boolean%29" title="clearCache in WebViews"><code>clearCache</code></a> when the app closes.</p>
<p>Devices running platforms older than Android 4.4 (API level 19) use a version of WebKit that has several security issues. As a workaround, the app must confirm that WebView objects <a href="https://developer.android.com/training/articles/security-tips.html#WebView" title="WebView Best Practices">display only trusted content</a> if the app runs on these devices.</p>
<h3 id="dynamic-analysis_5">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_5" title="Permanent link">&para;</a></h3>
<p>Dynamic Analysis depends on operating conditions. There are several ways to inject JavaScript into an app's WebView:</p>
<ul>
<li>Stored Cross-Site Scripting vulnerabilities in an endpoint; the exploit will be sent to the mobile app's WebView when the user navigates to the vulnerable function.</li>
<li>Attacker takes a man-in-the-middle (MITM) position and tampers with the response by injecting JavaScript.</li>
<li>Malware tampering with local files that are loaded by the WebView.</li>
</ul>
<p>To address these attack vectors, check the following:</p>
<ul>
<li>All functions offered by the endpoint should be free of <a href="https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/02-Testing_for_Stored_Cross_Site_Scripting" title="Stored Cross-Site Scripting">stored XSS</a>.</li>
<li>
<p>Only files that are in the app data directory should be rendered in a WebView (see test case "Testing for Local File Inclusion in WebViews").</p>
</li>
<li>
<p>The HTTPS communication must be implemented according to best practices to avoid MITM attacks. This means:</p>
</li>
<li>all communication is encrypted via TLS (see test case "Testing for Unencrypted Sensitive Data on the Network"),</li>
<li>the certificate is checked properly (see test case "Testing Endpoint Identify Verification"), and/or</li>
<li>the certificate should be pinned (see "Testing Custom Certificate Stores and Certificate Pinning").</li>
</ul>
<h2 id="testing-webview-protocol-handlers-mstg-platform-6">Testing WebView Protocol Handlers (MSTG-PLATFORM-6)<a class="headerlink" href="#testing-webview-protocol-handlers-mstg-platform-6" title="Permanent link">&para;</a></h2>
<h3 id="overview_7">Overview<a class="headerlink" href="#overview_7" title="Permanent link">&para;</a></h3>
<p>Several default <a href="https://developer.android.com/guide/appendix/g-app-intents.html" title="Intent List">schemas</a> are available for Android URLs. They can be triggered within a WebView with the following:</p>
<ul>
<li>http(s)://</li>
<li>file://</li>
<li>tel://</li>
</ul>
<p>WebViews can load remote content from an endpoint, but they can also load local content from the app data directory or external storage. If the local content is loaded, the user shouldn't be able to influence the filename or the path used to load the file, and users shouldn't be able to edit the loaded file.</p>
<h3 id="static-analysis_6">Static Analysis<a class="headerlink" href="#static-analysis_6" title="Permanent link">&para;</a></h3>
<p>Check the source code for WebView usage. The following <a href="https://developer.android.com/reference/android/webkit/WebSettings.html" title="WebView Settings">WebView settings</a> control resource access:</p>
<ul>
<li><code>setAllowContentAccess</code>: Content URL access allows WebViews to load content from a content provider installed on the system, which is enabled by default .</li>
<li><code>setAllowFileAccess</code>: Enables and disables file access within a WebView. The default value is <code>true</code> when targeting Android 10 (API level 29) and below and <code>false</code> for Android 11 (API level 30) and above. Note that this enables and disables <a href="https://developer.android.com/reference/android/webkit/WebSettings.html#setAllowFileAccess%28boolean%29" title="File Access in WebView">file system access</a> only. Asset and resource access is unaffected and accessible via <code>file:///android_asset</code> and <code>file:///android_res</code>.</li>
<li><code>setAllowFileAccessFromFileURLs</code>: Does or does not allow JavaScript running in the context of a file scheme URL to access content from other file scheme URLs. The default value is <code>true</code> for Android 4.0.3 - 4.0.4 (API level 15) and below and <code>false</code> for Android 4.1 (API level 16) and above.</li>
<li><code>setAllowUniversalAccessFromFileURLs</code>: Does or does not allow JavaScript running in the context of a file scheme URL to access content from any origin. The default value is <code>true</code> for Android 4.0.3 - 4.0.4 (API level 15) and below and <code>false</code> for Android 4.1 (API level 16) and above.</li>
</ul>
<p>If one or more of the above methods is/are activated, you should determine whether the method(s) is/are really necessary for the app to work properly.</p>
<p>If a WebView instance can be identified, find out whether local files are loaded with the <a href="https://developer.android.com/reference/android/webkit/WebView.html#loadUrl%28java.lang.String%29" title="loadURL in WebView"><code>loadURL</code></a> method.</p>
<div class="highlight"><pre><span></span><code><span class="n">WebView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">WebView</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="n">webView</span><span class="p">.</span><span class="na">loadUrl</span><span class="p">(</span><span class="s">&quot;file:///android_asset/filename.html&quot;</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>The location from which the HTML file is loaded must be verified. If the file is loaded from external storage, for example, the file is readable and writable by everyone. This is considered a bad practice. Instead, the file should be placed in the app's assets directory.</p>
<div class="highlight"><pre><span></span><code><span class="n">webview</span><span class="p">.</span><span class="na">loadUrl</span><span class="p">(</span><span class="s">&quot;file:///&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="n">Environment</span><span class="p">.</span><span class="na">getExternalStorageDirectory</span><span class="p">().</span><span class="na">getPath</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="s">&quot;filename.html&quot;</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>The URL specified in <code>loadURL</code> should be checked for dynamic parameters that can be manipulated; their manipulation may lead to local file inclusion.</p>
<p>Use the following <a href="https://github.com/nowsecure/secure-mobile-development/blob/master/en/android/webview-best-practices.md#remediation" title="WebView best practices">code snippet and best practices</a> to deactivate protocol handlers, if applicable:</p>
<div class="highlight"><pre><span></span><code><span class="c1">//If attackers can inject script into a WebView, they could access local resources. This can be prevented by disabling local file system access, which is enabled by default. You can use the Android WebSettings class to disable local file system access via the public method `setAllowFileAccess`.</span><span class="w"></span>
<span class="n">webView</span><span class="p">.</span><span class="na">getSettings</span><span class="p">().</span><span class="na">setAllowFileAccess</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>

<span class="n">webView</span><span class="p">.</span><span class="na">getSettings</span><span class="p">().</span><span class="na">setAllowFileAccessFromFileURLs</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>

<span class="n">webView</span><span class="p">.</span><span class="na">getSettings</span><span class="p">().</span><span class="na">setAllowUniversalAccessFromFileURLs</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>

<span class="n">webView</span><span class="p">.</span><span class="na">getSettings</span><span class="p">().</span><span class="na">setAllowContentAccess</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<ul>
<li>Create a list that defines local and remote web pages and protocols that are allowed to be loaded.</li>
<li>Create checksums of the local HTML/JavaScript files and check them while the app is starting up. Minify JavaScript files to make them harder to read.</li>
</ul>
<h3 id="dynamic-analysis_6">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_6" title="Permanent link">&para;</a></h3>
<p>To identify the usage of protocol handlers, look for ways to trigger phone calls and ways to access files from the file system while you're using the app.</p>
<h2 id="determining-whether-java-objects-are-exposed-through-webviews-mstg-platform-7">Determining Whether Java Objects Are Exposed Through WebViews (MSTG-PLATFORM-7)<a class="headerlink" href="#determining-whether-java-objects-are-exposed-through-webviews-mstg-platform-7" title="Permanent link">&para;</a></h2>
<h3 id="overview_8">Overview<a class="headerlink" href="#overview_8" title="Permanent link">&para;</a></h3>
<p>Android offers a way for JavaScript executed in a WebView to call and use native functions of an Android app (annotated with <code>@JavascriptInterface</code>) by using the <a href="https://developer.android.com/reference/android/webkit/WebView.html#addJavascriptInterface%28java.lang.Object,%20java.lang.String%29" title="Method addJavascriptInterface()"><code>addJavascriptInterface</code></a> method. This is known as a <em>WebView JavaScript bridge</em> or <em>native bridge</em>.</p>
<p>Please note that <strong>when you use <code>addJavascriptInterface</code>, you're explicitly granting access to the registered JavaScript Interface object to all pages loaded within that WebView</strong>. This implies that, if the user navigates outside your app or domain, all other external pages will also have access to those JavaScript Interface objects which might present a potential security risk if any sensitive data is being exposed though those interfaces.</p>
<blockquote>
<p>Warning: Take extreme care with apps targeting Android versions below Android 4.2 (API level 17) as they are <a href="https://labs.mwrinfosecurity.com/blog/webview-addjavascriptinterface-remote-code-execution/" title="WebView addJavascriptInterface Remote Code Execution">vulnerable to a flaw</a> in the implementation of <code>addJavascriptInterface</code>: an attack that is abusing reflection, which leads to remote code execution when malicious JavaScript is injected into a WebView. This was due to all Java Object methods being accessible by default (instead of only those annotated).</p>
</blockquote>
<h3 id="static-analysis_7">Static Analysis<a class="headerlink" href="#static-analysis_7" title="Permanent link">&para;</a></h3>
<p>You need to determine whether the method <code>addJavascriptInterface</code> is used, how it is used, and whether an attacker can inject malicious JavaScript.</p>
<p>The following example shows how <code>addJavascriptInterface</code> is used to bridge a Java Object and JavaScript in a WebView:</p>
<div class="highlight"><pre><span></span><code><span class="n">WebView</span><span class="w"> </span><span class="n">webview</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">WebView</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="n">WebSettings</span><span class="w"> </span><span class="n">webSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">webview</span><span class="p">.</span><span class="na">getSettings</span><span class="p">();</span><span class="w"></span>
<span class="n">webSettings</span><span class="p">.</span><span class="na">setJavaScriptEnabled</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>

<span class="n">MSTG_ENV_008_JS_Interface</span><span class="w"> </span><span class="n">jsInterface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MSTG_ENV_008_JS_Interface</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"></span>

<span class="n">myWebView</span><span class="p">.</span><span class="na">addJavascriptInterface</span><span class="p">(</span><span class="n">jsInterface</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Android&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">myWebView</span><span class="p">.</span><span class="na">loadURL</span><span class="p">(</span><span class="s">&quot;http://example.com/file.html&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">setContentView</span><span class="p">(</span><span class="n">myWebView</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>In Android 4.2 (API level 17) and above, an annotation <code>@JavascriptInterface</code> explicitly allows JavaScript to access a Java method.</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MSTG_ENV_008_JS_Interface</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="n">Context</span><span class="w"> </span><span class="n">mContext</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="cm">/** Instantiate the interface and set the context */</span><span class="w"></span>
<span class="w">        </span><span class="n">MSTG_ENV_005_JS_Interface</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">mContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="nd">@JavascriptInterface</span><span class="w"></span>
<span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">returnString</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Secret String&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="cm">/** Show a toast from the web page */</span><span class="w"></span>
<span class="w">        </span><span class="nd">@JavascriptInterface</span><span class="w"></span>
<span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">showToast</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">toast</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Toast</span><span class="p">.</span><span class="na">makeText</span><span class="p">(</span><span class="n">mContext</span><span class="p">,</span><span class="w"> </span><span class="n">toast</span><span class="p">,</span><span class="w"> </span><span class="n">Toast</span><span class="p">.</span><span class="na">LENGTH_SHORT</span><span class="p">).</span><span class="na">show</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This is how you can call the method <code>returnString</code> from JavaScript, the string "Secret String" will be stored in the variable <code>result</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">Android</span><span class="p">.</span><span class="nx">returnString</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>With access to the JavaScript code, via, for example, stored XSS or a MITM attack, an attacker can directly call the exposed Java methods.</p>
<p>If <code>addJavascriptInterface</code> is necessary, take the following considerations:</p>
<ul>
<li>Only JavaScript provided with the APK should be allowed to use the bridges, e.g. by verifying the URL on each bridged Java method (via <code>WebView.getUrl</code>).</li>
<li>No JavaScript should be loaded from remote endpoints, e.g. by keeping page navigation within the app's domains and opening all other domains on the default browser (e.g. Chrome, Firefox).</li>
<li>If necessary for legacy reasons (e.g. having to support older devices), at least set the minimal API level to 17 in the manifest file of the app (<code>&lt;uses-sdk android:minSdkVersion="17" /&gt;</code>).</li>
</ul>
<h3 id="dynamic-analysis_7">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_7" title="Permanent link">&para;</a></h3>
<p>Dynamic analysis of the app can show you which HTML or JavaScript files are loaded and which vulnerabilities are present. The procedure for exploiting the vulnerability starts with producing a JavaScript payload and injecting it into the file that the app is requesting. The injection can be accomplished via a MITM attack or direct modification of the file if it is stored in external storage. The whole process can be accomplished via Drozer and weasel (MWR's advanced exploitation payload), which can install a full agent, injecting a limited agent into a running process or connecting a reverse shell as a Remote Access Tool (RAT).</p>
<p>A full description of the attack is included in the <a href="https://labs.mwrinfosecurity.com/blog/webview-addjavascriptinterface-remote-code-execution/" title="WebView addJavascriptInterface Remote Code Execution">blog article by MWR</a>.</p>
<h2 id="testing-object-persistence-mstg-platform-8">Testing Object Persistence (MSTG-PLATFORM-8)<a class="headerlink" href="#testing-object-persistence-mstg-platform-8" title="Permanent link">&para;</a></h2>
<h3 id="overview_9">Overview<a class="headerlink" href="#overview_9" title="Permanent link">&para;</a></h3>
<p>There are several ways to persist an object on Android:</p>
<h4 id="object-serialization">Object Serialization<a class="headerlink" href="#object-serialization" title="Permanent link">&para;</a></h4>
<p>An object and its data can be represented as a sequence of bytes. This is done in Java via <a href="https://developer.android.com/reference/java/io/Serializable.html" title="Serializable">object serialization</a>. Serialization is not inherently secure. It is just a binary format (or representation) for locally storing data in a .ser file. Encrypting and signing HMAC-serialized data is possible as long as the keys are stored safely. Deserializing an object requires a class of the same version as the class used to serialize the object. After classes have been changed, the <code>ObjectInputStream</code> can't create objects from older .ser files. The example below shows how to create a <code>Serializable</code> class by implementing the <code>Serializable</code> interface.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.Serializable</span><span class="p">;</span><span class="w"></span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Person</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">firstName</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">lastName</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">Person</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">firstName</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">lastName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">firstName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstName</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">lastName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lastName</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">//..</span><span class="w"></span>
<span class="w">  </span><span class="c1">//getters, setters, etc</span><span class="w"></span>
<span class="w">  </span><span class="c1">//..</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Now you can read/write the object with <code>ObjectInputStream</code>/<code>ObjectOutputStream</code> in another class.</p>
<h4 id="json">JSON<a class="headerlink" href="#json" title="Permanent link">&para;</a></h4>
<p>There are several ways to serialize the contents of an object to JSON. Android comes with the <code>JSONObject</code> and <code>JSONArray</code> classes. A wide variety of libraries, including <a href="https://github.com/google/gson" title="Google Gson">GSON</a>, <a href="https://github.com/FasterXML/jackson-core" title="Jackson core">Jackson</a>, <a href="https://github.com/square/moshi" title="Moshi">Moshi</a>, can also be used. The main differences between the libraries are whether they use reflection to compose the object, whether they support annotations, whether the create immutable objects, and the amount of memory they use. Note that almost all the JSON representations are String-based and therefore immutable. This means that any secret stored in JSON will be harder to remove from memory.
JSON itself can be stored anywhere, e.g., a (NoSQL) database or a file. You just need to make sure that any JSON that contains secrets has been appropriately protected (e.g., encrypted/HMACed). See the chapter "<a href="../0x05d-Testing-Data-Storage/">Data Storage on Android</a>" for more details. A simple example (from the GSON User Guide) of writing and reading JSON with GSON follows. In this example, the contents of an instance of the <code>BagOfPrimitives</code> is serialized into JSON:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">BagOfPrimitives</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">value1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">value2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;abc&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">transient</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">value3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">BagOfPrimitives</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// no-args constructor</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Serialization</span><span class="w"></span>
<span class="n">BagOfPrimitives</span><span class="w"> </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BagOfPrimitives</span><span class="p">();</span><span class="w"></span>
<span class="n">Gson</span><span class="w"> </span><span class="n">gson</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Gson</span><span class="p">();</span><span class="w"></span>
<span class="n">String</span><span class="w"> </span><span class="n">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gson</span><span class="p">.</span><span class="na">toJson</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span><span class="w">  </span>

<span class="c1">// ==&gt; json is {&quot;value1&quot;:1,&quot;value2&quot;:&quot;abc&quot;}</span><span class="w"></span>
</code></pre></div>
<h4 id="xml">XML<a class="headerlink" href="#xml" title="Permanent link">&para;</a></h4>
<p>There are several ways to serialize the contents of an object to XML and back. Android comes with the <code>XmlPullParser</code> interface which allows for easily maintainable XML parsing. There are two implementations within Android: <code>KXmlParser</code> and <code>ExpatPullParser</code>. The <a href="https://developer.android.com/training/basics/network-ops/xml#java" title="Instantiate the parser">Android Developer Guide</a> provides a great write-up on how to use them. Next, there are various alternatives, such as a <code>SAX</code> parser that comes with the Java runtime. For more information, see <a href="https://www.ibm.com/developerworks/opensource/library/x-android/index.html" title="Working with XML on Android on IBM Developer">a blogpost from ibm.com</a>.
Similarly to JSON, XML has the issue of working mostly String based, which means that String-type secrets will be harder to remove from memory. XML data can be stored anywhere (database, files), but do need additional protection in case of secrets or information that should not be changed. See the chapter "<a href="../0x05d-Testing-Data-Storage/">Data Storage on Android</a>" for more details. As stated earlier: the true danger in XML lies in the <a href="https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing" title="XML eXternal Entity attack (XXE)">XML eXternal Entity (XXE)</a> attack as it might allow for reading external data sources that are still accessible within the application.</p>
<h4 id="orm">ORM<a class="headerlink" href="#orm" title="Permanent link">&para;</a></h4>
<p>There are libraries that provide functionality for directly storing the contents of an object in a database and then instantiating the object with the database contents. This is called Object-Relational Mapping (ORM). Libraries that use the SQLite database include</p>
<ul>
<li><a href="http://ormlite.com/" title="OrmLite">OrmLite</a>,</li>
<li><a href="https://satyan.github.io/sugar/" title="Sugar ORM">SugarORM</a>,</li>
<li><a href="https://greenrobot.org/greendao/" title="GreenDAO">GreenDAO</a> and</li>
<li><a href="http://www.activeandroid.com/" title="ActiveAndroid">ActiveAndroid</a>.</li>
</ul>
<p><a href="https://realm.io/docs/java/latest/" title="Realm Java">Realm</a>, on the other hand, uses its own database to store the contents of a class. The amount of protection that ORM can provide depends primarily on whether the database is encrypted. See the chapter "<a href="../0x05d-Testing-Data-Storage/">Data Storage on Android</a>" for more details. The Realm website includes a nice <a href="https://github.com/j256/ormlite-examples/tree/master/android/HelloAndroid" title="OrmLite example">example of ORM Lite</a>.</p>
<h4 id="parcelable">Parcelable<a class="headerlink" href="#parcelable" title="Permanent link">&para;</a></h4>
<p><a href="https://developer.android.com/reference/android/os/Parcelable.html" title="Parcelable"><code>Parcelable</code></a> is an interface for classes whose instances can be written to and restored from a <a href="https://developer.android.com/reference/android/os/Parcel.html" title="Parcel"><code>Parcel</code></a>. Parcels are often used to pack a class as part of a <code>Bundle</code> for an <code>Intent</code>. Here's an Android developer documentation example that implements <code>Parcelable</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyParcelable</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Parcelable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mData</span><span class="p">;</span><span class="w"></span>

<span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">describeContents</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeToParcel</span><span class="p">(</span><span class="n">Parcel</span><span class="w"> </span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="n">out</span><span class="p">.</span><span class="na">writeInt</span><span class="p">(</span><span class="n">mData</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>

<span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Parcelable</span><span class="p">.</span><span class="na">Creator</span><span class="o">&lt;</span><span class="n">MyParcelable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CREATOR</span><span class="w"></span>
<span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Parcelable</span><span class="p">.</span><span class="na">Creator</span><span class="o">&lt;</span><span class="n">MyParcelable</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="kd">public</span><span class="w"> </span><span class="n">MyParcelable</span><span class="w"> </span><span class="nf">createFromParcel</span><span class="p">(</span><span class="n">Parcel</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyParcelable</span><span class="p">(</span><span class="n">in</span><span class="p">);</span><span class="w"></span>
<span class="w">         </span><span class="p">}</span><span class="w"></span>

<span class="w">         </span><span class="kd">public</span><span class="w"> </span><span class="n">MyParcelable</span><span class="o">[]</span><span class="w"> </span><span class="nf">newArray</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyParcelable</span><span class="o">[</span><span class="n">size</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="p">}</span><span class="w"></span>
<span class="w">     </span><span class="p">};</span><span class="w"></span>

<span class="w">     </span><span class="kd">private</span><span class="w"> </span><span class="nf">MyParcelable</span><span class="p">(</span><span class="n">Parcel</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="n">mData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">readInt</span><span class="p">();</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Because this mechanism that involves Parcels and Intents may change over time, and the <code>Parcelable</code> may contain <code>IBinder</code> pointers, storing data to disk via <code>Parcelable</code> is not recommended.</p>
<h4 id="protocol-buffers">Protocol Buffers<a class="headerlink" href="#protocol-buffers" title="Permanent link">&para;</a></h4>
<p><a href="https://developers.google.com/protocol-buffers/" title="Google Documentation">Protocol Buffers</a> by Google, are a platform- and language neutral mechanism for serializing structured data by means of the <a href="https://developers.google.com/protocol-buffers/docs/encoding" title="Encoding">Binary Data Format</a>.
There have been a few vulnerabilities with Protocol Buffers, such as <a href="https://www.cvedetails.com/cve/CVE-2015-5237/" title="CVE-2015-5237">CVE-2015-5237</a>.
Note that Protocol Buffers do not provide any protection for confidentiality: there is no built in encryption.</p>
<h3 id="static-analysis_8">Static Analysis<a class="headerlink" href="#static-analysis_8" title="Permanent link">&para;</a></h3>
<p>If object persistence is used for storing sensitive information on the device, first make sure that the information is encrypted and signed/HMACed. See the chapters "<a href="../0x05d-Testing-Data-Storage/">Data Storage on Android</a>" and "<a href="../0x05e-Testing-Cryptography/">Android Cryptographic APIs</a>" for more details. Next, make sure that the decryption and verification keys are obtainable only after the user has been authenticated. Security checks should be carried out at the correct positions, as defined in <a href="https://wiki.sei.cmu.edu/confluence/display/java/SER04-J.%20Do%20not%20allow%20serialization%20and%20deserialization%20to%20bypass%20the%20security%20manager" title="SER04-J. Do not allow serialization and deserialization to bypass the security manager">best practices</a>.</p>
<p>There are a few generic remediation steps that you can always take:</p>
<ol>
<li>Make sure that sensitive data has been encrypted and HMACed/signed after serialization/persistence. Evaluate the signature or HMAC before you use the data. See the chapter "<a href="../0x05e-Testing-Cryptography/">Android Cryptographic APIs</a>" for more details.</li>
<li>Make sure that the keys used in step 1 can't be extracted easily. The user and/or application instance should be properly authenticated/authorized to obtain the keys. See the chapter "<a href="../0x05d-Testing-Data-Storage/">Data Storage on Android</a>" for more details.</li>
<li>Make sure that the data within the de-serialized object is carefully validated before it is actively used (e.g., no exploit of business/application logic).</li>
</ol>
<p>For high-risk applications that focus on availability, we recommend that you use <code>Serializable</code> only when the serialized classes are stable. Second, we recommend not using reflection-based persistence because</p>
<ul>
<li>the attacker could find the method's signature via the String-based argument</li>
<li>the attacker might be able to manipulate the reflection-based steps to execute business logic.</li>
</ul>
<p>See the chapter "<a href="../0x05j-Testing-Resiliency-Against-Reverse-Engineering/">Android Anti-Reversing Defenses</a>" for more details.</p>
<h4 id="object-serialization_1">Object Serialization<a class="headerlink" href="#object-serialization_1" title="Permanent link">&para;</a></h4>
<p>Search the source code for the following keywords:</p>
<ul>
<li><code>import java.io.Serializable</code></li>
<li><code>implements Serializable</code></li>
</ul>
<h4 id="json_1">JSON<a class="headerlink" href="#json_1" title="Permanent link">&para;</a></h4>
<p>If you need to counter memory-dumping, make sure that very sensitive information is not stored in the JSON format because you can't guarantee prevention of anti-memory dumping techniques with the standard libraries. You can check for the following keywords in the corresponding libraries:</p>
<p><strong><code>JSONObject</code></strong> Search the source code for the following keywords:</p>
<ul>
<li><code>import org.json.JSONObject;</code></li>
<li><code>import org.json.JSONArray;</code></li>
</ul>
<p><strong><code>GSON</code></strong> Search the source code for the following keywords:</p>
<ul>
<li><code>import com.google.gson</code></li>
<li><code>import com.google.gson.annotations</code></li>
<li><code>import com.google.gson.reflect</code></li>
<li><code>import com.google.gson.stream</code></li>
<li><code>new Gson();</code></li>
<li>Annotations such as <code>@Expose</code>, <code>@JsonAdapter</code>, <code>@SerializedName</code>,<code>@Since</code>, and <code>@Until</code></li>
</ul>
<p><strong><code>Jackson</code></strong> Search the source code for the following keywords:</p>
<ul>
<li><code>import com.fasterxml.jackson.core</code></li>
<li><code>import org.codehaus.jackson</code> for the older version.</li>
</ul>
<h4 id="orm_1">ORM<a class="headerlink" href="#orm_1" title="Permanent link">&para;</a></h4>
<p>When you use an ORM library, make sure that the data is stored in an encrypted database and the class representations are individually encrypted before storing it. See the chapters "<a href="../0x05d-Testing-Data-Storage/">Data Storage on Android</a>" and "<a href="../0x05e-Testing-Cryptography/">Android Cryptographic APIs</a>" for more details. You can check for the following keywords in the corresponding libraries:</p>
<p><strong><code>OrmLite</code></strong> Search the source code for the following keywords:</p>
<ul>
<li><code>import com.j256.*</code></li>
<li><code>import com.j256.dao</code></li>
<li><code>import com.j256.db</code></li>
<li><code>import com.j256.stmt</code></li>
<li><code>import com.j256.table\</code></li>
</ul>
<p>Please make sure that logging is disabled.</p>
<p><strong><code>SugarORM</code></strong> Search the source code for the following keywords:</p>
<ul>
<li><code>import com.github.satyan</code></li>
<li><code>extends SugarRecord&lt;Type&gt;</code></li>
<li>In the AndroidManifest, there will be <code>meta-data</code> entries with values such as <code>DATABASE</code>, <code>VERSION</code>, <code>QUERY_LOG</code> and <code>DOMAIN_PACKAGE_NAME</code>.</li>
</ul>
<p>Make sure that <code>QUERY_LOG</code> is set to false.</p>
<p><strong><code>GreenDAO</code></strong> Search the source code for the following keywords:</p>
<ul>
<li><code>import org.greenrobot.greendao.annotation.Convert</code></li>
<li><code>import org.greenrobot.greendao.annotation.Entity</code></li>
<li><code>import org.greenrobot.greendao.annotation.Generated</code></li>
<li><code>import org.greenrobot.greendao.annotation.Id</code></li>
<li><code>import org.greenrobot.greendao.annotation.Index</code></li>
<li><code>import org.greenrobot.greendao.annotation.NotNull</code></li>
<li><code>import org.greenrobot.greendao.annotation.*</code></li>
<li><code>import org.greenrobot.greendao.database.Database</code></li>
<li><code>import org.greenrobot.greendao.query.Query</code></li>
</ul>
<p><strong><code>ActiveAndroid</code></strong> Search the source code for the following keywords:</p>
<ul>
<li><code>ActiveAndroid.initialize(&lt;contextReference&gt;);</code></li>
<li><code>import com.activeandroid.Configuration</code></li>
<li><code>import com.activeandroid.query.*</code></li>
</ul>
<p><strong><code>Realm</code></strong> Search the source code for the following keywords:</p>
<ul>
<li><code>import io.realm.RealmObject;</code></li>
<li><code>import io.realm.annotations.PrimaryKey;</code></li>
</ul>
<h4 id="parcelable_1">Parcelable<a class="headerlink" href="#parcelable_1" title="Permanent link">&para;</a></h4>
<p>Make sure that appropriate security measures are taken when sensitive information is stored in an Intent via a Bundle that contains a Parcelable. Use explicit Intents and verify proper additional security controls when using application-level IPC (e.g., signature verification, intent-permissions, crypto).</p>
<h3 id="dynamic-analysis_8">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_8" title="Permanent link">&para;</a></h3>
<p>There are several ways to perform dynamic analysis:</p>
<ol>
<li>For the actual persistence: Use the techniques described in the data storage chapter.</li>
<li>For reflection-based approaches: Use Xposed to hook into the deserialization methods or add unprocessable information to the serialized objects to see how they are handled (e.g., whether the application crashes or extra information can be extracted by enriching the objects).</li>
</ol>
<h2 id="testing-for-overlay-attacks-mstg-platform-9">Testing for Overlay Attacks (MSTG-PLATFORM-9)<a class="headerlink" href="#testing-for-overlay-attacks-mstg-platform-9" title="Permanent link">&para;</a></h2>
<h3 id="overview_10">Overview<a class="headerlink" href="#overview_10" title="Permanent link">&para;</a></h3>
<p>Screen overlay attacks occur when a malicious application manages to put itself on top of another application which remains working normally as if it were on the foreground. The malicious app might create UI elements mimicking the look and feel and the original app or even the Android system UI. The intention is typically to make users believe that they keep interacting with the legitimate app and then try to elevate privileges (e.g by getting some permissions granted), stealthy phishing, capture user taps and keystrokes etc.</p>
<p>There are several attacks affecting different Android versions including:</p>
<ul>
<li><a href="https://medium.com/devknoxio/what-is-tapjacking-in-android-and-how-to-prevent-it-50140e57bf44" title="What is Tapjacking in Android and How to Prevent It"><strong>Tapjacking</strong></a> (Android 6.0 (API level 23) and lower) abuses the screen overlay feature of Android listening for taps and intercepting any information being passed to the underlying activity.</li>
<li><a href="https://cloak-and-dagger.org/" title="Cloak &amp; Dagger"><strong>Cloak &amp; Dagger</strong></a> attacks affect apps targeting Android 5.0 (API level 21) to Android 7.1 (API level 25). They abuse one or both of the <code>SYSTEM_ALERT_WINDOW</code> ("draw on top") and <code>BIND_ACCESSIBILITY_SERVICE</code> ("a11y") permissions that, in case the app is installed from the Play Store, the users do not need to explicitly grant and for which they are not even notified.</li>
<li><a href="https://unit42.paloaltonetworks.com/unit42-android-toast-overlay-attack-cloak-and-dagger-with-no-permissions/" title="Android Toast Overlay Attack: Cloak and Dagger with No Permissions"><strong>Toast Overlay</strong></a> is quite similar to Cloak &amp; Dagger but do not require specific Android permissions to be granted by users. It was closed with CVE-2017-0752 on Android 8.0 (API level 26).</li>
</ul>
<p>Usually, this kind of attacks are inherent to an Android system version having certain vulnerabilities or design issues. This makes them challenging and often virtually impossible to prevent unless the app is upgraded targeting a safe Android version (API level).</p>
<p>Over the years many known malware like MazorBot, BankBot or MysteryBot have been abusing the screen overlay feature of Android to target business critical applications, namely in the banking sector. This <a href="https://www.infosecurity-magazine.com/opinions/overlay-attacks-safeguard-mobile/" title="Dealing with Overlay Attacks: Adopting Built-in Security to Safeguard Mobile Experience">blog</a> discusses more about this type of malware.</p>
<h3 id="static-analysis_9">Static Analysis<a class="headerlink" href="#static-analysis_9" title="Permanent link">&para;</a></h3>
<p>You can find some general guidelines about Android View security in the <a href="https://developer.android.com/reference/android/view/View#security" title="View Security">Android Developer Documentation</a>, please be sure to read them carefully. For instance, the so-called <em>touch filtering</em> is a common defense against tapjacking, which contributes to safeguarding users against these vulnerabilities, usually in combination with other techniques and considerations as we introduce in this section.</p>
<p>To start your static analysis you can check the source code for the following methods and attributes (non-exhaustive list):</p>
<ul>
<li>Override <a href="https://developer.android.com/reference/android/view/View#onFilterTouchEventForSecurity%28android.view.MotionEvent%29" title="onFilterTouchEventForSecurity"><code>onFilterTouchEventForSecurity</code></a> for more fine-grained control and to implement a custom security policy for views.</li>
<li>Set the layout attribute <a href="https://developer.android.com/reference/android/view/View#attr_android:filterTouchesWhenObscured" title="android:filterTouchesWhenObscured"><code>android:filterTouchesWhenObscured</code></a> to true or call <a href="https://developer.android.com/reference/android/view/View.html#setFilterTouchesWhenObscured%28boolean%29" title="setFilterTouchesWhenObscured"><code>setFilterTouchesWhenObscured</code></a>.</li>
<li>Check <a href="https://developer.android.com/reference/android/view/MotionEvent.html#FLAG_WINDOW_IS_OBSCURED" title="FLAG_WINDOW_IS_OBSCURED">FLAG_WINDOW_IS_OBSCURED</a> (since API level 9) or <a href="https://developer.android.com/reference/android/view/MotionEvent.html#FLAG_WINDOW_IS_PARTIALLY_OBSCURED" title="FLAG_WINDOW_IS_PARTIALLY_OBSCURED">FLAG_WINDOW_IS_PARTIALLY_OBSCURED</a> (starting on API level 29).</li>
</ul>
<p>Some attributes might affect the app as a whole, while others can be applied to specific components. The latter would be the case when, for example, there is a business need to specifically allow overlays while wanting to protect sensitive input UI elements. The developers might also take additional precautions to confirm the user's actual intent which might be legitimate and tell it apart from a potential attack.</p>
<p>As a final note, always remember to properly check the API level that app is targeting and the implications that this has. For instance, <a href="https://developer.android.com/about/versions/oreo/android-8.0-changes#all-aw" title="Alert windows">Android 8.0 (API level 26) introduced changes</a> to apps requiring <code>SYSTEM_ALERT_WINDOW</code> ("draw on top"). From this API level on, apps using <code>TYPE_APPLICATION_OVERLAY</code> will be always <a href="https://developer.android.com/about/versions/oreo/android-8.0-changes#all-aw" title="Alert Windows">shown above other windows</a> having other types such as <code>TYPE_SYSTEM_OVERLAY</code> or <code>TYPE_SYSTEM_ALERT</code>. You can use this information to ensure that no overlay attacks may occur at least for this app in this concrete Android version.</p>
<h3 id="dynamic-analysis_9">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_9" title="Permanent link">&para;</a></h3>
<p>Abusing this kind of vulnerability on a dynamic manner can be pretty challenging and very specialized as it closely depends on the target Android version. For instance, for versions up to Android 7.0 (API level 24) you can use the following APKs as a proof of concept to identify the existence of the vulnerabilities.  </p>
<ul>
<li><a href="https://github.com/FSecureLABS/tapjacking-poc" title="Tapjacking POC">Tapjacking POC</a>: This APK creates a simple overlay which sits on top of the testing application.</li>
<li><a href="https://github.com/DEVizzi/Invisible-Keyboard" title="Invisible Keyboard">Invisible Keyboard</a>: This APK creates multiple overlays on the keyboard to capture keystrokes. This is one of the exploit demonstrated in Cloak and Dagger attacks.</li>
</ul>
<h2 id="testing-enforced-updating-mstg-arch-9">Testing enforced updating (MSTG-ARCH-9)<a class="headerlink" href="#testing-enforced-updating-mstg-arch-9" title="Permanent link">&para;</a></h2>
<p>Starting from Android 5.0 (API level 21), together with the Play Core Library, apps can be forced to be updated. This mechanism is based on using the <code>AppUpdateManager</code>. Before that, other mechanisms were used, such as doing http calls to the Google Play Store, which are not as reliable as the APIs of the Play Store might change. Alternatively, Firebase could be used to check for possible forced updates as well (see this <a href="https://medium.com/@sembozdemir/force-your-users-to-update-your-app-with-using-firebase-33f1e0bcec5a" title="Force users to update the app using Firebase">blog</a>).
Enforced updating can be really helpful when it comes to public key pinning (see the Testing Network communication for more details) when a pin has to be refreshed due to a certificate/public key rotation. Next, vulnerabilities are easily patched by means of forced updates.</p>
<p>Please note that newer versions of an application will not fix security issues that are living in the backends to which the app communicates. Allowing an app not to communicate with it might not be enough. Having proper API-lifecycle management is key here.
Similarly, when a user is not forced to update, do not forget to test older versions of your app against your API and/or use proper API versioning.</p>
<h3 id="static-analysis_10">Static analysis<a class="headerlink" href="#static-analysis_10" title="Permanent link">&para;</a></h3>
<p>The code sample below shows the example of an app-update:</p>
<div class="highlight"><pre><span></span><code><span class="c1">//Part 1: check for update</span><span class="w"></span>
<span class="c1">// Creates instance of the manager.</span><span class="w"></span>
<span class="n">AppUpdateManager</span><span class="w"> </span><span class="n">appUpdateManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AppUpdateManagerFactory</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">context</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Returns an intent object that you use to check for an update.</span><span class="w"></span>
<span class="n">Task</span><span class="o">&lt;</span><span class="n">AppUpdateInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">appUpdateInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appUpdateManager</span><span class="p">.</span><span class="na">getAppUpdateInfo</span><span class="p">();</span><span class="w"></span>

<span class="c1">// Checks that the platform will allow the specified type of update.</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">appUpdateInfo</span><span class="p">.</span><span class="na">updateAvailability</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UpdateAvailability</span><span class="p">.</span><span class="na">UPDATE_AVAILABLE</span><span class="w"></span>
<span class="w">      </span><span class="c1">// For a flexible update, use AppUpdateType.FLEXIBLE</span><span class="w"></span>
<span class="w">      </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">appUpdateInfo</span><span class="p">.</span><span class="na">isUpdateTypeAllowed</span><span class="p">(</span><span class="n">AppUpdateType</span><span class="p">.</span><span class="na">IMMEDIATE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>



<span class="w">                  </span><span class="c1">//...Part 2: request update</span><span class="w"></span>
<span class="w">                  </span><span class="n">appUpdateManager</span><span class="p">.</span><span class="na">startUpdateFlowForResult</span><span class="p">(</span><span class="w"></span>
<span class="w">                     </span><span class="c1">// Pass the intent that is returned by &#39;getAppUpdateInfo()&#39;.</span><span class="w"></span>
<span class="w">                     </span><span class="n">appUpdateInfo</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="c1">// Or &#39;AppUpdateType.FLEXIBLE&#39; for flexible updates.</span><span class="w"></span>
<span class="w">                     </span><span class="n">AppUpdateType</span><span class="p">.</span><span class="na">IMMEDIATE</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="c1">// The current activity making the update request.</span><span class="w"></span>
<span class="w">                     </span><span class="k">this</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="c1">// Include a request code to later monitor this update request.</span><span class="w"></span>
<span class="w">                     </span><span class="n">MY_REQUEST_CODE</span><span class="p">);</span><span class="w"></span>



<span class="w">                     </span><span class="c1">//...Part 3: check if update completed successfully</span><span class="w"></span>
<span class="w"> </span><span class="nd">@Override</span><span class="w"></span>
<span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onActivityResult</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">requestCode</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">resultCode</span><span class="p">,</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myRequestCode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MY_REQUEST_CODE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resultCode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RESULT_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Update flow failed! Result code: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">resultCode</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="c1">// If the update is cancelled or fails,</span><span class="w"></span>
<span class="w">       </span><span class="c1">// you can request to start the update again in case of forced updates</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="c1">//..Part 4:</span><span class="w"></span>
<span class="w"> </span><span class="c1">// Checks that the update is not stalled during &#39;onResume()&#39;.</span><span class="w"></span>
<span class="c1">// However, you should execute this check at all entry points into the app.</span><span class="w"></span>
<span class="nd">@Override</span><span class="w"></span>
<span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onResume</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">super</span><span class="p">.</span><span class="na">onResume</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="n">appUpdateManager</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">getAppUpdateInfo</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="na">addOnSuccessListener</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="n">appUpdateInfo</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="p">...</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">appUpdateInfo</span><span class="p">.</span><span class="na">updateAvailability</span><span class="p">()</span><span class="w"></span>
<span class="w">                </span><span class="o">==</span><span class="w"> </span><span class="n">UpdateAvailability</span><span class="p">.</span><span class="na">DEVELOPER_TRIGGERED_UPDATE_IN_PROGRESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// If an in-app update is already running, resume the update.</span><span class="w"></span>
<span class="w">                </span><span class="n">manager</span><span class="p">.</span><span class="na">startUpdateFlowForResult</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">appUpdateInfo</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">IMMEDIATE</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="k">this</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">MY_REQUEST_CODE</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">          </span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<blockquote>
<p>Source: <a href="https://developer.android.com/guide/app-bundle/in-app-updates" title="Support in-app updates">https://developer.android.com/guide/app-bundle/in-app-updates</a></p>
</blockquote>
<p>When checking for a proper update mechanism, make sure the usage of the <code>AppUpdateManager</code> is present. If it is not yet, then this means that users might be able to remain on an older version of the application with the given vulnerabilities.
Next, pay attention to the <code>AppUpdateType.IMMEDIATE</code> use: if a security update comes in, then this flag should be used in order to make sure that the user cannot go forward with using the app without updating it.
As you can see, in part 3 of the example: make sure that cancellations or errors do end up in re-checks and that a user cannot move forward in case of a critical security update.
Finally, in part 4: you can see that for every entry point in the application, an update-mechanism should be enforced, so that bypassing it will be harder.</p>
<h3 id="dynamic-analysis_10">Dynamic analysis<a class="headerlink" href="#dynamic-analysis_10" title="Permanent link">&para;</a></h3>
<p>In order to test for proper updating: try downloading an older version of the application with a security vulnerability, either by a release from the developers or by using a third party app-store.
Next, verify whether or not you can continue to use the application without updating it. If an update prompt is given, verify if you can still use the application by canceling the prompt or otherwise circumventing it through normal application usage. This includes validating whether the backend will stop calls to vulnerable backends and/or whether the vulnerable app-version itself is blocked by the backend.
Lastly, see if you can play with the version number of a man-in-the-middled app and see how the backend responds to this (and if it is recorded at all for instance).</p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<h3 id="android-app-bundles-and-updates">Android App Bundles and updates<a class="headerlink" href="#android-app-bundles-and-updates" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://developer.android.com/guide/app-bundle/in-app-updates">https://developer.android.com/guide/app-bundle/in-app-updates</a></li>
</ul>
<h3 id="android-fragment-injection">Android Fragment Injection<a class="headerlink" href="#android-fragment-injection" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://www.synopsys.com/blogs/software-security/fragment-injection/">https://www.synopsys.com/blogs/software-security/fragment-injection/</a></li>
<li><a href="https://securityintelligence.com/wp-content/uploads/2013/12/android-collapses-into-fragments.pdf">https://securityintelligence.com/wp-content/uploads/2013/12/android-collapses-into-fragments.pdf</a></li>
</ul>
<h3 id="android-permissions-documentation">Android Permissions Documentation<a class="headerlink" href="#android-permissions-documentation" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://developer.android.com/training/permissions/usage-notes">https://developer.android.com/training/permissions/usage-notes</a></li>
<li><a href="https://developer.android.com/training/permissions/requesting#java">https://developer.android.com/training/permissions/requesting#java</a></li>
<li><a href="https://developer.android.com/guide/topics/permissions/overview#permission-groups">https://developer.android.com/guide/topics/permissions/overview#permission-groups</a></li>
<li><a href="https://developer.android.com/guide/topics/manifest/provider-element#gprmsn">https://developer.android.com/guide/topics/manifest/provider-element#gprmsn</a></li>
<li><a href="https://developer.android.com/reference/android/content/Context#revokeUriPermission(android.net.Uri,%20int)">https://developer.android.com/reference/android/content/Context#revokeUriPermission(android.net.Uri,%20int)</a></li>
<li><a href="https://developer.android.com/reference/android/content/Context#checkUriPermission(android.net.Uri,%20int,%20int,%20int)">https://developer.android.com/reference/android/content/Context#checkUriPermission(android.net.Uri,%20int,%20int,%20int)</a></li>
<li><a href="https://developer.android.com/guide/components/broadcasts#restricting_broadcasts_with_permissions">https://developer.android.com/guide/components/broadcasts#restricting_broadcasts_with_permissions</a></li>
<li><a href="https://developer.android.com/guide/topics/permissions/overview">https://developer.android.com/guide/topics/permissions/overview</a></li>
<li><a href="https://developer.android.com/guide/topics/manifest/manifest-intro#filestruct">https://developer.android.com/guide/topics/manifest/manifest-intro#filestruct</a></li>
</ul>
<h3 id="android-bundles-and-instant-apps">Android Bundles and Instant Apps<a class="headerlink" href="#android-bundles-and-instant-apps" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://developer.android.com/topic/google-play-instant/getting-started/instant-enabled-app-bundle">https://developer.android.com/topic/google-play-instant/getting-started/instant-enabled-app-bundle</a></li>
<li><a href="https://developer.android.com/topic/google-play-instant/guides/multiple-entry-points">https://developer.android.com/topic/google-play-instant/guides/multiple-entry-points</a></li>
<li><a href="https://developer.android.com/studio/projects/dynamic-delivery">https://developer.android.com/studio/projects/dynamic-delivery</a></li>
</ul>
<h3 id="android-permissions-changes-in-android-8">Android permissions changes in Android 8<a class="headerlink" href="#android-permissions-changes-in-android-8" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://developer.android.com/about/versions/oreo/android-8.0-changes">https://developer.android.com/about/versions/oreo/android-8.0-changes</a></li>
</ul>
<h3 id="android-webviews-and-safebrowsing">Android WebViews and SafeBrowsing<a class="headerlink" href="#android-webviews-and-safebrowsing" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://developer.android.com/training/articles/security-tips#WebView">https://developer.android.com/training/articles/security-tips#WebView</a></li>
<li><a href="https://developer.android.com/guide/webapps/managing-webview#safe-browsing">https://developer.android.com/guide/webapps/managing-webview#safe-browsing</a></li>
<li><a href="https://developer.android.com/about/versions/oreo/android-8.1#safebrowsing">https://developer.android.com/about/versions/oreo/android-8.1#safebrowsing</a></li>
<li><a href="https://support.virustotal.com/hc/en-us/articles/115002146549-Mobile-Apps">https://support.virustotal.com/hc/en-us/articles/115002146549-Mobile-Apps</a></li>
</ul>
<h3 id="android-custom-url-schemes">Android Custom URL Schemes<a class="headerlink" href="#android-custom-url-schemes" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://developer.android.com/training/app-links/">https://developer.android.com/training/app-links/</a></li>
<li><a href="https://developer.android.com/training/app-links/deep-linking">https://developer.android.com/training/app-links/deep-linking</a></li>
<li><a href="https://developer.android.com/training/app-links/verify-site-associations">https://developer.android.com/training/app-links/verify-site-associations</a></li>
<li><a href="https://developers.google.com/digital-asset-links/v1/getting-started">https://developers.google.com/digital-asset-links/v1/getting-started</a></li>
<li><a href="https://pdfs.semanticscholar.org/0415/59c01d5235f8cf38a3c69ccee7e1f1a98067.pdf">https://pdfs.semanticscholar.org/0415/59c01d5235f8cf38a3c69ccee7e1f1a98067.pdf</a></li>
</ul>
<h3 id="android-app-notifications">Android App Notifications<a class="headerlink" href="#android-app-notifications" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://developer.android.com/guide/topics/ui/notifiers/notifications">https://developer.android.com/guide/topics/ui/notifiers/notifications</a></li>
<li><a href="https://developer.android.com/training/notify-user/build-notification">https://developer.android.com/training/notify-user/build-notification</a></li>
<li><a href="https://developer.android.com/reference/android/service/notification/NotificationListenerService">https://developer.android.com/reference/android/service/notification/NotificationListenerService</a></li>
<li><a href="https://medium.com/csis-techblog/analysis-of-joker-a-spy-premium-subscription-bot-on-googleplay-9ad24f044451">https://medium.com/csis-techblog/analysis-of-joker-a-spy-premium-subscription-bot-on-googleplay-9ad24f044451</a></li>
</ul>
<h3 id="owasp-masvs">OWASP MASVS<a class="headerlink" href="#owasp-masvs" title="Permanent link">&para;</a></h3>
<ul>
<li>MSTG-PLATFORM-1: "The app only requests the minimum set of permissions necessary."</li>
<li>MSTG-PLATFORM-2: "All inputs from external sources and the user are validated and if necessary sanitized. This includes data received via the UI, IPC mechanisms such as intents, custom URLs, and network sources."</li>
<li>MSTG-PLATFORM-3: "The app does not export sensitive functionality via custom URL schemes, unless these mechanisms are properly protected."</li>
<li>MSTG-PLATFORM-4: "The app does not export sensitive functionality through IPC facilities, unless these mechanisms are properly protected."</li>
<li>MSTG-PLATFORM-5: "JavaScript is disabled in WebViews unless explicitly required."</li>
<li>MSTG-PLATFORM-6: "WebViews are configured to allow only the minimum set of protocol handlers required (ideally, only https is supported). Potentially dangerous handlers, such as file, tel and app-id, are disabled."</li>
<li>MSTG-PLATFORM-7: "If native methods of the app are exposed to a WebView, verify that the WebView only renders JavaScript contained within the app package."</li>
<li>MSTG-PLATFORM-8: "Object serialization, if any, is implemented using safe serialization APIs."</li>
<li>MSTG-ARCH-9: "A mechanism for enforcing updates of the mobile app exists."</li>
</ul>

              
            </article>
            
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../0x05g-Testing-Network-Communication/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Android Network APIs" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Android Network APIs
            </div>
          </div>
        </a>
      
      
        
        <a href="../0x05i-Testing-Code-Quality-and-Build-Settings/" class="md-footer__link md-footer__link--next" aria-label="Next: Android Code Quality and Build Settings" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Android Code Quality and Build Settings
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <div style="float: left; padding-right: 1em;">
  <a href="https://www.owasp.org"><img src="https://github.com/OWASP/owasp-mstg/blob/master/Document/Images/OWASP_logo_white.png?raw=true" width="100px" /></a>
</div>
<span>
  &#169; OWASP Foundation 2022. This work is licensed under 
  <a href="https://creativecommons.org/licenses/by/4.0">CC-BY-4.0</a>. For any reuse or distribution, you must make clear to others the license terms of this work.
</span>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://owasp.slack.com/messages/project-mobile_omtg/details/" target="_blank" rel="noopener" title="owasp.slack.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/OWASP_MSTG" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/OWASP/owasp-mstg/discussions" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["search.suggest", "search.highlight", "search.share", "navigation.instant", "navigation.expand", "navigation.tabs", "navigation.tabs.sticky", "toc.integrate", "navigation.top"], "search": "../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../../javascripts/tablesort.js"></script>
      
    
  </body>
</html>