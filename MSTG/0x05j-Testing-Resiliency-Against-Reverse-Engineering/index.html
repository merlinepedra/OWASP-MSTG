
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/logo_circle.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.9">
    
    
      
        <title>Android Anti-Reversing Defenses - OWASP Mobile Security Project</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#android-anti-reversing-defenses" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OWASP Mobile Security Project" class="md-header__button md-logo" aria-label="OWASP Mobile Security Project" data-md-component="logo">
      
  <img src="../../assets/logo_circle.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OWASP Mobile Security Project
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Android Anti-Reversing Defenses
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/OWASP/owasp-mstg" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    OWASP/owasp-mstg
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Welcome
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../donate/" class="md-tabs__link">
      ♡ Donations
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../news/" class="md-tabs__link">
      News
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../talks/" class="md-tabs__link">
      Talks
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../0x01-Foreword/" class="md-tabs__link md-tabs__link--active">
        MSTG
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../contributing/1_How_Can_You_Contribute/" class="md-tabs__link">
        Contributing
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OWASP Mobile Security Project" class="md-nav__button md-logo" aria-label="OWASP Mobile Security Project" data-md-component="logo">
      
  <img src="../../assets/logo_circle.png" alt="logo">

    </a>
    OWASP Mobile Security Project
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/OWASP/owasp-mstg" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    OWASP/owasp-mstg
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../donate/" class="md-nav__link">
        ♡ Donations
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../news/" class="md-nav__link">
        News
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../talks/" class="md-nav__link">
        Talks
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          MSTG
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="MSTG" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          MSTG
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x01-Foreword/" class="md-nav__link">
        Foreword
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x02a-Frontispiece/" class="md-nav__link">
        Frontispiece
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x02b-MASVS-MSTG-Adoption/" class="md-nav__link">
        OWASP MASVS and MSTG Adoption
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x02c-Acknowledgements/" class="md-nav__link">
        Acknowledgments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x03-Overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04a-Mobile-App-Taxonomy/" class="md-nav__link">
        Mobile App Taxonomy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04b-Mobile-App-Security-Testing/" class="md-nav__link">
        Mobile App Security Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04c-Tampering-and-Reverse-Engineering/" class="md-nav__link">
        Mobile App Tampering and Reverse Engineering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04e-Testing-Authentication-and-Session-Management/" class="md-nav__link">
        Mobile App Authentication Architectures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04f-Testing-Network-Communication/" class="md-nav__link">
        Mobile App Network Communication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04g-Testing-Cryptography/" class="md-nav__link">
        Mobile App Cryptography
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04h-Testing-Code-Quality/" class="md-nav__link">
        Mobile App Code Quality
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04i-Testing-User-Privacy-Protection/" class="md-nav__link">
        Mobile App User Privacy Protection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05a-Platform-Overview/" class="md-nav__link">
        Android Platform Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05b-Basic-Security_Testing/" class="md-nav__link">
        Android Basic Security Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05c-Reverse-Engineering-and-Tampering/" class="md-nav__link">
        Android Tampering and Reverse Engineering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05d-Testing-Data-Storage/" class="md-nav__link">
        Android Data Storage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05e-Testing-Cryptography/" class="md-nav__link">
        Android Cryptographic APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05f-Testing-Local-Authentication/" class="md-nav__link">
        Android Local Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05g-Testing-Network-Communication/" class="md-nav__link">
        Android Network APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05h-Testing-Platform-Interaction/" class="md-nav__link">
        Android Platform APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05i-Testing-Code-Quality-and-Build-Settings/" class="md-nav__link">
        Android Code Quality and Build Settings
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Android Anti-Reversing Defenses
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Android Anti-Reversing Defenses
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#testing-root-detection-mstg-resilience-1" class="md-nav__link">
    Testing Root Detection (MSTG-RESILIENCE-1)
  </a>
  
    <nav class="md-nav" aria-label="Testing Root Detection (MSTG-RESILIENCE-1)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-root-detection-methods" class="md-nav__link">
    Common Root Detection Methods
  </a>
  
    <nav class="md-nav" aria-label="Common Root Detection Methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safetynet" class="md-nav__link">
    SafetyNet
  </a>
  
    <nav class="md-nav" aria-label="SafetyNet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ctsprofilematch-vs-basicintegrity" class="md-nav__link">
    ctsProfileMatch Vs basicIntegrity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recommendations-when-using-safetynetapiattest" class="md-nav__link">
    Recommendations when using SafetyNetApi.attest
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#programmatic-detection" class="md-nav__link">
    Programmatic Detection
  </a>
  
    <nav class="md-nav" aria-label="Programmatic Detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#file-existence-checks" class="md-nav__link">
    File existence checks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executing-su-and-other-commands" class="md-nav__link">
    Executing su and other commands
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-running-processes" class="md-nav__link">
    Checking running processes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-installed-app-packages" class="md-nav__link">
    Checking installed app packages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-for-writable-partitions-and-system-directories" class="md-nav__link">
    Checking for writable partitions and system directories
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-for-custom-android-builds" class="md-nav__link">
    Checking for custom Android builds
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bypassing-root-detection" class="md-nav__link">
    Bypassing Root Detection
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#effectiveness-assessment" class="md-nav__link">
    Effectiveness Assessment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-anti-debugging-detection-mstg-resilience-2" class="md-nav__link">
    Testing Anti-Debugging Detection (MSTG-RESILIENCE-2)
  </a>
  
    <nav class="md-nav" aria-label="Testing Anti-Debugging Detection (MSTG-RESILIENCE-2)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_1" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jdwp-anti-debugging" class="md-nav__link">
    JDWP Anti-Debugging
  </a>
  
    <nav class="md-nav" aria-label="JDWP Anti-Debugging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checking-the-debuggable-flag-in-applicationinfo" class="md-nav__link">
    Checking the Debuggable Flag in ApplicationInfo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#isdebuggerconnected" class="md-nav__link">
    isDebuggerConnected
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timer-checks" class="md-nav__link">
    Timer Checks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#messing-with-jdwp-related-data-structures" class="md-nav__link">
    Messing with JDWP-Related Data Structures
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traditional-anti-debugging" class="md-nav__link">
    Traditional Anti-Debugging
  </a>
  
    <nav class="md-nav" aria-label="Traditional Anti-Debugging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checking-tracerpid" class="md-nav__link">
    Checking TracerPid
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-fork-and-ptrace" class="md-nav__link">
    Using Fork and ptrace
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bypassing-debugger-detection" class="md-nav__link">
    Bypassing Debugger Detection
  </a>
  
    <nav class="md-nav" aria-label="Bypassing Debugger Detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bypassing-example-uncrackable-app-for-android-level-2" class="md-nav__link">
    Bypassing Example: UnCrackable App for Android Level 2
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#effectiveness-assessment_1" class="md-nav__link">
    Effectiveness Assessment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-file-integrity-checks-mstg-resilience-3" class="md-nav__link">
    Testing File Integrity Checks (MSTG-RESILIENCE-3)
  </a>
  
    <nav class="md-nav" aria-label="Testing File Integrity Checks (MSTG-RESILIENCE-3)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_2" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sample-implementation-application-source-code" class="md-nav__link">
    Sample Implementation - Application Source Code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sample-implementation-storage" class="md-nav__link">
    Sample Implementation - Storage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bypassing-file-integrity-checks" class="md-nav__link">
    Bypassing File Integrity Checks
  </a>
  
    <nav class="md-nav" aria-label="Bypassing File Integrity Checks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bypassing-the-application-source-integrity-checks" class="md-nav__link">
    Bypassing the application-source integrity checks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bypassing-the-storage-integrity-checks" class="md-nav__link">
    Bypassing the storage integrity checks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#effectiveness-assessment_2" class="md-nav__link">
    Effectiveness Assessment
  </a>
  
    <nav class="md-nav" aria-label="Effectiveness Assessment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#for-application-source-integrity-checks" class="md-nav__link">
    For application-source integrity checks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#for-storage-integrity-checks" class="md-nav__link">
    For storage integrity checks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-reverse-engineering-tools-detection-mstg-resilience-4" class="md-nav__link">
    Testing Reverse Engineering Tools Detection (MSTG-RESILIENCE-4)
  </a>
  
    <nav class="md-nav" aria-label="Testing Reverse Engineering Tools Detection (MSTG-RESILIENCE-4)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_3" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detection-methods" class="md-nav__link">
    Detection Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#effectiveness-assessment_3" class="md-nav__link">
    Effectiveness Assessment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-emulator-detection-mstg-resilience-5" class="md-nav__link">
    Testing Emulator Detection (MSTG-RESILIENCE-5)
  </a>
  
    <nav class="md-nav" aria-label="Testing Emulator Detection (MSTG-RESILIENCE-5)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_4" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emulator-detection-examples" class="md-nav__link">
    Emulator Detection Examples
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bypassing-emulator-detection" class="md-nav__link">
    Bypassing Emulator Detection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#effectiveness-assessment_4" class="md-nav__link">
    Effectiveness Assessment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-runtime-integrity-checks-mstg-resilience-6" class="md-nav__link">
    Testing Runtime Integrity Checks (MSTG-RESILIENCE-6)
  </a>
  
    <nav class="md-nav" aria-label="Testing Runtime Integrity Checks (MSTG-RESILIENCE-6)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_5" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#runtime-integrity-check-examples" class="md-nav__link">
    Runtime Integrity Check Examples
  </a>
  
    <nav class="md-nav" aria-label="Runtime Integrity Check Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#detecting-tampering-with-the-java-runtime" class="md-nav__link">
    Detecting tampering with the Java Runtime**
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-native-hooks" class="md-nav__link">
    Detecting Native Hooks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bypass-and-effectiveness-assessment" class="md-nav__link">
    Bypass and Effectiveness Assessment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-obfuscation-mstg-resilience-9" class="md-nav__link">
    Testing Obfuscation (MSTG-RESILIENCE-9)
  </a>
  
    <nav class="md-nav" aria-label="Testing Obfuscation (MSTG-RESILIENCE-9)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_6" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#effectiveness-assessment_5" class="md-nav__link">
    Effectiveness Assessment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-device-binding-mstg-resilience-10" class="md-nav__link">
    Testing Device Binding (MSTG-RESILIENCE-10)
  </a>
  
    <nav class="md-nav" aria-label="Testing Device Binding (MSTG-RESILIENCE-10)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_7" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis" class="md-nav__link">
    Dynamic Analysis
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis-with-an-emulator" class="md-nav__link">
    Dynamic Analysis with an Emulator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#google-instance-id" class="md-nav__link">
    Google Instance ID
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imei-serial" class="md-nav__link">
    IMEI &amp; Serial
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssaid" class="md-nav__link">
    SSAID
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#effectiveness-assessment_6" class="md-nav__link">
    Effectiveness Assessment
  </a>
  
    <nav class="md-nav" aria-label="Effectiveness Assessment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-an-emulator" class="md-nav__link">
    Using an Emulator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-two-different-rooted-devices" class="md-nav__link">
    Using two different rooted devices
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
    <nav class="md-nav" aria-label="References">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#owasp-masvs" class="md-nav__link">
    OWASP MASVS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safetynet-attestation" class="md-nav__link">
    SafetyNet Attestation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06a-Platform-Overview/" class="md-nav__link">
        iOS Platform Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06b-Basic-Security-Testing/" class="md-nav__link">
        iOS Basic Security Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06c-Reverse-Engineering-and-Tampering/" class="md-nav__link">
        iOS Tampering and Reverse Engineering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06d-Testing-Data-Storage/" class="md-nav__link">
        iOS Data Storage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06e-Testing-Cryptography/" class="md-nav__link">
        iOS Cryptographic APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06f-Testing-Local-Authentication/" class="md-nav__link">
        iOS Local Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06g-Testing-Network-Communication/" class="md-nav__link">
        iOS Network APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06h-Testing-Platform-Interaction/" class="md-nav__link">
        iOS Platform APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06i-Testing-Code-Quality-and-Build-Settings/" class="md-nav__link">
        iOS Code Quality and Build Settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06j-Testing-Resiliency-Against-Reverse-Engineering/" class="md-nav__link">
        iOS Anti-Reversing Defenses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x07-Appendix/" class="md-nav__link">
        Appendix
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x08-Testing-Tools/" class="md-nav__link">
        Testing Tools
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x09-Suggested-Reading/" class="md-nav__link">
        Suggested Reading
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Contributing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Contributing" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Contributing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/1_How_Can_You_Contribute/" class="md-nav__link">
        How Can You Contribute?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/2_Getting_Started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/3_PRs_and_Reviews/" class="md-nav__link">
        Pull Requests & Reviews
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/4_Add_new_Language/" class="md-nav__link">
        Add a New Language
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/5_Style_Guide/" class="md-nav__link">
        Style Guide
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/OWASP/owasp-mstg/edit/master/docs/MSTG/0x05j-Testing-Resiliency-Against-Reverse-Engineering.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="android-anti-reversing-defenses">Android Anti-Reversing Defenses<a class="headerlink" href="#android-anti-reversing-defenses" title="Permanent link">&para;</a></h1>
<h2 id="testing-root-detection-mstg-resilience-1">Testing Root Detection (MSTG-RESILIENCE-1)<a class="headerlink" href="#testing-root-detection-mstg-resilience-1" title="Permanent link">&para;</a></h2>
<h3 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h3>
<p>In the context of anti-reversing, the goal of root detection is to make running the app on a rooted device a bit more difficult, which in turn blocks some of the tools and techniques reverse engineers like to use. Like most other defenses, root detection is not very effective by itself, but implementing multiple root checks that are scattered throughout the app can improve the effectiveness of the overall anti-tampering scheme.</p>
<p>For Android, we define "root detection" a bit more broadly, including custom ROMs detection, i.e., determining whether the device is a stock Android build or a custom build.</p>
<h3 id="common-root-detection-methods">Common Root Detection Methods<a class="headerlink" href="#common-root-detection-methods" title="Permanent link">&para;</a></h3>
<p>In the following section, we list some common root detection methods you'll encounter. You'll find some of these methods implemented in the <a href="https://github.com/OWASP/owasp-mstg/tree/master/Crackmes" title="OWASP Mobile Crackmes">crackme examples</a> that accompany the OWASP Mobile Testing Guide.</p>
<p>Root detection can also be implemented through libraries such as <a href="https://github.com/scottyab/rootbeer" title="RootBeer">RootBeer</a>.</p>
<h4 id="safetynet">SafetyNet<a class="headerlink" href="#safetynet" title="Permanent link">&para;</a></h4>
<p>SafetyNet is an Android API that provides a set of services and creates profiles of devices according to software and hardware information. This profile is then compared to a list of accepted device models that have passed Android compatibility testing. Google <a href="https://developers.google.com/android/reference/com/google/android/gms/safetynet/SafetyNet" title="SafetyNet Documentation">recommends</a> using the feature as "an additional in-depth defense signal as part of an anti-abuse system".</p>
<p>How exactly SafetyNet works is not well documented and may change at any time. When you call this API, SafetyNet downloads a binary package containing the device validation code provided from Google, and the code is then dynamically executed via reflection. An <a href="https://koz.io/inside-safetynet/" title="SafetyNet: Google's tamper detection for Android">analysis by John Kozyrakis</a> showed that SafetyNet also attempts to detect whether the device is rooted, but exactly how that's determined is unclear.</p>
<p>To use the API, an app may call the <code>SafetyNetApi.attest</code> method (which returns a JWS message with the <em>Attestation Result</em>) and then check the following fields:</p>
<ul>
<li><code>ctsProfileMatch</code>: If 'true', the device profile matches one of Google's listed devices.</li>
<li><code>basicIntegrity</code>: If 'true', the device running the app likely hasn't been tampered with.</li>
<li><code>nonces</code>: To match the response to its request.</li>
<li><code>timestampMs</code>: To check how much time has passed since you made the request and you got the response. A delayed response may suggest suspicious activity.</li>
<li><code>apkPackageName</code>, <code>apkCertificateDigestSha256</code>, <code>apkDigestSha256</code>: Provide information about the APK, which is used to verify the identity of the calling app. These parameters are absent if the API cannot reliably determine the APK information.</li>
</ul>
<p>The following is a sample attestation result:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;nonce&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;R2Rra24fVm5xa2Mg&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;timestampMs&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">9860437986543</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;apkPackageName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;com.package.name.of.requesting.app&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;apkCertificateDigestSha256&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;base64 encoded, SHA-256 hash of the</span>
<span class="s2">                                  certificate used to sign requesting app&quot;</span><span class="p">],</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;apkDigestSha256&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;base64 encoded, SHA-256 hash of the app&#39;s APK&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;ctsProfileMatch&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;basicIntegrity&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h5 id="ctsprofilematch-vs-basicintegrity">ctsProfileMatch Vs basicIntegrity<a class="headerlink" href="#ctsprofilematch-vs-basicintegrity" title="Permanent link">&para;</a></h5>
<p>The SafetyNet Attestation API initially provided a single value called <code>basicIntegrity</code> to help developers determine the integrity of a device. As the API evolved, Google introduced a new, stricter check whose results appear in a value called <code>ctsProfileMatch</code>, which allows developers to more finely evaluate the devices on which their app is running.</p>
<p>In broad terms, <code>basicIntegrity</code> gives you a signal about the general integrity of the device and its API. Many Rooted devices fail <code>basicIntegrity</code>, as do emulators, virtual devices, and devices with signs of tampering, such as API hooks.</p>
<p>On the other hand, <code>ctsProfileMatch</code> gives you a much stricter signal about the compatibility of the device. Only unmodified devices that have been certified by Google can pass <code>ctsProfileMatch</code>. Devices that will fail <code>ctsProfileMatch</code> include the following:</p>
<ul>
<li>Devices that fail <code>basicIntegrity</code></li>
<li>Devices with an unlocked bootloader</li>
<li>Devices with a custom system image (custom ROM)</li>
<li>Devices for which the manufacturer didn't apply for, or pass, Google certification</li>
<li>Devices with a system image built directly from the Android Open Source Program source files</li>
<li>Devices with a system image distributed as part of a beta or developer preview program (including the Android Beta Program)</li>
</ul>
<h5 id="recommendations-when-using-safetynetapiattest">Recommendations when using <code>SafetyNetApi.attest</code><a class="headerlink" href="#recommendations-when-using-safetynetapiattest" title="Permanent link">&para;</a></h5>
<ul>
<li>Create a large (16 bytes or longer) random number on your server using a cryptographically-secure random function so that a malicious user can not reuse a successful attestation result in place of an unsuccessful result</li>
<li>Trust APK information (<code>apkPackageName</code>, <code>apkCertificateDigestSha256</code> and <code>apkDigestSha256</code>) only if the value of <code>ctsProfileMatch</code> is true.</li>
<li>The entire JWS response should be sent to your server, using a secure connection, for verification. It isn't recommended to perform the verification directly in the app because, in that case, there is no guarantee that the verification logic itself hasn't been modified.</li>
<li>The <code>verify</code> method only validates that the JWS message was signed by SafetyNet. It doesn't verify that the payload of the verdict matches your expectations. As useful as this service may seem, it is designed for test purposes only, and it has very strict usage quotas of 10,000 requests per day, per project which will not be increased upon request. Hence, you should refer <a href="https://github.com/googlesamples/android-play-safetynet/tree/master/server/java/src/main/java" title="Google SafetyNet Sample">SafetyNet Verification Samples</a> and implement the digital signature verification logic on your server in a way that it doesn't depend on Google's servers.</li>
<li>The SafetyNet Attestation API gives you a snapshot of the state of a device at the moment when the attestation request was made. A successful attestation doesn't necessarily mean that the device would have passed attestation in the past, or that it will in the future. It's recommended to plan a strategy to use the least amount of attestations required to satisfy the use case.</li>
<li>To prevent inadvertently reaching your <code>SafetyNetApi.attest</code> quota and getting attestation errors, you should build a system that monitors your usage of the API and warns you well before you reach your quota so you can get it increased. You should also be prepared to handle attestation failures because of an exceeded quota and avoid blocking all your users in this situation. If you are close to reaching your quota, or expect a short-term spike that may lead you to exceed your quota, you can submit this <a href="https://support.google.com/googleplay/android-developer/contact/safetynetqr" title="quota request">form</a> to request short or long-term increases to the quota for your API key. This process, as well as the additional quota, is free of charge.</li>
</ul>
<p>Follow this <a href="https://developer.android.com/training/safetynet/attestation-checklist" title="attestation checklist">checklist</a> to ensure that you've completed each of the steps needed to integrate the <code>SafetyNetApi.attest</code> API into the app.</p>
<h4 id="programmatic-detection">Programmatic Detection<a class="headerlink" href="#programmatic-detection" title="Permanent link">&para;</a></h4>
<h5 id="file-existence-checks">File existence checks<a class="headerlink" href="#file-existence-checks" title="Permanent link">&para;</a></h5>
<p>Perhaps the most widely used method of programmatic detection is checking for files typically found on rooted devices, such as package files of common rooting apps and their associated files and directories, including the following:</p>
<div class="highlight"><pre><span></span><code>/system/app/Superuser.apk
/system/etc/init.d/99SuperSUDaemon
/dev/com.koushikdutta.superuser.daemon/
/system/xbin/daemonsu
</code></pre></div>
<p>Detection code also often looks for binaries that are usually installed once a device has been rooted. These searches include checking for busybox and attempting to open the <em>su</em> binary at different locations:</p>
<div class="highlight"><pre><span></span><code>/sbin/su
/system/bin/su
/system/bin/failsafe/su
/system/xbin/su
/system/xbin/busybox
/system/sd/xbin/su
/data/local/su
/data/local/xbin/su
/data/local/bin/su
</code></pre></div>
<p>Checking whether <code>su</code> is on the PATH also works:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">checkRoot</span><span class="p">(){</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">pathDir</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;PATH&quot;</span><span class="p">).</span><span class="na">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)){</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">pathDir</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;su&quot;</span><span class="p">).</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>File checks can be easily implemented in both Java and native code. The following JNI example (adapted from <a href="https://github.com/devadvance/rootinspector/" title="rootinspector">rootinspector</a>) uses the <code>stat</code> system call to retrieve information about a file and returns "1" if the file exists.</p>
<div class="highlight"><pre><span></span><code><span class="n">jboolean</span><span class="w"> </span><span class="nf">Java_com_example_statfile</span><span class="p">(</span><span class="n">JNIEnv</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="n">jstring</span><span class="w"> </span><span class="n">filepath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">jboolean</span><span class="w"> </span><span class="n">fileExists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">jboolean</span><span class="w"> </span><span class="n">isCopy</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">filepath</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">isCopy</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">stat</span><span class="w"> </span><span class="n">fileattrib</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fileattrib</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">__android_log_print</span><span class="p">(</span><span class="n">ANDROID_LOG_DEBUG</span><span class="p">,</span><span class="w"> </span><span class="n">DEBUG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;NATIVE: stat error: [%s]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">__android_log_print</span><span class="p">(</span><span class="n">ANDROID_LOG_DEBUG</span><span class="p">,</span><span class="w"> </span><span class="n">DEBUG_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;NATIVE: stat success, access perms: [%d]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fileattrib</span><span class="p">.</span><span class="n">st_mode</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h5 id="executing-su-and-other-commands">Executing <code>su</code> and other commands<a class="headerlink" href="#executing-su-and-other-commands" title="Permanent link">&para;</a></h5>
<p>Another way of determining whether <code>su</code> exists is attempting to execute it through the <code>Runtime.getRuntime.exec</code> method. An IOException will be thrown if <code>su</code> is not on the PATH. The same method can be used to check for other programs often found on rooted devices, such as busybox and the symbolic links that typically point to it.</p>
<h5 id="checking-running-processes">Checking running processes<a class="headerlink" href="#checking-running-processes" title="Permanent link">&para;</a></h5>
<p>Supersu-by far the most popular rooting tool-runs an authentication daemon named <code>daemonsu</code>, so the presence of this process is another sign of a rooted device. Running processes can be enumerated with the <code>ActivityManager.getRunningAppProcesses</code> and <code>manager.getRunningServices</code> APIs, the <code>ps</code> command, and browsing through the <code>/proc</code> directory. The following is an example implemented in <a href="https://github.com/devadvance/rootinspector/" title="rootinspector">rootinspector</a>:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">checkRunningProcesses</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="kt">boolean</span><span class="w"> </span><span class="n">returnValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Get currently running application processes</span><span class="w"></span>
<span class="w">      </span><span class="n">List</span><span class="o">&lt;</span><span class="n">RunningServiceInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="na">getRunningServices</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">list</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">tempName</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">list</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="o">++</span><span class="n">i</span><span class="p">){</span><span class="w"></span>
<span class="w">          </span><span class="n">tempName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">process</span><span class="p">;</span><span class="w"></span>

<span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="n">tempName</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;supersu&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">tempName</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;superuser&quot;</span><span class="p">)){</span><span class="w"></span>
<span class="w">            </span><span class="n">returnValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">returnValue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h5 id="checking-installed-app-packages">Checking installed app packages<a class="headerlink" href="#checking-installed-app-packages" title="Permanent link">&para;</a></h5>
<p>You can use the Android package manager to obtain a list of installed packages. The following package names belong to popular rooting tools:</p>
<div class="highlight"><pre><span></span><code>com.thirdparty.superuser
eu.chainfire.supersu
com.noshufou.android.su
com.koushikdutta.superuser
com.zachspong.temprootremovejb
com.ramdroid.appquarantine
com.topjohnwu.magisk
</code></pre></div>
<h5 id="checking-for-writable-partitions-and-system-directories">Checking for writable partitions and system directories<a class="headerlink" href="#checking-for-writable-partitions-and-system-directories" title="Permanent link">&para;</a></h5>
<p>Unusual permissions on system directories may indicate a customized or rooted device. Although the system and data directories are normally mounted read-only, you'll sometimes find them mounted read-write when the device is rooted. Look for these filesystems mounted with the "rw" flag or try to create a file in the data directories.</p>
<h5 id="checking-for-custom-android-builds">Checking for custom Android builds<a class="headerlink" href="#checking-for-custom-android-builds" title="Permanent link">&para;</a></h5>
<p>Checking for signs of test builds and custom ROMs is also helpful. One way to do this is to check the BUILD tag for test-keys, which normally <a href="https://resources.infosecinstitute.com/android-hacking-security-part-8-root-detection-evasion//" title="InfoSec Institute - Android Root Detection and Evasion">indicate a custom Android image</a>. <a href="https://github.com/scottyab/rootbeer/blob/master/rootbeerlib/src/main/java/com/scottyab/rootbeer/RootBeer.java#L76" title="Rootbeer - detectTestKeys function">Check the BUILD tag as follows</a>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isTestKeyBuild</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="n">String</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Build</span><span class="p">.</span><span class="na">TAGS</span><span class="p">;</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">str</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;test-keys&quot;</span><span class="p">)));</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Missing Google Over-The-Air (OTA) certificates is another sign of a custom ROM: on stock Android builds, <a href="https://blog.netspi.com/android-root-detection-techniques/" title="Android Root Detection Techniques">OTA updates Google's public certificates</a>.</p>
<h4 id="bypassing-root-detection">Bypassing Root Detection<a class="headerlink" href="#bypassing-root-detection" title="Permanent link">&para;</a></h4>
<p>Run execution traces with jdb, <a href="https://developer.android.com/studio/profile/monitor" title="DDMS">DDMS</a>, <code>strace</code>, and/or kernel modules to find out what the app is doing. You'll usually see all kinds of suspect interactions with the operating system, such as opening <code>su</code> for reading and obtaining a list of processes. These interactions are surefire signs of root detection. Identify and deactivate the root detection mechanisms, one at a time. If you're performing a black box resilience assessment, disabling the root detection mechanisms is your first step.</p>
<p>To bypass these checks, you can use several techniques, most of which were introduced in the "Reverse Engineering and Tampering" chapter:</p>
<ul>
<li>Renaming binaries. For example, in some cases simply renaming the <code>su</code> binary is enough to defeat root detection (try not to break your environment though!).</li>
<li>Unmounting <code>/proc</code> to prevent reading of process lists. Sometimes, the unavailability of <code>/proc</code> is enough to bypass such checks.</li>
<li>Using Frida or Xposed to hook APIs on the Java and native layers. This hides files and processes, hides the contents of files, and returns all kinds of bogus values that the app requests.</li>
<li>Hooking low-level APIs by using kernel modules.</li>
<li>Patching the app to remove the checks.</li>
</ul>
<h3 id="effectiveness-assessment">Effectiveness Assessment<a class="headerlink" href="#effectiveness-assessment" title="Permanent link">&para;</a></h3>
<p>Check for root detection mechanisms, including the following criteria:</p>
<ul>
<li>Multiple detection methods are scattered throughout the app (as opposed to putting everything into a single method).</li>
<li>The root detection mechanisms operate on multiple API layers (Java APIs, native library functions, assembler/system calls).</li>
<li>The mechanisms are somehow original (they're not copied and pasted from StackOverflow or other sources).</li>
</ul>
<p>Develop bypass methods for the root detection mechanisms and answer the following questions:</p>
<ul>
<li>Can the mechanisms be easily bypassed with standard tools, such as RootCloak?</li>
<li>Is static/dynamic analysis necessary to handle the root detection?</li>
<li>Do you need to write custom code?</li>
<li>How long did successfully bypassing the mechanisms take?</li>
<li>What is your assessment of the difficulty of bypassing the mechanisms?</li>
</ul>
<p>If root detection is missing or too easily bypassed, make suggestions in line with the effectiveness criteria listed above. These suggestions may include more detection mechanisms and better integration of existing mechanisms with other defenses.</p>
<h2 id="testing-anti-debugging-detection-mstg-resilience-2">Testing Anti-Debugging Detection (MSTG-RESILIENCE-2)<a class="headerlink" href="#testing-anti-debugging-detection-mstg-resilience-2" title="Permanent link">&para;</a></h2>
<h3 id="overview_1">Overview<a class="headerlink" href="#overview_1" title="Permanent link">&para;</a></h3>
<p>Debugging is a highly effective way to analyze runtime app behavior. It allows the reverse engineer to step through the code, stop app execution at arbitrary points, inspect the state of variables, read and modify memory, and a lot more.</p>
<p>Anti-debugging features can be preventive or reactive. As the name implies, preventive anti-debugging prevents the debugger from attaching in the first place; reactive anti-debugging involves detecting debuggers and reacting to them in some way (e.g., terminating the app or triggering hidden behavior). The "more-is-better" rule applies: to maximize effectiveness, defenders combine multiple methods of prevention and detection that operate on different API layers and are well distributed throughout the app.</p>
<p>As mentioned in the "Reverse Engineering and Tampering" chapter, we have to deal with two debugging protocols on Android: we can debug on the Java level with JDWP or on the native layer via a ptrace-based debugger. A good anti-debugging scheme should defend against both types of debugging.</p>
<h3 id="jdwp-anti-debugging">JDWP Anti-Debugging<a class="headerlink" href="#jdwp-anti-debugging" title="Permanent link">&para;</a></h3>
<p>In the chapter "Reverse Engineering and Tampering", we talked about JDWP, the protocol used for communication between the debugger and the Java Virtual Machine. We showed that it is easy to enable debugging for any app by patching its manifest file, and changing the <code>ro.debuggable</code> system property which enables debugging for all apps. Let's look at a few things developers do to detect and disable JDWP debuggers.</p>
<h4 id="checking-the-debuggable-flag-in-applicationinfo">Checking the Debuggable Flag in ApplicationInfo<a class="headerlink" href="#checking-the-debuggable-flag-in-applicationinfo" title="Permanent link">&para;</a></h4>
<p>We have already encountered the <code>android:debuggable</code> attribute. This flag in the Android Manifest determines whether the JDWP thread is started for the app. Its value can be determined programmatically, via the app's <code>ApplicationInfo</code> object. If the flag is set, the manifest has been tampered with and allows debugging.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isDebuggable</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">){</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">context</span><span class="p">.</span><span class="na">getApplicationContext</span><span class="p">().</span><span class="na">getApplicationInfo</span><span class="p">().</span><span class="na">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ApplicationInfo</span><span class="p">.</span><span class="na">FLAG_DEBUGGABLE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h4 id="isdebuggerconnected">isDebuggerConnected<a class="headerlink" href="#isdebuggerconnected" title="Permanent link">&para;</a></h4>
<p>While this might be pretty obvious to circumvent for a reverse engineer, you can use <code>isDebuggerConnected</code> from the <code>android.os.Debug</code> class to determine whether a debugger is connected.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">detectDebugger</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Debug</span><span class="p">.</span><span class="na">isDebuggerConnected</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The same API can be called via native code by accessing the DvmGlobals global structure.</p>
<div class="highlight"><pre><span></span><code><span class="n">JNIEXPORT</span><span class="w"> </span><span class="n">jboolean</span><span class="w"> </span><span class="n">JNICALL</span><span class="w"> </span><span class="n">Java_com_test_debugging_DebuggerConnectedJNI</span><span class="p">(</span><span class="n">JNIenv</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gDvm</span><span class="p">.</span><span class="n">debuggerConnected</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">gDvm</span><span class="p">.</span><span class="n">debuggerActive</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">JNI_TRUE</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">JNI_FALSE</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h4 id="timer-checks">Timer Checks<a class="headerlink" href="#timer-checks" title="Permanent link">&para;</a></h4>
<p><code>Debug.threadCpuTimeNanos</code> indicates the amount of time that the current thread has been executing code. Because debugging slows down process execution, <a href="https://www.yumpu.com/en/document/read/15228183/android-reverse-engineering-defenses-bluebox-labs" title="Bluebox Security - Android Reverse Engineering &amp; Defenses">you can use the difference in execution time to guess whether a debugger is attached</a>.</p>
<div class="highlight"><pre><span></span><code><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">detect_threadCpuTimeNanos</span><span class="p">(){</span><span class="w"></span>
<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Debug</span><span class="p">.</span><span class="na">threadCpuTimeNanos</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">1000000</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Debug</span><span class="p">.</span><span class="na">threadCpuTimeNanos</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">stop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10000000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h4 id="messing-with-jdwp-related-data-structures">Messing with JDWP-Related Data Structures<a class="headerlink" href="#messing-with-jdwp-related-data-structures" title="Permanent link">&para;</a></h4>
<p>In Dalvik, the global virtual machine state is accessible via the <code>DvmGlobals</code> structure. The global variable gDvm holds a pointer to this structure. <code>DvmGlobals</code> contains various variables and pointers that are important for JDWP debugging and can be tampered with.</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">DvmGlobals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Some options that could be worth tampering with :)</span>
<span class="cm">     */</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w">        </span><span class="n">jdwpAllowed</span><span class="p">;</span><span class="w">        </span><span class="c1">// debugging allowed for this process?</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">        </span><span class="n">jdwpConfigured</span><span class="p">;</span><span class="w">     </span><span class="c1">// has debugging info been provided?</span>
<span class="w">    </span><span class="n">JdwpTransportType</span><span class="w"> </span><span class="n">jdwpTransport</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w">        </span><span class="n">jdwpServer</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w">       </span><span class="n">jdwpHost</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w">         </span><span class="n">jdwpPort</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w">        </span><span class="n">jdwpSuspend</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">Thread</span><span class="o">*</span><span class="w">     </span><span class="n">threadList</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w">        </span><span class="n">nativeDebuggerActive</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w">        </span><span class="n">debuggerConnected</span><span class="p">;</span><span class="w">      </span><span class="cm">/* debugger or DDMS is connected */</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w">        </span><span class="n">debuggerActive</span><span class="p">;</span><span class="w">         </span><span class="cm">/* debugger is making requests */</span><span class="w"></span>
<span class="w">    </span><span class="n">JdwpState</span><span class="o">*</span><span class="w">  </span><span class="n">jdwpState</span><span class="p">;</span><span class="w"></span>

<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>For example, <a href="https://github.com/crazykid95/Backup-Mobile-Security-Report/blob/master/AndroidREnDefenses201305.pdf" title="Bluebox Security - Android Reverse Engineering &amp; Defenses">setting the gDvm.methDalvikDdmcServer_dispatch function pointer to NULL crashes the JDWP thread</a>:</p>
<div class="highlight"><pre><span></span><code><span class="n">JNIEXPORT</span><span class="w"> </span><span class="n">jboolean</span><span class="w"> </span><span class="n">JNICALL</span><span class="w"> </span><span class="n">Java_poc_c_crashOnInit</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">JNIEnv</span><span class="o">*</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">gDvm</span><span class="p">.</span><span class="n">methDalvikDdmcServer_dispatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>You can disable debugging by using similar techniques in ART even though the gDvm variable is not available. The ART runtime exports some of the vtables of JDWP-related classes as global symbols (in C++, vtables are tables that hold pointers to class methods). This includes the vtables of the classes <code>JdwpSocketState</code> and <code>JdwpAdbState</code>, which handle JDWP connections via network sockets and ADB, respectively. You can manipulate the behavior of the debugging runtime <a href="https://web.archive.org/web/20200307152820/https://www.vantagepoint.sg/blog/88-anti-debugging-fun-with-android-art" title="Anti-Debugging Fun with Android ART">by overwriting the method pointers in the associated vtables</a> (archived).</p>
<p>One way to overwrite the method pointers is to overwrite the address of the function <code>jdwpAdbState::ProcessIncoming</code> with the address of <code>JdwpAdbState::Shutdown</code>. This will cause the debugger to disconnect immediately.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;jni.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;android/log.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;dlfcn.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;jdwp/jdwp.h&gt;</span><span class="cp"></span>

<span class="cp">#define log(FMT, ...) __android_log_print(ANDROID_LOG_VERBOSE, &quot;JDWPFun&quot;, FMT, ##__VA_ARGS__)</span>

<span class="c1">// Vtable structure. Just to make messing around with it more intuitive</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">VT_JdwpAdbState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">JdwpSocketState_destructor</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_JdwpSocketState_destructor</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Accept</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">showmanyc</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ShutDown</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ProcessIncoming</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"></span>

<span class="n">JNIEXPORT</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">JNICALL</span><span class="w"> </span><span class="n">Java_sg_vantagepoint_jdwptest_MainActivity_JDWPfun</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">JNIEnv</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">jobject</span><span class="w"> </span><span class="cm">/* this */</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlopen</span><span class="p">(</span><span class="s">&quot;libart.so&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">RTLD_NOW</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lib</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Error loading libart.so&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">dlerror</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">VT_JdwpAdbState</span><span class="w"> </span><span class="o">*</span><span class="n">vtable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VT_JdwpAdbState</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">dlsym</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_ZTVN3art4JDWP12JdwpAdbStateE&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vtable</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t resolve symbol &#39;_ZTVN3art4JDWP12JdwpAdbStateE&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">            </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Vtable for JdwpAdbState at: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">vtable</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="c1">// Let the fun begin!</span>

<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pagesize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_PAGE_SIZE</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">vtable</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">pagesize</span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">mprotect</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">pagesize</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">vtable</span><span class="o">-&gt;</span><span class="n">ProcessIncoming</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vtable</span><span class="o">-&gt;</span><span class="n">ShutDown</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="c1">// Reset permissions &amp; flush cache</span>

<span class="w">            </span><span class="n">mprotect</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">pagesize</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3 id="traditional-anti-debugging">Traditional Anti-Debugging<a class="headerlink" href="#traditional-anti-debugging" title="Permanent link">&para;</a></h3>
<p>On Linux, the <a href="http://man7.org/linux/man-pages/man2/ptrace.2.html" title="Ptrace man page"><code>ptrace</code> system call</a> is used to observe and control the execution of a process (the <em>tracee</em>) and to examine and change that process' memory and registers. <code>ptrace</code> is the primary way to implement system call tracing and breakpoint debugging in native code. Most JDWP anti-debugging tricks (which may be safe for timer-based checks) won't catch classical debuggers based on <code>ptrace</code> and therefore, many Android anti-debugging tricks include <code>ptrace</code>, often exploiting the fact that only one debugger at a time can attach to a process.</p>
<h4 id="checking-tracerpid">Checking TracerPid<a class="headerlink" href="#checking-tracerpid" title="Permanent link">&para;</a></h4>
<p>When you debug an app and set a breakpoint on native code, Android Studio will copy the needed files to the target device and start the lldb-server which will use <code>ptrace</code> to attach to the process. From this moment on, if you inspect the <a href="http://man7.org/linux/man-pages/man5/proc.5.html" title="/proc/[pid]/status">status file</a> of the debugged process (<code>/proc/&lt;pid&gt;/status</code> or <code>/proc/self/status</code>), you will see that the "TracerPid" field has a value different from 0, which is a sign of debugging.</p>
<blockquote>
<p>Remember that <strong>this only applies to native code</strong>. If you're debugging a Java/Kotlin-only app the value of the "TracerPid" field should be 0.</p>
</blockquote>
<p>This technique is usually applied within the JNI native libraries in C, as shown in <a href="https://github.com/gperftools/gperftools/blob/master/src/heap-checker.cc#L112" title="heap-checker.cc - IsDebuggerAttached">Google's gperftools (Google Performance Tools)) Heap Checker</a> implementation of the <code>IsDebuggerAttached</code> method. However, if you prefer to include this check as part of your Java/Kotlin code you can refer to this Java implementation of the <code>hasTracerPid</code> method from <a href="https://github.com/strazzere/anti-emulator/" title="anti-emulator">Tim Strazzere's Anti-Emulator project</a>.</p>
<p>When trying to implement such a method yourself, you can manually check the value of TracerPid with ADB. The following listing uses Google's NDK sample app <a href="https://github.com/android/ndk-samples/tree/android-mk/hello-jni" title="hello-jni sample">hello-jni (com.example.hellojni)</a> to perform the check after attaching Android Studio's debugger:</p>
<div class="highlight"><pre><span></span><code>$ adb shell ps -A <span class="p">|</span> grep com.example.hellojni
u0_a271      <span class="m">11657</span>   <span class="m">573</span> <span class="m">4302108</span>  <span class="m">50600</span> ptrace_stop         <span class="m">0</span> t com.example.hellojni
$ adb shell cat /proc/11657/status <span class="p">|</span> grep -e <span class="s2">&quot;^TracerPid:&quot;</span> <span class="p">|</span> sed <span class="s2">&quot;s/^TracerPid:\t//&quot;</span>
TracerPid:      <span class="m">11839</span>
$ adb shell ps -A <span class="p">|</span> grep <span class="m">11839</span>
u0_a271      <span class="m">11839</span> <span class="m">11837</span>   <span class="m">14024</span>   <span class="m">4548</span> poll_schedule_timeout <span class="m">0</span> S lldb-server
</code></pre></div>
<p>You can see how the status file of com.example.hellojni (PID=11657) contains a TracerPID of 11839, which we can identify as the lldb-server process.</p>
<h4 id="using-fork-and-ptrace">Using Fork and ptrace<a class="headerlink" href="#using-fork-and-ptrace" title="Permanent link">&para;</a></h4>
<p>You can prevent debugging of a process by forking a child process and attaching it to the parent as a debugger via code similar to the following simple example code:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">fork_and_attach</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">ppid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getppid</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_ATTACH</span><span class="p">,</span><span class="w"> </span><span class="n">ppid</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">waitpid</span><span class="p">(</span><span class="n">ppid</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">          </span><span class="cm">/* Continue the parent process */</span><span class="w"></span>
<span class="w">          </span><span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_CONT</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>With the child attached, further attempts to attach to the parent will fail. We can verify this by compiling the code into a JNI function and packing it into an app we run on the device.</p>
<div class="highlight"><pre><span></span><code>root@android:/ <span class="c1"># ps | grep -i anti</span>
u0_a151   <span class="m">18190</span> <span class="m">201</span>   <span class="m">1535844</span> <span class="m">54908</span> ffffffff b6e0f124 S sg.vantagepoint.antidebug
u0_a151   <span class="m">18224</span> <span class="m">18190</span> <span class="m">1495180</span> <span class="m">35824</span> c019a3ac b6e0ee5c S sg.vantagepoint.antidebug
</code></pre></div>
<p>Attempting to attach to the parent process with gdbserver fails with an error:</p>
<div class="highlight"><pre><span></span><code>root@android:/ <span class="c1"># ./gdbserver --attach localhost:12345 18190</span>
warning: process <span class="m">18190</span> is already traced by process <span class="m">18224</span>
Cannot attach to lwp <span class="m">18190</span>: Operation not permitted <span class="o">(</span><span class="m">1</span><span class="o">)</span>
Exiting
</code></pre></div>
<p>You can easily bypass this failure, however, by killing the child and "freeing" the parent from being traced. You'll therefore usually find more elaborate schemes, involving multiple processes and threads as well as some form of monitoring to impede tampering. Common methods include</p>
<ul>
<li>forking multiple processes that trace one another,</li>
<li>keeping track of running processes to make sure the children stay alive,</li>
<li>monitoring values in the <code>/proc</code> filesystem, such as TracerPID in <code>/proc/pid/status</code>.</li>
</ul>
<p>Let's look at a simple improvement for the method above. After the initial <code>fork</code>, we launch in the parent an extra thread that continually monitors the child's status. Depending on whether the app has been built in debug or release mode (which is indicated by the <code>android:debuggable</code> flag in the manifest), the child process should do one of the following things:</p>
<ul>
<li>In release mode: The call to ptrace fails and the child crashes immediately with a segmentation fault (exit code 11).</li>
<li>In debug mode: The call to ptrace works and the child should run indefinitely. Consequently, a call to <code>waitpid(child_pid)</code> should never return. If it does, something is fishy and we would kill the whole process group.</li>
</ul>
<p>The following is the complete code for implementing this improvement with a JNI function:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;jni.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/ptrace.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span><span class="cp"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">child_pid</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">monitor_pid</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">waitpid</span><span class="p">(</span><span class="n">child_pid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Child status should never change. */</span><span class="w"></span>

<span class="w">    </span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Commit seppuku</span>

<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">anti_debug</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">child_pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">child_pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">ppid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getppid</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_ATTACH</span><span class="p">,</span><span class="w"> </span><span class="n">ppid</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">waitpid</span><span class="p">(</span><span class="n">ppid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_CONT</span><span class="p">,</span><span class="w"> </span><span class="n">ppid</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">waitpid</span><span class="p">(</span><span class="n">ppid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WIFSTOPPED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_CONT</span><span class="p">,</span><span class="w"> </span><span class="n">ppid</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// Process has exited</span>
<span class="w">                    </span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">pthread_t</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* Start the monitoring thread */</span><span class="w"></span>
<span class="w">        </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">monitor_pid</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">JNIEXPORT</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">JNICALL</span><span class="w"></span>
<span class="n">Java_sg_vantagepoint_antidebug_MainActivity_antidebug</span><span class="p">(</span><span class="n">JNIEnv</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">jobject</span><span class="w"> </span><span class="n">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">anti_debug</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Again, we pack this into an Android app to see if it works. Just as before, two processes show up when we run the app's debug build.</p>
<div class="highlight"><pre><span></span><code>root@android:/ <span class="c1"># ps | grep -I anti-debug</span>
u0_a152   <span class="m">20267</span> <span class="m">201</span>   <span class="m">1552508</span> <span class="m">56796</span> ffffffff b6e0f124 S sg.vantagepoint.anti-debug
u0_a152   <span class="m">20301</span> <span class="m">20267</span> <span class="m">1495192</span> <span class="m">33980</span> c019a3ac b6e0ee5c S sg.vantagepoint.anti-debug
</code></pre></div>
<p>However, if we terminate the child process at this point, the parent exits as well:</p>
<div class="highlight"><pre><span></span><code>root@android:/ <span class="c1"># kill -9 20301</span>
<span class="m">130</span><span class="p">|</span>root@hammerhead:/ <span class="c1"># cd /data/local/tmp</span>
root@android:/ <span class="c1"># ./gdbserver --attach localhost:12345 20267</span>
gdbserver: unable to open /proc file <span class="s1">&#39;/proc/20267/status&#39;</span>
Cannot attach to lwp <span class="m">20267</span>: No such file or directory <span class="o">(</span><span class="m">2</span><span class="o">)</span>
Exiting
</code></pre></div>
<p>To bypass this, we must modify the app's behavior slightly (the easiest ways to do so are patching the call to <code>_exit</code> with NOPs and hooking the function <code>_exit</code> in <code>libc.so</code>). At this point, we have entered the proverbial "arms race": implementing more intricate forms of this defense as well as bypassing it are always possible.</p>
<h3 id="bypassing-debugger-detection">Bypassing Debugger Detection<a class="headerlink" href="#bypassing-debugger-detection" title="Permanent link">&para;</a></h3>
<p>There's no generic way to bypass anti-debugging: the best method depends on the particular mechanism(s) used to prevent or detect debugging and the other defenses in the overall protection scheme. For example, if there are no integrity checks or you've already deactivated them, patching the app might be the easiest method. In other cases, a hooking framework or kernel modules might be preferable.
The following methods describe different approaches to bypass debugger detection:</p>
<ul>
<li>Patching the anti-debugging functionality: Disable the unwanted behavior by simply overwriting it with NOP instructions. Note that more complex patches may be required if the anti-debugging mechanism is well designed.</li>
<li>Using Frida or Xposed to hook APIs on the Java and native layers: manipulate the return values of functions such as <code>isDebuggable</code> and <code>isDebuggerConnected</code> to hide the debugger.</li>
<li>Changing the environment: Android is an open environment. If nothing else works, you can modify the operating system to subvert the assumptions the developers made when designing the anti-debugging tricks.</li>
</ul>
<h4 id="bypassing-example-uncrackable-app-for-android-level-2">Bypassing Example: UnCrackable App for Android Level 2<a class="headerlink" href="#bypassing-example-uncrackable-app-for-android-level-2" title="Permanent link">&para;</a></h4>
<p>When dealing with obfuscated apps, you'll often find that developers purposely "hide away" data and functionality in native libraries. You'll find an example of this in level 2 of the "UnCrackable App for Android".</p>
<p>At first glance, the code looks like the prior challenge. A class called <code>CodeCheck</code> is responsible for verifying the code entered by the user. The actual check appears to occur in the <code>bar</code> method, which is declared as a <em>native</em> method.</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">sg.vantagepoint.uncrackable2</span><span class="p">;</span><span class="w"></span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CodeCheck</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">CodeCheck</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">super</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">arg2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">bar</span><span class="p">(</span><span class="n">arg2</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">native</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">bar</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">arg1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">loadLibrary</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Please see <a href="https://github.com/OWASP/owasp-mstg/tree/master/Crackmes#uncrackable-app-for-android-level-2" title="Solutions Android Crackme Level 2">different proposed solutions for the Android Crackme Level 2</a> in GitHub.</p>
<h3 id="effectiveness-assessment_1">Effectiveness Assessment<a class="headerlink" href="#effectiveness-assessment_1" title="Permanent link">&para;</a></h3>
<p>Check for anti-debugging mechanisms, including the following criteria:</p>
<ul>
<li>Attaching jdb and ptrace-based debuggers fails or causes the app to terminate or malfunction.</li>
<li>Multiple detection methods are scattered throughout the app's source code (as opposed to their all being in a single method or function).</li>
<li>The anti-debugging defenses operate on multiple API layers (Java, native library functions, assembler/system calls).</li>
<li>The mechanisms are somehow original (as opposed to being copied and pasted from StackOverflow or other sources).</li>
</ul>
<p>Work on bypassing the anti-debugging defenses and answer the following questions:</p>
<ul>
<li>Can the mechanisms be bypassed trivially (e.g., by hooking a single API function)?</li>
<li>How difficult is identifying the anti-debugging code via static and dynamic analysis?</li>
<li>Did you need to write custom code to disable the defenses? How much time did you need?</li>
<li>What is your subjective assessment of the difficulty of bypassing the mechanisms?</li>
</ul>
<p>If anti-debugging mechanisms are missing or too easily bypassed, make suggestions in line with the effectiveness criteria above. These suggestions may include adding more detection mechanisms and better integration of existing mechanisms with other defenses.</p>
<h2 id="testing-file-integrity-checks-mstg-resilience-3">Testing File Integrity Checks (MSTG-RESILIENCE-3)<a class="headerlink" href="#testing-file-integrity-checks-mstg-resilience-3" title="Permanent link">&para;</a></h2>
<h3 id="overview_2">Overview<a class="headerlink" href="#overview_2" title="Permanent link">&para;</a></h3>
<p>There are two topics related to file integrity:</p>
<ol>
<li><em>Code integrity checks:</em> In the "<a href="../0x05c-Reverse-Engineering-and-Tampering/">Tampering and Reverse Engineering on Android</a>" chapter, we discussed Android's APK code signature check. We also saw that determined reverse engineers can easily bypass this check by re-packaging and re-signing an app. To make this bypassing process more involved, a protection scheme can be augmented with CRC checks on the app bytecode, native libraries, and important data files. These checks can be implemented on both the Java and the native layer. The idea is to have additional controls in place so that the app only runs correctly in its unmodified state, even if the code signature is valid.</li>
<li><em>The file storage integrity checks:</em> The integrity of files that the application stores on the SD card or public storage and the integrity of key-value pairs that are stored in <code>SharedPreferences</code> should be protected.</li>
</ol>
<h4 id="sample-implementation-application-source-code">Sample Implementation - Application Source Code<a class="headerlink" href="#sample-implementation-application-source-code" title="Permanent link">&para;</a></h4>
<p>Integrity checks often calculate a checksum or hash over selected files. Commonly protected files include</p>
<ul>
<li>AndroidManifest.xml,</li>
<li>class files *.dex,</li>
<li>native libraries (*.so).</li>
</ul>
<p>The following <a href="https://androidcracking.blogspot.com/2011/06/anti-tampering-with-crc-check.html" title="anti-tampering with crc check">sample implementation from the Android Cracking blog</a> calculates a CRC over <code>classes.dex</code> and compares it to the expected value.</p>
<div class="highlight"><pre><span></span><code><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">crcTest</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">modified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="c1">// required dex crc value stored as a text string.</span><span class="w"></span>
<span class="w"> </span><span class="c1">// it could be any invisible layout element</span><span class="w"></span>
<span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">dexCrc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">parseLong</span><span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="na">MyContext</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">string</span><span class="p">.</span><span class="na">dex_crc</span><span class="p">));</span><span class="w"></span>

<span class="w"> </span><span class="n">ZipFile</span><span class="w"> </span><span class="n">zf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ZipFile</span><span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="na">MyContext</span><span class="p">.</span><span class="na">getPackageCodePath</span><span class="p">());</span><span class="w"></span>
<span class="w"> </span><span class="n">ZipEntry</span><span class="w"> </span><span class="n">ze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zf</span><span class="p">.</span><span class="na">getEntry</span><span class="p">(</span><span class="s">&quot;classes.dex&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ze</span><span class="p">.</span><span class="na">getCrc</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dexCrc</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// dex has been modified</span><span class="w"></span>
<span class="w">  </span><span class="n">modified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// dex not tampered with</span><span class="w"></span>
<span class="w">  </span><span class="n">modified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h4 id="sample-implementation-storage">Sample Implementation - Storage<a class="headerlink" href="#sample-implementation-storage" title="Permanent link">&para;</a></h4>
<p>When providing integrity on the storage itself, you can either create an HMAC over a given key-value pair (as for the Android <code>SharedPreferences</code>) or create an HMAC over a complete file that's provided by the file system.</p>
<p>When using an HMAC, you can <a href="https://web.archive.org/web/20210804035343/https://cseweb.ucsd.edu/~mihir/papers/oem.html" title="Authenticated Encryption: Relations among notions and analysis of the generic composition paradigm">use a bouncy castle implementation or the AndroidKeyStore to HMAC the given content</a>.</p>
<p>Complete the following procedure when generating an HMAC with BouncyCastle:</p>
<ol>
<li>Make sure BouncyCastle or SpongyCastle is registered as a security provider.</li>
<li>Initialize the HMAC with a key (which can be stored in a keystore).</li>
<li>Get the byte array of the content that needs an HMAC.</li>
<li>Call <code>doFinal</code> on the HMAC with the bytecode.</li>
<li>Append the HMAC to the bytearray obtained in step 3.</li>
<li>Store the result of step 5.</li>
</ol>
<p>Complete the following procedure when verifying the HMAC with BouncyCastle:</p>
<ol>
<li>Make sure that BouncyCastle or SpongyCastle is registered as a security provider.</li>
<li>Extract the message and the HMAC-bytes as separate arrays.</li>
<li>Repeat steps 1-4 of the procedure for generating an HMAC.</li>
<li>Compare the extracted HMAC-bytes to the result of step 3.</li>
</ol>
<p>When generating the HMAC based on the <a href="https://developer.android.com/training/articles/keystore.html" title="Android Keystore">Android Keystore</a>, then it is best to only do this for Android 6.0 (API level 23) and higher.</p>
<p>The following is a convenient HMAC implementation without <code>AndroidKeyStore</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="n">HMACWrapper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">HMAC_512</span><span class="p">(</span><span class="s">&quot;HMac-SHA512&quot;</span><span class="p">),</span><span class="w"> </span><span class="c1">//please note that this is the spec for the BC provider</span><span class="w"></span>
<span class="w">    </span><span class="n">HMAC_256</span><span class="p">(</span><span class="s">&quot;HMac-SHA256&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">algorithm</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="nf">HMACWrapper</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">algorithm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">algorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">algorithm</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Mac</span><span class="w"> </span><span class="nf">createHMAC</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">SecretKey</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Mac</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mac</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">algorithm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BC&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">SecretKeySpec</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecretKeySpec</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="na">getKey</span><span class="p">().</span><span class="na">getEncoded</span><span class="p">(),</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">algorithm</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">secret</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">NoSuchProviderException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InvalidKeyException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">NoSuchAlgorithmException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">//handle them</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">hmac</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">SecretKey</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Mac</span><span class="w"> </span><span class="n">mac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">createHMAC</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mac</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">verify</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">messageWithHMAC</span><span class="p">,</span><span class="w"> </span><span class="n">SecretKey</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Mac</span><span class="w"> </span><span class="n">mac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">createHMAC</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractChecksum</span><span class="p">(</span><span class="n">messageWithHMAC</span><span class="p">,</span><span class="w"> </span><span class="n">mac</span><span class="p">.</span><span class="na">getMacLength</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractMessage</span><span class="p">(</span><span class="n">messageWithHMAC</span><span class="p">,</span><span class="w"> </span><span class="n">mac</span><span class="p">.</span><span class="na">getMacLength</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">calculatedChecksum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">hmac</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checksum</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">calculatedChecksum</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">checksum</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">calculatedChecksum</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">diff</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">checksum</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">calculatedChecksum</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">diff</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">extractMessage</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">messageWithHMAC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Mac</span><span class="w"> </span><span class="n">hmac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">createHMAC</span><span class="p">(</span><span class="n">SecretKey</span><span class="p">.</span><span class="na">newKey</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">extractMessage</span><span class="p">(</span><span class="n">messageWithHMAC</span><span class="p">,</span><span class="w"> </span><span class="n">hmac</span><span class="p">.</span><span class="na">getMacLength</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">extractMessage</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">checksumLength</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">checksumLength</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">body</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">checksumLength</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">length</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">message</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">extractChecksum</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">checksumLength</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">checksumLength</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">checksum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">checksumLength</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">checksumLength</span><span class="p">,</span><span class="w"> </span><span class="n">checksum</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">checksumLength</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">checksum</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Security</span><span class="p">.</span><span class="na">addProvider</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">BouncyCastleProvider</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Another way to provide integrity is to sign the byte array you obtained and add the signature to the original byte array.</p>
<h4 id="bypassing-file-integrity-checks">Bypassing File Integrity Checks<a class="headerlink" href="#bypassing-file-integrity-checks" title="Permanent link">&para;</a></h4>
<h5 id="bypassing-the-application-source-integrity-checks">Bypassing the application-source integrity checks<a class="headerlink" href="#bypassing-the-application-source-integrity-checks" title="Permanent link">&para;</a></h5>
<ol>
<li>Patch the anti-debugging functionality. Disable the unwanted behavior by simply overwriting the associated bytecode or native code with NOP instructions.</li>
<li>Use Frida or Xposed to hook file system APIs on the Java and native layers. Return a handle to the original file instead of the modified file.</li>
<li>Use the kernel module to intercept file-related system calls. When the process attempts to open the modified file, return a file descriptor for the unmodified version of the file.</li>
</ol>
<p>Refer to the "<a href="../0x05c-Reverse-Engineering-and-Tampering/">Tampering and Reverse Engineering on Android</a>" chapter for examples of patching, code injection, and kernel modules.</p>
<h5 id="bypassing-the-storage-integrity-checks">Bypassing the storage integrity checks<a class="headerlink" href="#bypassing-the-storage-integrity-checks" title="Permanent link">&para;</a></h5>
<ol>
<li>Retrieve the data from the device, as described in the "<a href="#testing-device-binding-mstg-resilience-10" title="Testing Device Binding">Testing Device Binding</a>" section.</li>
<li>Alter the retrieved data and then put it back into storage.</li>
</ol>
<h3 id="effectiveness-assessment_2">Effectiveness Assessment<a class="headerlink" href="#effectiveness-assessment_2" title="Permanent link">&para;</a></h3>
<h4 id="for-application-source-integrity-checks">For application-source integrity checks<a class="headerlink" href="#for-application-source-integrity-checks" title="Permanent link">&para;</a></h4>
<p>Run the app in an unmodified state and make sure that everything works. Apply simple patches to <code>classes.dex</code> and any .so libraries in the app package. Re-package and re-sign the app as described in the "Basic Security Testing" chapter, then run the app. The app should detect the modification and respond in some way. At the very least, the app should alert the user and/or terminate. Work on bypassing the defenses and answer the following questions:</p>
<ul>
<li>Can the mechanisms be bypassed trivially (e.g., by hooking a single API function)?</li>
<li>How difficult is identifying the anti-debugging code via static and dynamic analysis?</li>
<li>Did you need to write custom code to disable the defenses? How much time did you need?</li>
<li>What is your assessment of the difficulty of bypassing the mechanisms?</li>
</ul>
<h4 id="for-storage-integrity-checks">For storage integrity checks<a class="headerlink" href="#for-storage-integrity-checks" title="Permanent link">&para;</a></h4>
<p>An approach similar to that for application-source integrity checks applies. Answer the following questions:</p>
<ul>
<li>Can the mechanisms be bypassed trivially (e.g., by changing the contents of a file or a key-value)?</li>
<li>How difficult is getting the HMAC key or the asymmetric private key?</li>
<li>Did you need to write custom code to disable the defenses? How much time did you need?</li>
<li>What is your assessment of the difficulty of bypassing the mechanisms?</li>
</ul>
<h2 id="testing-reverse-engineering-tools-detection-mstg-resilience-4">Testing Reverse Engineering Tools Detection (MSTG-RESILIENCE-4)<a class="headerlink" href="#testing-reverse-engineering-tools-detection-mstg-resilience-4" title="Permanent link">&para;</a></h2>
<h3 id="overview_3">Overview<a class="headerlink" href="#overview_3" title="Permanent link">&para;</a></h3>
<p>The presence of tools, frameworks and apps commonly used by reverse engineers may indicate an attempt to reverse engineer the app. Some of these tools can only run on a rooted device, while others force the app into debugging mode or depend on starting a background service on the mobile phone. Therefore, there are different ways that an app may implement to detect a reverse engineering attack and react to it, e.g. by terminating itself.</p>
<h3 id="detection-methods">Detection Methods<a class="headerlink" href="#detection-methods" title="Permanent link">&para;</a></h3>
<p>You can detect popular reverse engineering tools that have been installed in an unmodified form by looking for associated application packages, files, processes, or other tool-specific modifications and artifacts. In the following examples, we'll discuss different ways to detect the Frida instrumentation framework, which is used extensively in this guide. Other tools, such as Substrate and Xposed, can be detected similarly. Note that DBI/injection/hooking tools can often be detected implicitly, through runtime integrity checks, which are discussed below.</p>
<p>For instance, in its default configuration on a rooted device, Frida runs on the device as frida-server. When you explicitly attach to a target app (e.g. via frida-trace or the Frida REPL), Frida injects a frida-agent into the memory of the app. Therefore, you may expect to find it there after attaching to the app (and not before). If you check <code>/proc/&lt;pid&gt;/maps</code> you'll find the frida-agent as frida-agent-64.so:</p>
<div class="highlight"><pre><span></span><code>bullhead:/ <span class="c1"># cat /proc/18370/maps | grep -i frida</span>
71b6bd6000-71b7d62000 r-xp  /data/local/tmp/re.frida.server/frida-agent-64.so
71b7d7f000-71b7e06000 r--p  /data/local/tmp/re.frida.server/frida-agent-64.so
71b7e06000-71b7e28000 rw-p  /data/local/tmp/re.frida.server/frida-agent-64.so
</code></pre></div>
<p>The other method (which also works for non-rooted devices) consists of embedding a <a href="https://www.frida.re/docs/gadget/" title="Frida Gadget">frida-gadget</a> into the APK and <em>forcing</em> the app to load it as one of its native libraries. If you inspect the app memory maps after starting the app (no need to attach explicitly to it) you'll find the embedded frida-gadget as libfrida-gadget.so.</p>
<div class="highlight"><pre><span></span><code>bullhead:/ <span class="c1"># cat /proc/18370/maps | grep -i frida</span>

71b865a000-71b97f1000 r-xp  /data/app/sg.vp.owasp_mobile.omtg_android-.../lib/arm64/libfrida-gadget.so
71b9802000-71b988a000 r--p  /data/app/sg.vp.owasp_mobile.omtg_android-.../lib/arm64/libfrida-gadget.so
71b988a000-71b98ac000 rw-p  /data/app/sg.vp.owasp_mobile.omtg_android-.../lib/arm64/libfrida-gadget.so
</code></pre></div>
<p>Looking at these two <em>traces</em> that Frida <em>lefts behind</em>, you might already imagine that detecting those would be a trivial task. And actually, so trivial will be bypassing that detection. But things can get much more complicated. The following table shortly presents a set of some typical Frida detection methods and a short discussion on their effectiveness.</p>
<blockquote>
<p>Some of the following detection methods are presented in the article <a href="https://web.archive.org/web/20181227120751/http://www.vantagepoint.sg/blog/90-the-jiu-jitsu-of-detecting-frida" title="The Jiu-Jitsu of Detecting Frida">"The Jiu-Jitsu of Detecting Frida" by Berdhard Mueller</a> (archived). Please refer to it for more details and for example code snippets.</p>
</blockquote>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
<th>Discussion</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Checking the App Signature</strong></td>
<td>In order to embed the frida-gadget within the APK, it would need to be repackaged and resigned. You could check the signature of the APK when the app is starting (e.g. <a href="https://developer.android.com/reference/android/content/pm/PackageManager#GET_SIGNING_CERTIFICATES" title="GET_SIGNING_CERTIFICATES">GET_SIGNING_CERTIFICATES</a> since API level 28) and compare it to the one you pinned in your APK.</td>
<td>This is unfortunately too trivial to bypass, e.g. by patching the APK or performing system call hooking.</td>
</tr>
<tr>
<td><strong>Check The Environment For Related Artifacts</strong></td>
<td>Artifacts can be package files, binaries, libraries, processes, and temporary files. For Frida, this could be the frida-server running in the target (rooted) system (the daemon responsible for exposing Frida over TCP). Inspect the running services (<a href="https://developer.android.com/reference/android/app/ActivityManager.html#getRunningServices%28int%29" title="getRunningServices"><code>getRunningServices</code></a>) and processes (<code>ps</code>) searching for one whose name is "frida-server". You could also walk through the list of loaded libraries and check for suspicious ones (e.g. those including "frida" in their names).</td>
<td>Since Android 7.0 (API level 24), inspecting the running services/processes won't show you daemons like the frida-server as it is not being started by the app itself. Even if it would be possible, bypassing this would be as easy just renaming the corresponding Frida artifact (frida-server/frida-gadget/frida-agent).</td>
</tr>
<tr>
<td><strong>Checking For Open TCP Ports</strong></td>
<td>The frida-server process binds to TCP port 27042 by default. Check whether this port is open is another method of detecting the daemon.</td>
<td>This method detects frida-server in its default mode, but the listening port can be changed via a command line argument, so bypassing this is a little too trivial.</td>
</tr>
<tr>
<td><strong>Checking For Ports Responding To D-Bus Auth</strong></td>
<td><code>frida-server</code> uses the D-Bus protocol to communicate, so you can expect it to respond to D-Bus AUTH. Send a D-Bus AUTH message to every open port and check for an answer, hoping that <code>frida-server</code> will reveal itself.</td>
<td>This is a fairly robust method of detecting <code>frida-server</code>, but Frida offers alternative modes of operation that don't require frida-server.</td>
</tr>
<tr>
<td><strong>Scanning Process Memory for Known Artifacts</strong></td>
<td>Scan the memory for artifacts found in Frida's libraries, e.g. the string "LIBFRIDA" present in all versions of frida-gadget and frida-agent. For example, use <code>Runtime.getRuntime().exec</code> and iterate through the memory mappings listed in <code>/proc/self/maps</code> or <code>/proc/&lt;pid&gt;/maps</code> (depending on the Android version) searching for the string.</td>
<td>This method is a bit more effective, and it is difficult to bypass with Frida only, especially if some obfuscation has been added and if multiple artifacts are being scanned. However, the chosen artifacts might be patched in the Frida binaries. Find the source code on <a href="https://github.com/b-mueller/frida-detection-demo/blob/master/AntiFrida/app/src/main/cpp/native-lib.cpp" title="frida-detection-demo">Berdhard Mueller's GitHub</a>.</td>
</tr>
</tbody>
</table>
<p>Please remember that this table is far from exhaustive. We could start talking about <a href="https://en.wikipedia.org/wiki/Named_pipe" title="Named Pipes">named pipes</a> (used by frida-server for external communication), detecting <a href="https://en.wikipedia.org/wiki/Trampoline_%28computing%29" title="Trampolines">trampolines</a> (indirect jump vectors inserted at the prologue of functions), which would <em>help</em> detecting Substrate or Frida's Interceptor but, for example, won't be effective against Frida's Stalker; and many other, more or less, effective detection methods. Each of them will depend on whether you're using a rooted device, the specific version of the rooting method and/or the version of the tool itself. Further, the app can try to make it harder to detect the implemented protection mechanisms by using various obfuscation techniques, as discussed below in section "<a href="#testing-obfuscation-mstg-resilience-9" title="Testing Resiliency Against Reverse Engineering">Testing Resiliency Against Reverse Engineering</a>". At the end, this is part of the cat and mouse game of protecting data being processed on an untrusted environment (an app running in the user device).</p>
<blockquote>
<p>It is important to note that these controls are only increasing the complexity of the reverse engineering process. If used, the best approach is to combine the controls cleverly instead of using them individually. However, none of them can assure a 100% effectiveness, as the reverse engineer will always have full access to the device and will therefore always win! You also have to consider that integrating some of the controls into your app might increase the complexity of your app and even have an impact on its performance.</p>
</blockquote>
<h3 id="effectiveness-assessment_3">Effectiveness Assessment<a class="headerlink" href="#effectiveness-assessment_3" title="Permanent link">&para;</a></h3>
<p>Launch the app with various reverse engineering tools and frameworks installed in your test device. Include at least the following: Frida, Xposed, Substrate for Android, RootCloak, Android SSL Trust Killer.</p>
<p>The app should respond in some way to the presence of those tools. For example by:</p>
<ul>
<li>Alerting the user and asking for accepting liability.</li>
<li>Preventing execution by gracefully terminating.</li>
<li>Securely wiping any sensitive data stored on the device.</li>
<li>Reporting to a backend server, e.g, for fraud detection.</li>
</ul>
<p>Next, work on bypassing the detection of the reverse engineering tools and answer the following questions:</p>
<ul>
<li>Can the mechanisms be bypassed trivially (e.g., by hooking a single API function)?</li>
<li>How difficult is identifying the anti reverse engineering code via static and dynamic analysis?</li>
<li>Did you need to write custom code to disable the defenses? How much time did you need?</li>
<li>What is your assessment of the difficulty of bypassing the mechanisms?</li>
</ul>
<p>The following steps should guide you when bypassing detection of reverse engineering tools:</p>
<ol>
<li>Patch the anti reverse engineering functionality. Disable the unwanted behavior by simply overwriting the associated bytecode or native code with NOP instructions.</li>
<li>Use Frida or Xposed to hook file system APIs on the Java and native layers. Return a handle to the original file, not the modified file.</li>
<li>Use a kernel module to intercept file-related system calls. When the process attempts to open the modified file, return a file descriptor for the unmodified version of the file.</li>
</ol>
<p>Refer to the "<a href="../0x05c-Reverse-Engineering-and-Tampering/">Tampering and Reverse Engineering on Android</a>" chapter for examples of patching, code injection, and kernel modules.</p>
<h2 id="testing-emulator-detection-mstg-resilience-5">Testing Emulator Detection (MSTG-RESILIENCE-5)<a class="headerlink" href="#testing-emulator-detection-mstg-resilience-5" title="Permanent link">&para;</a></h2>
<h3 id="overview_4">Overview<a class="headerlink" href="#overview_4" title="Permanent link">&para;</a></h3>
<p>In the context of anti-reversing, the goal of emulator detection is to increase the difficulty of running the app on an emulated device, which impedes some tools and techniques reverse engineers like to use. This increased difficulty forces the reverse engineer to defeat the emulator checks or utilize the physical device, thereby barring the access required for large-scale device analysis.</p>
<h3 id="emulator-detection-examples">Emulator Detection Examples<a class="headerlink" href="#emulator-detection-examples" title="Permanent link">&para;</a></h3>
<p>There are several indicators that the device in question is being emulated. Although all these API calls can be hooked, these indicators provide a modest first line of defense.</p>
<p>The first set of indicators are in the file <code>build.prop</code>.</p>
<div class="highlight"><pre><span></span><code>API Method          Value           Meaning
Build.ABI           armeabi         possibly emulator
BUILD.ABI2          unknown         possibly emulator
Build.BOARD         unknown         emulator
Build.Brand         generic         emulator
Build.DEVICE        generic         emulator
Build.FINGERPRINT   generic         emulator
Build.Hardware      goldfish        emulator
Build.Host          android-test    possibly emulator
Build.ID            FRF91           emulator
Build.MANUFACTURER  unknown         emulator
Build.MODEL         sdk             emulator
Build.PRODUCT       sdk             emulator
Build.RADIO         unknown         possibly emulator
Build.SERIAL        null            emulator
Build.USER          android-build   emulator
</code></pre></div>
<p>You can edit the file <code>build.prop</code> on a rooted Android device or modify it while compiling AOSP from source. Both techniques will allow you to bypass the static string checks above.</p>
<p>The next set of static indicators utilize the Telephony manager. All Android emulators have fixed values that this API can query.</p>
<div class="highlight"><pre><span></span><code>API                                                     Value                   Meaning
TelephonyManager.getDeviceId()                          0&#39;s                     emulator
TelephonyManager.getLine1 Number()                      155552155               emulator
TelephonyManager.getNetworkCountryIso()                 us                      possibly emulator
TelephonyManager.getNetworkType()                       3                       possibly emulator
TelephonyManager.getNetworkOperator().substring(0,3)    310                     possibly emulator
TelephonyManager.getNetworkOperator().substring(3)      260                     possibly emulator
TelephonyManager.getPhoneType()                         1                       possibly emulator
TelephonyManager.getSimCountryIso()                     us                      possibly emulator
TelephonyManager.getSimSerial Number()                  89014103211118510720    emulator
TelephonyManager.getSubscriberId()                      310260000000000         emulator
TelephonyManager.getVoiceMailNumber()                   15552175049             emulator
</code></pre></div>
<p>Keep in mind that a hooking framework, such as Xposed or Frida, can hook this API to provide false data.</p>
<h3 id="bypassing-emulator-detection">Bypassing Emulator Detection<a class="headerlink" href="#bypassing-emulator-detection" title="Permanent link">&para;</a></h3>
<ol>
<li>Patch the emulator detection functionality. Disable the unwanted behavior by simply overwriting the associated bytecode or native code with NOP instructions.</li>
<li>Use Frida or Xposed APIs to hook file system APIs on the Java and native layers. Return innocent-looking values (preferably taken from a real device) instead of the telltale emulator values. For example, you can override the <code>TelephonyManager.getDeviceID</code> method to return an IMEI value.</li>
</ol>
<p>Refer to the "<a href="../0x05c-Reverse-Engineering-and-Tampering/">Tampering and Reverse Engineering on Android</a>" chapter for examples of patching, code injection, and kernel modules.</p>
<h3 id="effectiveness-assessment_4">Effectiveness Assessment<a class="headerlink" href="#effectiveness-assessment_4" title="Permanent link">&para;</a></h3>
<p>Install and run the app in the emulator. The app should detect that it is being executed in an emulator and terminate or refuse to execute the functionality that's meant to be protected.</p>
<p>Work on bypassing the defenses and answer the following questions:</p>
<ul>
<li>How difficult is identifying the emulator detection code via static and dynamic analysis?</li>
<li>Can the detection mechanisms be bypassed trivially (e.g., by hooking a single API function)?</li>
<li>Did you need to write custom code to disable the anti-emulation feature(s)? How much time did you need?</li>
<li>What is your assessment of the difficulty of bypassing the mechanisms?</li>
</ul>
<h2 id="testing-runtime-integrity-checks-mstg-resilience-6">Testing Runtime Integrity Checks (MSTG-RESILIENCE-6)<a class="headerlink" href="#testing-runtime-integrity-checks-mstg-resilience-6" title="Permanent link">&para;</a></h2>
<h3 id="overview_5">Overview<a class="headerlink" href="#overview_5" title="Permanent link">&para;</a></h3>
<p>Controls in this category verify the integrity of the app's memory space to defend the app against memory patches applied during runtime. Such patches include unwanted changes to binary code, bytecode, function pointer tables, and important data structures, as well as rogue code loaded into process memory. Integrity can be verified by:</p>
<ol>
<li>comparing the contents of memory or a checksum over the contents to good values,</li>
<li>searching memory for the signatures of unwanted modifications.</li>
</ol>
<p>There's some overlap with the category "detecting reverse engineering tools and frameworks", and, in fact, we demonstrated the signature-based approach in that chapter when we showed how to search process memory for Frida-related strings. Below are a few more examples of various kinds of integrity monitoring.</p>
<h4 id="runtime-integrity-check-examples">Runtime Integrity Check Examples<a class="headerlink" href="#runtime-integrity-check-examples" title="Permanent link">&para;</a></h4>
<h5 id="detecting-tampering-with-the-java-runtime">Detecting tampering with the Java Runtime**<a class="headerlink" href="#detecting-tampering-with-the-java-runtime" title="Permanent link">&para;</a></h5>
<p>This detection code is from the <a href="https://d3adend.org/blog/?p=589" title="dead &amp;&amp; end blog - Android Anti-Hooking Techniques in Java">dead &amp;&amp; end blog</a>.</p>
<div class="highlight"><pre><span></span><code><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">catch</span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">zygoteInitCallCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">StackTraceElement</span><span class="w"> </span><span class="n">stackTraceElement</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getStackTrace</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">stackTraceElement</span><span class="p">.</span><span class="na">getClassName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;com.android.internal.os.ZygoteInit&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">zygoteInitCallCount</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">zygoteInitCallCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">wtf</span><span class="p">(</span><span class="s">&quot;HookDetection&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Substrate is active on the device.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">stackTraceElement</span><span class="p">.</span><span class="na">getClassName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;com.saurik.substrate.MS$2&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">stackTraceElement</span><span class="p">.</span><span class="na">getMethodName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;invoked&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Log</span><span class="p">.</span><span class="na">wtf</span><span class="p">(</span><span class="s">&quot;HookDetection&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;A method on the stack trace has been hooked using Substrate.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">stackTraceElement</span><span class="p">.</span><span class="na">getClassName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;de.robv.android.xposed.XposedBridge&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">stackTraceElement</span><span class="p">.</span><span class="na">getMethodName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;main&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Log</span><span class="p">.</span><span class="na">wtf</span><span class="p">(</span><span class="s">&quot;HookDetection&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Xposed is active on the device.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">stackTraceElement</span><span class="p">.</span><span class="na">getClassName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;de.robv.android.xposed.XposedBridge&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">        </span><span class="n">stackTraceElement</span><span class="p">.</span><span class="na">getMethodName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;handleHookedMethod&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Log</span><span class="p">.</span><span class="na">wtf</span><span class="p">(</span><span class="s">&quot;HookDetection&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;A method on the stack trace has been hooked using Xposed.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h5 id="detecting-native-hooks">Detecting Native Hooks<a class="headerlink" href="#detecting-native-hooks" title="Permanent link">&para;</a></h5>
<p>By using ELF binaries, native function hooks can be installed by overwriting function pointers in memory (e.g., Global Offset Table or PLT hooking) or patching parts of the function code itself (inline hooking). Checking the integrity of the respective memory regions is one way to detect this kind of hook.</p>
<p>The Global Offset Table (GOT) is used to resolve library functions. During runtime, the dynamic linker patches this table with the absolute addresses of global symbols. <em>GOT hooks</em> overwrite the stored function addresses and redirect legitimate function calls to adversary-controlled code. This type of hook can be detected by enumerating the process memory map and verifying that each GOT entry points to a legitimately loaded library.</p>
<p>In contrast to GNU <code>ld</code>, which resolves symbol addresses only after they are needed for the first time (lazy binding), the Android linker resolves all external functions and writes the respective GOT entries immediately after a library is loaded (immediate binding). You can therefore expect all GOT entries to point to valid memory locations in the code sections of their respective libraries during runtime. GOT hook detection methods usually walk the GOT and verify this.</p>
<p><em>Inline hooks</em> work by overwriting a few instructions at the beginning or end of the function code. During runtime, this so-called trampoline redirects execution to the injected code. You can detect inline hooks by inspecting the prologues and epilogues of library functions for suspect instructions, such as far jumps to locations outside the library.</p>
<h3 id="bypass-and-effectiveness-assessment">Bypass and Effectiveness Assessment<a class="headerlink" href="#bypass-and-effectiveness-assessment" title="Permanent link">&para;</a></h3>
<p>Make sure that all file-based detection of reverse engineering tools is disabled. Then, inject code by using Xposed, Frida, and Substrate, and attempt to install native hooks and Java method hooks. The app should detect the "hostile" code in its memory and respond accordingly.</p>
<p>Work on bypassing the checks with the following techniques:</p>
<ol>
<li>Patch the integrity checks. Disable the unwanted behavior by overwriting the respective bytecode or native code with NOP instructions.</li>
<li>Use Frida or Xposed to hook the APIs used for detection and return fake values.</li>
</ol>
<p>Refer to the "<a href="../0x05c-Reverse-Engineering-and-Tampering/">Tampering and Reverse Engineering on Android</a>" chapter for examples of patching, code injection, and kernel modules.</p>
<h2 id="testing-obfuscation-mstg-resilience-9">Testing Obfuscation (MSTG-RESILIENCE-9)<a class="headerlink" href="#testing-obfuscation-mstg-resilience-9" title="Permanent link">&para;</a></h2>
<h3 id="overview_6">Overview<a class="headerlink" href="#overview_6" title="Permanent link">&para;</a></h3>
<p>Obfuscation is the process of transforming code and data to make it more difficult to comprehend. It is an integral part of every software protection scheme. What's important to understand is that obfuscation isn't something that can be simply turned on or off. Programs can be made incomprehensible, in whole or in part, in many ways and to different degrees.</p>
<p>In the test case "Make Sure That Free Security Features Are Activated (MSTG-CODE-9)" in chapter "Code Quality and Build Settings of Android Apps", we describe a few basic obfuscation techniques that are commonly used on Android with R8 and Pro-Guard.</p>
<h3 id="effectiveness-assessment_5">Effectiveness Assessment<a class="headerlink" href="#effectiveness-assessment_5" title="Permanent link">&para;</a></h3>
<p>Attempt to decompile the bytecode, disassemble any included library files and try to understand it. When doing so, consider the following:</p>
<ul>
<li>Obfuscation often carries a cost in runtime performance, therefore it might have been only applied to certain very specific parts of the code, typically those dealing with security and runtime protection.</li>
<li>Meaningful identifiers, such as class names, method names, and variable names, might have been discarded.</li>
<li>String resources and strings in binaries might have been encrypted.</li>
<li>Code and data related to the protected functionality might be encrypted, packed, or otherwise concealed.</li>
<li>For native code, <a href="https://man7.org/linux/man-pages/dir_section_3.html">libc APIs</a> (e.g open, read) might have been replaced with OS <a href="https://man7.org/linux/man-pages/man2/syscalls.2.html">syscalls</a>.</li>
<li>Additional obfuscation techniques such as <a href="https://github.com/obfuscator-llvm/obfuscator/wiki/Control-Flow-Flattening">"Control Flow Flattening"</a> or <a href="https://github.com/obfuscator-llvm/obfuscator/wiki/Bogus-Control-Flow">"Bogus Control Flow"</a> might have been applied using e.g. <a href="https://github.com/obfuscator-llvm/obfuscator" title="Obfuscator-LLVM">Obfuscator-LLVM</a>.</li>
</ul>
<p>Some of these techniques are discussed and analyzed in the blog post <a href="https://darvincitech.wordpress.com/2020/01/07/security-hardening-of-android-native-code/">"Security hardening of Android native code"</a> by Gautam Arvind.</p>
<p>For a more detailed assessment, you need a detailed understanding of the relevant threats and the obfuscation methods used. There are some tools such as <a href="https://github.com/rednaga/APKiD">APKiD</a> that might be able to give you some indications about the kind of obfuscators being used.</p>
<h2 id="testing-device-binding-mstg-resilience-10">Testing Device Binding (MSTG-RESILIENCE-10)<a class="headerlink" href="#testing-device-binding-mstg-resilience-10" title="Permanent link">&para;</a></h2>
<h3 id="overview_7">Overview<a class="headerlink" href="#overview_7" title="Permanent link">&para;</a></h3>
<p>The goal of device binding is to impede an attacker who tries to both copy an app and its state from device A to device B and continue executing the app on device B. After device A has been determined trustworthy, it may have more privileges than device B. These differential privileges should not change when an app is copied from device A to device B.</p>
<p>Before we describe the usable identifiers, let's quickly discuss how they can be used for binding. There are three methods that allow device binding:</p>
<ul>
<li>
<p>Augmenting the credentials used for authentication with device identifiers. This make sense if the application needs to re-authenticate itself and/or the user frequently.</p>
</li>
<li>
<p>Encrypting the data stored in the device with the key material which is strongly bound to the device can strengthen the device binding. The Android Keystore offers non-exportable private keys which we can use for this. When a malicious actor would extract such data from a device, it wouldn't be possible to decrypt the data, as the key is not accessible. Implementing this, takes the following steps:</p>
</li>
<li>
<p>Generate the key pair in the Android Keystore using <code>KeyGenParameterSpec</code> API.</p>
<div class="highlight"><pre><span></span><code><span class="c1">//Source: &lt;https://developer.android.com/reference/android/security/keystore/KeyGenParameterSpec.html&gt;</span><span class="w"></span>
<span class="n">KeyPairGenerator</span><span class="w"> </span><span class="n">keyPairGenerator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyPairGenerator</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">KEY_ALGORITHM_RSA</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AndroidKeyStore&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">keyPairGenerator</span><span class="p">.</span><span class="na">initialize</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">KeyGenParameterSpec</span><span class="p">.</span><span class="na">Builder</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="s">&quot;key1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">PURPOSE_DECRYPT</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="na">setDigests</span><span class="p">(</span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">DIGEST_SHA256</span><span class="p">,</span><span class="w"> </span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">DIGEST_SHA512</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="na">setEncryptionPaddings</span><span class="p">(</span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">ENCRYPTION_PADDING_RSA_OAEP</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="n">KeyPair</span><span class="w"> </span><span class="n">keyPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyPairGenerator</span><span class="p">.</span><span class="na">generateKeyPair</span><span class="p">();</span><span class="w"></span>
<span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;RSA/ECB/OAEPWithSHA-256AndMGF1Padding&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">DECRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">keyPair</span><span class="p">.</span><span class="na">getPrivate</span><span class="p">());</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>

<span class="c1">// The key pair can also be obtained from the Android Keystore any time as follows:</span><span class="w"></span>
<span class="n">KeyStore</span><span class="w"> </span><span class="n">keyStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyStore</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;AndroidKeyStore&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">keyStore</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="n">PrivateKey</span><span class="w"> </span><span class="n">privateKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PrivateKey</span><span class="p">)</span><span class="w"> </span><span class="n">keyStore</span><span class="p">.</span><span class="na">getKey</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="n">PublicKey</span><span class="w"> </span><span class="n">publicKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyStore</span><span class="p">.</span><span class="na">getCertificate</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">).</span><span class="na">getPublicKey</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>Generating a secret key for AES-GCM:</p>
<div class="highlight"><pre><span></span><code><span class="c1">//Source: &lt;https://developer.android.com/reference/android/security/keystore/KeyGenParameterSpec.html&gt;</span><span class="w"></span>
<span class="n">KeyGenerator</span><span class="w"> </span><span class="n">keyGenerator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyGenerator</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">KEY_ALGORITHM_AES</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AndroidKeyStore&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">keyGenerator</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">KeyGenParameterSpec</span><span class="p">.</span><span class="na">Builder</span><span class="p">(</span><span class="s">&quot;key2&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">PURPOSE_ENCRYPT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">PURPOSE_DECRYPT</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="na">setBlockModes</span><span class="p">(</span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">BLOCK_MODE_GCM</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="na">setEncryptionPaddings</span><span class="p">(</span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">ENCRYPTION_PADDING_NONE</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span><span class="w"></span>
<span class="n">SecretKey</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyGenerator</span><span class="p">.</span><span class="na">generateKey</span><span class="p">();</span><span class="w"></span>

<span class="c1">// The key can also be obtained from the Android Keystore any time as follows:</span><span class="w"></span>
<span class="n">KeyStore</span><span class="w"> </span><span class="n">keyStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyStore</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;AndroidKeyStore&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">keyStore</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SecretKey</span><span class="p">)</span><span class="w"> </span><span class="n">keyStore</span><span class="p">.</span><span class="na">getKey</span><span class="p">(</span><span class="s">&quot;key2&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>Encrypt the authentication data and other sensitive data stored by the application using a secret key through AES-GCM cipher and use device specific parameters such as Instance ID, etc. as associated data:</p>
<div class="highlight"><pre><span></span><code><span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;AES/GCM/NoPadding&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">final</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">nonce</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">GCM_NONCE_LENGTH</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="n">random</span><span class="p">.</span><span class="na">nextBytes</span><span class="p">(</span><span class="n">nonce</span><span class="p">);</span><span class="w"></span>
<span class="n">GCMParameterSpec</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GCMParameterSpec</span><span class="p">(</span><span class="n">GCM_TAG_LENGTH</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">nonce</span><span class="p">);</span><span class="w"></span>
<span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">ENCRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">spec</span><span class="p">);</span><span class="w"></span>
<span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">aad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&lt;deviceidentifierhere&gt;&quot;</span><span class="p">.</span><span class="na">getBytes</span><span class="p">();;</span><span class="w"></span>
<span class="n">cipher</span><span class="p">.</span><span class="na">updateAAD</span><span class="p">(</span><span class="n">aad</span><span class="p">);</span><span class="w"></span>
<span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">ENCRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">);</span><span class="w"></span>

<span class="c1">//use the cipher to encrypt the authentication data see 0x50e for more details.</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>Encrypt the secret key using the public key stored in Android Keystore and store the encrypted secret key in the private storage of the application.</p>
</li>
<li>
<p>Whenever authentication data such as access tokens or other sensitive data is required, decrypt the secret key using private key stored in Android Keystore and then use the decrypted secret key to decrypt the ciphertext.</p>
</li>
<li>
<p>Use token-based device authentication (Instance ID) to make sure that the same instance of the app is used.</p>
</li>
</ul>
<h3 id="static-analysis">Static Analysis<a class="headerlink" href="#static-analysis" title="Permanent link">&para;</a></h3>
<p>In the past, Android developers often relied on the <code>Settings.Secure.ANDROID_ID</code> (SSAID) and MAC addresses. This <a href="https://android-developers.googleblog.com/2017/04/changes-to-device-identifiers-in.html" title="Changes in the Android device identifiers">changed with the release of Android 8.0 (API level 26)</a>. As the MAC address is now often randomized when not connected to an access point and the SSAID is no longer a device bound ID. Instead, it became a value bound to the user, the device and the app signing key of the application which requests the SSAID.
In addition, there are new <a href="https://developer.android.com/training/articles/user-data-ids.html" title="Developer Android documentation - User data IDs">recommendations for identifiers</a> in Google's SDK documentation. Basically, Google recommends to:</p>
<ul>
<li>use the Advertising ID (<code>AdvertisingIdClient.Info</code>) when it comes to advertising -so that the user has the option to decline.</li>
<li>use the Instance ID (<code>FirebaseInstanceId</code>) for device identification.</li>
<li>use the SSAID only for fraud detection and for sharing state between apps signed by the same developer.</li>
</ul>
<p>Note that the Instance ID and the Advertising ID are not stable across device upgrades and device-resets. However, the Instance ID will at least allow to identify the current software installation on a device.</p>
<p>There are a few key terms you can look for when the source code is available:</p>
<ul>
<li>Unique identifiers that will no longer work:</li>
<li><code>Build.SERIAL</code> without <code>Build.getSerial</code></li>
<li><code>htc.camera.sensor.front_SN</code> for HTC devices</li>
<li><code>persist.service.bdroid.bdadd</code></li>
<li><code>Settings.Secure.bluetooth_address</code> or <code>WifiInfo.getMacAddress</code> from <code>WifiManager</code>, unless the system permission <code>LOCAL_MAC_ADDRESS</code> is enabled in the manifest.</li>
<li><code>ANDROID_ID</code> used only as an identifier. This will influence the binding quality over time for older devices.</li>
<li>The absence of Instance ID, <code>Build.SERIAL</code>, and the IMEI.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="n">TelephonyManager</span><span class="w"> </span><span class="n">tm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TelephonyManager</span><span class="p">)</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">TELEPHONY_SERVICE</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">String</span><span class="w"> </span><span class="n">IMEI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tm</span><span class="p">.</span><span class="na">getDeviceId</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<ul>
<li>The creation of private keys in the <code>AndroidKeyStore</code> using the <code>KeyPairGeneratorSpec</code> or <code>KeyGenParameterSpec</code> APIs.</li>
</ul>
<p>To be sure that the identifiers can be used, check <code>AndroidManifest.xml</code> for usage of the IMEI and <code>Build.Serial</code>. The file should contain the permission <code>&lt;uses-permission android:name="android.permission.READ_PHONE_STATE" /&gt;</code>.</p>
<blockquote>
<p>Apps for Android 8.0 (API level 26) will get the result "UNKNOWN" when they request <code>Build.Serial</code>.</p>
</blockquote>
<h3 id="dynamic-analysis">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis" title="Permanent link">&para;</a></h3>
<p>There are several ways to test the application binding:</p>
<h4 id="dynamic-analysis-with-an-emulator">Dynamic Analysis with an Emulator<a class="headerlink" href="#dynamic-analysis-with-an-emulator" title="Permanent link">&para;</a></h4>
<ol>
<li>Run the application on an emulator.</li>
<li>Make sure you can raise the trust in the application instance (e.g., authenticate in the app).</li>
<li>Retrieve the data from the emulator according to the following steps:</li>
<li>SSH into your simulator via an ADB shell.</li>
<li>Execute <code>run-as &lt;your app-id&gt;</code>. Your app-id is the package described in the AndroidManifest.xml.</li>
<li><code>chmod 777</code> the contents of cache and shared-preferences.</li>
<li>Exit the current user from the the app-id.</li>
<li>Copy the contents of <code>/data/data/&lt;your appid&gt;/cache</code> and <code>shared-preferences</code> to the SD card.</li>
<li>Use ADB or the DDMS to pull the contents.</li>
<li>Install the application on another emulator.</li>
<li>In the application's data folder, overwrite the data from step 3.</li>
<li>Copy the data from step 3 to the second emulator's SD card.</li>
<li>SSH into your simulator via an ADB shell.</li>
<li>Execute <code>run-as &lt;your app-id&gt;</code>. Your app-id is the package described in  <code>AndroidManifest.xml</code>.</li>
<li><code>chmod 777</code> the folder's cache and shared-preferences.</li>
<li>Copy the older contents of the SD card <code>to /data/data/&lt;your appid&gt;/cache</code> and <code>shared-preferences</code>.</li>
<li>Can you continue in an authenticated state? If so, binding may not be working properly.</li>
</ol>
<h4 id="google-instance-id">Google Instance ID<a class="headerlink" href="#google-instance-id" title="Permanent link">&para;</a></h4>
<p><a href="https://developers.google.com/instance-id/" title="Google Instance ID documentation">Google Instance ID</a> uses tokens to authenticate the running application instance. The moment the application is reset, uninstalled, etc., the Instance ID is reset, meaning that you'll have a new "instance" of the app.
Go through the following steps for Instance ID:</p>
<ol>
<li>
<p>Configure your Instance ID for the given application in your Google Developer Console. This includes managing the PROJECT_ID.</p>
</li>
<li>
<p>Setup Google Play services. In the file <code>build.gradle</code>, add</p>
<div class="highlight"><pre><span></span><code>apply plugin: &#39;com.android.application&#39;
    ...

    dependencies {
        compile &#39;com.google.android.gms:play-services-gcm:10.2.4&#39;
    }
</code></pre></div>
</li>
<li>
<p>Get an Instance ID.</p>
<div class="highlight"><pre><span></span><code><span class="n">String</span><span class="w"> </span><span class="n">iid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instance</span><span class="w"> </span><span class="n">ID</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="na">getId</span><span class="p">();</span><span class="w"></span>
<span class="c1">//now submit this iid to your server.</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>Generate a token.</p>
<div class="highlight"><pre><span></span><code><span class="n">String</span><span class="w"> </span><span class="n">authorizedEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PROJECT_ID</span><span class="p">;</span><span class="w"> </span><span class="c1">// Project id from Google Developer Console</span><span class="w"></span>
<span class="n">String</span><span class="w"> </span><span class="n">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;GCM&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// e.g. communicating using GCM, but you can use any</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// URL-safe characters up to a maximum of 1000, or</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// you can also leave it blank.</span><span class="w"></span>
<span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instance</span><span class="w"> </span><span class="n">ID</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="na">getToken</span><span class="p">(</span><span class="n">authorizedEntity</span><span class="p">,</span><span class="n">scope</span><span class="p">);</span><span class="w"></span>
<span class="c1">//now submit this token to the server.</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>Make sure that you can handle callbacks from Instance ID, in case of invalid device information, security issues, etc. This requires extending <code>Instance IDListenerService</code> and handling the callbacks there:</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyInstance</span><span class="w"> </span><span class="n">IDService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Instance</span><span class="w"> </span><span class="n">IDListenerService</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onTokenRefresh</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">refreshAllTokens</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">refreshAllTokens</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// assuming you have defined TokenList as</span><span class="w"></span>
<span class="w">    </span><span class="c1">// some generalized store for your tokens for the different scopes.</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Please note that for application validation having just one token with one scopes can be enough.</span><span class="w"></span>
<span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">TokenList</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tokenList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TokensList</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">Instance</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="n">iid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instance</span><span class="w"> </span><span class="n">ID</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">tokenItem</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">tokenList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">tokenItem</span><span class="p">.</span><span class="na">token</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">iid</span><span class="p">.</span><span class="na">getToken</span><span class="p">(</span><span class="n">tokenItem</span><span class="p">.</span><span class="na">authorizedEntity</span><span class="p">,</span><span class="n">tokenItem</span><span class="p">.</span><span class="na">scope</span><span class="p">,</span><span class="n">tokenItem</span><span class="p">.</span><span class="na">options</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// send this tokenItem.token to your server</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>Register the service in your Android manifest:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;service</span> <span class="na">android:name=</span><span class="s">&quot;.MyInstance IDService&quot;</span> <span class="na">android:exported=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;intent-filter&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;com.google.android.gms.iid.Instance ID&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/service&gt;</span>
</code></pre></div>
</li>
</ol>
<p>When you submit the Instance ID (iid) and the tokens to your server, you can use that server with the Instance ID Cloud Service to validate the tokens and the iid. When the iid or token seems invalid, you can trigger a safeguard procedure (e.g., informing the server of possible copying or security issues or removing the data from the app and asking for a re-registration).</p>
<p>Please note that <a href="https://firebase.google.com/docs/reference/android/com/google/firebase/iid/FirebaseInstanceId" title="Firebase Instance ID documentation">Firebase also supports Instance ID</a>.</p>
<h4 id="imei-serial">IMEI &amp; Serial<a class="headerlink" href="#imei-serial" title="Permanent link">&para;</a></h4>
<p>Google recommends not using these identifiers unless the application is at a high risk.</p>
<p>For Android devices before Android 8.0 (API level 26), you can request the serial as follows:</p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="n">String</span><span class="w"> </span><span class="n">serial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">os</span><span class="p">.</span><span class="na">Build</span><span class="p">.</span><span class="na">SERIAL</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>For devices running Android version O and later, you can request the device's serial as follows:</p>
<ol>
<li>
<p>Set the permission in your Android manifest:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.READ_PHONE_STATE&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span> <span class="nt">/&gt;</span>
</code></pre></div>
</li>
<li>
<p>Request the permission at runtime from the user: See <a href="https://developer.android.com/training/permissions/requesting.html" title="Request App Permissions">https://developer.android.com/training/permissions/requesting.html</a> for more details.</p>
</li>
<li>
<p>Get the serial:</p>
<div class="highlight"><pre><span></span><code><span class="n">String</span><span class="w"> </span><span class="n">serial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="na">os</span><span class="p">.</span><span class="na">Build</span><span class="p">.</span><span class="na">getSerial</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
</li>
</ol>
<p>Retrieve the IMEI:</p>
<ol>
<li>
<p>Set the required permission in your Android manifest:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.READ_PHONE_STATE&quot;</span> <span class="nt">/&gt;</span>
</code></pre></div>
</li>
<li>
<p>If you're using Android version Android 6 (API level 23) or later, request the permission at runtime from the user: See <a href="https://developer.android.com/training/permissions/requesting.html" title="Request App Permissions">https://developer.android.com/training/permissions/requesting.html</a> for more details.</p>
</li>
<li>
<p>Get the IMEI:</p>
<div class="highlight"><pre><span></span><code><span class="n">TelephonyManager</span><span class="w"> </span><span class="n">tm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TelephonyManager</span><span class="p">)</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">TELEPHONY_SERVICE</span><span class="p">);</span><span class="w"></span>
<span class="n">String</span><span class="w"> </span><span class="n">IMEI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tm</span><span class="p">.</span><span class="na">getDeviceId</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
</li>
</ol>
<h4 id="ssaid">SSAID<a class="headerlink" href="#ssaid" title="Permanent link">&para;</a></h4>
<p>Google recommends not using these identifiers unless the application is at a high risk. You can retrieve the SSAID as follows:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="n">String</span><span class="w"> </span><span class="n">SSAID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Settings</span><span class="p">.</span><span class="na">Secure</span><span class="p">.</span><span class="na">ANDROID_ID</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>The behavior of the SSAID and MAC addresses have <a href="https://android-developers.googleblog.com/2017/04/changes-to-device-identifiers-in.html" title="Changes in the Android device identifiers">changed since Android 8.0 (API level 26)</a>. In addition, there are <a href="https://developer.android.com/training/articles/user-data-ids.html" title="Developer Android documentation">new recommendations</a> for identifiers in Google's SDK documentation. Because of this new behavior, we recommend that developers not rely on the SSAID alone. The identifier has become less stable. For example, the SSAID may change after a factory reset or when the app is reinstalled after the upgrade to Android 8.0 (API level 26). There are devices that have the same <code>ANDROID_ID</code> and/or have an <code>ANDROID_ID</code> that can be overridden. Therefore it is better to encrypt the <code>ANDROID_ID</code> with a randomly generated key from the <code>AndroidKeyStore</code> using <code>AES_GCM</code> encryption. The encrypted <code>ANDROID_ID</code> should then be stored in the <code>SharedPreferences</code> (privately). The moment the app-signature changes, the application can check for a delta and register the new <code>ANDROID_ID</code>. The moment this changes without a new application signing key, it should indicate that something else is wrong.</p>
<h3 id="effectiveness-assessment_6">Effectiveness Assessment<a class="headerlink" href="#effectiveness-assessment_6" title="Permanent link">&para;</a></h3>
<p>There are a few key terms you can look for when the source code is available:</p>
<ul>
<li>Unique identifiers that will no longer work:</li>
<li><code>Build.SERIAL</code> without <code>Build.getSerial</code></li>
<li><code>htc.camera.sensor.front_SN</code> for HTC devices</li>
<li><code>persist.service.bdroid.bdadd</code></li>
<li>
<p><code>Settings.Secure.bluetooth_address</code> or <code>WifiInfo.getMacAddress</code> from <code>WifiManager</code>, unless the system permission <code>LOCAL_MAC_ADDRESS</code> is enabled in the manifest.</p>
</li>
<li>
<p>Usage of ANDROID_ID as an identifier only. Over time, this will influence the binding quality on older devices.</p>
</li>
<li>The absence of Instance ID, <code>Build.SERIAL</code>, and the IMEI.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="n">TelephonyManager</span><span class="w"> </span><span class="n">tm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TelephonyManager</span><span class="p">)</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="na">TELEPHONY_SERVICE</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">String</span><span class="w"> </span><span class="n">IMEI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tm</span><span class="p">.</span><span class="na">getDeviceId</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>To make sure that the identifiers can be used, check <code>AndroidManifest.xml</code> for usage of the IMEI and <code>Build.Serial</code>. The manifest should contain the permission <code>&lt;uses-permission android:name="android.permission.READ_PHONE_STATE" /&gt;</code>.</p>
<p>There are a few ways to test device binding dynamically:</p>
<h4 id="using-an-emulator">Using an Emulator<a class="headerlink" href="#using-an-emulator" title="Permanent link">&para;</a></h4>
<p>See section "<a href="#dynamic-analysis-with-an-emulator" title="Dynamic Analysis with an Emulator">Dynamic Analysis with an Emulator</a>" above.</p>
<h4 id="using-two-different-rooted-devices">Using two different rooted devices<a class="headerlink" href="#using-two-different-rooted-devices" title="Permanent link">&para;</a></h4>
<ol>
<li>Run the application on your rooted device.</li>
<li>Make sure you can raise the trust (e.g., authenticate in the app) in the application instance.</li>
<li>Retrieve the data from the first rooted device.</li>
<li>Install the application on the second rooted device.</li>
<li>In the application's data folder, overwrite the data from step 3.</li>
<li>Can you continue in an authenticated state? If so, binding may not be working properly.</li>
</ol>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<h3 id="owasp-masvs">OWASP MASVS<a class="headerlink" href="#owasp-masvs" title="Permanent link">&para;</a></h3>
<ul>
<li>MSTG-RESILIENCE-1: "The app detects, and responds to, the presence of a rooted or jailbroken device either by alerting the user or terminating the app."</li>
<li>MSTG-RESILIENCE-2: "The app prevents debugging and/or detects, and responds to, a debugger being attached. All available debugging protocols must be covered."</li>
<li>MSTG-RESILIENCE-3: "The app detects, and responds to, tampering with executable files and critical data within its own sandbox."</li>
<li>MSTG-RESILIENCE-4: "The app detects, and responds to, the presence of widely used reverse engineering tools and frameworks on the device."</li>
<li>MSTG-RESILIENCE-5: "The app detects, and responds to, being run in an emulator."</li>
<li>MSTG-RESILIENCE-6: "The app detects, and responds to, tampering the code and data in its own memory space."</li>
<li>MSTG-RESILIENCE-9: "Obfuscation is applied to programmatic defenses, which in turn impede de-obfuscation via dynamic analysis."</li>
<li>MSTG-RESILIENCE-10: "The app implements a 'device binding' functionality using a device fingerprint derived from multiple properties unique to the device."</li>
</ul>
<h3 id="safetynet-attestation">SafetyNet Attestation<a class="headerlink" href="#safetynet-attestation" title="Permanent link">&para;</a></h3>
<ul>
<li>Developer Guideline - <a href="https://developer.android.com/training/safetynet/attestation.html">https://developer.android.com/training/safetynet/attestation.html</a></li>
<li>SafetyNet Attestation Checklist - <a href="https://developer.android.com/training/safetynet/attestation-checklist">https://developer.android.com/training/safetynet/attestation-checklist</a></li>
<li>Do's &amp; Don'ts of SafetyNet Attestation - <a href="https://android-developers.googleblog.com/2017/11/10-things-you-might-be-doing-wrong-when.html">https://android-developers.googleblog.com/2017/11/10-things-you-might-be-doing-wrong-when.html</a></li>
<li>SafetyNet Verification Samples - <a href="https://github.com/googlesamples/android-play-safetynet/">https://github.com/googlesamples/android-play-safetynet/</a></li>
<li>SafetyNet Attestation API - Quota Request - <a href="https://support.google.com/googleplay/android-developer/contact/safetynetqr">https://support.google.com/googleplay/android-developer/contact/safetynetqr</a></li>
<li>Obfuscator-LLVM - <a href="https://github.com/obfuscator-llvm/obfuscator">https://github.com/obfuscator-llvm/obfuscator</a></li>
</ul>

              
            </article>
            
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../0x05i-Testing-Code-Quality-and-Build-Settings/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Android Code Quality and Build Settings" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Android Code Quality and Build Settings
            </div>
          </div>
        </a>
      
      
        
        <a href="../0x06a-Platform-Overview/" class="md-footer__link md-footer__link--next" aria-label="Next: iOS Platform Overview" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              iOS Platform Overview
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <div style="float: left; padding-right: 1em;">
  <a href="https://www.owasp.org"><img src="https://github.com/OWASP/owasp-mstg/blob/master/Document/Images/OWASP_logo_white.png?raw=true" width="100px" /></a>
</div>
<span>
  &#169; OWASP Foundation 2022. This work is licensed under 
  <a href="https://creativecommons.org/licenses/by/4.0">CC-BY-4.0</a>. For any reuse or distribution, you must make clear to others the license terms of this work.
</span>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://owasp.slack.com/messages/project-mobile_omtg/details/" target="_blank" rel="noopener" title="owasp.slack.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/OWASP_MSTG" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/OWASP/owasp-mstg/discussions" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["search.suggest", "search.highlight", "search.share", "navigation.instant", "navigation.expand", "navigation.tabs", "navigation.tabs.sticky", "toc.integrate", "navigation.top"], "search": "../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../../javascripts/tablesort.js"></script>
      
    
  </body>
</html>