
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/logo_circle.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.9">
    
    
      
        <title>Android Tampering and Reverse Engineering - OWASP Mobile Security Project</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#android-tampering-and-reverse-engineering" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OWASP Mobile Security Project" class="md-header__button md-logo" aria-label="OWASP Mobile Security Project" data-md-component="logo">
      
  <img src="../../assets/logo_circle.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OWASP Mobile Security Project
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Android Tampering and Reverse Engineering
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/OWASP/owasp-mstg" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    OWASP/owasp-mstg
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Welcome
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../donate/" class="md-tabs__link">
      ♡ Donations
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../news/" class="md-tabs__link">
      News
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../talks/" class="md-tabs__link">
      Talks
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../0x01-Foreword/" class="md-tabs__link md-tabs__link--active">
        MSTG
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../contributing/1_How_Can_You_Contribute/" class="md-tabs__link">
        Contributing
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OWASP Mobile Security Project" class="md-nav__button md-logo" aria-label="OWASP Mobile Security Project" data-md-component="logo">
      
  <img src="../../assets/logo_circle.png" alt="logo">

    </a>
    OWASP Mobile Security Project
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/OWASP/owasp-mstg" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    OWASP/owasp-mstg
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../donate/" class="md-nav__link">
        ♡ Donations
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../news/" class="md-nav__link">
        News
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../talks/" class="md-nav__link">
        Talks
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          MSTG
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="MSTG" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          MSTG
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x01-Foreword/" class="md-nav__link">
        Foreword
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x02a-Frontispiece/" class="md-nav__link">
        Frontispiece
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x02b-MASVS-MSTG-Adoption/" class="md-nav__link">
        OWASP MASVS and MSTG Adoption
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x02c-Acknowledgements/" class="md-nav__link">
        Acknowledgments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x03-Overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04a-Mobile-App-Taxonomy/" class="md-nav__link">
        Mobile App Taxonomy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04b-Mobile-App-Security-Testing/" class="md-nav__link">
        Mobile App Security Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04c-Tampering-and-Reverse-Engineering/" class="md-nav__link">
        Mobile App Tampering and Reverse Engineering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04e-Testing-Authentication-and-Session-Management/" class="md-nav__link">
        Mobile App Authentication Architectures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04f-Testing-Network-Communication/" class="md-nav__link">
        Mobile App Network Communication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04g-Testing-Cryptography/" class="md-nav__link">
        Mobile App Cryptography
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04h-Testing-Code-Quality/" class="md-nav__link">
        Mobile App Code Quality
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04i-Testing-User-Privacy-Protection/" class="md-nav__link">
        Mobile App User Privacy Protection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05a-Platform-Overview/" class="md-nav__link">
        Android Platform Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05b-Basic-Security_Testing/" class="md-nav__link">
        Android Basic Security Testing
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Android Tampering and Reverse Engineering
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Android Tampering and Reverse Engineering
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reverse-engineering" class="md-nav__link">
    Reverse Engineering
  </a>
  
    <nav class="md-nav" aria-label="Reverse Engineering">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disassembling-and-decompiling" class="md-nav__link">
    Disassembling and Decompiling
  </a>
  
    <nav class="md-nav" aria-label="Disassembling and Decompiling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#decompiling-java-code" class="md-nav__link">
    Decompiling Java Code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disassembling-native-code" class="md-nav__link">
    Disassembling Native Code
  </a>
  
    <nav class="md-nav" aria-label="Disassembling Native Code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#radare2" class="md-nav__link">
    radare2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ida-pro" class="md-nav__link">
    IDA Pro
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#static-analysis" class="md-nav__link">
    Static Analysis
  </a>
  
    <nav class="md-nav" aria-label="Static Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-information-gathering" class="md-nav__link">
    Basic Information Gathering
  </a>
  
    <nav class="md-nav" aria-label="Basic Information Gathering">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#retrieving-strings" class="md-nav__link">
    Retrieving Strings
  </a>
  
    <nav class="md-nav" aria-label="Retrieving Strings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#java-and-kotlin-bytecode" class="md-nav__link">
    Java and Kotlin Bytecode
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#native-code" class="md-nav__link">
    Native Code
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-references" class="md-nav__link">
    Cross References
  </a>
  
    <nav class="md-nav" aria-label="Cross References">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#java-and-kotlin" class="md-nav__link">
    Java and Kotlin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#native-code_1" class="md-nav__link">
    Native Code
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-usage" class="md-nav__link">
    API Usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network-communication" class="md-nav__link">
    Network Communication
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-reversed-code-review" class="md-nav__link">
    Manual (Reversed) Code Review
  </a>
  
    <nav class="md-nav" aria-label="Manual (Reversed) Code Review">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reviewing-decompiled-java-code" class="md-nav__link">
    Reviewing Decompiled Java Code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reviewing-disassembled-native-code" class="md-nav__link">
    Reviewing Disassembled Native Code
  </a>
  
    <nav class="md-nav" aria-label="Reviewing Disassembled Native Code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#radare2_1" class="md-nav__link">
    radare2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ida-pro_1" class="md-nav__link">
    IDA Pro
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ghidra" class="md-nav__link">
    Ghidra
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automated-static-analysis" class="md-nav__link">
    Automated Static Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dynamic-analysis" class="md-nav__link">
    Dynamic Analysis
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis-on-non-rooted-devices" class="md-nav__link">
    Dynamic Analysis on Non-Rooted Devices
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#basic-information-gathering_1" class="md-nav__link">
    Basic Information Gathering
  </a>
  
    <nav class="md-nav" aria-label="Basic Information Gathering">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#open-files" class="md-nav__link">
    Open Files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#open-connections" class="md-nav__link">
    Open Connections
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loaded-native-libraries" class="md-nav__link">
    Loaded Native Libraries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sandbox-inspection" class="md-nav__link">
    Sandbox Inspection
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging" class="md-nav__link">
    Debugging
  </a>
  
    <nav class="md-nav" aria-label="Debugging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#debugging-release-apps" class="md-nav__link">
    Debugging Release Apps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging-with-jdb" class="md-nav__link">
    Debugging with jdb
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging-with-an-ide" class="md-nav__link">
    Debugging with an IDE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging-native-code" class="md-nav__link">
    Debugging Native Code
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tracing" class="md-nav__link">
    Tracing
  </a>
  
    <nav class="md-nav" aria-label="Tracing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#execution-tracing" class="md-nav__link">
    Execution Tracing
  </a>
  
    <nav class="md-nav" aria-label="Execution Tracing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tracing-system-calls" class="md-nav__link">
    Tracing System Calls
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ftrace" class="md-nav__link">
    Ftrace
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kprobes" class="md-nav__link">
    KProbes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-tracing" class="md-nav__link">
    Method Tracing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#native-code-tracing" class="md-nav__link">
    Native Code Tracing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jni-tracing" class="md-nav__link">
    JNI Tracing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emulation-based-analysis" class="md-nav__link">
    Emulation-based Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#binary-analysis" class="md-nav__link">
    Binary Analysis
  </a>
  
    <nav class="md-nav" aria-label="Binary Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#symbolic-execution" class="md-nav__link">
    Symbolic Execution
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tampering-and-runtime-instrumentation" class="md-nav__link">
    Tampering and Runtime Instrumentation
  </a>
  
    <nav class="md-nav" aria-label="Tampering and Runtime Instrumentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patching-repackaging-and-re-signing" class="md-nav__link">
    Patching, Repackaging, and Re-Signing
  </a>
  
    <nav class="md-nav" aria-label="Patching, Repackaging, and Re-Signing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patching-example-disabling-certificate-pinning" class="md-nav__link">
    Patching Example: Disabling Certificate Pinning
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patching-example-making-an-app-debuggable" class="md-nav__link">
    Patching Example: Making an App Debuggable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#repackaging" class="md-nav__link">
    Repackaging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#re-signing" class="md-nav__link">
    Re-Signing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-wait-for-debugger-feature" class="md-nav__link">
    The "Wait For Debugger" Feature
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patching-react-native-applications" class="md-nav__link">
    Patching React Native applications
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#library-injection" class="md-nav__link">
    Library Injection
  </a>
  
    <nav class="md-nav" aria-label="Library Injection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patching-the-applications-smali-code" class="md-nav__link">
    Patching the Application's Smali Code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patching-applications-native-library" class="md-nav__link">
    Patching Application's Native Library
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preloading-symbols" class="md-nav__link">
    Preloading Symbols
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-instrumentation" class="md-nav__link">
    Dynamic Instrumentation
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Instrumentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#information-gathering" class="md-nav__link">
    Information Gathering
  </a>
  
    <nav class="md-nav" aria-label="Information Gathering">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-loaded-classes-and-their-methods" class="md-nav__link">
    Getting Loaded Classes and their Methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-loaded-libraries" class="md-nav__link">
    Getting Loaded Libraries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-hooking" class="md-nav__link">
    Method Hooking
  </a>
  
    <nav class="md-nav" aria-label="Method Hooking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#xposed" class="md-nav__link">
    Xposed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#frida" class="md-nav__link">
    Frida
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#process-exploration" class="md-nav__link">
    Process Exploration
  </a>
  
    <nav class="md-nav" aria-label="Process Exploration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#memory-maps-and-inspection" class="md-nav__link">
    Memory Maps and Inspection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#in-memory-search" class="md-nav__link">
    In-Memory Search
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-dump" class="md-nav__link">
    Memory Dump
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runtime-reverse-engineering" class="md-nav__link">
    Runtime Reverse Engineering
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customizing-android-for-reverse-engineering" class="md-nav__link">
    Customizing Android for Reverse Engineering
  </a>
  
    <nav class="md-nav" aria-label="Customizing Android for Reverse Engineering">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customizing-the-ramdisk" class="md-nav__link">
    Customizing the RAMDisk
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customizing-the-android-kernel" class="md-nav__link">
    Customizing the Android Kernel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#booting-the-custom-environment" class="md-nav__link">
    Booting the Custom Environment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-call-hooking-with-kernel-modules" class="md-nav__link">
    System Call Hooking with Kernel Modules
  </a>
  
    <nav class="md-nav" aria-label="System Call Hooking with Kernel Modules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-file-hiding" class="md-nav__link">
    Example: File Hiding
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05d-Testing-Data-Storage/" class="md-nav__link">
        Android Data Storage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05e-Testing-Cryptography/" class="md-nav__link">
        Android Cryptographic APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05f-Testing-Local-Authentication/" class="md-nav__link">
        Android Local Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05g-Testing-Network-Communication/" class="md-nav__link">
        Android Network APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05h-Testing-Platform-Interaction/" class="md-nav__link">
        Android Platform APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05i-Testing-Code-Quality-and-Build-Settings/" class="md-nav__link">
        Android Code Quality and Build Settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05j-Testing-Resiliency-Against-Reverse-Engineering/" class="md-nav__link">
        Android Anti-Reversing Defenses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06a-Platform-Overview/" class="md-nav__link">
        iOS Platform Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06b-Basic-Security-Testing/" class="md-nav__link">
        iOS Basic Security Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06c-Reverse-Engineering-and-Tampering/" class="md-nav__link">
        iOS Tampering and Reverse Engineering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06d-Testing-Data-Storage/" class="md-nav__link">
        iOS Data Storage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06e-Testing-Cryptography/" class="md-nav__link">
        iOS Cryptographic APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06f-Testing-Local-Authentication/" class="md-nav__link">
        iOS Local Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06g-Testing-Network-Communication/" class="md-nav__link">
        iOS Network APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06h-Testing-Platform-Interaction/" class="md-nav__link">
        iOS Platform APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06i-Testing-Code-Quality-and-Build-Settings/" class="md-nav__link">
        iOS Code Quality and Build Settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06j-Testing-Resiliency-Against-Reverse-Engineering/" class="md-nav__link">
        iOS Anti-Reversing Defenses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x07-Appendix/" class="md-nav__link">
        Appendix
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x08-Testing-Tools/" class="md-nav__link">
        Testing Tools
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x09-Suggested-Reading/" class="md-nav__link">
        Suggested Reading
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Contributing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Contributing" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Contributing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/1_How_Can_You_Contribute/" class="md-nav__link">
        How Can You Contribute?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/2_Getting_Started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/3_PRs_and_Reviews/" class="md-nav__link">
        Pull Requests & Reviews
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/4_Add_new_Language/" class="md-nav__link">
        Add a New Language
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/5_Style_Guide/" class="md-nav__link">
        Style Guide
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/OWASP/owasp-mstg/edit/master/docs/MSTG/0x05c-Reverse-Engineering-and-Tampering.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="android-tampering-and-reverse-engineering">Android Tampering and Reverse Engineering<a class="headerlink" href="#android-tampering-and-reverse-engineering" title="Permanent link">&para;</a></h1>
<p>Android's openness makes it a favorable environment for reverse engineers. In the following chapter, we'll look at some peculiarities of Android reversing and OS-specific tools as processes.</p>
<p>Android offers reverse engineers big advantages that are not available with iOS. Because Android is open-source, you can study its source code at the Android Open Source Project (AOSP) and modify the OS and its standard tools any way you want. Even on standard retail devices, it is possible to do things like activating developer mode and sideloading apps without jumping through many hoops. From the powerful tools shipping with the SDK to the wide range of available reverse engineering tools, there's a lot of niceties to make your life easier.</p>
<p>However, there are also a few Android-specific challenges. For example, you'll need to deal with both Java bytecode and native code. Java Native Interface (JNI) is sometimes deliberately used to confuse reverse engineers (to be fair, there are legitimate reasons for using JNI, such as improving performance or supporting legacy code). Developers sometimes use the native layer to "hide" data and functionality, and they may structure their apps such that execution frequently jumps between the two layers.</p>
<p>You'll need at least a working knowledge of both the Java-based Android environment and the Linux OS and Kernel, on which Android is based. You'll also need the right toolset to deal with both the bytecode running on the Java virtual machine and the native code.</p>
<p>Note that we'll use the <a href="https://github.com/OWASP/owasp-mstg/blob/master/Crackmes/" title="UnCrackable Mobile Apps">OWASP Mobile Testing Guide Crackmes</a> as examples for demonstrating various reverse engineering techniques in the following sections, so expect partial and full spoilers. We encourage you to have a crack at the challenges yourself before reading on!</p>
<h2 id="reverse-engineering">Reverse Engineering<a class="headerlink" href="#reverse-engineering" title="Permanent link">&para;</a></h2>
<p>Reverse engineering is the process of taking an app apart to find out how it works. You can do this by examining the compiled app (static analysis), observing the app during runtime (dynamic analysis), or a combination of both.</p>
<h3 id="disassembling-and-decompiling">Disassembling and Decompiling<a class="headerlink" href="#disassembling-and-decompiling" title="Permanent link">&para;</a></h3>
<p>In Android app security testing, if the application is based solely on Java and doesn't have any native code (C/C++ code), the reverse engineering process is relatively easy and recovers (decompiles) almost all the source code. In those cases, black-box testing (with access to the compiled binary, but not the original source code) can get pretty close to white-box testing.</p>
<p>Nevertheless, if the code has been purposefully obfuscated (or some tool-breaking anti-decompilation tricks have been applied), the reverse engineering process may be very time-consuming and unproductive. This also applies to applications that contain native code. They can still be reverse engineered, but the process is not automated and requires knowledge of low-level details.</p>
<h4 id="decompiling-java-code">Decompiling Java Code<a class="headerlink" href="#decompiling-java-code" title="Permanent link">&para;</a></h4>
<p>If you don't mind looking at Smali instead of Java, you can simply <a href="https://developer.android.com/studio/debug/apk-debugger" title="Debug pre-built APKs">open your APK in Android Studio</a> by clicking <strong>Profile or debug APK</strong> from the Welcome screen (even if you don't intend to debug it you can take a look at the smali code).</p>
<p>Alternatively you can use <a href="../0x08-Testing-Tools/#apktool">apktool</a> to extract and disassemble resources directly from the APK archive and disassemble Java bytecode to Smali. apktool allows you to reassemble the package, which is useful for patching and applying changes to e.g. the Android Manifest.</p>
<p>If you want to look directly into Java source code on a GUI, simply open your APK using <a href="../0x08-Testing-Tools/#jadx">jadx</a> or <a href="../0x08-Testing-Tools/#bytecode-viewer">Bytecode Viewer</a>.</p>
<p>Android decompilers go one step further and attempt to convert Android bytecode back into Java source code, making it more human-readable. Fortunately, Java decompilers generally handle Android bytecode well. The above mentioned tools embed, and sometimes even combine, popular free decompilers such as:</p>
<ul>
<li><a href="http://jd.benow.ca/" title="JD">JD</a></li>
<li><a href="http://www.javadecompilers.com/jad" title="JAD">JAD</a></li>
<li><a href="https://github.com/skylot/jadx" title="jadx">jadx</a></li>
<li><a href="https://github.com/mstrobel/procyon" title="Procyon">Procyon</a></li>
<li><a href="https://www.benf.org/other/cfr/" title="CFR">CFR</a></li>
</ul>
<p>Alternatively run <a href="../0x08-Testing-Tools/#apkx">apkx</a> on your APK or use the exported files from the previous tools to open the Java source code in another tool such as an IDE.</p>
<p>In the following example we'll be using <a href="https://github.com/OWASP/owasp-mstg/raw/master/Crackmes/Android/Level_01/UnCrackable-Level1.apk" title="UnCrackable App for Android Level 1">UnCrackable App for Android Level 1</a>. First, let's install the app on a device or emulator and run it to see what the crackme is about.</p>
<p><img src="../../assets/Images/Chapters/0x05c/crackme-1.png" width="400px" /></p>
<p>Seems like we're expected to find some kind of secret code!</p>
<p>We're looking for a secret string stored somewhere inside the app, so the next step is to look inside. First, unzip the APK file (<code>unzip UnCrackable-Level1.apk -d UnCrackable-Level1</code>) and look at the content. In the standard setup, all the Java bytecode and app data is in the file <code>classes.dex</code> in the app root directory (<code>UnCrackable-Level1/</code>). This file conforms to the Dalvik Executable Format (DEX), an Android-specific way of packaging Java programs. Most Java decompilers take plain class files or JARs as input, so you need to convert the classes.dex file into a JAR first. You can do this with <code>dex2jar</code> or <code>enjarify</code>.</p>
<p>Once you have a JAR file, you can use any free decompiler to produce Java code. In this example, we'll use the <a href="https://www.benf.org/other/cfr/" title="CFR decompiler">CFR decompiler</a>. CFR is under active development, and brand-new releases are available on the author's website. CFR was released under an MIT license, so you can use it freely even though its source code is not available.</p>
<p>The easiest way to run CFR is through <a href="../0x08-Testing-Tools/#apkx">apkx</a>, which also packages <code>dex2jar</code> and automates extraction, conversion, and decompilation. Run it on the APK and you should find the decompiled sources in the directory <code>Uncrackable-Level1/src</code>. To view the sources, a simple text editor (preferably with syntax highlighting) is fine, but loading the code into a Java IDE makes navigation easier. Let's import the code into IntelliJ, which also provides on-device debugging functionality.</p>
<p>Open IntelliJ and select "Android" as the project type in the left tab of the "New Project" dialog. Enter "Uncrackable1" as the application name and "vantagepoint.sg" as the company name. This results in the package name "sg.vantagepoint.uncrackable1", which matches the original package name. Using a matching package name is important if you want to attach the debugger to the running app later on because IntelliJ uses the package name to identify the correct process.</p>
<p><img src="../../assets/Images/Chapters/0x05c/intellij_new_project.jpg" width="100%" /></p>
<p>In the next dialog, pick any API number; you don't actually want to compile the project, so the number doesn't matter. Click "next" and choose "Add no Activity", then click "finish".</p>
<p>Once you have created the project, expand the "1: Project" view on the left and navigate to the folder <code>app/src/main/java</code>. Right-click and delete the default package "sg.vantagepoint.uncrackable1" created by IntelliJ.</p>
<p><img src="../../assets/Images/Chapters/0x05c/delete_package.jpg" width="400px" /></p>
<p>Now, open the <code>Uncrackable-Level1/src</code> directory in a file browser and drag the <code>sg</code> directory into the now empty <code>Java</code> folder in the IntelliJ project view (hold the "alt" key to copy the folder instead of moving it).</p>
<p><img src="../../assets/Images/Chapters/0x05c/drag_code.jpg" width="100%" /></p>
<p>You'll end up with a structure that resembles the original Android Studio project from which the app was built.</p>
<p><img src="../../assets/Images/Chapters/0x05c/final_structure.jpg" width="400px" /></p>
<p>See the section "<a href="#reviewing-decompiled-java-code" title="Reviewing Decompiled Java Code">Reviewing Decompiled Java Code</a>" below to learn on how to proceed when inspecting the decompiled Java code.</p>
<h4 id="disassembling-native-code">Disassembling Native Code<a class="headerlink" href="#disassembling-native-code" title="Permanent link">&para;</a></h4>
<p>Dalvik and ART both support the Java Native Interface (JNI), which defines a way for Java code to interact with native code written in C/C++. As on other Linux-based operating systems, native code is packaged (compiled) into ELF dynamic libraries (*.so), which the Android app loads at runtime via the <code>System.load</code> method. However, instead of relying on widely used C libraries (such as glibc), Android binaries are built against a custom libc named <a href="https://github.com/android/platform_bionic" title="Bionic libc">Bionic</a>. Bionic adds support for important Android-specific services such as system properties and logging, and it is not fully POSIX-compatible.</p>
<p>When reversing an Android application containing native code, we need to understand a couple of data structures related to the JNI bridge between Java and native code. From the reversing perspective, we need to be aware of two key data structures: <code>JavaVM</code> and <code>JNIEnv</code>. Both of them are pointers to pointers to function tables:</p>
<ul>
<li><code>JavaVM</code> provides an interface to invoke functions for creating and destroying a JavaVM. Android allows only one <code>JavaVM</code> per process and is not really relevant for our reversing purposes.</li>
<li><code>JNIEnv</code> provides access to most of the JNI functions which are accessible at a fixed offset through the <code>JNIEnv</code> pointer. This <code>JNIEnv</code> pointer is the first parameter passed to every JNI function. We will discuss this concept again with the help of an example later in this chapter.</li>
</ul>
<p>It is worth highlighting that analyzing disassembled native code is much more challenging than disassembled Java code. When reversing the native code in an Android application we will need a disassembler.</p>
<p>In the next example we'll reverse the HelloWorld-JNI.apk from the OWASP MSTG repository. Installing and running it in an emulator or Android device is optional.</p>
<div class="highlight"><pre><span></span><code>$ wget https://github.com/OWASP/owasp-mstg/raw/master/Samples/Android/01_HelloWorld-JNI/HelloWord-JNI.apk
</code></pre></div>
<blockquote>
<p>This app is not exactly spectacular, all it does is show a label with the text "Hello from C++". This is the app Android generates by default when you create a new project with C/C++ support, which is just enough to show the basic principles of JNI calls.</p>
</blockquote>
<p><img src="../../assets/Images/Chapters/0x05c/helloworld.png" width="200px" /></p>
<p>Decompile the APK with <code>apkx</code>.</p>
<div class="highlight"><pre><span></span><code>$ apkx HelloWord-JNI.apk
Extracting HelloWord-JNI.apk to HelloWord-JNI
Converting: classes.dex -&gt; classes.jar <span class="o">(</span>dex2jar<span class="o">)</span>
dex2jar HelloWord-JNI/classes.dex -&gt; HelloWord-JNI/classes.jar
Decompiling to HelloWord-JNI/src <span class="o">(</span>cfr<span class="o">)</span>
</code></pre></div>
<p>This extracts the source code into the <code>HelloWord-JNI/src</code> directory. The main activity is found in the file <code>HelloWord-JNI/src/sg/vantagepoint/helloworldjni/MainActivity.java</code>. The "Hello World" text view is populated in the <code>onCreate</code> method:</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MainActivity</span><span class="w"></span>
<span class="kd">extends</span><span class="w"> </span><span class="n">AppCompatActivity</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">loadLibrary</span><span class="p">(</span><span class="s">&quot;native-lib&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="nd">@Override</span><span class="w"></span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span><span class="w"> </span><span class="n">bundle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">bundle</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">setContentView</span><span class="p">(</span><span class="mi">2130968603</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="n">TextView</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="na">findViewById</span><span class="p">(</span><span class="mi">2131427422</span><span class="p">)).</span><span class="na">setText</span><span class="p">((</span><span class="n">CharSequence</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="w"> </span><span class="err">\</span><span class="w"></span>
<span class="w">        </span><span class="n">stringFromJNI</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">native</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">stringFromJNI</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Note the declaration of <code>public native String stringFromJNI</code> at the bottom. The keyword "native" tells the Java compiler that this method is implemented in a native language. The corresponding function is resolved during runtime, but only if a native library that exports a global symbol with the expected signature is loaded (signatures comprise a package name, class name, and method name). In this example, this requirement is satisfied by the following C or C++ function:</p>
<div class="highlight"><pre><span></span><code><span class="n">JNIEXPORT</span><span class="w"> </span><span class="n">jstring</span><span class="w"> </span><span class="n">JNICALL</span><span class="w"> </span><span class="n">Java_sg_vantagepoint_helloworld_MainActivity_stringFromJNI</span><span class="p">(</span><span class="n">JNIEnv</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">jobject</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>So where is the native implementation of this function? If you look into the "lib" directory of the unzipped APK archive, you'll see several subdirectories (one per supported processor architecture), each of them containing a version of the native library, in this case <code>libnative-lib.so</code>. When <code>System.loadLibrary</code> is called, the loader selects the correct version based on the device that the app is running on. Before moving ahead, pay attention to the first parameter passed to the current JNI function. It is the same <code>JNIEnv</code> data structure which was discussed earlier in this section.</p>
<p><img src="../../assets/Images/Chapters/0x05c/archs.jpg" width="300px" /></p>
<p>Following the naming convention mentioned above, you can expect the library to export a symbol called <code>Java_sg_vantagepoint_helloworld_MainActivity_stringFromJNI</code>. On Linux systems, you can retrieve the list of symbols with <code>readelf</code> (included in GNU binutils) or <code>nm</code>. Do this on macOS with the <code>greadelf</code> tool, which you can install via Macports or Homebrew. The following example uses <code>greadelf</code>:</p>
<div class="highlight"><pre><span></span><code>$ greadelf -W -s libnative-lib.so <span class="p">|</span> grep Java
     <span class="m">3</span>: 00004e49   <span class="m">112</span> FUNC    GLOBAL DEFAULT   <span class="m">11</span> Java_sg_vantagepoint_helloworld_MainActivity_stringFromJNI
</code></pre></div>
<p>You can also see this using radare2's rabin2:</p>
<div class="highlight"><pre><span></span><code>$ rabin2 -s HelloWord-JNI/lib/armeabi-v7a/libnative-lib.so <span class="p">|</span> grep -i Java
<span class="m">003</span> 0x00000e78 0x00000e78 GLOBAL   FUNC   <span class="m">16</span> Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI
</code></pre></div>
<p>This is the native function that eventually gets executed when the <code>stringFromJNI</code> native method is called.</p>
<p>To disassemble the code, you can load <code>libnative-lib.so</code> into any disassembler that understands ELF binaries (i.e., any disassembler). If the app ships with binaries for different architectures, you can theoretically pick the architecture you're most familiar with, as long as it is compatible with the disassembler. Each version is compiled from the same source and implements the same functionality. However, if you're planning to debug the library on a live device later, it's usually wise to pick an ARM build.</p>
<p>To support both older and newer ARM processors, Android apps ship with multiple ARM builds compiled for different Application Binary Interface (ABI) versions. The ABI defines how the application's machine code is supposed to interact with the system at runtime. The following ABIs are supported:</p>
<ul>
<li>armeabi: ABI is for ARM-based CPUs that support at least the ARMv5TE instruction set.</li>
<li>armeabi-v7a: This ABI extends armeabi to include several CPU instruction set extensions.</li>
<li>arm64-v8a: ABI for ARMv8-based CPUs that support AArch64, the new 64-bit ARM architecture.</li>
</ul>
<p>Most disassemblers can handle any of those architectures. Below, we'll be viewing the armeabi-v7a version (located in <code>HelloWord-JNI/lib/armeabi-v7a/libnative-lib.so</code>) in radare2 and in IDA Pro. See the section "<a href="#reviewing-disassembled-native-code" title="Reviewing Disassembled Native Code">Reviewing Disassembled Native Code</a>" below to learn on how to proceed when inspecting the disassembled native code.</p>
<h5 id="radare2">radare2<a class="headerlink" href="#radare2" title="Permanent link">&para;</a></h5>
<p>To open the file in radare2 you only have to run <code>r2 -A HelloWord-JNI/lib/armeabi-v7a/libnative-lib.so</code>. The chapter "<a href="../0x05b-Basic-Security_Testing/" title="Android Basic Security Testing">Android Basic Security Testing</a>" already introduced radare2. Remember that you can use the flag <code>-A</code> to run the <code>aaa</code> command right after loading the binary in order to analyze all referenced code.</p>
<div class="highlight"><pre><span></span><code>$ r2 -A HelloWord-JNI/lib/armeabi-v7a/libnative-lib.so

<span class="o">[</span>x<span class="o">]</span> Analyze all flags starting with sym. and entry0 <span class="o">(</span>aa<span class="o">)</span>
<span class="o">[</span>x<span class="o">]</span> Analyze <span class="k">function</span> calls <span class="o">(</span>aac<span class="o">)</span>
<span class="o">[</span>x<span class="o">]</span> Analyze len bytes of instructions <span class="k">for</span> references <span class="o">(</span>aar<span class="o">)</span>
<span class="o">[</span>x<span class="o">]</span> Check <span class="k">for</span> objc references
<span class="o">[</span>x<span class="o">]</span> Check <span class="k">for</span> vtables
<span class="o">[</span>x<span class="o">]</span> Finding xrefs <span class="k">in</span> noncode section with anal.in<span class="o">=</span>io.maps
<span class="o">[</span>x<span class="o">]</span> Analyze value pointers <span class="o">(</span>aav<span class="o">)</span>
<span class="o">[</span>x<span class="o">]</span> Value from 0x00000000 to 0x00001dcf <span class="o">(</span>aav<span class="o">)</span>
<span class="o">[</span>x<span class="o">]</span> 0x00000000-0x00001dcf <span class="k">in</span> 0x0-0x1dcf <span class="o">(</span>aav<span class="o">)</span>
<span class="o">[</span>x<span class="o">]</span> Emulate code to find computed references <span class="o">(</span>aae<span class="o">)</span>
<span class="o">[</span>x<span class="o">]</span> Type matching analysis <span class="k">for</span> all functions <span class="o">(</span>aaft<span class="o">)</span>
<span class="o">[</span>x<span class="o">]</span> Use -AA or aaaa to perform additional experimental analysis.
 -- Print the contents of the current block with the <span class="s1">&#39;p&#39;</span> <span class="nb">command</span>
<span class="o">[</span>0x00000e3c<span class="o">]</span>&gt;
</code></pre></div>
<p>Note that for bigger binaries, starting directly with the flag <code>-A</code> might be very time consuming as well as unnecessary. Depending on your purpose, you may open the binary without this option and then apply a less complex analysis like <code>aa</code> or a more concrete type of analysis such as the ones offered in <code>aa</code> (basic analysis of all functions) or <code>aac</code> (analyze function calls). Remember to always type <code>?</code> to get the help or attach it to commands to see even more command or options. For example, if you enter <code>aa?</code> you'll get the full list of analysis commands.</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00001760<span class="o">]</span>&gt; aa?
Usage: aa<span class="o">[</span><span class="m">0</span>*?<span class="o">]</span>   <span class="c1"># see also &#39;af&#39; and &#39;afna&#39;</span>
<span class="p">|</span> aa                  <span class="nb">alias</span> <span class="k">for</span> <span class="s1">&#39;af@@ sym.*;af@entry0;afva&#39;</span>
<span class="p">|</span> aaa<span class="o">[</span>?<span class="o">]</span>              autoname functions after aa <span class="o">(</span>see afna<span class="o">)</span>
<span class="p">|</span> aab                 abb across bin.sections.rx
<span class="p">|</span> aac <span class="o">[</span>len<span class="o">]</span>           analyze <span class="k">function</span> calls <span class="o">(</span>af @@ <span class="sb">`</span>pi len~call<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="sb">`</span><span class="o">)</span>
<span class="p">|</span> aac* <span class="o">[</span>len<span class="o">]</span>          flag <span class="k">function</span> calls without performing a <span class="nb">complete</span> analysis
<span class="p">|</span> aad <span class="o">[</span>len<span class="o">]</span>           analyze data references to code
<span class="p">|</span> aae <span class="o">[</span>len<span class="o">]</span> <span class="o">([</span>addr<span class="o">])</span>  analyze references with ESIL <span class="o">(</span>optionally to address<span class="o">)</span>
<span class="p">|</span> aaf<span class="o">[</span>e<span class="p">|</span>t<span class="o">]</span>            analyze all functions <span class="o">(</span>e anal.hasnext<span class="o">=</span><span class="m">1</span><span class="p">;</span>afr @@c:isq<span class="o">)</span> <span class="o">(</span><span class="nv">aafe</span><span class="o">=</span>aef@@f<span class="o">)</span>
<span class="p">|</span> aaF <span class="o">[</span>sym*<span class="o">]</span>          <span class="nb">set</span> anal.in<span class="o">=</span>block <span class="k">for</span> all the spaces between flags matching glob
<span class="p">|</span> aaFa <span class="o">[</span>sym*<span class="o">]</span>         same as aaF but uses af/a2f instead of af+/afb+ <span class="o">(</span>slower but more accurate<span class="o">)</span>
<span class="p">|</span> aai<span class="o">[</span>j<span class="o">]</span>              show info of all analysis parameters
<span class="p">|</span> aan                 autoname functions that either start with fcn.* or sym.func.*
<span class="p">|</span> aang                find <span class="k">function</span> and symbol names from golang binaries
<span class="p">|</span> aao                 analyze all objc references
<span class="p">|</span> aap                 find and analyze <span class="k">function</span> preludes
<span class="p">|</span> aar<span class="o">[</span>?<span class="o">]</span> <span class="o">[</span>len<span class="o">]</span>        analyze len bytes of instructions <span class="k">for</span> references
<span class="p">|</span> aas <span class="o">[</span>len<span class="o">]</span>           analyze symbols <span class="o">(</span>af @@<span class="o">=</span> <span class="sb">`</span>isq~<span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="sb">`</span><span class="o">)</span>
<span class="p">|</span> aaS                 analyze all flags starting with sym. <span class="o">(</span>af @@ sym.*<span class="o">)</span>
<span class="p">|</span> aat <span class="o">[</span>len<span class="o">]</span>           analyze all consecutive functions <span class="k">in</span> section
<span class="p">|</span> aaT <span class="o">[</span>len<span class="o">]</span>           analyze code after trap-sleds
<span class="p">|</span> aau <span class="o">[</span>len<span class="o">]</span>           list mem areas <span class="o">(</span>larger than len bytes<span class="o">)</span> not covered by functions
<span class="p">|</span> aav <span class="o">[</span>sat<span class="o">]</span>           find values referencing a specific section or map
</code></pre></div>
<p>There is a thing that is worth noticing about radare2 vs other disassemblers like e.g. IDA Pro. The following quote from an <a href="http://radare.today/posts/analysis-by-default/" title="radare2 - Analysis By Default">article</a> of radare2's blog (<a href="http://radare.today/">http://radare.today/</a>) pretty summarizes this.</p>
<blockquote>
<p>Code analysis is not a quick operation, and not even predictable or taking a linear time to be processed. This makes starting times pretty heavy, compared to just loading the headers and strings information like it’s done by default.</p>
<p>People that are used to IDA or Hopper just load the binary, go out to make a coffee and then when the analysis is done, they start doing the manual analysis to understand what the program is doing. It’s true that those tools perform the analysis in background, and the GUI is not blocked. But this takes a lot of CPU time, and r2 aims to run in many more platforms than just high-end desktop computers.</p>
</blockquote>
<p>This said, please see section "<a href="#reviewing-disassembled-native-code" title="Reviewing Disassembled Native Code">Reviewing Disassembled Native Code</a>" to learn more bout how radare2 can help us performing our reversing tasks much faster. For example, getting the disassembly of an specific function is a trivial task that can be performed in one command.</p>
<h5 id="ida-pro">IDA Pro<a class="headerlink" href="#ida-pro" title="Permanent link">&para;</a></h5>
<p>If you own an IDA Pro license, open the file and once in the "Load new file" dialog, choose "ELF for ARM (Shared Object)" as the file type (IDA should detect this automatically), and "ARM Little-Endian" as the processor type.</p>
<p><img src="../../assets/Images/Chapters/0x05c/IDA_open_file.jpg" width="100%" /></p>
<blockquote>
<p>The freeware version of IDA Pro unfortunately does not support the ARM processor type.</p>
</blockquote>
<h2 id="static-analysis">Static Analysis<a class="headerlink" href="#static-analysis" title="Permanent link">&para;</a></h2>
<p>For white-box source code testing, you'll need a setup similar to the developer's setup, including a test environment that includes the Android SDK and an IDE. Access to either a physical device or an emulator (for debugging the app) is recommended.</p>
<p>During <strong>black-box testing</strong>, you won't have access to the original form of the source code. You'll usually have the application package in <a href="https://en.wikipedia.org/wiki/Android_application_package" title="Android application package">Android's APK format</a>, which can be installed on an Android device or reverse engineered as explained in the section "Disassembling and Decompiling".</p>
<h3 id="basic-information-gathering">Basic Information Gathering<a class="headerlink" href="#basic-information-gathering" title="Permanent link">&para;</a></h3>
<p>As discussed in previous sections, an Android application can consist of both Java/Kotlin bytecode and native code. In this section, we will learn about some approaches and tools for collecting basic information using static analysis.</p>
<h4 id="retrieving-strings">Retrieving Strings<a class="headerlink" href="#retrieving-strings" title="Permanent link">&para;</a></h4>
<p>While performing any kind of binary analysis, strings can be considered as one of the most valuable starting points as they provide context. For example, an error log string like "Data encryption failed." gives us a hint that the adjoining code might be responsible for performing some kind of encryption operation.</p>
<h5 id="java-and-kotlin-bytecode">Java and Kotlin Bytecode<a class="headerlink" href="#java-and-kotlin-bytecode" title="Permanent link">&para;</a></h5>
<p>As we already know, all the Java and Kotlin bytecode of an Android application is compiled into a DEX file. Each DEX file contains a <a href="https://source.android.com/devices/tech/dalvik/dex-format#file-layout" title="string identifiers list">list of string identifiers</a> (strings_ids), which contains all the string identifiers used in the binary whenever a string is referred, including internal naming (e.g, type descriptors) or constant objects referred by the code (e.g hardcoded strings). You can simply dump this list using tools such as Ghidra (GUI based) or <a href="http://newandroidbook.com/tools/dextra.html" title="Dextra">Dextra</a> (CLI based).</p>
<p>With Ghidra, strings can be obtained by simply loading the DEX file and selecting <strong>Window -&gt; Defined strings</strong> in the menu.</p>
<blockquote>
<p>Loading an APK file directly into Ghidra might lead to inconsistencies. Thus it is recommended to extract the DEX file by unzipping the APK file and then loading it into Ghidra.</p>
</blockquote>
<p><img src="../../assets/Images/Chapters/0x05c/ghidra_dex_strings.png" width="100%" /></p>
<p>With Dextra, you can dump all the strings using the following command:</p>
<div class="highlight"><pre><span></span><code>dextra -S classes.dex
</code></pre></div>
<p>The output from Dextra can be manipulated using standard Linux commands, for example, using <code>grep</code> to search for certain keywords.</p>
<p>It is important to know, the list of strings obtained using the above tools can be very big, as it also includes the various class and package names used in the application. Going through the complete list, specially for big binaries, can be very cumbersome. Thus, it is recommended to start with keyword-based searching and go through the list only when keyword search does not help. Some generic keywords which can be a good starting point are - password, key, and secret. Other useful keywords specific to the context of the app can be obtained while you are using the app itself. For instance, imagine that the app has as login form, you can take note of the displayed placeholder or title text of the input fields and use that as an entry point for your static analysis.</p>
<h5 id="native-code">Native Code<a class="headerlink" href="#native-code" title="Permanent link">&para;</a></h5>
<p>In order to extract strings from native code used in an Android application, you can use GUI tools such as Ghidra or Cutter or rely on CLI-based tools such as the <em>strings</em> Unix utility (<code>strings &lt;path_to_binary&gt;</code>) or radare2's rabin2 (<code>rabin2 -zz &lt;path_to_binary&gt;</code>). When using the CLI-based ones you can take advantage of other tools such as grep (e.g. in conjunction with regular expressions) to further filter and analyze the results.</p>
<h4 id="cross-references">Cross References<a class="headerlink" href="#cross-references" title="Permanent link">&para;</a></h4>
<h5 id="java-and-kotlin">Java and Kotlin<a class="headerlink" href="#java-and-kotlin" title="Permanent link">&para;</a></h5>
<p>There are many RE tools that support retrieving Java cross references. For many of the GUI-based ones, this is usually done by right clicking on the desired function and selecting the corresponding option, e.g. <strong>Show References to</strong> in Ghidra or <a href="https://github.com/skylot/jadx/wiki/jadx-gui-features-overview#find-usage" title="jadx - find-usage"><strong>Find Usage</strong></a> in <a href="../0x08-Testing-Tools/#jadx">jadx</a>.</p>
<h5 id="native-code_1">Native Code<a class="headerlink" href="#native-code_1" title="Permanent link">&para;</a></h5>
<p>Similarly to Java analysis, you can also use Ghidra to analyze native libraries and obtain cross references by right clicking the desired function and selecting <strong>Show References to</strong>.</p>
<h4 id="api-usage">API Usage<a class="headerlink" href="#api-usage" title="Permanent link">&para;</a></h4>
<p>The Android platform provides many in-built libraries for frequently used functionalities in applications, for example cryptography, Bluetooth, NFC, network or location libraries. Determining the presence of these libraries in an application can give us valuable information about its nature.</p>
<p>For instance, if an application is importing <code>javax.crypto.Cipher</code>, it indicates that the application will be performing some kind of cryptographic operation. Fortunately, cryptographic calls are very standard in nature, i.e, they need to be called in a particular order to work correctly, this knowledge can be helpful when analyzing cryptography APIs. For example, by looking for the <code>Cipher.getInstance</code> function, we can determine the cryptographic algorithm being used. With such an approach we can directly move to analyzing cryptographic assets, which often are very critical in an application. Further information on how to analyze Android's cryptographic APIs is discussed in the section  "<a href="../0x05e-Testing-Cryptography/" title="Android Cryptographic APIs">Android Cryptographic APIs</a>".</p>
<p>Similarly, the above approach can be used to determine where and how an application is using NFC. For instance, an application using Host-based Card Emulation for performing digital payments must use the <code>android.nfc</code> package. Therefore, a good stating point for NFC API analysis would be to consult the <a href="https://developer.android.com/guide/topics/connectivity/nfc/hce" title="Host-based card emulation overview">Android Developer Documentation</a> to get some ideas and start searching for critical functions such as <code>processCommandApdu</code> from the <code>android.nfc.cardemulation.HostApduService</code> class.</p>
<h4 id="network-communication">Network Communication<a class="headerlink" href="#network-communication" title="Permanent link">&para;</a></h4>
<p>Most of the apps you might encounter connect to remote endpoints. Even before you perform any dynamic analysis (e.g. traffic capture and analysis), you can obtain some initial inputs or entry points by enumerating the domains to which the application is supposed to communicate to.</p>
<p>Typically these domains will be present as strings within the binary of the application. One way to achieve this is by using automated tools such as <a href="https://github.com/shivsahni/APKEnum" title="APKEnum: A Python Utility For APK Enumeration">APKEnum</a> or <a href="https://github.com/MobSF/Mobile-Security-Framework-MobSF" title="MobSF">MobSF</a>. Alternatively, you can <em>grep</em> for the domain names by using regular expressions. For this you can target the app binary directly or reverse engineer it and target the disassembled or decompiled code. The latter option has a clear advantage: it can provide you with <strong>context</strong>, as you'll be able to see in which context each domain is being used (e.g. class and method).
``</p>
<p>From here on you can use this information to derive more insights which might be of use later during your analysis, e.g. you could match the domains to the pinned certificates or the Network Security Configuration file or perform further reconnaissance on domain names to know more about the target environment. When evaluating an application it is important to check the Network Security Configuration file, as often (less secure) debug configurations might be pushed into final release builds by mistake.</p>
<p>The implementation and verification of secure connections can be an intricate process and there are numerous aspects to consider. For instance, many applications use other protocols apart from HTTP such as XMPP or plain TCP packets, or perform certificate pinning in an attempt to deter MITM attacks but unfortunately having severe logical bugs in its implementation or an inherently wrong security network configuration.</p>
<p>Remember that in most of the cases, just using static analysis will not be enough and might even turn to be extremely inefficient when compared to the dynamic alternatives which will get much more reliable results (e.g. using an interceptor proxy). In this section we've just slightly touched the surface, please refer to the section "<a href="../0x05b-Basic-Security_Testing/#basic-network-monitoringsniffing" title="Basic Network Monitoring/Sniffing">Basic Network Monitoring/Sniffing</a>" in the "Android Basic Security Testing" chapter and also check the test cases in the chapter "<a href="../0x05g-Testing-Network-Communication/" title="Android Network APIs">Android Network APIs</a>".</p>
<h3 id="manual-reversed-code-review">Manual (Reversed) Code Review<a class="headerlink" href="#manual-reversed-code-review" title="Permanent link">&para;</a></h3>
<h4 id="reviewing-decompiled-java-code">Reviewing Decompiled Java Code<a class="headerlink" href="#reviewing-decompiled-java-code" title="Permanent link">&para;</a></h4>
<p>Following the example from "Decompiling Java Code", we assume that you've successfully decompiled and opened the crackme app in IntelliJ. As soon as IntelliJ has indexed the code, you can browse it just like you'd browse any other Java project. Note that many of the decompiled packages, classes, and methods have weird one-letter names; this is because the bytecode has been "minified" with ProGuard at build time. This is a basic type of obfuscation that makes the bytecode a little more difficult to read, but with a fairly simple app like this one, it won't cause you much of a headache. When you're analyzing a more complex app, however, it can get quite annoying.</p>
<p>When analyzing obfuscated code, annotating class names, method names, and other identifiers as you go along is a good practice. Open the <code>MainActivity</code> class in the package <code>sg.vantagepoint.uncrackable1</code>. The method <code>verify</code> is called when you tap the "verify" button. This method passes the user input to a static method called <code>a.a</code>, which returns a boolean value. It seems plausible that <code>a.a</code> verifies user input, so we'll refactor the code to reflect this.</p>
<p><img src="../../assets/Images/Chapters/0x05c/check_input.jpg" width="100%" /></p>
<p>Right-click the class name (the first <code>a</code> in <code>a.a</code>) and select Refactor -&gt; Rename from the drop-down menu (or press Shift-F6). Change the class name to something that makes more sense given what you know about the class so far. For example, you could call it "Validator" (you can always revise the name later). <code>a.a</code> now becomes <code>Validator.a</code>. Follow the same procedure to rename the static method <code>a</code> to <code>check_input</code>.</p>
<p><img src="../../assets/Images/Chapters/0x05c/refactored.jpg" width="100%" /></p>
<p>Congratulations, you just learned the fundamentals of static analysis! It is all about theorizing, annotating, and gradually revising theories about the analyzed program until you understand it completely or, at least, well enough for whatever you want to achieve.</p>
<p>Next, Ctrl+click (or Command+click on Mac) on the <code>check_input</code> method. This takes you to the method definition. The decompiled method looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">check_input</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">arrby</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decode</span><span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="err">\</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;5UJiFctbmgbDoLXmpL12mkno8HT4Lv8dlat8FxR2GOc=&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">arrby2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="p">{};</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">arrby</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sg</span><span class="p">.</span><span class="na">vantagepoint</span><span class="p">.</span><span class="na">a</span><span class="p">.</span><span class="na">a</span><span class="p">.</span><span class="na">a</span><span class="p">(</span><span class="n">Validator</span><span class="p">.</span><span class="na">b</span><span class="p">(</span><span class="s">&quot;8d127684cbc37c17616d806cf50473cc&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">arrby</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">arrby2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arrby</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="n">sa</span><span class="w"></span>
<span class="w">        </span><span class="nf">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">exception</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="s">&quot;CodeCheck&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)(</span><span class="s">&quot;AES error:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">exception</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">arrby2</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>So, you have a Base64-encoded String that's passed to the function <code>a</code> in the package \
<code>sg.vantagepoint.a.a</code> (again, everything is called <code>a</code>) along with something that looks suspiciously like a hex-encoded encryption key (16 hex bytes = 128bit, a common key length). What exactly does this particular <code>a</code> do? Ctrl-click it to find out.</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">a</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">arrby</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecretKeySpec</span><span class="p">((</span><span class="kt">byte</span><span class="o">[]</span><span class="p">)</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AES/ECB/PKCS7Padding&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;AES&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Key</span><span class="p">)</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">arrby</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Now you're getting somewhere: it's simply standard AES-ECB. Looks like the Base64 string stored in <code>arrby1</code> in <code>check_input</code> is a ciphertext. It is decrypted with 128bit AES, then compared with the user input. As a bonus task, try to decrypt the extracted ciphertext and find the secret value!</p>
<p>A faster way to get the decrypted string is to add dynamic analysis. We'll revisit UnCrackable App for Android Level 1 later to show how (e.g. in the Debugging section), so don't delete the project yet!</p>
<h4 id="reviewing-disassembled-native-code">Reviewing Disassembled Native Code<a class="headerlink" href="#reviewing-disassembled-native-code" title="Permanent link">&para;</a></h4>
<p>Following the example from "Disassembling Native Code" we will use different disassemblers to review the disassembled native code.</p>
<h5 id="radare2_1">radare2<a class="headerlink" href="#radare2_1" title="Permanent link">&para;</a></h5>
<p>Once you've opened your file in radare2 you should first get the address of the function you're looking for. You can do this by listing or getting information <code>i</code> about the symbols <code>s</code> (<code>is</code>) and grepping (<code>~</code> radare2's built-in grep) for some keyword, in our case we're looking for JNI related symbols so we enter "Java":</p>
<div class="highlight"><pre><span></span><code>$ r2 -A HelloWord-JNI/lib/armeabi-v7a/libnative-lib.so
...
<span class="o">[</span>0x00000e3c<span class="o">]</span>&gt; is~Java
<span class="m">003</span> 0x00000e78 0x00000e78 GLOBAL   FUNC   <span class="m">16</span> Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI
</code></pre></div>
<p>The method can be found at address <code>0x00000e78</code>. To display its disassembly simply run the following commands:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000e3c<span class="o">]</span>&gt; e emu.str<span class="o">=</span>true<span class="p">;</span>
<span class="o">[</span>0x00000e3c<span class="o">]</span>&gt; s 0x00000e78
<span class="o">[</span>0x00000e78<span class="o">]</span>&gt; af
<span class="o">[</span>0x00000e78<span class="o">]</span>&gt; pdf
╭ <span class="o">(</span>fcn<span class="o">)</span> sym.Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI <span class="m">12</span>
│   sym.Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI <span class="o">(</span>int32_t arg1<span class="o">)</span><span class="p">;</span>
│           <span class="p">;</span> arg int32_t arg1 @ r0
│           0x00000e78  ~   <span class="m">0268</span>           ldr r2, <span class="o">[</span>r0<span class="o">]</span>                <span class="p">;</span> arg1
│           <span class="p">;</span>-- aav.0x00000e79:
│           <span class="p">;</span> UNKNOWN XREF from aav.0x00000189 <span class="o">(</span>+0x3<span class="o">)</span>
│           0x00000e79                    unaligned
│           0x00000e7a      <span class="m">0249</span>           ldr r1, aav.0x00000f3c      <span class="p">;</span> <span class="o">[</span>0xe84:4<span class="o">]=</span>0xf3c aav.0x00000f3c
│           0x00000e7c      d2f89c22       ldr.w r2, <span class="o">[</span>r2, 0x29c<span class="o">]</span>
│           0x00000e80      <span class="m">7944</span>           add r1, pc                  <span class="p">;</span> <span class="s2">&quot;Hello from C++&quot;</span> section..rodata
╰           0x00000e82      <span class="m">1047</span>           bx r2
</code></pre></div>
<p>Let's explain the previous commands:</p>
<ul>
<li><code>e emu.str=true;</code> enables radare2's string emulation. Thanks to this, we can see the string we're looking for ("Hello from C++").</li>
<li><code>s 0x00000e78</code> is a <em>seek</em> to the address <code>s 0x00000e78</code>, where our target function is located. We do this so that the following commands apply to this address.</li>
<li><code>pdf</code> means <em>print disassembly of function</em>.</li>
</ul>
<p>Using radare2 you can quickly run commands and exit by using the flags <code>-qc '&lt;commands&gt;'</code>. From the previous steps we know already what to do so we will simply put everything together:</p>
<div class="highlight"><pre><span></span><code>$ r2 -qc <span class="s1">&#39;e emu.str=true; s 0x00000e78; af; pdf&#39;</span> HelloWord-JNI/lib/armeabi-v7a/libnative-lib.so

╭ <span class="o">(</span>fcn<span class="o">)</span> sym.Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI <span class="m">12</span>
│   sym.Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI <span class="o">(</span>int32_t arg1<span class="o">)</span><span class="p">;</span>
│           <span class="p">;</span> arg int32_t arg1 @ r0
│           0x00000e78      <span class="m">0268</span>           ldr r2, <span class="o">[</span>r0<span class="o">]</span>                <span class="p">;</span> arg1
│           0x00000e7a      <span class="m">0249</span>           ldr r1, <span class="o">[</span>0x00000e84<span class="o">]</span>        <span class="p">;</span> <span class="o">[</span>0xe84:4<span class="o">]=</span>0xf3c
│           0x00000e7c      d2f89c22       ldr.w r2, <span class="o">[</span>r2, 0x29c<span class="o">]</span>
│           0x00000e80      <span class="m">7944</span>           add r1, pc                  <span class="p">;</span> <span class="s2">&quot;Hello from C++&quot;</span> section..rodata
╰           0x00000e82      <span class="m">1047</span>           bx r2
</code></pre></div>
<p>Notice that in this case we're not starting with the <code>-A</code> flag not running <code>aaa</code>. Instead, we just tell radare2 to analyze that one function by using the <em>analyze function</em> <code>af</code> command. This is one of those cases where we can speed up our workflow because you're focusing on some specific part of an app.</p>
<p>The workflow can be further improved by using <a href="https://github.com/radareorg/r2ghidra-dec" title="r2ghidra-dec">r2ghidra-dec</a>, a deep integration of Ghidra decompiler for radare2. r2ghidra-dec generates decompiled C code, which can aid in quickly analyzing the binary.</p>
<h5 id="ida-pro_1">IDA Pro<a class="headerlink" href="#ida-pro_1" title="Permanent link">&para;</a></h5>
<p>We assume that you've successfully opened <code>lib/armeabi-v7a/libnative-lib.so</code> in IDA pro. Once the file is loaded, click into the "Functions" window on the left and press <code>Alt+t</code> to open the search dialog. Enter "java" and hit enter. This should highlight the <code>Java_sg_vantagepoint_helloworld_ MainActivity_stringFromJNI</code> function. Double-click the function to jump to its address in the disassembly Window. "Ida View-A" should now show the disassembly of the function.</p>
<p><img src="../../assets/Images/Chapters/0x05c/helloworld_stringfromjni.jpg" width="400px" /></p>
<p>Not a lot of code there, but you should analyze it. The first thing you need to know is that the first argument passed to every JNI function is a JNI interface pointer. An interface pointer is a pointer to a pointer. This pointer points to a function table: an array of even more pointers, each of which points to a JNI interface function (is your head spinning yet?). The function table is initialized by the Java VM and allows the native function to interact with the Java environment.</p>
<p><img src="../../assets/Images/Chapters/0x05c/JNI_interface.png" width="100%" /></p>
<p>With that in mind, let's have a look at each line of assembly code.</p>
<div class="highlight"><pre><span></span><code>LDR  R2, [R0]
</code></pre></div>
<p>Remember: the first argument (in R0) is a pointer to the JNI function table pointer. The <code>LDR</code> instruction loads this function table pointer into R2.</p>
<div class="highlight"><pre><span></span><code>LDR  R1, =aHelloFromC
</code></pre></div>
<p>This instruction loads into R1 the PC-relative offset of the string "Hello from C++". Note that this string comes directly after the end of the function block at offset 0xe84. Addressing relative to the program counter allows the code to run independently of its position in memory.</p>
<div class="highlight"><pre><span></span><code>LDR.W  R2, [R2, #0x29C]
</code></pre></div>
<p>This instruction loads the function pointer from offset 0x29C into the JNI function pointer table pointed to by R2. This is the <code>NewStringUTF</code> function. You can look at the list of function pointers in jni.h, which is included in the Android NDK. The function prototype looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="n">jstring</span><span class="w">     </span><span class="p">(</span><span class="o">*</span><span class="n">NewStringUTF</span><span class="p">)(</span><span class="n">JNIEnv</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>The function takes two arguments: the JNIEnv pointer (already in R0) and a String pointer. Next, the current value of PC is added to R1, resulting in the absolute address of the static string "Hello from C++" (PC + offset).</p>
<div class="highlight"><pre><span></span><code>ADD  R1, PC
</code></pre></div>
<p>Finally, the program executes a branch instruction to the <code>NewStringUTF</code> function pointer loaded into R2:</p>
<div class="highlight"><pre><span></span><code>BX   R2
</code></pre></div>
<p>When this function returns, R0 contains a pointer to the newly constructed UTF string. This is the final return value, so R0 is left unchanged and the function returns.</p>
<h5 id="ghidra">Ghidra<a class="headerlink" href="#ghidra" title="Permanent link">&para;</a></h5>
<p>After opening the library in Ghidra we can see all the functions defined in the <strong>Symbol Tree</strong> panel under <strong>Functions</strong>. The native library for the current application is relatively very small. There are three user defined functions: <code>FUN_001004d0</code>, <code>FUN_0010051c</code>, and <code>Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI</code>. The other symbols are not user defined and are generated for proper functioning of the shared library. The instructions in the function <code>Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI</code> are already discussed in detail in previous sections. In this section we can look into the decompilation of the function.</p>
<p>Inside the current function there is a call to another function, whose address is obtained by accessing an offset in the <code>JNIEnv</code> pointer (found as <code>plParm1</code>). This logic has been diagrammatically demonstrated above as well. The corresponding C code for the disassembled function is shown in the <strong>Decompiler</strong> window. This decompiled C code makes it much easier to understand the function call being made. Since this function is small and extremely simple, the decompilation output is very accurate, this can change drastically when dealing with complex functions.</p>
<p><img src="../../assets/Images/Chapters/0x05c/Ghidra_decompiled_function.png" width="100%" /></p>
<h3 id="automated-static-analysis">Automated Static Analysis<a class="headerlink" href="#automated-static-analysis" title="Permanent link">&para;</a></h3>
<p>You should use tools for efficient static analysis. They allow the tester to focus on the more complicated business logic. A plethora of static code analyzers are available, ranging from open source scanners to full-blown enterprise-ready scanners. The best tool for the job depends on budget, client requirements, and the tester's preferences.</p>
<p>Some static analyzers rely on the availability of the source code; others take the compiled APK as input.
Keep in mind that static analyzers may not be able to find all problems by themselves even though they can help us focus on potential problems. Review each finding carefully and try to understand what the app is doing to improve your chances of finding vulnerabilities.</p>
<p>Configure the static analyzer properly to reduce the likelihood of false positives and maybe only select several vulnerability categories in the scan. The results generated by static analyzers can otherwise be overwhelming, and your efforts can be counterproductive if you must manually investigate a large report.</p>
<p>There are several open source tools for automated security analysis of an APK.</p>
<ul>
<li><a href="https://github.com/AndroBugs/AndroBugs_Framework" title="Androbugs">Androbugs</a></li>
<li><a href="https://github.com/flankerhqd/JAADAS" title="JAADAS">JAADAS</a></li>
<li><a href="../0x08-Testing-Tools/#mobsf">MobSF</a></li>
<li><a href="https://github.com/linkedin/qark/" title="QARK">QARK</a></li>
</ul>
<h2 id="dynamic-analysis">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis" title="Permanent link">&para;</a></h2>
<p>Dynamic Analysis tests the mobile app by executing and running the app binary and analyzing its workflows for vulnerabilities. For example, vulnerabilities regarding data storage might be sometimes hard to catch during static analysis, but in dynamic analysis you can easily spot what information is stored persistently and if the information is protected properly. Besides this, dynamic analysis allows the tester to properly identify:</p>
<ul>
<li>Business logic flaws</li>
<li>Vulnerabilities in the tested environments</li>
<li>Weak input validation and bad input/output encoding as they are processed through one or multiple services</li>
</ul>
<p>Analysis can be assisted by automated tools, such as <a href="https://github.com/MobSF/Mobile-Security-Framework-MobSF/" title="MobSF">MobSF</a>, while assessing an application. An application can be assessed by side-loading it, re-packaging it, or by simply attacking the installed version.</p>
<h3 id="dynamic-analysis-on-non-rooted-devices">Dynamic Analysis on Non-Rooted Devices<a class="headerlink" href="#dynamic-analysis-on-non-rooted-devices" title="Permanent link">&para;</a></h3>
<p>Non-rooted devices provide the tester with two benefits:</p>
<ul>
<li>Replicate an environment that the application is intended to run on.</li>
<li>Thanks to tools like objection, you can patch the app in order to test it like if you were on a rooted device (but of course being jailed to that one app).</li>
</ul>
<p>In order to dynamically analyze the application, you can also rely on <a href="https://github.com/sensepost/objection" title="objection">objection</a> which is leveraging Frida. However, in order to be able to use objection on non-rooted devices you have to perform one additional step: <a href="https://github.com/sensepost/objection/wiki/Patching-Android-Applications#patching---patching-an-apk" title="patching - patching an APK">patch the APK</a> to include the <a href="https://www.frida.re/docs/gadget/" title="Frida Gadget">Frida gadget</a> library. Objection communicates then using a Python API with the mobile phone through the installed Frida gadget.</p>
<p>In order to accomplish this, the following commands can set you up and running:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Download the Uncrackable APK</span>
$ wget https://raw.githubusercontent.com/OWASP/owasp-mstg/master/Crackmes/Android/Level_01/UnCrackable-Level1.apk
<span class="c1"># Patch the APK with the Frida Gadget</span>
$ objection patchapk --source UnCrackable-Level1.apk
<span class="c1"># Install the patched APK on the android phone</span>
$ adb install UnCrackable-Level1.objection.apk
<span class="c1"># After running the mobile phone, objection will detect the running frida-server through the APK</span>
$ objection explore
</code></pre></div>
<h3 id="basic-information-gathering_1">Basic Information Gathering<a class="headerlink" href="#basic-information-gathering_1" title="Permanent link">&para;</a></h3>
<p>As mentioned previously, Android runs on top of a modified Linux kernel and retains the <a href="https://www.kernel.org/doc/Documentation/filesystems/proc.txt" title="procfs">proc filesystem</a> (procfs) from Linux, which is mounted at <code>/proc</code>. Procfs provides a directory-based view of a process running on the system, providing detailed information about the process itself, its threads, and other system-wide diagnostics. Procfs is arguably one of the most important filesystems on Android, where many OS native tools depend on it as their source of information.</p>
<p>Many command line tools are not shipped with the Android firmware to reduce the size, but can be easily installed on a rooted device using <a href="../0x08-Testing-Tools/#busybox">BusyBox</a>. We can also create our own custom scripts using commands like <code>cut</code>, <code>grep</code>, <code>sort</code> etc, to parse the proc filesystem information.</p>
<p>In this section, we will be using information from procfs directly or indirectly to gather information about a running process.</p>
<h4 id="open-files">Open Files<a class="headerlink" href="#open-files" title="Permanent link">&para;</a></h4>
<p>You can use <code>lsof</code> with the flag <code>-p &lt;pid&gt;</code> to return the list of open files for the specified process. See the <a href="http://man7.org/linux/man-pages/man8/lsof.8.html" title="Man Page of lsof">man page</a> for more options.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># lsof -p 6233</span>
COMMAND     PID       USER   FD      TYPE             DEVICE  SIZE/OFF       NODE NAME
.foobar.c  <span class="m">6233</span>     u0_a97  cwd       DIR                <span class="m">0</span>,1         <span class="m">0</span>          <span class="m">1</span> /
.foobar.c  <span class="m">6233</span>     u0_a97  rtd       DIR                <span class="m">0</span>,1         <span class="m">0</span>          <span class="m">1</span> /
.foobar.c  <span class="m">6233</span>     u0_a97  txt       REG             <span class="m">259</span>,11     <span class="m">23968</span>        <span class="m">399</span> /system/bin/app_process64
.foobar.c  <span class="m">6233</span>     u0_a97  mem   unknown                                         /dev/ashmem/dalvik-main space <span class="o">(</span>region space<span class="o">)</span> <span class="o">(</span>deleted<span class="o">)</span>
.foobar.c  <span class="m">6233</span>     u0_a97  mem       REG              <span class="m">253</span>,0   <span class="m">2797568</span>    <span class="m">1146914</span> /data/dalvik-cache/arm64/system@framework@boot.art
.foobar.c  <span class="m">6233</span>     u0_a97  mem       REG              <span class="m">253</span>,0   <span class="m">1081344</span>    <span class="m">1146915</span> /data/dalvik-cache/arm64/system@framework@boot-core-libart.art
...
</code></pre></div>
<p>In the above output, the most relevant fields for us are:</p>
<ul>
<li><code>NAME</code>: path of the file.</li>
<li><code>TYPE</code>: type of the file, for example, file is a directory or a regular file.</li>
</ul>
<p>This can be extremely useful to spot unusual files when monitoring applications using obfuscation or other anti-reverse engineering techniques, without having to reverse the code. For instance, an application might be performing encryption-decryption of data and storing it in a file temporarily.</p>
<h4 id="open-connections">Open Connections<a class="headerlink" href="#open-connections" title="Permanent link">&para;</a></h4>
<p>You can find system-wide networking information in <code>/proc/net</code> or just by inspecting the <code>/proc/&lt;pid&gt;/net</code> directories (for some reason not process specific). There are multiple files present in these directories, of which <code>tcp</code>, <code>tcp6</code> and <code>udp</code> might be considered relevant from the tester's perspective.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># cat /proc/7254/net/tcp</span>
sl  local_address rem_address   st tx_queue rx_queue tr tm-&gt;when retrnsmt   uid  timeout inode
...
<span class="m">69</span>: 1101A8C0:BB2F 9A447D4A:01BB <span class="m">01</span> <span class="m">00000000</span>:00000000 <span class="m">00</span>:00000000 <span class="m">00000000</span> <span class="m">10093</span>        <span class="m">0</span> <span class="m">75412</span> <span class="m">1</span> <span class="m">0000000000000000</span> <span class="m">20</span> <span class="m">3</span> <span class="m">19</span> <span class="m">10</span> -1
<span class="m">70</span>: 1101A8C0:917C E3CB3AD8:01BB <span class="m">01</span> <span class="m">00000000</span>:00000000 <span class="m">00</span>:00000000 <span class="m">00000000</span> <span class="m">10093</span>        <span class="m">0</span> <span class="m">75553</span> <span class="m">1</span> <span class="m">0000000000000000</span> <span class="m">20</span> <span class="m">3</span> <span class="m">23</span> <span class="m">10</span> -1
<span class="m">71</span>: 1101A8C0:C1E3 9C187D4A:01BB <span class="m">01</span> <span class="m">00000000</span>:00000000 <span class="m">00</span>:00000000 <span class="m">00000000</span> <span class="m">10093</span>        <span class="m">0</span> <span class="m">75458</span> <span class="m">1</span> <span class="m">0000000000000000</span> <span class="m">20</span> <span class="m">3</span> <span class="m">19</span> <span class="m">10</span> -1
...
</code></pre></div>
<p>In the output above, the most relevant fields for us are:</p>
<ul>
<li><code>rem_address</code>: remote address and port number pair (in hexadecimal representation).</li>
<li><code>tx_queue</code> and <code>rx_queue</code>: the outgoing and incoming data queue in terms of kernel memory usage. These fields give an indication how actively the connection is being used.</li>
<li><code>uid</code>: containing the effective UID of the creator of the socket.</li>
</ul>
<p>Another alternative is to use the <code>netstat</code> command, which also provides information about the network activity for the complete system in a more readable format, and can be easily filtered as per our requirements. For instance, we can easily filter it by PID:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># netstat -p | grep 24685</span>
Active Internet connections <span class="o">(</span>w/o servers<span class="o">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program Name
tcp        <span class="m">0</span>      <span class="m">0</span> <span class="m">192</span>.168.1.17:47368      <span class="m">172</span>.217.194.103:https   CLOSE_WAIT  <span class="m">24685</span>/com.google.android.youtube
tcp        <span class="m">0</span>      <span class="m">0</span> <span class="m">192</span>.168.1.17:47233      <span class="m">172</span>.217.194.94:https    CLOSE_WAIT  <span class="m">24685</span>/com.google.android.youtube
tcp        <span class="m">0</span>      <span class="m">0</span> <span class="m">192</span>.168.1.17:38480      sc-in-f100.1e100.:https ESTABLISHED <span class="m">24685</span>/com.google.android.youtube
tcp        <span class="m">0</span>      <span class="m">0</span> <span class="m">192</span>.168.1.17:44833      <span class="m">74</span>.125.24.91:https      ESTABLISHED <span class="m">24685</span>/com.google.android.youtube
tcp        <span class="m">0</span>      <span class="m">0</span> <span class="m">192</span>.168.1.17:38481      sc-in-f100.1e100.:https ESTABLISHED <span class="m">24685</span>/com.google.android.youtube
...
</code></pre></div>
<p><code>netstat</code> output is clearly more user friendly than reading <code>/proc/&lt;pid&gt;/net</code>. The most relevant fields for us, similar to the previous output, are following:</p>
<ul>
<li><code>Foreign Address</code>: remote address and port number pair (port number can be replaced with the well-known name of a protocol associated with the port).</li>
<li><code>Recv-Q</code> and <code>Send-Q</code>: Statistics related to receive and send queue. Gives an indication on how actively the connection is being used.</li>
<li><code>State</code>: the state of a socket, for example, if the socket is in active use (<code>ESTABLISHED</code>) or closed (<code>CLOSED</code>).</li>
</ul>
<h4 id="loaded-native-libraries">Loaded Native Libraries<a class="headerlink" href="#loaded-native-libraries" title="Permanent link">&para;</a></h4>
<p>The file <code>/proc/&lt;pid&gt;/maps</code> contains the currently mapped memory regions and their access permissions. Using this file we can get the list of the libraries loaded in the process.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># cat /proc/9568/maps</span>
12c00000-52c00000 rw-p <span class="m">00000000</span> <span class="m">00</span>:04 <span class="m">14917</span>                              /dev/ashmem/dalvik-main space <span class="o">(</span>region space<span class="o">)</span> <span class="o">(</span>deleted<span class="o">)</span>
6f019000-6f2c0000 rw-p <span class="m">00000000</span> fd:00 <span class="m">1146914</span>                            /data/dalvik-cache/arm64/system@framework@boot.art
...
<span class="m">7327670000</span>-7329747000 r--p <span class="m">00000000</span> fd:00 <span class="m">1884627</span>                        /data/app/com.google.android.gms-4FJbDh-oZv-5bCw39jkIMQ<span class="o">==</span>/oat/arm64/base.odex
..
733494d000-7334cfb000 r-xp <span class="m">00000000</span> fd:00 <span class="m">1884542</span>                        /data/app/com.google.android.youtube-Rl_hl9LptFQf3Vf-JJReGw<span class="o">==</span>/lib/arm64/libcronet.80.0.3970.3.so
...
</code></pre></div>
<h4 id="sandbox-inspection">Sandbox Inspection<a class="headerlink" href="#sandbox-inspection" title="Permanent link">&para;</a></h4>
<p>The application data is stored in a sandboxed directory present at <code>/data/data/&lt;app_package_name&gt;</code>. The content of this directory has already been discussed in detail in the "<a href="../0x05b-Basic-Security_Testing/#accessing-app-data-directories" title="Accessing App Data Directories">Accessing App Data Directories</a>" section.</p>
<h3 id="debugging">Debugging<a class="headerlink" href="#debugging" title="Permanent link">&para;</a></h3>
<p>So far, you've been using static analysis techniques without running the target apps. In the real world, especially when reversing malware or more complex apps, pure static analysis is very difficult. Observing and manipulating an app during runtime makes it much, much easier to decipher its behavior. Next, we'll have a look at dynamic analysis methods that help you do just that.</p>
<p>Android apps support two different types of debugging: Debugging on the level of the Java runtime with the Java Debug Wire Protocol (JDWP), and Linux/Unix-style ptrace-based debugging on the native layer, both of which are valuable to reverse engineers.</p>
<h4 id="debugging-release-apps">Debugging Release Apps<a class="headerlink" href="#debugging-release-apps" title="Permanent link">&para;</a></h4>
<p>Dalvik and ART support the JDWP, a protocol for communication between the debugger and the Java virtual machine (VM) that it debugs. JDWP is a standard debugging protocol that's supported by all command line tools and Java IDEs, including jdb, JEB, IntelliJ, and Eclipse. Android's implementation of JDWP also includes hooks for supporting extra features implemented by the Dalvik Debug Monitor Server (DDMS).</p>
<p>A JDWP debugger allows you to step through Java code, set breakpoints on Java methods, and inspect and modify local and instance variables. You'll use a JDWP debugger most of the time you debug "normal" Android apps (i.e., apps that don't make many calls to native libraries).</p>
<p>In the following section, we'll show how to solve the UnCrackable App for Android Level 1 with jdb alone. Note that this is not an <em>efficient</em> way to solve this crackme. Actually you can do it much faster with Frida and other methods, which we'll introduce later in the guide. This, however, serves as an introduction to the capabilities of the Java debugger.</p>
<h4 id="debugging-with-jdb">Debugging with jdb<a class="headerlink" href="#debugging-with-jdb" title="Permanent link">&para;</a></h4>
<p>The <code>adb</code> command line tool was introduced in the "<a href="../0x05b-Basic-Security_Testing/" title="Android Basic Security Testing">Android Basic Security Testing</a>" chapter. You can use its <code>adb jdwp</code> command to list the process IDs of all debuggable processes running on the connected device (i.e., processes hosting a JDWP transport). With the <code>adb forward</code> command, you can open a listening socket on your host computer and forward this socket's incoming TCP connections to the JDWP transport of a chosen process.</p>
<div class="highlight"><pre><span></span><code>$ adb jdwp
<span class="m">12167</span>
$ adb forward tcp:7777 jdwp:12167
</code></pre></div>
<p>You're now ready to attach jdb. Attaching the debugger, however, causes the app to resume, which you don't want. You want to keep it suspended so that you can explore first. To prevent the process from resuming, pipe the <code>suspend</code> command into jdb:</p>
<div class="highlight"><pre><span></span><code>$ <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;suspend&quot;</span><span class="p">;</span> cat<span class="p">;</span> <span class="o">}</span> <span class="p">|</span> jdb -attach localhost:7777
Initializing jdb ...
&gt; All threads suspended.
&gt;
</code></pre></div>
<p>You're now attached to the suspended process and ready to go ahead with the jdb commands. Entering <code>?</code> prints the complete list of commands. Unfortunately, the Android VM doesn't support all available JDWP features. For example, the <code>redefine</code> command, which would let you redefine a class' code is not supported. Another important restriction is that line breakpoints won't work because the release bytecode doesn't contain line information. Method breakpoints do work, however. Useful working commands include:</p>
<ul>
<li>classes: list all loaded classes</li>
<li>class/methods/fields <em>class id</em>: Print details about a class and list its methods and fields</li>
<li>locals: print local variables in current stack frame</li>
<li>print/dump <em>expr</em>: print information about an object</li>
<li>stop in <em>method</em>: set a method breakpoint</li>
<li>clear <em>method</em>: remove a method breakpoint</li>
<li>set <em>lvalue</em> = <em>expr</em>:  assign new value to field/variable/array element</li>
</ul>
<p>Let's revisit the decompiled code from the UnCrackable App for Android Level 1 and think about possible solutions. A good approach would be suspending the app in a state where the secret string is held in a variable in plain text so you can retrieve it. Unfortunately, you won't get that far unless you deal with the root/tampering detection first.</p>
<p>Review the code and you'll see that the method <code>sg.vantagepoint.uncrackable1.MainActivity.a</code> displays the "This in unacceptable..." message box. This method creates an <code>AlertDialog</code> and sets a listener class for the <code>onClick</code> event. This class (named <code>b</code>) has a callback method will terminates the app once the user taps the <strong>OK</strong> button. To prevent the user from simply canceling the dialog, the <code>setCancelable</code> method is called.</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">title</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">AlertDialog</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AlertDialog$Builder</span><span class="p">((</span><span class="n">Context</span><span class="p">)</span><span class="k">this</span><span class="p">).</span><span class="na">create</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">create</span><span class="p">.</span><span class="na">setTitle</span><span class="p">((</span><span class="n">CharSequence</span><span class="p">)</span><span class="n">title</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">create</span><span class="p">.</span><span class="na">setMessage</span><span class="p">((</span><span class="n">CharSequence</span><span class="p">)</span><span class="s">&quot;This in unacceptable. The app is now going to exit.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">create</span><span class="p">.</span><span class="na">setButton</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">CharSequence</span><span class="p">)</span><span class="s">&quot;OK&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">DialogInterface$OnClickListener</span><span class="p">)</span><span class="k">new</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="k">this</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">create</span><span class="p">.</span><span class="na">setCancelable</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">create</span><span class="p">.</span><span class="na">show</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>You can bypass this with a little runtime tampering. With the app still suspended, set a method breakpoint on <code>android.app.Dialog.setCancelable</code> and resume the app.</p>
<div class="highlight"><pre><span></span><code>&gt; stop <span class="k">in</span> android.app.Dialog.setCancelable
Set breakpoint android.app.Dialog.setCancelable
&gt; resume
All threads resumed.
&gt;
Breakpoint hit: <span class="s2">&quot;thread=main&quot;</span>, android.app.Dialog.setCancelable<span class="o">()</span>, <span class="nv">line</span><span class="o">=</span><span class="m">1</span>,110 <span class="nv">bci</span><span class="o">=</span><span class="m">0</span>
main<span class="o">[</span><span class="m">1</span><span class="o">]</span>
</code></pre></div>
<p>The app is now suspended at the first instruction of the <code>setCancelable</code> method. You can print the arguments passed to <code>setCancelable</code> with the <code>locals</code> command (the arguments are shown incorrectly under "local variables").</p>
<div class="highlight"><pre><span></span><code>main<span class="o">[</span><span class="m">1</span><span class="o">]</span> locals
Method arguments:
Local variables:
<span class="nv">flag</span> <span class="o">=</span> <span class="nb">true</span>
</code></pre></div>
<p><code>setCancelable(true)</code> was called, so this can't be the call we're looking for. Resume the process with the <code>resume</code> command.</p>
<div class="highlight"><pre><span></span><code>main<span class="o">[</span><span class="m">1</span><span class="o">]</span> resume
Breakpoint hit: <span class="s2">&quot;thread=main&quot;</span>, android.app.Dialog.setCancelable<span class="o">()</span>, <span class="nv">line</span><span class="o">=</span><span class="m">1</span>,110 <span class="nv">bci</span><span class="o">=</span><span class="m">0</span>
main<span class="o">[</span><span class="m">1</span><span class="o">]</span> locals
<span class="nv">flag</span> <span class="o">=</span> <span class="nb">false</span>
</code></pre></div>
<p>You've now reached a call to <code>setCancelable</code> with the argument <code>false</code>. Set the variable to <code>true</code> with the <code>set</code> command and resume.</p>
<div class="highlight"><pre><span></span><code>main<span class="o">[</span><span class="m">1</span><span class="o">]</span> <span class="nb">set</span> <span class="nv">flag</span> <span class="o">=</span> <span class="nb">true</span>
 <span class="nv">flag</span> <span class="o">=</span> <span class="nb">true</span> <span class="o">=</span> <span class="nb">true</span>
main<span class="o">[</span><span class="m">1</span><span class="o">]</span> resume
</code></pre></div>
<p>Repeat this process, setting <code>flag</code> to <code>true</code> each time the breakpoint is reached, until the alert box is finally displayed (the breakpoint will be reached five or six times). The alert box should now be cancelable! Tap the screen next to the box and it will close without terminating the app.</p>
<p>Now that the anti-tampering is out of the way, you're ready to extract the secret string! In the "static analysis" section, you saw that the string is decrypted with AES, then compared with the string input to the message box. The method <code>equals</code> of the <code>java.lang.String</code> class compares the string input with the secret string. Set a method breakpoint on <code>java.lang.String.equals</code>, enter an arbitrary text string in the edit field, and tap the "verify" button. Once the breakpoint is reached, you can read the method argument with the <code>locals</code> command.</p>
<div class="highlight"><pre><span></span><code>&gt; stop <span class="k">in</span> java.lang.String.equals
Set breakpoint java.lang.String.equals
&gt;
Breakpoint hit: <span class="s2">&quot;thread=main&quot;</span>, java.lang.String.equals<span class="o">()</span>, <span class="nv">line</span><span class="o">=</span><span class="m">639</span> <span class="nv">bci</span><span class="o">=</span><span class="m">2</span>

main<span class="o">[</span><span class="m">1</span><span class="o">]</span> locals
Method arguments:
Local variables:
<span class="nv">other</span> <span class="o">=</span> <span class="s2">&quot;radiusGravity&quot;</span>
main<span class="o">[</span><span class="m">1</span><span class="o">]</span> cont

Breakpoint hit: <span class="s2">&quot;thread=main&quot;</span>, java.lang.String.equals<span class="o">()</span>, <span class="nv">line</span><span class="o">=</span><span class="m">639</span> <span class="nv">bci</span><span class="o">=</span><span class="m">2</span>

main<span class="o">[</span><span class="m">1</span><span class="o">]</span> locals
Method arguments:
Local variables:
<span class="nv">other</span> <span class="o">=</span> <span class="s2">&quot;I want to believe&quot;</span>
main<span class="o">[</span><span class="m">1</span><span class="o">]</span> cont
</code></pre></div>
<p>This is the plaintext string you're looking for!</p>
<h4 id="debugging-with-an-ide">Debugging with an IDE<a class="headerlink" href="#debugging-with-an-ide" title="Permanent link">&para;</a></h4>
<p>Setting up a project in an IDE with the decompiled sources is a neat trick that allows you to set method breakpoints directly in the source code. In most cases, you should be able single-step through the app and inspect the state of variables with the GUI. The experience won't be perfect, it's not the original source code after all, so you won't be able to set line breakpoints and things will sometimes simply not work correctly. Then again, reversing code is never easy, and efficiently navigating and debugging plain old Java code is a pretty convenient way of doing it. A similar method has been described in the <a href="https://blog.netspi.com/attacking-android-applications-with-debuggers/" title="NetSPI Blog - Attacking Android Applications with Debuggers">NetSPI blog</a>.</p>
<p>To set up IDE debugging, first create your Android project in IntelliJ and copy the decompiled Java sources into the source folder as described above in the "<a href="#reviewing-decompiled-java-code" title="Reviewing Decompiled Java Code">Reviewing Decompiled Java Code</a>" section. On the device, choose the app as <strong>debug app</strong> on the "Developer options" (Uncrackable1 in this tutorial), and make sure you've switched on the "Wait For Debugger" feature.</p>
<p>Once you tap the Uncrackable app icon from the launcher, it will be suspended in "Wait For Debugger" mode.</p>
<p><img src="../../assets/Images/Chapters/0x05c/waitfordebugger.png" width="300px" /></p>
<p>Now you can set breakpoints and attach to the Uncrackable1 app process with the "Attach Debugger" toolbar button.</p>
<p><img src="../../assets/Images/Chapters/0x05c/set_breakpoint_and_attach_debugger.png" width="100%" /></p>
<p>Note that only method breakpoints work when debugging an app from decompiled sources. Once a method breakpoint is reached, you'll get the chance to single step during the method execution.</p>
<p><img src="../../assets/Images/Chapters/0x05c/Choose_Process.png" width="300px" /></p>
<p>After you choose the Uncrackable1 application from the list, the debugger will attach to the app process and you'll reach the breakpoint that was set on the <code>onCreate</code> method. Uncrackable1 app triggers anti-debugging and anti-tampering controls within the <code>onCreate</code> method. That's why setting a breakpoint on the <code>onCreate</code> method just before the anti-tampering and anti-debugging checks are performed is a good idea.</p>
<p>Next, single-step through the <code>onCreate</code> method by clicking "Force Step Into" in Debugger view. The "Force Step Into" option allows you to debug the Android framework functions and core Java classes that are normally ignored by debuggers.</p>
<p><img src="../../assets/Images/Chapters/0x05c/Force_Step_Into.png" width="100%" /></p>
<p>Once you "Force Step Into", the debugger will stop at the beginning of the next method, which is the <code>a</code> method of the class <code>sg.vantagepoint.a.c</code>.</p>
<p><img src="../../assets/Images/Chapters/0x05c/fucntion_a_of_class_sg_vantagepoint_a.png" width="100%" /></p>
<p>This method searches for the "su" binary within a list of directories (<code>/system/xbin</code> and others). Since you're running the app on a rooted device/emulator, you need to defeat this check by manipulating variables and/or function return values.</p>
<p><img src="../../assets/Images/Chapters/0x05c/fucntion_a_of_class_sg_vantagepoint_a.png" width="100%" /></p>
<p>You can see the directory names inside the "Variables" window by clicking "Step Over" the Debugger view to step into and through the <code>a</code> method.</p>
<p><img src="../../assets/Images/Chapters/0x05c/step_over.png" width="100%" /></p>
<p>Step into the <code>System.getenv</code> method with the "Force Step Into" feature.</p>
<p>After you get the colon-separated directory names, the debugger cursor will return to the beginning of the <code>a</code> method, not to the next executable line. This happens because you're working on the decompiled code instead of the source code. This skipping makes following the code flow crucial to debugging decompiled applications. Otherwise, identifying the next line to be executed would become complicated.</p>
<p>If you don't want to debug core Java and Android classes, you can step out of the function by clicking "Step Out" in the Debugger view. Using "Force Step Into" might be a good idea once you reach the decompiled sources and "Step Out" of the core Java and Android classes. This will help speed up debugging while you keep an eye on the return values of the core class functions.</p>
<p><img src="../../assets/Images/Chapters/0x05c/step_out.png" width="100%" /></p>
<p>After the <code>a</code> method gets the directory names,  it will search for the <code>su</code> binary within these directories. To defeat this check, step through the detection method and inspect the variable content. Once execution reaches a location where the <code>su</code> binary would be detected, modify one of the variables holding the file name or directory name by pressing F2 or right-clicking and choosing "Set Value".</p>
<p><img src="../../assets/Images/Chapters/0x05c/set_value.png" width="100%" /></p>
<p><img src="../../assets/Images/Chapters/0x05c/modified_binary_name.png" width="100%" /></p>
<p>Once you modify the binary name or the directory name, <code>File.exists</code> should return <code>false</code>.</p>
<p><img src="../../assets/Images/Chapters/0x05c/file_exists_false.png" width="100%" /></p>
<p>This defeats the first root detection control of UnCrackable App for Android Level 1. The remaining anti-tampering and anti-debugging controls can be defeated in similar ways so that you can finally reach the secret string verification functionality.</p>
<p><img src="../../assets/Images/Chapters/0x05c/anti_debug_anti_tamper_defeated.png" width="400px" /></p>
<p><img src="../../assets/Images/Chapters/0x05c/MainActivity_verify.png" width="100%" /></p>
<p>The secret code is verified by the method <code>a</code> of class <code>sg.vantagepoint.uncrackable1.a</code>. Set a breakpoint on method <code>a</code> and "Force Step Into" when you reach the breakpoint. Then, single-step until you reach the call to <code>String.equals</code>. This is where user input is compared with the secret string.</p>
<p><img src="../../assets/Images/Chapters/0x05c/sg_vantagepoint_uncrackable1_a_function_a.png" width="100%" /></p>
<p>You can see the secret string in the "Variables" view when you reach the <code>String.equals</code> method call.</p>
<p><img src="../../assets/Images/Chapters/0x05c/secret_code.png" width="100%" /></p>
<p><img src="../../assets/Images/Chapters/0x05c/success.png" width="400px" /></p>
<h4 id="debugging-native-code">Debugging Native Code<a class="headerlink" href="#debugging-native-code" title="Permanent link">&para;</a></h4>
<p>Native code on Android is packed into ELF shared libraries and runs just like any other native Linux program. Consequently, you can debug it with standard tools (including GDB and built-in IDE debuggers such as IDA Pro and JEB) as long as they support the device's processor architecture (most devices are based on ARM chipsets, so this is usually not an issue).</p>
<p>You'll now set up your JNI demo app, HelloWorld-JNI.apk, for debugging. It's the same APK you downloaded in "Statically Analyzing Native Code". Use <code>adb install</code> to install it on your device or on an emulator.</p>
<div class="highlight"><pre><span></span><code>$ adb install HelloWorld-JNI.apk
</code></pre></div>
<p>If you followed the instructions at the beginning of this chapter, you should already have the Android NDK. It contains prebuilt versions of gdbserver for various architectures. Copy the gdbserver binary to your device:</p>
<div class="highlight"><pre><span></span><code>$ adb push <span class="nv">$NDK</span>/prebuilt/android-arm/gdbserver/gdbserver /data/local/tmp
</code></pre></div>
<p>The <code>gdbserver --attach</code> command causes gdbserver to attach to the running process and bind to the IP address and port specified in <code>comm</code>, which in this case is a HOST:PORT descriptor. Start HelloWorldJNI on the device, then connect to the device and determine the PID of the HelloWorldJNI process (sg.vantagepoint.helloworldjni). Then switch to the root user and attach <code>gdbserver</code>:</p>
<div class="highlight"><pre><span></span><code>$ adb shell
$ ps <span class="p">|</span> grep helloworld
u0_a164   <span class="m">12690</span> <span class="m">201</span>   <span class="m">1533400</span> <span class="m">51692</span> ffffffff <span class="m">00000000</span> S sg.vantagepoint.helloworldjni
$ su
<span class="c1"># /data/local/tmp/gdbserver --attach localhost:1234 12690</span>
Attached<span class="p">;</span> <span class="nv">pid</span> <span class="o">=</span> <span class="m">12690</span>
Listening on port <span class="m">1234</span>
</code></pre></div>
<p>The process is now suspended, and <code>gdbserver</code> is listening for debugging clients on port <code>1234</code>. With the device connected via USB, you can forward this port to a local port on the host with the <code>abd forward</code> command:</p>
<div class="highlight"><pre><span></span><code>$ adb forward tcp:1234 tcp:1234
</code></pre></div>
<p>You'll now use the prebuilt version of <code>gdb</code> included in the NDK toolchain.</p>
<div class="highlight"><pre><span></span><code>$ <span class="nv">$TOOLCHAIN</span>/bin/gdb libnative-lib.so
GNU gdb <span class="o">(</span>GDB<span class="o">)</span> <span class="m">7</span>.11
<span class="o">(</span>...<span class="o">)</span>
Reading symbols from libnative-lib.so...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
<span class="o">(</span>gdb<span class="o">)</span> target remote :1234
Remote debugging using :1234
0xb6e0f124 <span class="k">in</span> ?? <span class="o">()</span>
</code></pre></div>
<p>You have successfully attached to the process! The only problem is that you're already too late to debug the JNI function <code>StringFromJNI</code>; it only runs once, at startup. You can solve this problem by activating the "Wait for Debugger" option. Go to <strong>Developer Options</strong> -&gt; <strong>Select debug app</strong> and pick HelloWorldJNI, then activate the <strong>Wait for debugger</strong> switch. Then terminate and re-launch the app. It should be suspended automatically.</p>
<p>Our objective is to set a breakpoint at the first instruction of the native function <code>Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI</code> before resuming the app. Unfortunately, this isn't possible at this point in the execution because <code>libnative-lib.so</code> isn't yet mapped into process memory, it's loaded dynamically during runtime. To get this working, you'll first use jdb to gently change the process into the desired state.</p>
<p>First, resume execution of the Java VM by attaching jdb. You don't want the process to resume immediately though, so pipe the <code>suspend</code> command into jdb:</p>
<div class="highlight"><pre><span></span><code>$ adb jdwp
<span class="m">14342</span>
$ adb forward tcp:7777 jdwp:14342
$ <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;suspend&quot;</span><span class="p">;</span> cat<span class="p">;</span> <span class="o">}</span> <span class="p">|</span> jdb -attach localhost:7777
</code></pre></div>
<p>Next, suspend the process where the Java runtime loads <code>libnative-lib.so</code>. In jdb, set a breakpoint at the <code>java.lang.System.loadLibrary</code> method and resume the process. After the breakpoint has been reached, execute the <code>step up</code> command, which will resume the process until <code>loadLibrary</code>returns. At this point, <code>libnative-lib.so</code> has been loaded.</p>
<div class="highlight"><pre><span></span><code>&gt; stop <span class="k">in</span> java.lang.System.loadLibrary
&gt; resume
All threads resumed.
Breakpoint hit: <span class="s2">&quot;thread=main&quot;</span>, java.lang.System.loadLibrary<span class="o">()</span>, <span class="nv">line</span><span class="o">=</span><span class="m">988</span> <span class="nv">bci</span><span class="o">=</span><span class="m">0</span>
&gt; step up
main<span class="o">[</span><span class="m">1</span><span class="o">]</span> step up
&gt;
Step completed: <span class="s2">&quot;thread=main&quot;</span>, sg.vantagepoint.helloworldjni.MainActivity.&lt;clinit&gt;<span class="o">()</span>, <span class="nv">line</span><span class="o">=</span><span class="m">12</span> <span class="nv">bci</span><span class="o">=</span><span class="m">5</span>

main<span class="o">[</span><span class="m">1</span><span class="o">]</span>
</code></pre></div>
<p>Execute <code>gdbserver</code> to attach to the suspended app. This will cause the app to be suspended by both the Java VM and the Linux kernel (creating a state of "double-suspension").</p>
<div class="highlight"><pre><span></span><code>$ adb forward tcp:1234 tcp:1234
$ <span class="nv">$TOOLCHAIN</span>/arm-linux-androideabi-gdb libnative-lib.so
GNU gdb <span class="o">(</span>GDB<span class="o">)</span> <span class="m">7</span>.7
Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2014</span> Free Software Foundation, Inc.
<span class="o">(</span>...<span class="o">)</span>
<span class="o">(</span>gdb<span class="o">)</span> target remote :1234
Remote debugging using :1234
0xb6de83b8 <span class="k">in</span> ?? <span class="o">()</span>
</code></pre></div>
<h3 id="tracing">Tracing<a class="headerlink" href="#tracing" title="Permanent link">&para;</a></h3>
<h4 id="execution-tracing">Execution Tracing<a class="headerlink" href="#execution-tracing" title="Permanent link">&para;</a></h4>
<p>Besides being useful for debugging, the jdb command line tool offers basic execution tracing functionality. To trace an app right from the start, you can pause the app with the Android "Wait for Debugger" feature or a <code>kill -STOP</code> command and attach jdb to set a deferred method breakpoint on any initialization method. Once the breakpoint is reached, activate method tracing with the <code>trace go methods</code> command and resume execution. jdb will dump all method entries and exits from that point onwards.</p>
<div class="highlight"><pre><span></span><code>$ adb forward tcp:7777 jdwp:7288
$ <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;suspend&quot;</span><span class="p">;</span> cat<span class="p">;</span> <span class="o">}</span> <span class="p">|</span> jdb -attach localhost:7777
Set uncaught java.lang.Throwable
Set deferred uncaught java.lang.Throwable
Initializing jdb ...
&gt; All threads suspended.
&gt; stop <span class="k">in</span> com.acme.bob.mobile.android.core.BobMobileApplication.&lt;clinit&gt;<span class="o">()</span>
Deferring breakpoint com.acme.bob.mobile.android.core.BobMobileApplication.&lt;clinit&gt;<span class="o">()</span>.
It will be <span class="nb">set</span> after the class is loaded.
&gt; resume
All threads resumed.M
Set deferred breakpoint com.acme.bob.mobile.android.core.BobMobileApplication.&lt;clinit&gt;<span class="o">()</span>

Breakpoint hit: <span class="s2">&quot;thread=main&quot;</span>, com.acme.bob.mobile.android.core.BobMobileApplication.&lt;clinit&gt;<span class="o">()</span>, <span class="nv">line</span><span class="o">=</span><span class="m">44</span> <span class="nv">bci</span><span class="o">=</span><span class="m">0</span>
main<span class="o">[</span><span class="m">1</span><span class="o">]</span> trace go methods
main<span class="o">[</span><span class="m">1</span><span class="o">]</span> resume
Method entered: All threads resumed.
</code></pre></div>
<p>The Dalvik Debug Monitor Server (DDMS) is a GUI tool included with Android Studio. It may not look like much, but its Java method tracer is one of the most awesome tools you can have in your arsenal, and it is indispensable for analyzing obfuscated bytecode.</p>
<p>DDMS is somewhat confusing, however; it can be launched several ways, and different trace viewers will be launched depending on how a method was traced. There's a standalone tool called "Traceview" as well as a built-in viewer in Android Studio, both of which offer different ways to navigate the trace. You'll usually use Android studio's built-in viewer, which gives you a <em>zoomable</em> hierarchical timeline of all method calls. However, the standalone tool is also useful, it has a profile panel that shows the time spent in each method along with the parents and children of each method.</p>
<p>To record an execution trace in Android Studio, open the <strong>Android</strong> tab at the bottom of the GUI. Select the target process in the list and click the little <strong>stop watch</strong> button on the left. This starts the recording. Once you're done, click the same button to stop the recording. The integrated trace view will open and show the recorded trace. You can scroll and zoom the timeline view with the mouse or trackpad.</p>
<p>Execution traces can also be recorded in the standalone Android Device Monitor. The Device Monitor can be started within Android Studio (<strong>Tools</strong> -&gt; <strong>Android</strong> -&gt; <strong>Android Device Monitor</strong>) or from the shell with the <code>ddms</code> command.</p>
<p>To start recording tracing information, select the target process in the <strong>Devices</strong> tab and click <strong>Start Method Profiling</strong>. Click the <strong>stop</strong> button to stop recording, after which the Traceview tool will open and show the recorded trace. Clicking any of the methods in the profile panel highlights the selected method in the timeline panel.</p>
<p>DDMS also offers a convenient heap dump button that will dump the Java heap of a process to a .hprof file. The Android Studio user guide contains more information about Traceview.</p>
<h5 id="tracing-system-calls">Tracing System Calls<a class="headerlink" href="#tracing-system-calls" title="Permanent link">&para;</a></h5>
<p>Moving down a level in the OS hierarchy, you arrive at privileged functions that require the powers of the Linux kernel. These functions are available to normal processes via the system call interface. Instrumenting and intercepting calls into the kernel is an effective method for getting a rough idea of what a user process is doing, and often the most efficient way to deactivate low-level tampering defenses.</p>
<p>Strace is a standard Linux utility that is not included with Android by default, but can be easily built from source via the Android NDK. It monitors the interaction between processes and the kernel, being a very convenient way to monitor system calls. However, there's a downside: as strace depends on the <code>ptrace</code> system call to attach to the target process, once anti-debugging measures become active it will stop working.</p>
<p>If the "Wait for debugger" feature in <strong>Settings &gt; Developer options</strong> is unavailable, you can use a shell script to launch the process and immediately attach strace (not an elegant solution, but it works):</p>
<div class="highlight"><pre><span></span><code>$ <span class="k">while</span> true<span class="p">;</span> <span class="k">do</span> <span class="nv">pid</span><span class="o">=</span><span class="k">$(</span>pgrep <span class="s1">&#39;target_process&#39;</span> <span class="p">|</span> head -1<span class="k">)</span><span class="p">;</span> <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> strace -s <span class="m">2000</span> - e <span class="s2">&quot;!read&quot;</span> -ff -p <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span><span class="p">;</span> break<span class="p">;</span> <span class="k">fi</span><span class="p">;</span> <span class="k">done</span>
</code></pre></div>
<h5 id="ftrace">Ftrace<a class="headerlink" href="#ftrace" title="Permanent link">&para;</a></h5>
<p>Ftrace is a tracing utility built directly into the Linux kernel. On a rooted device, ftrace can trace kernel system calls more transparently than strace can (strace relies on the ptrace system call to attach to the target process).</p>
<p>Conveniently, the stock Android kernel on both Lollipop and Marshmallow include ftrace functionality. The feature can be enabled with the following command:</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/kernel/ftrace_enabled
</code></pre></div>
<p>The <code>/sys/kernel/debug/tracing</code> directory holds all control and output files related to ftrace. The following files are found in this directory:</p>
<ul>
<li>available_tracers: This file lists the available tracers compiled into the kernel.</li>
<li>current_tracer: This file sets or displays the current tracer.</li>
<li>tracing_on: Echo "1" into this file to allow/start update of the ring buffer. Echoing "0" will prevent further writes into the ring buffer.</li>
</ul>
<h5 id="kprobes">KProbes<a class="headerlink" href="#kprobes" title="Permanent link">&para;</a></h5>
<p>The KProbes interface provides an even more powerful way to instrument the kernel: it allows you to insert probes into (almost) arbitrary code addresses within kernel memory. KProbes inserts a breakpoint instruction at the specified address. Once the breakpoint is reached, control passes to the KProbes system, which then executes the user-defined handler function(s) and the original instruction. Besides being great for function tracing, KProbes can implement rootkit-like functionality, such as file hiding.</p>
<p>Jprobes and Kretprobes are other KProbes-based probe types that allow hooking of function entries and exits.</p>
<p>The stock Android kernel comes without loadable module support, which is a problem because Kprobes are usually deployed as kernel modules. The strict memory protection the Android kernel is compiled with is another issue because it prevents the patching of some parts of Kernel memory. Elfmaster's system call hooking method causes a Kernel panic on stock Lollipop and Marshmallow because the sys_call_table is non-writable. You can, however, use KProbes in a sandbox by compiling your own, more lenient Kernel (more on this later).</p>
<h4 id="method-tracing">Method Tracing<a class="headerlink" href="#method-tracing" title="Permanent link">&para;</a></h4>
<p>In contrast to method profiling, which tells you how frequently a method is being called, method tracing helps you to also determine its input and output values. This technique can prove to be very useful when dealing with applications that have a big codebase and/or are obfuscated.</p>
<p>As we will discuss shortly in the next section, <code>frida-trace</code> offers out-of-the-box support for Android/iOS native code tracing and iOS high level method tracing. If you prefer a GUI-based approach you can use tools such as <a href="../0x08-Testing-Tools/#RMS-Runtime-Mobile-Security">RMS - Runtime Mobile Security</a> which enables a more visual experience as well as include several convenience <a href="https://github.com/m0bilesecurity/RMS-Runtime-Mobile-Security#3-hook-on-the-fly-classesmethods-and-trace-their-args-and-return-values">tracing options</a>.</p>
<h4 id="native-code-tracing">Native Code Tracing<a class="headerlink" href="#native-code-tracing" title="Permanent link">&para;</a></h4>
<p>Native methods tracing can be performed with relative ease than compared to Java method tracing. <code>frida-trace</code> is a CLI tool for dynamically tracing function calls. It makes tracing native functions trivial and can be very useful for collecting information about an application.</p>
<p>In order to use <code>frida-trace</code>, a Frida server should be running on the device. An example for tracing libc's <code>open</code> function using <code>frida-trace</code> is demonstrated below, where <code>-U</code> connects to the USB device and <code>-i</code> specifies the function to be included in the trace.</p>
<div class="highlight"><pre><span></span><code>$ frida-trace -U -i <span class="s2">&quot;open&quot;</span> com.android.chrome
</code></pre></div>
<p><img src="../../assets/Images/Chapters/0x05c/frida_trace_native_functions.png" width="100%" /></p>
<p>Note how, by default, only the arguments passed to the function are shown, but not the return values. Under the hood, <code>frida-trace</code> generates one little JavaScript handler file per matched function in the auto-generated <code>__handlers__</code> folder, which Frida then injects into the process. You can edit these files for more advanced usage such as obtaining the return value of the functions, their input parameters, accessing the memory, etc. Check Frida's <a href="https://www.frida.re/docs/javascript-api/" title="JavaScript API">JavaScript API</a> for more details.</p>
<p>In this case, the generated script which traces all calls to the <code>open</code> function in <code>libc.so</code> is located in is <code>__handlers__/libc.so/open.js</code>, it looks as follows:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">onEnter</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">log</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;open(&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">      </span><span class="s1">&#39;path=&quot;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">readUtf8String</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">      </span><span class="s1">&#39;, oflag=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="s1">&#39;)&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>


<span class="w">  </span><span class="nx">onLeave</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">log</span><span class="p">,</span><span class="w"> </span><span class="nx">retval</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\t return: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">retval</span><span class="p">);</span><span class="w">      </span><span class="err">\\</span><span class="w"> </span><span class="nx">edited</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>In the above script, <code>onEnter</code> takes care of logging the calls to this function and its two input parameters in the right format. You can edit the <code>onLeave</code> event to print the return values as shown above.</p>
<blockquote>
<p>Note that libc is a well-known library, Frida is able to derive the input parameters of its <code>open</code> function and automatically log them correctly. But this won't be the case for other libraries or for Android Kotlin/Java code. In that case, you may want to obtain the signatures of the functions you're interested in by referring to Android Developers documentation or by reverse engineer the app first.</p>
</blockquote>
<p>Another thing to notice in the output above is that it's colorized. An application can have multiple threads running, and each thread can call the <code>open</code> function independently. By using such a color scheme, the output can be easily visually segregated for each thread.</p>
<p><code>frida-trace</code> is a very versatile tool and there are multiple configuration options available such as:</p>
<ul>
<li>Including <code>-I</code> and excluding <code>-X</code> entire modules.</li>
<li>Tracing all JNI functions in an Android application using <code>-i "Java_*"</code> (note the use of a glob <code>*</code> to match all possible functions starting with "Java_").</li>
<li>Tracing functions by address when no function name symbols are available (stripped binaries), e.g. <code>-a "libjpeg.so!0x4793c"</code>.</li>
</ul>
<div class="highlight"><pre><span></span><code>$ frida-trace -U -i <span class="s2">&quot;Java_*&quot;</span> com.android.chrome
</code></pre></div>
<p>Many binaries are stripped and don't have function name symbols available with them. In such cases, a function can be traced using its address as well.</p>
<div class="highlight"><pre><span></span><code>$ frida-trace -p <span class="m">1372</span> -a <span class="s2">&quot;libjpeg.so!0x4793c&quot;</span>
</code></pre></div>
<p>Frida 12.10 introduces a new useful syntax to query Java classes and methods as well as Java method tracing support for frida-trace via <code>-j</code> (starting on frida-tools 8.0).</p>
<ul>
<li>In Frida scripts: e.g. <code>Java.enumerateMethods('*youtube*!on*')</code> uses globs to take all classes that include "youtube" as part of their name and enumerate all methods starting with "on".</li>
<li>In frida-trace: e.g. <code>-j '*!*certificate*/isu'</code> triggers a case-insensitive query (<code>i</code>), including method signatures (<code>s</code>) and excluding system classes (<code>u</code>).</li>
</ul>
<p>Refer to the <a href="https://frida.re/news/2020/06/29/frida-12-10-released/" title="Frida 12.10">Release Notes</a> for more details. To learn more about all options for advanced usage, check the <a href="https://frida.re/docs/frida-trace/" title="documentation">documentation on the official Frida website</a>.</p>
<h4 id="jni-tracing">JNI Tracing<a class="headerlink" href="#jni-tracing" title="Permanent link">&para;</a></h4>
<p>As detailed in section <a href="#reviewing-disassembled-native-code">Reviewing Disassembled Native Code</a>, the first argument passed to every JNI function is a JNI interface pointer. This pointer contains a table of functions that allows native code to access the Android Runtime. Identifying calls to these functions can help with understanding library functionality, such as what strings are created or Java methods are called.</p>
<p><a href="https://github.com/chame1eon/jnitrace" title="jnitrace">jnitrace</a> is a Frida based tool similar to frida-trace which specifically targets the usage of Android's JNI API by native libraries, providing a convenient way to obtain JNI method traces including arguments and return values.</p>
<p>You can easily install it by running <code>pip install jnitrace</code> and run it straight away as follows:</p>
<div class="highlight"><pre><span></span><code>$ jnitrace -l libnative-lib.so sg.vantagepoint.helloworldjni
</code></pre></div>
<blockquote>
<p>The <code>-l</code> option can be provided multiple times to trace multiple libraries, or <code>*</code> can be provided to trace all libraries. This, however, may provide a lot of output.</p>
</blockquote>
<p><img src="../../assets/Images/Chapters/0x05c/jni_tracing_helloworldjni.png" width="100%" /></p>
<p>In the output you can see the trace of a call to <code>NewStringUTF</code> made from the native code (its return value is then given back to Java code, see section "<a href="#reviewing-disassembled-native-code">Reviewing Disassembled Native Code</a>" for more details). Note how similarly to frida-trace, the output is colorized helping to visually distinguish the different threads.</p>
<p>When tracing JNI API calls you can see the thread ID at the top, followed by the JNI method call including the method name, the input arguments and the return value. In the case of a call to a Java method from native code, the Java method arguments will also be supplied. Finally jnitrace will attempt to use the Frida backtracing library to show where the JNI call was made from.</p>
<p>To learn more about all options for advanced usage, check the <a href="https://github.com/chame1eon/jnitrace" title="documentation">documentation on the jnitrace GitHub page</a>.</p>
<h3 id="emulation-based-analysis">Emulation-based Analysis<a class="headerlink" href="#emulation-based-analysis" title="Permanent link">&para;</a></h3>
<p>The Android emulator is based on QEMU, a generic and open source machine emulator. QEMU emulates a guest CPU by translating the guest instructions on-the-fly into instructions the host processor can understand. Each basic block of guest instructions is disassembled and translated into an intermediate representation called Tiny Code Generator (TCG). The TCG block is compiled into a block of host instructions, stored in a code cache, and executed. After execution of the basic block, QEMU repeats the process for the next block of guest instructions (or loads the already translated block from the cache). The whole process is called dynamic binary translation.</p>
<p>Because the Android emulator is a fork of QEMU, it comes with all QEMU features, including monitoring, debugging, and tracing facilities. QEMU-specific parameters can be passed to the emulator with the <code>-qemu</code> command line flag. You can use QEMU's built-in tracing facilities to log executed instructions and virtual register values. Starting QEMU with the <code>-d</code> command line flag will cause it to dump the blocks of guest code, micro operations, or host instructions being executed. With the <code>-d_asm</code> flag, QEMU logs all basic blocks of guest code as they enter QEMU's translation function. The following command logs all translated blocks to a file:</p>
<div class="highlight"><pre><span></span><code>$ emulator -show-kernel -avd Nexus_4_API_19 -snapshot default-boot -no-snapshot-save -qemu -d in_asm,cpu <span class="m">2</span>&gt;/tmp/qemu.log
</code></pre></div>
<p>Unfortunately, generating a complete guest instruction trace with QEMU is impossible because code blocks are written to the log only at the time they are translated, not when they're taken from the cache. For example, if a block is repeatedly executed in a loop, only the first iteration will be printed to the log. There's no way to disable TB caching in QEMU (besides hacking the source code). Nevertheless, the functionality is sufficient for basic tasks, such as reconstructing the disassembly of a natively executed cryptographic algorithm.</p>
<h3 id="binary-analysis">Binary Analysis<a class="headerlink" href="#binary-analysis" title="Permanent link">&para;</a></h3>
<p>Binary analysis frameworks give you powerful ways to automate tasks that would be almost impossible to do manually. Binary analysis frameworks typically use a technique called symbolic execution, which allow to determine the conditions necessary to reach a specific target. It translates the program's semantics into a logical formula in which some variables are represented by symbols with specific constraints. By resolving the constraints, you can find the conditions necessary for the execution of some branch of the program.</p>
<h4 id="symbolic-execution">Symbolic Execution<a class="headerlink" href="#symbolic-execution" title="Permanent link">&para;</a></h4>
<p>Symbolic execution is a very useful technique to have in your toolbox, especially while dealing with problems where you need to find a correct input for reaching a certain block of code. In this section, we will solve a simple Android crackme by using the <a href="../0x08-Testing-Tools/#angr">Angr</a> binary analysis framework as our symbolic execution engine.</p>
<p>The target crackme is a simple <a href="https://github.com/angr/angr-doc/tree/master/examples/android_arm_license_validation" title="Android license key validation">Android license key validation</a> executable. As we will soon observe, the key validation logic in the crackme is implemented in native code. It is a common notion that analyzing compiled native code is tougher than analyzing an equivalent compiled Java code, and hence, critical business logic is often written in native. The current sample application may not represent a real world problem, but nevertheless it helps getting some basic notions about symbolic execution that you can use in a real situation. You can use the same techniques on Android apps that ship with obfuscated native libraries (in fact, obfuscated code is often put into native libraries specifically to make de-obfuscation more difficult).</p>
<p>The crackme consists of a single ELF executable file, which can be executed on any Android device by following the instructions below:</p>
<div class="highlight"><pre><span></span><code>$ adb push validate /data/local/tmp
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> /data/local/tmp/validate

$ adb shell chmod <span class="m">755</span> /data/local/tmp/validate

$ adb shell /data/local/tmp/validate
Usage: ./validate &lt;serial&gt;

$ adb shell /data/local/tmp/validate <span class="m">12345</span>
Incorrect serial <span class="o">(</span>wrong format<span class="o">)</span>.
</code></pre></div>
<p>So far so good, but we know nothing about what a valid license key looks like. To get started, open the ELF executable in a disassembler such as Cutter. The main function is located at offset <code>0x00001874</code> in the disassembly. It is important to note that this binary is PIE-enabled, and Cutter chooses to load the binary at <code>0x0</code> as image base address.</p>
<p><img src="../../assets/Images/Chapters/0x05c/disass_main_1874.png" width="100%" /></p>
<p>The function names have been stripped from the binary, but luckily there are enough debugging strings to provide us a context to the code. Moving forward,  we will start analyzing the binary from the entry function at offset <code>0x00001874</code>, and keep a note of all the information easily available to us. During this analysis, we will also try to identify the code regions which are suitable for symbolic execution.</p>
<p><img src="../../assets/Images/Chapters/0x05c/graph_1874.png" width="100%" /></p>
<p><code>strlen</code> is called at offset <code>0x000018a8</code>, and the returned value is compared to 0x10 at offset <code>0x000018b0</code>. Immediately after that, the input string is passed to a Base32 decoding function at offset <code>0x00001340</code>. This provides us with valuable information that the input license key is a Base32-encoded 16-character string (which totals 10 bytes in raw). The decoded input is then passed to the function at offset <code>0x00001760</code>, which validates the license key. The disassembly of this function is shown below.</p>
<p>We can now use this information about the expected input to further look into the validation function at <code>0x00001760</code>.</p>
<div class="highlight"><pre><span></span><code>╭ (fcn) fcn.00001760 268
│   fcn.00001760 (int32_t arg1);
│           ; var int32_t var_20h @ fp-0x20
│           ; var int32_t var_14h @ fp-0x14
│           ; var int32_t var_10h @ fp-0x10
│           ; arg int32_t arg1 @ r0
│           ; CALL XREF from fcn.00001760 (+0x1c4)
│           0x00001760      push {r4, fp, lr}
│           0x00001764      add fp, sp, 8
│           0x00001768      sub sp, sp, 0x1c
│           0x0000176c      str r0, [var_20h]                          ; 0x20 ; &quot;$!&quot; ; arg1
│           0x00001770      ldr r3, [var_20h]                          ; 0x20 ; &quot;$!&quot; ; entry.preinit0
│           0x00001774      str r3, [var_10h]                          ; str.
│                                                                      ; 0x10
│           0x00001778      mov r3, 0
│           0x0000177c      str r3, [var_14h]                          ; 0x14
│       ╭─&lt; 0x00001780      b 0x17d0
│       │   ; CODE XREF from fcn.00001760 (0x17d8)
│      ╭──&gt; 0x00001784      ldr r3, [var_10h]                          ; str.
│       │                                                              ; 0x10 ; entry.preinit0
│      ╎│   0x00001788      ldrb r2, [r3]
│      ╎│   0x0000178c      ldr r3, [var_10h]                          ; str.
│      ╎│                                                              ; 0x10 ; entry.preinit0
│      ╎│   0x00001790      add r3, r3, 1
│      ╎│   0x00001794      ldrb r3, [r3]
│      ╎│   0x00001798      eor r3, r2, r3
│      ╎│   0x0000179c      and r2, r3, 0xff
│      ╎│   0x000017a0      mvn r3, 0xf
│      ╎│   0x000017a4      ldr r1, [var_14h]                          ; 0x14 ; entry.preinit0
│      ╎│   0x000017a8      sub r0, fp, 0xc
│      ╎│   0x000017ac      add r1, r0, r1
│      ╎│   0x000017b0      add r3, r1, r3
│      ╎│   0x000017b4      strb r2, [r3]
│      ╎│   0x000017b8      ldr r3, [var_10h]                          ; str.
│      ╎│                                                              ; 0x10 ; entry.preinit0
│      ╎│   0x000017bc      add r3, r3, 2                              ; &quot;ELF\x01\x01\x01&quot; ; aav.0x00000001
│      ╎│   0x000017c0      str r3, [var_10h]                          ; str.
│      ╎│                                                              ; 0x10
│      ╎│   0x000017c4      ldr r3, [var_14h]                          ; 0x14 ; entry.preinit0
│      ╎│   0x000017c8      add r3, r3, 1
│      ╎│   0x000017cc      str r3, [var_14h]                          ; 0x14
│      ╎│   ; CODE XREF from fcn.00001760 (0x1780)
│      ╎╰─&gt; 0x000017d0      ldr r3, [var_14h]                          ; 0x14 ; entry.preinit0
│      ╎    0x000017d4      cmp r3, 4                                  ; aav.0x00000004 ; aav.0x00000001 ; aav.0x00000001
│      ╰──&lt; 0x000017d8      ble 0x1784                                 ; likely
│           0x000017dc      ldrb r4, [fp, -0x1c]                       ; &quot;4&quot;
│           0x000017e0      bl fcn.000016f0
│           0x000017e4      mov r3, r0
│           0x000017e8      cmp r4, r3
│       ╭─&lt; 0x000017ec      bne 0x1854                                 ; likely
│       │   0x000017f0      ldrb r4, [fp, -0x1b]
│       │   0x000017f4      bl fcn.0000170c
│       │   0x000017f8      mov r3, r0
│       │   0x000017fc      cmp r4, r3
│      ╭──&lt; 0x00001800      bne 0x1854                                 ; likely
│      ││   0x00001804      ldrb r4, [fp, -0x1a]
│      ││   0x00001808      bl fcn.000016f0
│      ││   0x0000180c      mov r3, r0
│      ││   0x00001810      cmp r4, r3
│     ╭───&lt; 0x00001814      bne 0x1854                                 ; likely
│     │││   0x00001818      ldrb r4, [fp, -0x19]
│     │││   0x0000181c      bl fcn.00001728
│     │││   0x00001820      mov r3, r0
│     │││   0x00001824      cmp r4, r3
│    ╭────&lt; 0x00001828      bne 0x1854                                 ; likely
│    ││││   0x0000182c      ldrb r4, [fp, -0x18]
│    ││││   0x00001830      bl fcn.00001744
│    ││││   0x00001834      mov r3, r0
│    ││││   0x00001838      cmp r4, r3
│   ╭─────&lt; 0x0000183c      bne 0x1854                                 ; likely
│   │││││   0x00001840      ldr r3, [0x0000186c]                       ; [0x186c:4]=0x270 section..hash ; section..hash
│   │││││   0x00001844      add r3, pc, r3                             ; 0x1abc ; &quot;Product activation passed. Congratulations!&quot;
│   │││││   0x00001848      mov r0, r3                                 ; 0x1abc ; &quot;Product activation passed. Congratulations!&quot; ;
│   │││││   0x0000184c      bl sym.imp.puts                            ; int puts(const char *s)
│   │││││                                                              ; int puts(&quot;Product activation passed. Congratulations!&quot;)
│  ╭──────&lt; 0x00001850      b 0x1864
│  ││││││   ; CODE XREFS from fcn.00001760 (0x17ec, 0x1800, 0x1814, 0x1828, 0x183c)
│  │╰╰╰╰╰─&gt; 0x00001854      ldr r3, aav.0x00000288                     ; [0x1870:4]=0x288 aav.0x00000288
│  │        0x00001858      add r3, pc, r3                             ; 0x1ae8 ; &quot;Incorrect serial.&quot; ;
│  │        0x0000185c      mov r0, r3                                 ; 0x1ae8 ; &quot;Incorrect serial.&quot; ;
│  │        0x00001860      bl sym.imp.puts                            ; int puts(const char *s)
│  │                                                                   ; int puts(&quot;Incorrect serial.&quot;)
│  │        ; CODE XREF from fcn.00001760 (0x1850)
│  ╰──────&gt; 0x00001864      sub sp, fp, 8
╰           0x00001868      pop {r4, fp, pc}                           ; entry.preinit0 ; entry.preinit0 ;
</code></pre></div>
<p>Discussing all the instructions in the function is beyond the scope of this chapter, instead we will discuss only the important points needed for the analysis. In the validation function, there is a loop present at <code>0x00001784</code> which performs a XOR operation at offset <code>0x00001798</code>. The loop is more clearly visible in the graph view below.</p>
<p><img src="../../assets/Images/Chapters/0x05c/loop_1784.png" width="100%" /></p>
<p>XOR is a very commonly used technique to <em>encrypt</em> information where obfuscation is the goal rather than security. <strong>XOR should not be used for any serious encryption</strong>, as it can be cracked using frequency analysis. Therefore, the mere presence of XOR encryption in such a validation logic always requires special attention and analysis.</p>
<p>Moving forward, at offset <code>0x000017dc</code>, the XOR decoded value obtained from above is being compared against the return value from a sub-function call at <code>0x000017e8</code>.</p>
<p><img src="../../assets/Images/Chapters/0x05c/values_compare_17dc.png" width="100%" /></p>
<p>Clearly this function is not complex, and can be analyzed manually, but still remains a cumbersome task. Especially while working on a big code base, time can be a major constraint, and it is desirable to automate such analysis. Dynamic symbolic execution is helpful in exactly those situations. In the above crackme, the symbolic execution engine can determine the constraints on each byte of the input string by mapping a path between the first instruction of the license check (at <code>0x00001760</code>) and the code that prints the "Product activation passed" message (at <code>0x00001840</code>).</p>
<p><img src="../../assets/Images/Chapters/0x05c/graph_ifelse_1760.png" width="100%" /></p>
<p>The constraints obtained from the above steps are passed to a solver engine, which finds an input that satisfies them - a valid license key.</p>
<p>You need to perform several steps to initialize Angr's symbolic execution engine:</p>
<ul>
<li>
<p>Load the binary into a <code>Project</code>, which is the starting point for any kind of analysis in Angr.</p>
</li>
<li>
<p>Pass the address from which the analysis should start. In this case, we will initialize the state with the first instruction of the serial validation function. This makes the problem significantly easier to solve because you avoid symbolically executing the Base32 implementation.</p>
</li>
<li>
<p>Pass the address of the code block that the analysis should reach. In this case, that's the offset <code>0x00001840</code>, where the code responsible for printing the "Product activation passed" message is located.</p>
</li>
<li>
<p>Also, specify the addresses that the analysis should not reach. In this case, the code block that prints the "Incorrect serial" message at <code>0x00001854</code> is not interesting.</p>
</li>
</ul>
<blockquote>
<p>Note that the Angr loader will load the PIE executable with a base address of <code>0x400000</code>, which needs to be added to the offsets from Cutter before passing it to Angr.</p>
</blockquote>
<p>The final solution script is presented below:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">angr</span> <span class="c1"># Version: 9.2.2</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="n">load_options</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">angr</span><span class="o">.</span><span class="n">Project</span><span class="p">(</span><span class="s2">&quot;./validate&quot;</span><span class="p">,</span> <span class="n">load_options</span> <span class="o">=</span> <span class="n">load_options</span><span class="p">)</span>
<span class="c1"># The key validation function starts at 0x401760, so that&#39;s where we create the initial state.</span>
<span class="c1"># This speeds things up a lot because we&#39;re bypassing the Base32-encoder.</span>

<span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">angr</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">SYMBOL_FILL_UNCONSTRAINED_MEMORY</span><span class="p">,</span>
    <span class="n">angr</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">ZERO_FILL_UNCONSTRAINED_REGISTERS</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">blank_state</span><span class="p">(</span><span class="n">addr</span><span class="o">=</span><span class="mh">0x401760</span><span class="p">,</span> <span class="n">add_options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

<span class="n">simgr</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">simulation_manager</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="n">simgr</span><span class="o">.</span><span class="n">explore</span><span class="p">(</span><span class="n">find</span><span class="o">=</span><span class="mh">0x401840</span><span class="p">,</span> <span class="n">avoid</span><span class="o">=</span><span class="mh">0x401854</span><span class="p">)</span>

<span class="c1"># 0x401840 = Product activation passed</span>
<span class="c1"># 0x401854 = Incorrect serial</span>
<span class="n">found</span> <span class="o">=</span> <span class="n">simgr</span><span class="o">.</span><span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Get the solution string from *(R11 - 0x20).</span>

<span class="n">addr</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">found</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">r11</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">endness</span><span class="o">=</span><span class="s2">&quot;Iend_LE&quot;</span><span class="p">)</span>
<span class="n">concrete_addr</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
<span class="n">solution</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">found</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">concrete_addr</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">cast_to</span><span class="o">=</span><span class="nb">bytes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b32encode</span><span class="p">(</span><span class="n">solution</span><span class="p">))</span>
</code></pre></div>
<p>As discussed previously in the section "<a href="../0x04c-Tampering-and-Reverse-Engineering/#static-and-dynamic-binary-analysis" title="Dynamic Binary Instrumentation">Dynamic Binary Instrumentation</a>", the symbolic execution engine constructs a binary tree of the operations for the program input given and generates a mathematical equation for each possible path that might be taken. Internally, Angr explores all the paths between the two points specified by us, and passes the corresponding mathematical equations to the solver to return meaningful concrete results. We can access these solutions via <code>simulation_manager.found</code> list, which contains all the possible paths explored by Angr which satisfies our specified search criteria.</p>
<p>Take a closer look at the latter part of the script where the final solution string is being retrieved. The address of the string is obtained from address <code>r11 - 0x20</code>. This may appear magical at first, but a careful analysis of the function at <code>0x00001760</code> holds the clue, as it determines if the given input string is a valid license key or not. In the disassembly above, you can see how the input string to the function (in register R0) is stored into a local stack variable <code>0x0000176c      str r0, [var_20h]</code>. Hence, we decided to use this value to retrieve the final solution in the script. Using <code>found.solver.eval</code> you can ask the solver questions like "given the output of this sequence of operations (the current state in <code>found</code>), what must the input (at <code>addr</code>) have been?").</p>
<blockquote>
<p>In ARMv7, R11 is called fp (<em>function pointer</em>), therefore <code>R11 - 0x20</code> is equivalent to <code>fp-0x20</code>: <code>var int32_t var_20h @ fp-0x20</code></p>
</blockquote>
<p>Next, the <code>endness</code> parameter in the script specifies that the data is stored in "little-endian" fashion, which is the case for almost all of the Android devices.</p>
<p>Also, it may appear as if the script is simply reading the solution string from the memory of the script. However, it's reading it from the symbolic memory. Neither the string nor the pointer to the string actually exist. The solver ensures that the solution it provides is the same as if the program would be executed to that point.</p>
<p>Running this script should return the following output:</p>
<div class="highlight"><pre><span></span><code>$ python3 solve.py
WARNING <span class="p">|</span> ... <span class="p">|</span> cle.loader <span class="p">|</span> The main binary is a position-independent executable. It is being loaded with a base address of 0x400000.

b<span class="s1">&#39;JACE6ACIARNAAIIA&#39;</span>
</code></pre></div>
<p>Now you can run the validate binary in your Android device to verify the solution as indicated <a href="../Crackmes/README.md#android-license-validator">here</a>.</p>
<blockquote>
<p>You may obtain different solutions using the script, as there are multiple valid license keys possible.</p>
</blockquote>
<p>To conclude, learning symbolic execution might look a bit intimidating at first, as it requires deep understanding and extensive practice. However, the effort is justified considering the valuable time it can save in contrast to analyzing complex disassembled instructions manually. Typically you'd use hybrid techniques, as in the above example, where we performed manual analysis of the disassembled code to provide the correct criteria to the symbolic execution engine. Please to the iOS chapter for more examples on Angr usage.</p>
<h2 id="tampering-and-runtime-instrumentation">Tampering and Runtime Instrumentation<a class="headerlink" href="#tampering-and-runtime-instrumentation" title="Permanent link">&para;</a></h2>
<p>First, we'll look at some simple ways to modify and instrument mobile apps. <em>Tampering</em> means making patches or runtime changes to the app to affect its behavior. For example, you may want to deactivate SSL pinning or binary protections that hinder the testing process. <em>Runtime Instrumentation</em> encompasses adding hooks and runtime patches to observe the app's behavior. In mobile application security however, the term loosely refers to all kinds of runtime manipulation, including overriding methods to change behavior.</p>
<h3 id="patching-repackaging-and-re-signing">Patching, Repackaging, and Re-Signing<a class="headerlink" href="#patching-repackaging-and-re-signing" title="Permanent link">&para;</a></h3>
<p>Making small changes to the Android Manifest or bytecode is often the quickest way to fix small annoyances that prevent you from testing or reverse engineering an app. On Android, two issues in particular happen regularly:</p>
<ol>
<li>You can't intercept HTTPS traffic with a proxy because the app employs SSL pinning.</li>
<li>You can't attach a debugger to the app because the <code>android:debuggable</code> flag is not set to <code>"true"</code> in the Android Manifest.</li>
</ol>
<p>In most cases, both issues can be fixed by making minor changes to the app (aka. patching) and then re-signing and repackaging it. Apps that run additional integrity checks beyond default Android code-signing are an exception. In those cases, you have to patch the additional checks as well.</p>
<p>The first step is unpacking and disassembling the APK with <code>apktool</code>:</p>
<div class="highlight"><pre><span></span><code>$ apktool d target_apk.apk
</code></pre></div>
<blockquote>
<p>Note: To save time, you may use the flag <code>--no-src</code> if you only want to unpack the APK but not disassemble the code. For example, when you only want to modify the Android Manifest and repack immediately.</p>
</blockquote>
<h4 id="patching-example-disabling-certificate-pinning">Patching Example: Disabling Certificate Pinning<a class="headerlink" href="#patching-example-disabling-certificate-pinning" title="Permanent link">&para;</a></h4>
<p>Certificate pinning is an issue for security testers who want to intercept HTTPS communication for legitimate reasons. Patching bytecode to deactivate SSL pinning can help with this. To demonstrate bypassing certificate pinning, we'll walk through an implementation in an example application.</p>
<p>Once you've unpacked and disassembled the APK, it's time to find the certificate pinning checks in the Smali source code. Searching the code for keywords such as "X509TrustManager" should point you in the right direction.</p>
<p>In our example, a search for "X509TrustManager" returns one class that implements a custom TrustManager. The derived class implements the methods <code>checkClientTrusted</code>, <code>checkServerTrusted</code>, and <code>getAcceptedIssuers</code>.</p>
<p>To bypass the pinning check, add the <code>return-void</code> opcode to the first line of each method. This opcode causes the checks to return immediately. With this modification, no certificate checks are performed, and the application accepts all certificates.</p>
<div class="highlight"><pre><span></span><code>.method public checkServerTrusted([LJava/security/cert/X509Certificate;Ljava/lang/String;)V
  .locals 3
  .param p1, &quot;chain&quot;  # [Ljava/security/cert/X509Certificate;
  .param p2, &quot;authType&quot;   # Ljava/lang/String;

  .prologue
  return-void      # &lt;-- OUR INSERTED OPCODE!
  .line 102
  iget-object v1, p0, Lasdf/t$a;-&gt;a:Ljava/util/ArrayList;

  invoke-virtual {v1}, Ljava/util/ArrayList;-&gt;iterator()Ljava/util/Iterator;

  move-result-object v1

  :goto_0
  invoke-interface {v1}, Ljava/util/Iterator;-&gt;hasNext()Z
</code></pre></div>
<p>This modification will break the APK signature, so you'll also have to re-sign the altered APK archive after repackaging it.</p>
<h4 id="patching-example-making-an-app-debuggable">Patching Example: Making an App Debuggable<a class="headerlink" href="#patching-example-making-an-app-debuggable" title="Permanent link">&para;</a></h4>
<p>Every debugger-enabled process runs an extra thread for handling JDWP protocol packets. This thread is started only for apps that have the <code>android:debuggable="true"</code> flag set in their manifest file's <code>&lt;application&gt;</code> element. This is the typical configuration of Android devices shipped to end users.</p>
<p>When reverse engineering apps, you'll often have access to the target app's release build only. Release builds aren't meant to be debugged, that's the purpose of <em>debug builds</em>. If the system property <code>ro.debuggable</code> is set to "0", Android disallows both JDWP and native debugging of release builds. Although this is easy to bypass, you're still likely to encounter limitations, such as a lack of line breakpoints. Nevertheless, even an imperfect debugger is still an invaluable tool, being able to inspect the runtime state of a program makes understanding the program <em>a lot</em> easier.</p>
<p>To <em>convert</em> a release build into a debuggable build, you need to modify a flag in the Android Manifest file (AndroidManifest.xml). Once you've unpacked the app (e.g. <code>apktool d --no-src UnCrackable-Level1.apk</code>) and decoded the Android Manifest, add <code>android:debuggable="true"</code> to it using a text editor:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;application</span> <span class="na">android:allowBackup=</span><span class="s">&quot;true&quot;</span> <span class="na">android:debuggable=</span><span class="s">&quot;true&quot;</span> <span class="na">android:icon=</span><span class="s">&quot;@drawable/ic_launcher&quot;</span> <span class="na">android:label=</span><span class="s">&quot;@string/app_name&quot;</span> <span class="na">android:name=</span><span class="s">&quot;com.xxx.xxx.xxx&quot;</span> <span class="na">android:theme=</span><span class="s">&quot;@style/AppTheme&quot;</span><span class="nt">&gt;</span>
</code></pre></div>
<p>Even if we haven't altered the source code, this modification also breaks the APK signature, so you'll also have to re-sign the altered APK archive.</p>
<h4 id="repackaging">Repackaging<a class="headerlink" href="#repackaging" title="Permanent link">&para;</a></h4>
<p>You can easily repackage an app by doing the following:</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">cd</span> UnCrackable-Level1
$ apktool b
$ zipalign -v <span class="m">4</span> dist/UnCrackable-Level1.apk ../UnCrackable-Repackaged.apk
</code></pre></div>
<p>Note that the Android Studio build tools directory must be in the path. It is located at <code>[SDK-Path]/build-tools/[version]</code>. The <code>zipalign</code> and <code>apksigner</code> tools are in this directory.</p>
<h4 id="re-signing">Re-Signing<a class="headerlink" href="#re-signing" title="Permanent link">&para;</a></h4>
<p>Before re-signing, you first need a code-signing certificate. If you have built a project in Android Studio before, the IDE has already created a debug keystore and certificate in <code>$HOME/.android/debug.keystore</code>. The default password for this KeyStore is "android" and the key is called "androiddebugkey".</p>
<p>The standard Java distribution includes <code>keytool</code> for managing KeyStores and certificates. You can create your own signing certificate and key, then add it to the debug KeyStore:</p>
<div class="highlight"><pre><span></span><code>$ keytool -genkey -v -keystore ~/.android/debug.keystore -alias signkey -keyalg RSA -keysize <span class="m">2048</span> -validity <span class="m">20000</span>
</code></pre></div>
<p>After the certificate is available, you can re-sign the APK with it. Be sure that <code>apksigner</code> is in the path and that you run it from the folder where your repackaged APK is located.</p>
<div class="highlight"><pre><span></span><code>$ apksigner sign --ks  ~/.android/debug.keystore --ks-key-alias signkey UnCrackable-Repackaged.apk
</code></pre></div>
<p>Note: If you experience JRE compatibility issues with <code>apksigner</code>, you can use <code>jarsigner</code> instead. When you do this, <code>zipalign</code> must be called <strong>after</strong> signing.</p>
<div class="highlight"><pre><span></span><code>$ jarsigner -verbose -keystore ~/.android/debug.keystore ../UnCrackable-Repackaged.apk signkey
$ zipalign -v <span class="m">4</span> dist/UnCrackable-Level1.apk ../UnCrackable-Repackaged.apk
</code></pre></div>
<p>Now you may reinstall the app:</p>
<div class="highlight"><pre><span></span><code>$ adb install UnCrackable-Repackaged.apk
</code></pre></div>
<h4 id="the-wait-for-debugger-feature">The "Wait For Debugger" Feature<a class="headerlink" href="#the-wait-for-debugger-feature" title="Permanent link">&para;</a></h4>
<p>The UnCrackable App is not stupid: it notices that it has been run in debuggable mode and reacts by shutting down. A modal dialog is shown immediately, and the crackme terminates once you tap "OK".</p>
<p>Fortunately, Android's "Developer options" contain the useful "Wait for Debugger" feature, which allows you to automatically suspend an app doing startup until a JDWP debugger connects. With this feature, you can connect the debugger before the detection mechanism runs, and trace, debug, and deactivate that mechanism. It's really an unfair advantage, but, on the other hand, reverse engineers never play fair!</p>
<p><img src="../../assets/Images/Chapters/0x05c/debugger_detection.png" width="400px" /></p>
<p>In the Developer options, pick <code>Uncrackable1</code> as the debugging application and activate the "Wait for Debugger" switch.</p>
<p><img src="../../assets/Images/Chapters/0x05c/developer-options.png" width="400px" /></p>
<p>Note: Even with <code>ro.debuggable</code> set to "1" in <code>default.prop</code>, an app won't show up in the "debug app" list unless the <code>android:debuggable</code> flag is set to <code>"true"</code> in the Android Manifest.</p>
<h4 id="patching-react-native-applications">Patching React Native applications<a class="headerlink" href="#patching-react-native-applications" title="Permanent link">&para;</a></h4>
<p>If the <a href="https://facebook.github.io/react-native" title="React Native">React Native</a> framework has been used for developing then the main application code is located in the file <code>assets/index.android.bundle</code>. This file contains the JavaScript code. Most of the time, the JavaScript code in this file is minified. By using the tool <a href="https://mindedsecurity.github.io/jstillery" title="JStillery">JStillery</a> a human readable version of the file can be retried, allowing code analysis. The <a href="https://github.com/mindedsecurity/jstillery/" title="CLI version of JStillery">CLI version of JStillery</a> or the local server should be preferred instead of using the online version as otherwise source code is sent and disclosed to a 3rd party.</p>
<p>The following approach can be used in order to patch the JavaScript file:</p>
<ol>
<li>Unpack the APK archive using <code>apktool</code> tool.</li>
<li>Copy the content of the file <code>assets/index.android.bundle</code> into a temporary file.</li>
<li>Use <code>JStillery</code> to beautify and deobfuscate the content of the temporary file.</li>
<li>Identify where the code should be patched in the temporary file and implement the changes.</li>
<li>Put the <em>patched code</em> on a single line and copy it in the original <code>assets/index.android.bundle</code> file.</li>
<li>Repack the APK archive using <code>apktool</code> tool and sign it before to install it on the target device/emulator.</li>
</ol>
<h4 id="library-injection">Library Injection<a class="headerlink" href="#library-injection" title="Permanent link">&para;</a></h4>
<p>In the previous section we learned about patching application code to assist in our analysis, but this approach has several limitations. For instance, you'd like to log everything that's being sent over the network without having to perform a MITM attack. For this you'd have to patch all possible calls to the network APIs, which can quickly become impracticable when dealing with large applications. In addition, the fact that patching is unique to each application can be also considered a shortcoming, as this code cannot be easily reused.</p>
<p>Using library injection you can develop reusable libraries and inject them to different applications, effectively making them behave differently without having to modify their original source code. This is known as DLL injection on Windows (broadly used to modify and bypass anti-cheat mechanisms in games), <code>LD_PRELOAD</code> on Linux and <code>DYLD_INSERT_LIBRARIES</code> on macOS. On Android and iOS, a common example is using the Frida Gadget whenever Frida's so-called <a href="https://frida.re/docs/modes/#injected" title="Frida Injected Mode">Injected mode</a> of operation isn’t suitable (i.e. you cannot run the Frida server on the target device). In this situation, you can <a href="https://frida.re/docs/gadget/" title="Frida Gadget">inject the Gadget</a> library by using the same methods you're going to learn in this section.</p>
<p>Library injection is desirable in many situations such as:</p>
<ul>
<li>Performing process introspection (e.g. listing classes, tracing method calls, monitoring accessed files, monitoring network access, obtaining direct memory access).</li>
<li>Supporting or replacing existing code with your own implementations (e.g. replace a function that should give random numbers).</li>
<li>Introducing new features to an existing application.</li>
<li>Debugging and fixing elusive runtime bugs on code for which you don't have the original source.</li>
<li>Enable dynamic testing on a non-rooted device (e.g. with Frida).</li>
</ul>
<p>In this section, we will learn about techniques for performing library injection on Android, which basically consist of patching the application code (smali or native) or alternatively using the <code>LD_PRELOAD</code> feature provided by the OS loader itself.</p>
<h5 id="patching-the-applications-smali-code">Patching the Application's Smali Code<a class="headerlink" href="#patching-the-applications-smali-code" title="Permanent link">&para;</a></h5>
<p>An Android application's decompiled smali code can be patched to introduce a call to <code>System.loadLibrary</code>. The following smali patch injects a library named libinject.so:</p>
<div class="highlight"><pre><span></span><code>const-string v0, &quot;inject&quot;
invoke-static {v0}, Ljava/lang/System;-&gt;loadLibrary(Ljava/lang/String;)V
</code></pre></div>
<p>Ideally you should insert the above code early in the <a href="https://developer.android.com/guide/components/activities/activity-lifecycle" title="Understand the Activity Lifecycle">application lifecycle</a>, for instance in the <code>onCreate</code> method. It is important to remember to add the library libinject.so in the respective architecture folder (armeabi-v7a, arm64-v8a, x86) of the <code>lib</code> folder in the APK. Finally, you need to re-sign the application before using it.</p>
<p>A well-known use case of this technique is loading the Frida gadget to an application, specially while working on a non-rooted device (this is what <a href="https://github.com/sensepost/objection/wiki/Patching-Android-Applications" title="Patching Android Applications"><code>objection patchapk</code></a> basically does).</p>
<h5 id="patching-applications-native-library">Patching Application's Native Library<a class="headerlink" href="#patching-applications-native-library" title="Permanent link">&para;</a></h5>
<p>Many Android applications use native code in addition to Java code for various performance and security reasons. The native code is present in the form of ELF shared libraries. An ELF executable includes a list of shared libraries (dependencies) that are linked to the executable for it to function optimally. This list can be modified to insert an additional library to be injected into the process.</p>
<p>Modifying the ELF file structure manually to inject a library can be cumbersome and prone to errors. However, this task can be performed with relative ease using <a href="../0x08-Testing-Tools/#LIEF">LIEF</a> (Library to Instrument Executable Formats). Using it requires only a few lines of Python code as shown below:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">lief</span>

<span class="n">libnative</span> <span class="o">=</span> <span class="n">lief</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;libnative.so&quot;</span><span class="p">)</span>
<span class="n">libnative</span><span class="o">.</span><span class="n">add_library</span><span class="p">(</span><span class="s2">&quot;libinject.so&quot;</span><span class="p">)</span> <span class="c1"># Injection!</span>
<span class="n">libnative</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;libnative.so&quot;</span><span class="p">)</span>
</code></pre></div>
<p>In the above example, libinject.so library is injected as a dependency of a native library (libnative.so), which the application already loads by default. Frida gadget can be injected into an application using this approach as explained in detail in <a href="https://lief.quarkslab.com/doc/latest/tutorials/09_frida_lief.html" title="LIEF's documentation - How to use frida on a non-rooted device">LIEF's documentation</a>. As in the previous section, it is important to remember adding the library to the respective architecture <code>lib</code> folder in the APK and finally re-signing the application.</p>
<h5 id="preloading-symbols">Preloading Symbols<a class="headerlink" href="#preloading-symbols" title="Permanent link">&para;</a></h5>
<p>Above we looked into techniques which require some kind of modification of the application's code. A library can also be injected into a process using functionalities offered by the loader of the operating system. On Android, which is a Linux based OS, you can load an additional library by setting the <code>LD_PRELOAD</code> environment variable.</p>
<p>As the <a href="http://man7.org/linux/man-pages/man8/ld.so.8.html" title="LD.SO man page">ld.so man page</a> states, symbols loaded from the library passed using <code>LD_PRELOAD</code> always get precedence, i.e. they are searched first by the loader while resolving the symbols, effectively overriding the original ones. This feature is often used to inspect the input parameters of some commonly used libc functions such as <code>fopen</code>, <code>read</code>, <code>write</code>, <code>strcmp</code>, etc., specially in obfuscated programs, where understanding their behavior may be challenging. Therefore, having an insight on which files are being opened or which strings are being compared may be very valuable. The key idea here is "function wrapping", meaning that you cannot patch system calls such as libc's <code>fopen</code>, but you can override (wrap) it including custom code that will, for instance, print the input parameters for you and still call the original <code>fopen</code> remaining transparent to the caller.</p>
<p>On Android, setting <code>LD_PRELOAD</code> is slightly different compared to other Linux distributions. If you recall from the "<a href="../0x05a-Platform-Overview/#zygote" title="Platform Overview">Platform Overview</a>" section, every application in Android is forked from Zygote, which is started very early during the Android boot-up. Thus, setting <code>LD_PRELOAD</code> on Zygote is not possible. As a workaround for this problem, Android supports the <code>setprop</code> (set property) functionality. Below you can see an example for an application with package name <code>com.foo.bar</code> (note the additional <code>wrap.</code> prefix):</p>
<div class="highlight"><pre><span></span><code>$ setprop wrap.com.foo.bar <span class="nv">LD_PRELOAD</span><span class="o">=</span>/data/local/tmp/libpreload.so
</code></pre></div>
<blockquote>
<p>Please note that if the library to be preloaded does not have SELinux context assigned, from Android 5.0 (API level 21) onwards, you need to disable SELinux to make <code>LD_PRELOAD</code> work, which may require root.</p>
</blockquote>
<h3 id="dynamic-instrumentation">Dynamic Instrumentation<a class="headerlink" href="#dynamic-instrumentation" title="Permanent link">&para;</a></h3>
<h4 id="information-gathering">Information Gathering<a class="headerlink" href="#information-gathering" title="Permanent link">&para;</a></h4>
<p>In this section we will learn about how to use Frida to obtain information about a running application.</p>
<h5 id="getting-loaded-classes-and-their-methods">Getting Loaded Classes and their Methods<a class="headerlink" href="#getting-loaded-classes-and-their-methods" title="Permanent link">&para;</a></h5>
<p>You can use the command <code>Java</code> in the Frida CLI to access the Java runtime and retrieve information from the running app. Remember that, unlike Frida for iOS, in Android you need to wrap your code inside a <code>Java.perform</code> function. Thus, it's more convenient to use Frida scripts to e.g. get a list of loaded Java classes and their corresponding methods and fields or for more complex information gathering or instrumentation. One such scripts is listed below. The script to list class's methods used below is available on <a href="https://github.com/frida/frida-java-bridge/issues/44" title="Github">Github</a>.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Get list of loaded Java classes and methods</span><span class="w"></span>

<span class="c1">// Filename: java_class_listing.js</span><span class="w"></span>

<span class="n">Java</span><span class="p">.</span><span class="na">perform</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Java</span><span class="p">.</span><span class="na">enumerateLoadedClasses</span><span class="p">({</span><span class="w"></span>
<span class="w">        </span><span class="n">onMatch</span><span class="p">:</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">className</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">console</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="n">className</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">describeJavaClass</span><span class="p">(</span><span class="n">className</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="n">onComplete</span><span class="p">:</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>

<span class="c1">// Get the methods and fields</span><span class="w"></span>
<span class="n">function</span><span class="w"> </span><span class="nf">describeJavaClass</span><span class="p">(</span><span class="n">className</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">jClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Java</span><span class="p">.</span><span class="na">use</span><span class="p">(</span><span class="n">className</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">console</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="n">JSON</span><span class="p">.</span><span class="na">stringify</span><span class="p">({</span><span class="w"></span>
<span class="w">    </span><span class="n">_name</span><span class="p">:</span><span class="w"> </span><span class="n">className</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">_methods</span><span class="p">:</span><span class="w"> </span><span class="n">Object</span><span class="p">.</span><span class="na">getOwnPropertyNames</span><span class="p">(</span><span class="n">jClass</span><span class="p">.</span><span class="na">__proto__</span><span class="p">).</span><span class="na">filter</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="n">m</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="sc">&#39;$&#39;</span><span class="p">)</span><span class="w"> </span><span class="c1">// filter out Frida related special properties</span><span class="w"></span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="err">&#39;</span><span class="kd">class</span><span class="err">&#39;</span> <span class="err">||</span> <span class="nc">m</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="err">&#39;</span><span class="n">constructor</span><span class="err">&#39;</span><span class="w"> </span><span class="c1">// optional</span><span class="w"></span>
<span class="w">    </span><span class="p">}),</span><span class="w"></span>
<span class="w">    </span><span class="n">_fields</span><span class="p">:</span><span class="w"> </span><span class="n">jClass</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getFields</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="p">(</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>After saving the script to a file called java_class_listing.js, you can tell Frida CLI to load it by using the flag <code>-l</code> and inject it to the process ID specified by <code>-p</code>.</p>
<div class="highlight"><pre><span></span><code>frida -U -l java_class_listing.js -p &lt;pid&gt;

// Output
<span class="o">[</span>Huawei Nexus 6P::sg.vantagepoint.helloworldjni<span class="o">]</span>-&gt;
...

com.scottyab.rootbeer.sample.MainActivity
<span class="o">{</span>
  <span class="s2">&quot;_name&quot;</span>: <span class="s2">&quot;com.scottyab.rootbeer.sample.MainActivity&quot;</span>,
  <span class="s2">&quot;_methods&quot;</span>: <span class="o">[</span>
  ...
    <span class="s2">&quot;beerView&quot;</span>,
    <span class="s2">&quot;checkRootImageViewList&quot;</span>,
    <span class="s2">&quot;floatingActionButton&quot;</span>,
    <span class="s2">&quot;infoDialog&quot;</span>,
    <span class="s2">&quot;isRootedText&quot;</span>,
    <span class="s2">&quot;isRootedTextDisclaimer&quot;</span>,
    <span class="s2">&quot;mActivity&quot;</span>,
    <span class="s2">&quot;GITHUB_LINK&quot;</span>
  <span class="o">]</span>,
  <span class="s2">&quot;_fields&quot;</span>: <span class="o">[</span>
    <span class="s2">&quot;public static final int android.app.Activity.DEFAULT_KEYS_DIALER&quot;</span>,
...
</code></pre></div>
<p>Given the verbosity of the output, the system classes can be filtered out programmatically to make output more readable and relevant to the use case.</p>
<h5 id="getting-loaded-libraries">Getting Loaded Libraries<a class="headerlink" href="#getting-loaded-libraries" title="Permanent link">&para;</a></h5>
<p>You can retrieve process related information straight from the Frida CLI by using the <code>Process</code> command. Within the <code>Process</code> command the function <code>enumerateModules</code> lists the libraries loaded into the process memory.</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>Huawei Nexus 6P::sg.vantagepoint.helloworldjni<span class="o">]</span>-&gt; Process.enumerateModules<span class="o">()</span>
<span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">&quot;base&quot;</span>: <span class="s2">&quot;0x558a442000&quot;</span>,
        <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;app_process64&quot;</span>,
        <span class="s2">&quot;path&quot;</span>: <span class="s2">&quot;/system/bin/app_process64&quot;</span>,
        <span class="s2">&quot;size&quot;</span>: <span class="m">32768</span>
    <span class="o">}</span>,
    <span class="o">{</span>
        <span class="s2">&quot;base&quot;</span>: <span class="s2">&quot;0x78bc984000&quot;</span>,
        <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;libandroid_runtime.so&quot;</span>,
        <span class="s2">&quot;path&quot;</span>: <span class="s2">&quot;/system/lib64/libandroid_runtime.so&quot;</span>,
        <span class="s2">&quot;size&quot;</span>: <span class="m">2011136</span>
    <span class="o">}</span>,
...
</code></pre></div>
<h4 id="method-hooking">Method Hooking<a class="headerlink" href="#method-hooking" title="Permanent link">&para;</a></h4>
<h5 id="xposed">Xposed<a class="headerlink" href="#xposed" title="Permanent link">&para;</a></h5>
<p>Let's assume you're testing an app that's stubbornly quitting on your rooted device. You decompile the app and find the following highly suspect method:</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.a.b</span><span class="w"></span>

<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">c</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">boolean</span><span class="w"> </span><span class="n">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">&quot;/sbin/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/system/bin/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/system/xbin/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/data/local/xbin/&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;/data/local/bin/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/system/sd/xbin/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/system/bin/failsafe/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/data/local/&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">v3</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">v2</span><span class="p">;</span><span class="w"> </span><span class="n">v3</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">v1</span><span class="o">[</span><span class="n">v3</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;su&quot;</span><span class="p">).</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="n">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="n">v0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This method iterates through a list of directories and returns <code>true</code> (device rooted) if it finds the <code>su</code> binary in any of them. Checks like this are easy to deactivate all you have to do is replace the code with something that returns "false". Method hooking with an Xposed module is one way to do this (see "Android Basic Security Testing" for more details on Xposed installation and basics).</p>
<p>The method  <code>XposedHelpers.findAndHookMethod</code> allows you to override existing class methods. By inspecting the decompiled source code, you can find out that the method performing the check is <code>c</code>. This method is located in the class <code>com.example.a.b</code>. The following is an Xposed module that overrides the function so that it always returns false:</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.awesome.pentestcompany</span><span class="p">;</span><span class="w"></span>

<span class="kn">import static</span><span class="w"> </span><span class="nn">de.robv.android.xposed.XposedHelpers.findAndHookMethod</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">de.robv.android.xposed.IXposedHookLoadPackage</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">de.robv.android.xposed.XposedBridge</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">de.robv.android.xposed.XC_MethodHook</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam</span><span class="p">;</span><span class="w"></span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DisableRootCheck</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">IXposedHookLoadPackage</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleLoadPackage</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">LoadPackageParam</span><span class="w"> </span><span class="n">lpparam</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">lpparam</span><span class="p">.</span><span class="na">packageName</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;com.example.targetapp&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">findAndHookMethod</span><span class="p">(</span><span class="s">&quot;com.example.a.b&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lpparam</span><span class="p">.</span><span class="na">classLoader</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;c&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XC_MethodHook</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nd">@Override</span><span class="w"></span>

<span class="w">            </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">beforeHookedMethod</span><span class="p">(</span><span class="n">MethodHookParam</span><span class="w"> </span><span class="n">param</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">XposedBridge</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="s">&quot;Caught root check!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">param</span><span class="p">.</span><span class="na">setResult</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Just like regular Android apps, modules for Xposed are developed and deployed with Android Studio. For more details on writing, compiling, and installing Xposed modules, refer to the tutorial provided by its author, <a href="https://www.xda-developers.com/rovo89-updates-on-the-situation-regarding-xposed-for-nougat/" title="Rovo89: Update on Development of Xposed for Nougat">rovo89</a>.</p>
<h5 id="frida">Frida<a class="headerlink" href="#frida" title="Permanent link">&para;</a></h5>
<p>We'll use Frida to solve the UnCrackable App for Android Level 1 and demonstrate how we can easily bypass root detection and extract secret data from the app.</p>
<p>When you start the crackme app on an emulator or a rooted device, you'll find that the it presents a dialog box and exits as soon as you press "OK" because it detected root:</p>
<p><img src="../../assets/Images/Chapters/0x05c/crackme-frida-1.png" width="400px" /></p>
<p>Let's see how we can prevent this.</p>
<p>The main method (decompiled with CFR) looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">sg.vantagepoint.uncrackable1</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">android.app.Activity</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">android.app.AlertDialog</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">android.content.Context</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">android.content.DialogInterface</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">android.os.Bundle</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">android.text.Editable</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">android.view.View</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">android.widget.EditText</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sg.vantagepoint.a.b</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sg.vantagepoint.a.c</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sg.vantagepoint.uncrackable1.a</span><span class="p">;</span><span class="w"></span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MainActivity</span><span class="w"></span>
<span class="kd">extends</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">AlertDialog</span><span class="w"> </span><span class="n">alertDialog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AlertDialog</span><span class="p">.</span><span class="na">Builder</span><span class="p">((</span><span class="n">Context</span><span class="p">)</span><span class="k">this</span><span class="p">).</span><span class="na">create</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">alertDialog</span><span class="p">.</span><span class="na">setTitle</span><span class="p">((</span><span class="n">CharSequence</span><span class="p">)</span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">alertDialog</span><span class="p">.</span><span class="na">setMessage</span><span class="p">((</span><span class="n">CharSequence</span><span class="p">)</span><span class="s">&quot;This is unacceptable. The app is now going to exit.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">alertDialog</span><span class="p">.</span><span class="na">setButton</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">CharSequence</span><span class="p">)</span><span class="s">&quot;OK&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DialogInterface</span><span class="p">.</span><span class="na">OnClickListener</span><span class="p">(){</span><span class="w"></span>

<span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onClick</span><span class="p">(</span><span class="n">DialogInterface</span><span class="w"> </span><span class="n">dialogInterface</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">exit</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="n">alertDialog</span><span class="p">.</span><span class="na">setCancelable</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">alertDialog</span><span class="p">.</span><span class="na">show</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span><span class="w"> </span><span class="n">bundle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="na">a</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="na">b</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="na">c</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">a</span><span class="p">(</span><span class="s">&quot;Root detected!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="na">a</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getApplicationContext</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">a</span><span class="p">(</span><span class="s">&quot;App is debuggable!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">bundle</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">setContentView</span><span class="p">(</span><span class="mi">2130903040</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Enabled aggressive block sorting</span>
<span class="cm">     */</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">verify</span><span class="p">(</span><span class="n">View</span><span class="w"> </span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">EditText</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="na">findViewById</span><span class="p">(</span><span class="mi">2130837505</span><span class="p">)).</span><span class="na">getText</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">AlertDialog</span><span class="w"> </span><span class="n">alertDialog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AlertDialog</span><span class="p">.</span><span class="na">Builder</span><span class="p">((</span><span class="n">Context</span><span class="p">)</span><span class="k">this</span><span class="p">).</span><span class="na">create</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="na">a</span><span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="n">object</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">alertDialog</span><span class="p">.</span><span class="na">setTitle</span><span class="p">((</span><span class="n">CharSequence</span><span class="p">)</span><span class="s">&quot;Success!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;This is the correct secret.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">alertDialog</span><span class="p">.</span><span class="na">setTitle</span><span class="p">((</span><span class="n">CharSequence</span><span class="p">)</span><span class="s">&quot;Nope...&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;That&#39;s not it. Try again.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">alertDialog</span><span class="p">.</span><span class="na">setMessage</span><span class="p">((</span><span class="n">CharSequence</span><span class="p">)</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">alertDialog</span><span class="p">.</span><span class="na">setButton</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">CharSequence</span><span class="p">)</span><span class="s">&quot;OK&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DialogInterface</span><span class="p">.</span><span class="na">OnClickListener</span><span class="p">(){</span><span class="w"></span>

<span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onClick</span><span class="p">(</span><span class="n">DialogInterface</span><span class="w"> </span><span class="n">dialogInterface</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">dialogInterface</span><span class="p">.</span><span class="na">dismiss</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="n">alertDialog</span><span class="p">.</span><span class="na">show</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Notice the "Root detected" message in the <code>onCreate</code> method and the various methods called in the preceding <code>if</code>-statement (which perform the actual root checks). Also note the "This is unacceptable..." message from the first method of the class, <code>private void a</code>. Obviously, this method displays the dialog box. There is an <code>alertDialog.onClickListener</code> callback set in the <code>setButton</code> method call, which closes the application via <code>System.exit</code> after successful root detection. With Frida, you can prevent the app from exiting by hooking the <code>MainActivity.a</code> method or the callback inside it. The example below shows how you can hook <code>MainActivity.a</code> and prevent it from ending the application.</p>
<div class="highlight"><pre><span></span><code><span class="nx">setImmediate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//prevent timeout</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;[*] Starting script&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">mainActivity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&quot;sg.vantagepoint.uncrackable1.MainActivity&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="nx">mainActivity</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">implementation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;[*] MainActivity.a called&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">};</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;[*] MainActivity.a modified&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</code></pre></div>
<p>Wrap your code in the function <code>setImmediate</code> to prevent timeouts (you may or may not need to do this), then call <code>Java.perform</code> to use Frida's methods for dealing with Java. Afterwards retrieve a wrapper for <code>MainActivity</code> class and overwrite its <code>a</code> method. Unlike the original, the new version of <code>a</code> just writes console output and doesn't exit the app. An alternative solution is to hook <code>onClick</code> method of the <code>OnClickListener</code> interface. You can overwrite the <code>onClick</code> method and prevent it from ending the application with the <code>System.exit</code> call. If you want to inject your own Frida script, it should either disable the <code>AlertDialog</code> entirely or change the behavior of the <code>onClick</code> method so the app does not exit when you click "OK".</p>
<p>Save the above script as <code>uncrackable1.js</code> and load it:</p>
<div class="highlight"><pre><span></span><code>$ frida -U -f owasp.mstg.uncrackable1 -l uncrackable1.js --no-pause
</code></pre></div>
<p>After you see the "MainActivity.a modified" message and the app will not exit anymore.</p>
<p>You can now try to input a "secret string". But where do you get it?</p>
<p>If you look at the class <code>sg.vantagepoint.uncrackable1.a</code>, you can see the encrypted string with which your input gets compared:</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">sg.vantagepoint.uncrackable1</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">android.util.Base64</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">android.util.Log</span><span class="p">;</span><span class="w"></span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">a</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">arrby</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decode</span><span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="s">&quot;5UJiFctbmgbDoLXmpL12mkno8HT4Lv8dlat8FxR2GOc=&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">arrby</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sg</span><span class="p">.</span><span class="na">vantagepoint</span><span class="p">.</span><span class="na">a</span><span class="p">.</span><span class="na">a</span><span class="p">.</span><span class="na">a</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="na">b</span><span class="p">(</span><span class="s">&quot;8d127684cbc37c17616d806cf50473cc&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">arrby</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">exception</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">StringBuilder</span><span class="w"> </span><span class="n">stringBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StringBuilder</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">stringBuilder</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="s">&quot;AES error:&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">stringBuilder</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="s">&quot;CodeCheck&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">stringBuilder</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">arrby</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="p">{};</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">string</span><span class="p">.</span><span class="na">equals</span><span class="p">((</span><span class="n">Object</span><span class="p">)</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">arrby</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">b</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="p">.</span><span class="na">length</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">arrby</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">n</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">arrby</span><span class="o">[</span><span class="n">i</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)((</span><span class="n">Character</span><span class="p">.</span><span class="na">digit</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span><span class="n">string</span><span class="p">.</span><span class="na">charAt</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Character</span><span class="p">.</span><span class="na">digit</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span><span class="n">string</span><span class="p">.</span><span class="na">charAt</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="mi">16</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">arrby</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Look at the <code>string.equals</code> comparison at the end of the <code>a</code> method and the creation of the string <code>arrby</code> in the <code>try</code> block above. <code>arrby</code> is the return value of the function <code>sg.vantagepoint.a.a.a</code>. <code>string.equals</code> comparison compares your input with <code>arrby</code>. So we want the return value of <code>sg.vantagepoint.a.a.a.</code></p>
<p>Instead of reversing the decryption routines to reconstruct the secret key, you can simply ignore all the decryption logic in the app and hook the <code>sg.vantagepoint.a.a.a</code> function to catch its return value.
Here is the complete script that prevents exiting on root and intercepts the decryption of the secret string:</p>
<div class="highlight"><pre><span></span><code><span class="nx">setImmediate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//prevent timeout</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;[*] Starting script&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">mainActivity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&quot;sg.vantagepoint.uncrackable1.MainActivity&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="nx">mainActivity</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">implementation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">           </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;[*] MainActivity.a called&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;[*] MainActivity.a modified&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">aaClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&quot;sg.vantagepoint.a.a&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="nx">aaClass</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">implementation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span><span class="w"> </span><span class="nx">arg2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">a</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span><span class="w"> </span><span class="nx">arg2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">retval</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">password</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">retval</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;[*] Decrypted: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">password</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">retval</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;[*] sg.vantagepoint.a.a.a modified&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</code></pre></div>
<p>After running the script in Frida and seeing the "[*] sg.vantagepoint.a.a.a modified" message in the console, enter a random value for "secret string" and press verify. You should get an output similar to the following:</p>
<div class="highlight"><pre><span></span><code>$ frida -U -f owasp.mstg.uncrackable1 -l uncrackable1.js --no-pause

<span class="o">[</span>*<span class="o">]</span> Starting script
<span class="o">[</span>USB::Android Emulator <span class="m">5554</span>::sg.vantagepoint.uncrackable1<span class="o">]</span>-&gt; <span class="o">[</span>*<span class="o">]</span> MainActivity.a modified
<span class="o">[</span>*<span class="o">]</span> sg.vantagepoint.a.a.a modified
<span class="o">[</span>*<span class="o">]</span> MainActivity.a called.
<span class="o">[</span>*<span class="o">]</span> Decrypted: I want to believe
</code></pre></div>
<p>The hooked function outputted the decrypted string. You extracted the secret string without having to dive too deep into the application code and its decryption routines.</p>
<p>You've now covered the basics of static/dynamic analysis on Android. Of course, the only way to <em>really</em> learn it is hands-on experience: build your own projects in Android Studio, observe how your code gets translated into bytecode and native code, and try to crack our challenges.</p>
<p>In the remaining sections, we'll introduce a few advanced subjects, including process exploration, kernel modules and dynamic execution.</p>
<h4 id="process-exploration">Process Exploration<a class="headerlink" href="#process-exploration" title="Permanent link">&para;</a></h4>
<p>When testing an app, process exploration can provide the tester with deep insights into the app process memory. It can be achieved via runtime instrumentation and allows to perform tasks such as:</p>
<ul>
<li>Retrieving the memory map and loaded libraries.</li>
<li>Searching for occurrences of certain data.</li>
<li>After doing a search, obtaining the location of a certain offset in the memory map.</li>
<li>Performing a memory dump and inspect or reverse engineer the binary data <em>offline</em>.</li>
<li>Reverse engineering a native library while it's running.</li>
</ul>
<p>As you can see, these passive tasks help us collect information. This Information is often used for other techniques, such as method hooking.</p>
<p>In the following sections you will be using <a href="../0x08-Testing-Tools/#r2frida">r2frida</a> to retrieve information straight from the app runtime. Please refer to <a href="https://github.com/nowsecure/r2frida/blob/master/README.md#installation" title="r2frida installation instructions">r2frida's official installation instructions</a>. First start by opening an r2frida session to the target app (e.g. <a href="https://github.com/OWASP/owasp-mstg/raw/master/Samples/Android/01_HelloWorld-JNI/HelloWord-JNI.apk" title="HelloWorld JNI">HelloWorld JNI</a> APK) that should be running on your Android phone (connected per USB). Use the following command:</p>
<div class="highlight"><pre><span></span><code>$ r2 frida://usb//sg.vantagepoint.helloworldjni
</code></pre></div>
<blockquote>
<p>See all options with <code>r2 frida://?</code>.</p>
</blockquote>
<p>Once in the r2frida session, all commands start with <code>\</code>. For example, in radare2 you'd run <code>i</code> to display the binary information, but in r2frida you'd use <code>\i</code>.</p>
<h5 id="memory-maps-and-inspection">Memory Maps and Inspection<a class="headerlink" href="#memory-maps-and-inspection" title="Permanent link">&para;</a></h5>
<p>You can retrieve the app's memory maps by running <code>\dm</code>, The output in Android can get very long (e.g. between 1500 and 2000 lines), to narrow your search and see only what directly belongs to the app apply a grep (<code>~</code>) by package name <code>\dm~&lt;package_name&gt;</code>:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\d</span>m~sg.vantagepoint.helloworldjni
0x000000009b2dc000 - 0x000000009b361000 rw- /dev/ashmem/dalvik-/data/app/sg.vantagepoint.helloworldjni-1/oat/arm64/base.art <span class="o">(</span>deleted<span class="o">)</span>
0x000000009b361000 - 0x000000009b36e000 --- /dev/ashmem/dalvik-/data/app/sg.vantagepoint.helloworldjni-1/oat/arm64/base.art <span class="o">(</span>deleted<span class="o">)</span>
0x000000009b36e000 - 0x000000009b371000 rw- /dev/ashmem/dalvik-/data/app/sg.vantagepoint.helloworldjni-1/oat/arm64/base.art <span class="o">(</span>deleted<span class="o">)</span>
0x0000007d103be000 - 0x0000007d10686000 r-- /data/app/sg.vantagepoint.helloworldjni-1/oat/arm64/base.vdex
0x0000007d10dd0000 - 0x0000007d10dee000 r-- /data/app/sg.vantagepoint.helloworldjni-1/oat/arm64/base.odex
0x0000007d10dee000 - 0x0000007d10e2b000 r-x /data/app/sg.vantagepoint.helloworldjni-1/oat/arm64/base.odex
0x0000007d10e3a000 - 0x0000007d10e3b000 r-- /data/app/sg.vantagepoint.helloworldjni-1/oat/arm64/base.odex
0x0000007d10e3b000 - 0x0000007d10e3c000 rw- /data/app/sg.vantagepoint.helloworldjni-1/oat/arm64/base.odex
0x0000007d1c499000 - 0x0000007d1c49a000 r-x /data/app/sg.vantagepoint.helloworldjni-1/lib/arm64/libnative-lib.so
0x0000007d1c4a9000 - 0x0000007d1c4aa000 r-- /data/app/sg.vantagepoint.helloworldjni-1/lib/arm64/libnative-lib.so
0x0000007d1c4aa000 - 0x0000007d1c4ab000 rw- /data/app/sg.vantagepoint.helloworldjni-1/lib/arm64/libnative-lib.so
0x0000007d1c516000 - 0x0000007d1c54d000 r-- /data/app/sg.vantagepoint.helloworldjni-1/base.apk
0x0000007dbd23c000 - 0x0000007dbd247000 r-- /data/app/sg.vantagepoint.helloworldjni-1/base.apk
0x0000007dc05db000 - 0x0000007dc05dc000 r-- /data/app/sg.vantagepoint.helloworldjni-1/oat/arm64/base.art
</code></pre></div>
<p>While you're searching or exploring the app memory, you can always verify where you're located in each moment (where your current offset is located) in the memory map. Instead of noting and searching for the memory address in this list you can simply run <code>\dm.</code>. You'll find an example in the following section "In-Memory Search".</p>
<p>If you're only interested into the modules (binaries and libraries) that the app has loaded, you can use the command <code>\il</code> to list them all:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\i</span>l
0x000000558b1fd000 app_process64
0x0000007dbc859000 libandroid_runtime.so
0x0000007dbf5d7000 libbinder.so
0x0000007dbff4d000 libcutils.so
0x0000007dbfd13000 libhwbinder.so
0x0000007dbea00000 liblog.so
0x0000007dbcf17000 libnativeloader.so
0x0000007dbf21c000 libutils.so
0x0000007dbde4b000 libc++.so
0x0000007dbe09b000 libc.so
...
0x0000007d10dd0000 base.odex
0x0000007d1c499000 libnative-lib.so
0x0000007d2354e000 frida-agent-64.so
0x0000007dc065d000 linux-vdso.so.1
0x0000007dc065f000 linker64
</code></pre></div>
<p>As you might expect you can correlate the addresses of the libraries with the memory maps: e.g. the native library of the app is located at <code>0x0000007d1c499000</code> and optimized dex (base.odex) at <code>0x0000007d10dd0000</code>.</p>
<p>You can also use objection to display the same information.</p>
<div class="highlight"><pre><span></span><code>$ objection --gadget sg.vantagepoint.helloworldjni explore

sg.vantagepoint.helloworldjni on <span class="o">(</span>google: <span class="m">8</span>.1.0<span class="o">)</span> <span class="o">[</span>usb<span class="o">]</span> <span class="c1"># memory list modules</span>
Save the output by adding <span class="sb">`</span>--json modules.json<span class="sb">`</span> to this <span class="nb">command</span>

Name                                             Base          Size                  Path
-----------------------------------------------  ------------  --------------------  --------------------------------------------------------------------
app_process64                                    0x558b1fd000  <span class="m">32768</span> <span class="o">(</span><span class="m">32</span>.0 KiB<span class="o">)</span>      /system/bin/app_process64
libandroid_runtime.so                            0x7dbc859000  <span class="m">1982464</span> <span class="o">(</span><span class="m">1</span>.9 MiB<span class="o">)</span>     /system/lib64/libandroid_runtime.so
libbinder.so                                     0x7dbf5d7000  <span class="m">557056</span> <span class="o">(</span><span class="m">544</span>.0 KiB<span class="o">)</span>    /system/lib64/libbinder.so
libcutils.so                                     0x7dbff4d000  <span class="m">77824</span> <span class="o">(</span><span class="m">76</span>.0 KiB<span class="o">)</span>      /system/lib64/libcutils.so
libhwbinder.so                                   0x7dbfd13000  <span class="m">163840</span> <span class="o">(</span><span class="m">160</span>.0 KiB<span class="o">)</span>    /system/lib64/libhwbinder.so
base.odex                                        0x7d10dd0000  <span class="m">442368</span> <span class="o">(</span><span class="m">432</span>.0 KiB<span class="o">)</span>    /data/app/sg.vantagepoint.helloworldjni-1/oat/arm64/base.odex
libnative-lib.so                                 0x7d1c499000  <span class="m">73728</span> <span class="o">(</span><span class="m">72</span>.0 KiB<span class="o">)</span>      /data/app/sg.vantagepoint.helloworldjni-1/lib/arm64/libnative-lib.so
</code></pre></div>
<p>You can even directly see the size and the path to that binary in the Android file system.</p>
<h5 id="in-memory-search">In-Memory Search<a class="headerlink" href="#in-memory-search" title="Permanent link">&para;</a></h5>
<p>In-memory search is a very useful technique to test for sensitive data that might be present in the app memory.</p>
<p>See r2frida's help on the search command (<code>\/?</code>) to learn about the search command and get a list of options. The following shows only a subset of them:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\/</span>?
 /      search
 /j     search json
 /w     search wide
 /wj    search wide json
 /x     search hex
 /xj    search hex json
...
</code></pre></div>
<p>You can adjust your search by using the search settings <code>\e~search</code>. For example, <code>\e search.quiet=true;</code> will print only the results and hide search progress:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\e</span>~search
e search.in<span class="o">=</span>perm:r--
e search.quiet<span class="o">=</span><span class="nb">false</span>
</code></pre></div>
<p>For now, we'll continue with the defaults and concentrate on string search. This app is actually very simple, it loads the string "Hello from C++" from its native library and displays it to us. You can start by searching for "Hello" and see what r2frida finds:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\/</span> Hello
Searching <span class="m">5</span> bytes: <span class="m">48</span> <span class="m">65</span> 6c 6c 6f
...
hits: <span class="m">11</span>
0x13125398 hit0_0 HelloWorldJNI
0x13126b90 hit0_1 Hello World!
0x1312e220 hit0_2 Hello from C++
0x70654ec5 hit0_3 Hello
0x7d1c499560 hit0_4 Hello from C++
0x7d1c4a9560 hit0_5 Hello from C++
0x7d1c51cef9 hit0_6 HelloWorldJNI
0x7d30ba11bc hit0_7 Hello World!
0x7d39cd796b hit0_8 Hello.java
0x7d39d2024d hit0_9 Hello<span class="p">;</span>
0x7d3aa4d274 hit0_10 Hello
</code></pre></div>
<p>Now you'd like to know where are these addresses actually. You may do so by running the <code>\dm.</code> command for all <code>@@</code> hits matching the glob <code>hit0_*</code>:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\d</span>m.@@ hit0_*
0x0000000013100000 - 0x0000000013140000 rw- /dev/ashmem/dalvik-main space <span class="o">(</span>region space<span class="o">)</span> <span class="o">(</span>deleted<span class="o">)</span>
0x0000000013100000 - 0x0000000013140000 rw- /dev/ashmem/dalvik-main space <span class="o">(</span>region space<span class="o">)</span> <span class="o">(</span>deleted<span class="o">)</span>
0x0000000013100000 - 0x0000000013140000 rw- /dev/ashmem/dalvik-main space <span class="o">(</span>region space<span class="o">)</span> <span class="o">(</span>deleted<span class="o">)</span>
0x00000000703c2000 - 0x00000000709b5000 rw- /data/dalvik-cache/arm64/system@framework@boot-framework.art
0x0000007d1c499000 - 0x0000007d1c49a000 r-x /data/app/sg.vantagepoint.helloworldjni-1/lib/arm64/libnative-lib.so
0x0000007d1c4a9000 - 0x0000007d1c4aa000 r-- /data/app/sg.vantagepoint.helloworldjni-1/lib/arm64/libnative-lib.so
0x0000007d1c516000 - 0x0000007d1c54d000 r-- /data/app/sg.vantagepoint.helloworldjni-1/base.apk
0x0000007d30a00000 - 0x0000007d30c00000 rw-
0x0000007d396bc000 - 0x0000007d3a998000 r-- /system/framework/arm64/boot-framework.vdex
0x0000007d396bc000 - 0x0000007d3a998000 r-- /system/framework/arm64/boot-framework.vdex
0x0000007d3a998000 - 0x0000007d3aa9c000 r-- /system/framework/arm64/boot-ext.vdex
</code></pre></div>
<p>Additionally, you can search for occurrences of the <a href="https://en.wikipedia.org/wiki/Wide_character" title="Wide character">wide version of the string</a> (<code>\/w</code>) and, again, check their memory regions:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\/</span>w Hello
Searching <span class="m">10</span> bytes: <span class="m">48</span> <span class="m">00</span> <span class="m">65</span> <span class="m">00</span> 6c <span class="m">00</span> 6c <span class="m">00</span> 6f <span class="m">00</span>
hits: <span class="m">6</span>
0x13102acc hit1_0 480065006c006c006f00
0x13102b9c hit1_1 480065006c006c006f00
0x7d30a53aa0 hit1_2 480065006c006c006f00
0x7d30a872b0 hit1_3 480065006c006c006f00
0x7d30bb9568 hit1_4 480065006c006c006f00
0x7d30bb9a68 hit1_5 480065006c006c006f00

<span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\d</span>m.@@ hit1_*
0x0000000013100000 - 0x0000000013140000 rw- /dev/ashmem/dalvik-main space <span class="o">(</span>region space<span class="o">)</span> <span class="o">(</span>deleted<span class="o">)</span>
0x0000000013100000 - 0x0000000013140000 rw- /dev/ashmem/dalvik-main space <span class="o">(</span>region space<span class="o">)</span> <span class="o">(</span>deleted<span class="o">)</span>
0x0000007d30a00000 - 0x0000007d30c00000 rw-
0x0000007d30a00000 - 0x0000007d30c00000 rw-
0x0000007d30a00000 - 0x0000007d30c00000 rw-
0x0000007d30a00000 - 0x0000007d30c00000 rw-
</code></pre></div>
<p>They are in the same rw- region as one of the previous strings (<code>0x0000007d30a00000</code>). Note that searching for the wide versions of strings is sometimes the only way to find them as you'll see in the following section.</p>
<p>In-memory search can be very useful to quickly know if certain data is located in the main app binary, inside a shared library or in another region. You may also use it to test the behavior of the app regarding how the data is kept in memory. For instance, you could analyze an app that performs a login and search for occurrences of the user password. Also, you may check if you still can find the password in memory after the login is completed to verify if this sensitive data is wiped from memory after its use.</p>
<p>In addition, you could use this approach to locate and extract cryptographic keys. For instance, in the case of an app encrypting/decrypting data and handling keys in memory instead of using the AndroidKeyStore API. See the section "<a href="../0x05e-Testing-Cryptography/#testing-key-management-mstg-storage-1-mstg-crypto-1-and-mstg-crypto-5" title="Testing Key Management">Testing Key Management</a>" in the chapter "<a href="../0x05e-Testing-Cryptography/">Android Cryptographic APIs</a>" for more details.</p>
<h5 id="memory-dump">Memory Dump<a class="headerlink" href="#memory-dump" title="Permanent link">&para;</a></h5>
<p>You can dump the app's process memory with <a href="https://github.com/sensepost/objection" title="Objection">objection</a> and <a href="https://github.com/Nightbringer21/fridump" title="Fridump">Fridump</a>. To take advantage of these tools on a non-rooted device, the Android app must be repackaged with <code>frida-gadget.so</code> and re-signed. A detailed explanation of this process is in the section "<a href="#dynamic-analysis-on-non-rooted-devices" title="Dynamic Analysis on Non-Rooted Devices">Dynamic Analysis on Non-Rooted Devices</a>. To use these tools on a rooted phone, simply have frida-server installed and running.</p>
<blockquote>
<p>Note: When using these tools, you might get several memory access violation errors which can be normally ignored. These tools inject a Frida agent and try to dump all the mapped memory of the app regardless of the access permissions (read/write/execute). Therefore, when the injected Frida agent tries to read a region that's not readable, it'll return the corresponding <em>memory access violation errors</em>. Refer to previous section "Memory Maps and Inspection" for more details.</p>
</blockquote>
<p>With objection it is possible to dump all memory of the running process on the device by using the command <code>memory dump all</code>.</p>
<div class="highlight"><pre><span></span><code>$ objection --gadget sg.vantagepoint.helloworldjni explore

sg.vantagepoint.helloworldjni on <span class="o">(</span>google: <span class="m">8</span>.1.0<span class="o">)</span> <span class="o">[</span>usb<span class="o">]</span> <span class="c1"># memory dump all /Users/foo/memory_Android/memory</span>

Will dump <span class="m">719</span> rw- images, totalling <span class="m">1</span>.6 GiB
Dumping <span class="m">1002</span>.8 MiB from base: 0x14140000  <span class="o">[</span>------------------------------------<span class="o">]</span>    <span class="m">0</span>%  <span class="m">00</span>:11:03<span class="o">(</span>session detach message<span class="o">)</span> process-terminated
Dumping <span class="m">8</span>.0 MiB from base: 0x7fc753e000  <span class="o">[</span><span class="c1">####################################]  100%</span>
Memory dumped to file: /Users/foo/memory_Android/memory
</code></pre></div>
<blockquote>
<p>In this case there was an error, which is probably due to memory access violations as we already anticipated. This error can be safely ignored as long as we are able to see the extracted dump in the file system. If you have any problems, a first step would be to enable the debug flag <code>-d</code> when running objection or, if that doesn't help, file an issue in <a href="https://github.com/sensepost/objection/issues" title="objection Issues">objection's GitHub</a>.</p>
</blockquote>
<p>Next, we are able to find the "Hello from C++" strings with radare2:</p>
<div class="highlight"><pre><span></span><code>$ r2 /Users/foo/memory_Android/memory
<span class="o">[</span>0x00000000<span class="o">]</span>&gt; izz~Hello from
<span class="m">1136</span> 0x00065270 0x00065270  <span class="m">14</span>  <span class="m">15</span> <span class="o">()</span> ascii Hello from C++
</code></pre></div>
<p>Alternatively you can use Fridump. This time, we will input a string and see if we can find it in the memory dump. For this, open the <a href="https://github.com/OWASP/MSTG-Hacking-Playground/tree/master/Android" title="MSTG Hacking Playground">MSTG Hacking Playground</a> app, navigate to "OMTG_DATAST_002_LOGGING" and enter "owasp-mstg" to the password field. Next, run Fridump:</p>
<div class="highlight"><pre><span></span><code>python3 fridump.py -U sg.vp.owasp_mobile.omtg_android -s

Current Directory: /Users/foo/git/fridump
Output directory is <span class="nb">set</span> to: /Users/foo/git/fridump/dump
Starting Memory dump...
Oops, memory access violation!-------------------------------<span class="o">]</span> <span class="m">0</span>.28% Complete
Progress: <span class="o">[</span><span class="c1">##################################################] 99.58% Complete</span>
Running strings on all files:
Progress: <span class="o">[</span><span class="c1">##################################################] 100.0% Complete</span>

Finished!
</code></pre></div>
<blockquote>
<p>Tip: Enable verbosity by including the flag <code>-v</code> if you want to see more details, e.g. the regions provoking memory access violations.</p>
</blockquote>
<p>It will take a while until it's completed and you'll get a collection of *.data files inside the dump folder. When you add the <code>-s</code> flag, all strings are extracted from the dumped raw memory files and added to the file <code>strings.txt</code>, which is also stored in the dump directory.</p>
<div class="highlight"><pre><span></span><code>ls dump/
dump/1007943680_dump.data dump/357826560_dump.data  dump/630456320_dump.data ... strings.txt
</code></pre></div>
<p>Finally, search for the input string in the dump directory:</p>
<div class="highlight"><pre><span></span><code>$ grep -nri owasp-mstg dump/
Binary file dump//316669952_dump.data matches
Binary file dump//strings.txt matches
</code></pre></div>
<p>The "owasp-mstg" string can be found in one of the dump files as well as in the processed strings file.</p>
<h5 id="runtime-reverse-engineering">Runtime Reverse Engineering<a class="headerlink" href="#runtime-reverse-engineering" title="Permanent link">&para;</a></h5>
<p>Runtime reverse engineering can be seen as the on-the-fly version of reverse engineering where you don't have the binary data to your host computer. Instead, you'll analyze it straight from the memory of the app.</p>
<p>We'll keep using the HelloWorld JNI app, open a session with r2frida <code>r2 frida://usb//sg.vantagepoint.helloworldjni</code> and you can start by displaying the target binary information by using the <code>\i</code> command:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\i</span>
arch                arm
bits                <span class="m">64</span>
os                  linux
pid                 <span class="m">13215</span>
uid                 <span class="m">10096</span>
objc                <span class="nb">false</span>
runtime             V8
java                <span class="nb">true</span>
cylang              <span class="nb">false</span>
pageSize            <span class="m">4096</span>
pointerSize         <span class="m">8</span>
codeSigningPolicy   optional
isDebuggerAttached  <span class="nb">false</span>
cwd                 /
dataDir             /data/user/0/sg.vantagepoint.helloworldjni
codeCacheDir        /data/user/0/sg.vantagepoint.helloworldjni/code_cache
extCacheDir         /storage/emulated/0/Android/data/sg.vantagepoint.helloworldjni/cache
obbDir              /storage/emulated/0/Android/obb/sg.vantagepoint.helloworldjni
filesDir            /data/user/0/sg.vantagepoint.helloworldjni/files
noBackupDir         /data/user/0/sg.vantagepoint.helloworldjni/no_backup
codePath            /data/app/sg.vantagepoint.helloworldjni-1/base.apk
packageName         sg.vantagepoint.helloworldjni
androidId           c92f43af46f5578d
cacheDir            /data/local/tmp
jniEnv              0x7d30a43c60
</code></pre></div>
<p>Search all symbols of a certain module with <code>\is &lt;lib&gt;</code>, e.g. <code>\is libnative-lib.so</code>.</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\i</span>s libnative-lib.so

<span class="o">[</span>0x00000000<span class="o">]</span>&gt;
</code></pre></div>
<p>Which are empty in this case. Alternatively, you might prefer to look into the imports/exports. For example, list the imports with <code>\ii &lt;lib&gt;</code>:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\i</span>i libnative-lib.so
0x7dbe1159d0 f __cxa_finalize /system/lib64/libc.so
0x7dbe115868 f __cxa_atexit /system/lib64/libc.so
</code></pre></div>
<p>And list the exports with <code>\iE &lt;lib&gt;</code>:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\i</span>E libnative-lib.so
0x7d1c49954c f Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI
</code></pre></div>
<blockquote>
<p>For big binaries it's recommended to pipe the output to the internal less program by appending <code>~..</code>, i.e. <code>\ii libandroid_runtime.so~..</code> (if not, for this binary, you'd get almost 2500 lines printed to your terminal).</p>
</blockquote>
<p>The next thing you might want to look at are the <strong>currently loaded</strong> Java classes:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\i</span>c~sg.vantagepoint.helloworldjni
sg.vantagepoint.helloworldjni.MainActivity
</code></pre></div>
<p>List class fields:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\i</span>c sg.vantagepoint.helloworldjni.MainActivity~sg.vantagepoint.helloworldjni
public native java.lang.String sg.vantagepoint.helloworldjni.MainActivity.stringFromJNI<span class="o">()</span>
public sg.vantagepoint.helloworldjni.MainActivity<span class="o">()</span>
</code></pre></div>
<p>Note that we've filtered by package name as this is the <code>MainActivity</code> and it includes all methods from Android's <code>Activity</code> class.</p>
<p>You can also display information about the class loader:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x00000000<span class="o">]</span>&gt; <span class="se">\i</span>cL
dalvik.system.PathClassLoader<span class="o">[</span>
 DexPathList<span class="o">[</span>
  <span class="o">[</span>
   directory <span class="s2">&quot;.&quot;</span><span class="o">]</span>
  ,
  <span class="nv">nativeLibraryDirectories</span><span class="o">=[</span>
   /system/lib64,
    /vendor/lib64,
    /system/lib64,
    /vendor/lib64<span class="o">]</span>
  <span class="o">]</span>
 <span class="o">]</span>
java.lang.BootClassLoader@b1f1189dalvik.system.PathClassLoader<span class="o">[</span>
 DexPathList<span class="o">[</span>
  <span class="o">[</span>
   zip file <span class="s2">&quot;/data/app/sg.vantagepoint.helloworldjni-1/base.apk&quot;</span><span class="o">]</span>
  ,
  <span class="nv">nativeLibraryDirectories</span><span class="o">=[</span>
   /data/app/sg.vantagepoint.helloworldjni-1/lib/arm64,
    /data/app/sg.vantagepoint.helloworldjni-1/base.apk!/lib/arm64-v8a,
    /system/lib64,
    /vendor/lib64<span class="o">]</span>
  <span class="o">]</span>
 <span class="o">]</span>
</code></pre></div>
<p>Next, imagine that you are interested into the method exported by libnative-lib.so <code>0x7d1c49954c f Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI</code>. You can seek to that address with <code>s 0x7d1c49954c</code>, analyze that function <code>af</code> and print 10 lines of its disassembly <code>pd 10</code>:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>0x7d1c49954c<span class="o">]</span>&gt; pdf
            <span class="p">;</span>-- sym.fun.Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI:
╭ <span class="o">(</span>fcn<span class="o">)</span> fcn.7d1c49954c <span class="m">18</span>
│   fcn.7d1c49954c <span class="o">(</span>int32_t arg_40f942h<span class="o">)</span><span class="p">;</span>
│           <span class="p">;</span> arg int32_t arg_40f942h @ x29+0x40f942
│           0x7d1c49954c      080040f9       ldr x8, <span class="o">[</span>x0<span class="o">]</span>
│           0x7d1c499550      <span class="m">01000090</span>       adrp x1, 0x7d1c499000
│           0x7d1c499554      <span class="m">21801591</span>       add x1, x1, 0x560         <span class="p">;</span> hit0_4
│           0x7d1c499558      029d42f9       ldr x2, <span class="o">[</span>x8, 0x538<span class="o">]</span>       <span class="p">;</span> <span class="o">[</span>0x538:4<span class="o">]=</span>-1 <span class="p">;</span> <span class="m">1336</span>
│           0x7d1c49955c      <span class="m">4000</span>           invalid
</code></pre></div>
<p>Note that the line tagged with <code>; hit0_4</code> corresponds to the string that we've previously found: <code>0x7d1c499560 hit0_4 Hello from C++</code>.</p>
<p>To learn more, please refer to the <a href="https://github.com/enovella/r2frida-wiki/blob/master/README.md" title="r2frida Wiki">r2frida wiki</a>.</p>
<h2 id="customizing-android-for-reverse-engineering">Customizing Android for Reverse Engineering<a class="headerlink" href="#customizing-android-for-reverse-engineering" title="Permanent link">&para;</a></h2>
<p>Working on real devices has advantages, especially for interactive, debugger-supported static/dynamic analysis. For example, working on a real device is simply faster. Also, Running the target app on a real device is less likely to trigger defenses. Instrumenting the live environment at strategic points gives you useful tracing functionality and the ability to manipulate the environment, which will help you bypass any anti-tampering defenses the app might implement.</p>
<h3 id="customizing-the-ramdisk">Customizing the RAMDisk<a class="headerlink" href="#customizing-the-ramdisk" title="Permanent link">&para;</a></h3>
<p>Initramfs is a small CPIO archive stored inside the boot image. It contains a few files that are required at boot, before the actual root file system is mounted. On Android, initramfs stays mounted indefinitely. It contains an important configuration file, default.prop, that defines some basic system properties. Changing this file can make the Android environment easier to reverse engineer. For our purposes, the most important settings in default.prop are <code>ro.debuggable</code> and <code>ro.secure</code>.</p>
<div class="highlight"><pre><span></span><code>$ cat /default.prop
<span class="c1">#</span>
<span class="c1"># ADDITIONAL_DEFAULT_PROPERTIES</span>
<span class="c1">#</span>
ro.secure<span class="o">=</span><span class="m">1</span>
ro.allow.mock.location<span class="o">=</span><span class="m">0</span>
ro.debuggable<span class="o">=</span><span class="m">1</span>
ro.zygote<span class="o">=</span>zygote32
persist.radio.snapshot_enabled<span class="o">=</span><span class="m">1</span>
persist.radio.snapshot_timer<span class="o">=</span><span class="m">2</span>
persist.radio.use_cc_names<span class="o">=</span><span class="nb">true</span>
persist.sys.usb.config<span class="o">=</span>mtp
rild.libpath<span class="o">=</span>/system/lib/libril-qc-qmi-1.so
camera.disable_zsl_mode<span class="o">=</span><span class="m">1</span>
ro.adb.secure<span class="o">=</span><span class="m">1</span>
dalvik.vm.dex2oat-Xms<span class="o">=</span>64m
dalvik.vm.dex2oat-Xmx<span class="o">=</span>512m
dalvik.vm.image-dex2oat-Xms<span class="o">=</span>64m
dalvik.vm.image-dex2oat-Xmx<span class="o">=</span>64m
ro.dalvik.vm.native.bridge<span class="o">=</span><span class="m">0</span>
</code></pre></div>
<p>Setting <code>ro.debuggable</code> to "1" makes all running apps debuggable (i.e., the debugger thread will run in every process), regardless of the value of the <code>android:debuggable</code> attribute in the Android Manifest. Setting <code>ro.secure</code> to "0" causes adbd to run as root.
To modify initrd on any Android device, back up the original boot image with TWRP or dump it with the following command:</p>
<div class="highlight"><pre><span></span><code>$ adb shell cat /dev/mtd/mtd0 &gt;/mnt/sdcard/boot.img
$ adb pull /mnt/sdcard/boot.img /tmp/boot.img
</code></pre></div>
<p>To extract the contents of the boot image, use the abootimg tool as described in Krzysztof Adamski's how-to :</p>
<div class="highlight"><pre><span></span><code>$ mkdir boot
$ <span class="nb">cd</span> boot
$ ../abootimg -x /tmp/boot.img
$ mkdir initrd
$ <span class="nb">cd</span> initrd
$ cat ../initrd.img <span class="p">|</span> gunzip <span class="p">|</span> cpio -vid
</code></pre></div>
<p>Note the boot parameters written to bootimg.cfg; you'll need them when booting your new kernel and ramdisk.</p>
<div class="highlight"><pre><span></span><code>$ ~/Desktop/abootimg/boot$ cat bootimg.cfg
<span class="nv">bootsize</span> <span class="o">=</span> 0x1600000
<span class="nv">pagesize</span> <span class="o">=</span> 0x800
<span class="nv">kerneladdr</span> <span class="o">=</span> 0x8000
<span class="nv">ramdiskaddr</span> <span class="o">=</span> 0x2900000
<span class="nv">secondaddr</span> <span class="o">=</span> 0xf00000
<span class="nv">tagsaddr</span> <span class="o">=</span> 0x2700000
<span class="nv">name</span> <span class="o">=</span>
<span class="nv">cmdline</span> <span class="o">=</span> <span class="nv">console</span><span class="o">=</span>ttyHSL0,115200,n8 androidboot.hardware<span class="o">=</span>hammerhead <span class="nv">user_debug</span><span class="o">=</span><span class="m">31</span> <span class="nv">maxcpus</span><span class="o">=</span><span class="m">2</span> msm_watchdog_v2.enable<span class="o">=</span><span class="m">1</span>
</code></pre></div>
<p>Modify default.prop and package your new ramdisk:</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">cd</span> initrd
$ find . <span class="p">|</span> cpio --create --format<span class="o">=</span><span class="s1">&#39;newc&#39;</span> <span class="p">|</span> gzip &gt; ../myinitd.img
</code></pre></div>
<h3 id="customizing-the-android-kernel">Customizing the Android Kernel<a class="headerlink" href="#customizing-the-android-kernel" title="Permanent link">&para;</a></h3>
<p>The Android kernel is a powerful ally to the reverse engineer. Although regular Android apps are hopelessly restricted and sandboxed, you, the reverser, can customize and alter the behavior of the operating system and kernel any way you wish. This gives you an advantage because most integrity checks and anti-tampering features ultimately rely on services performed by the kernel. Deploying a kernel that abuses this trust and unabashedly lies about itself and the environment, goes a long way in defeating most reversing defenses that malware authors (or normal developers) can throw at you.</p>
<p>Android apps have several ways to interact with the OS. Interacting through the Android Application Framework's APIs is standard. At the lowest level, however, many important functions (such as allocating memory and accessing files) are translated into old-school Linux system calls. On ARM Linux, system calls are invoked via the SVC instruction, which triggers a software interrupt. This interrupt calls the <code>vector_swi</code> kernel function, which then uses the system call number as an offset into a table (known as sys_call_table on Android) of function pointers.</p>
<p>The most straightforward way to intercept system calls is to inject your own code into kernel memory, then overwrite the original function in the system call table to redirect execution. Unfortunately, current stock Android kernels enforce memory restrictions that prevent this. Specifically, stock Lollipop and Marshmallow kernels are built with the CONFIG_STRICT_MEMORY_RWX option enabled. This prevents writing to kernel memory regions marked as read-only, so any attempt to patch kernel code or the system call table result in a segmentation fault and reboot. To get around this, build your own kernel. You can then deactivate this protection and make many other useful customizations that simplify reverse engineering. If you reverse Android apps on a regular basis, building your own reverse engineering sandbox is a no-brainer.</p>
<p>For hacking, I recommend an AOSP-supported device. Google's Nexus smartphones and tablets are the most logical candidates because kernels and system components built from the AOSP run on them without issues. Sony's Xperia series is also known for its openness. To build the AOSP kernel, you need a toolchain (a set of programs for cross-compiling the sources) and the appropriate version of the kernel sources. Follow Google's instructions to identify the correct git repo and branch for a given device and Android version.</p>
<p><a href="https://source.android.com/source/building-kernels.html#id-version">https://source.android.com/source/building-kernels.html#id-version</a></p>
<p>For example, to get kernel sources for Lollipop that are compatible with the Nexus 5, you need to clone the <code>msm</code> repository and check out one of the <code>android-msm-hammerhead</code> branches (hammerhead is the codename of the Nexus 5, and finding the right branch is confusing). Once you have downloaded the sources, create the default kernel config with the command <code>make hammerhead_defconfig</code> (replacing "hammerhead" with your target device).</p>
<div class="highlight"><pre><span></span><code>$ git clone https://android.googlesource.com/kernel/msm.git
$ <span class="nb">cd</span> msm
$ git checkout origin/android-msm-hammerhead-3.4-lollipop-mr1
$ <span class="nb">export</span> <span class="nv">ARCH</span><span class="o">=</span>arm
$ <span class="nb">export</span> <span class="nv">SUBARCH</span><span class="o">=</span>arm
$ make hammerhead_defconfig
$ vim .config
</code></pre></div>
<p>I recommend using the following settings to add loadable module support, enable the most important tracing facilities, and open kernel memory for patching.</p>
<div class="highlight"><pre><span></span><code><span class="nv">CONFIG_MODULES</span><span class="o">=</span>Y
<span class="nv">CONFIG_STRICT_MEMORY_RWX</span><span class="o">=</span>N
<span class="nv">CONFIG_DEVMEM</span><span class="o">=</span>Y
<span class="nv">CONFIG_DEVKMEM</span><span class="o">=</span>Y
<span class="nv">CONFIG_KALLSYMS</span><span class="o">=</span>Y
<span class="nv">CONFIG_KALLSYMS_ALL</span><span class="o">=</span>Y
<span class="nv">CONFIG_HAVE_KPROBES</span><span class="o">=</span>Y
<span class="nv">CONFIG_HAVE_KRETPROBES</span><span class="o">=</span>Y
<span class="nv">CONFIG_HAVE_FUNCTION_TRACER</span><span class="o">=</span>Y
<span class="nv">CONFIG_HAVE_FUNCTION_GRAPH_TRACER</span><span class="o">=</span>Y
<span class="nv">CONFIG_TRACING</span><span class="o">=</span>Y
<span class="nv">CONFIG_FTRACE</span><span class="o">=</span>Y
CONFIG <span class="nv">KDB</span><span class="o">=</span>Y
</code></pre></div>
<p>Once you're finished editing save the .config file, build the kernel.</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">export</span> <span class="nv">ARCH</span><span class="o">=</span>arm
$ <span class="nb">export</span> <span class="nv">SUBARCH</span><span class="o">=</span>arm
$ <span class="nb">export</span> <span class="nv">CROSS_COMPILE</span><span class="o">=</span>/path_to_your_ndk/arm-eabi-4.8/bin/arm-eabi-
$ make
</code></pre></div>
<p>You can now create a standalone toolchain for cross-compiling the kernel and subsequent tasks. To create a toolchain for Android 7.0 (API level 24), run make-standalone-toolchain.sh from the Android NDK package:</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">cd</span> android-ndk-rXXX
$ build/tools/make-standalone-toolchain.sh --arch<span class="o">=</span>arm --platform<span class="o">=</span>android-24 --install-dir<span class="o">=</span>/tmp/my-android-toolchain
</code></pre></div>
<p>Set the CROSS_COMPILE environment variable to point to your NDK directory and run "make" to build
the kernel.</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">export</span> <span class="nv">CROSS_COMPILE</span><span class="o">=</span>/tmp/my-android-toolchain/bin/arm-eabi-
$ make
</code></pre></div>
<h3 id="booting-the-custom-environment">Booting the Custom Environment<a class="headerlink" href="#booting-the-custom-environment" title="Permanent link">&para;</a></h3>
<p>Before booting into the new kernel, make a copy of your device's original boot image. Find the boot partition:</p>
<div class="highlight"><pre><span></span><code>root@hammerhead:/dev <span class="c1"># ls -al /dev/block/platform/msm_sdcc.1/by-name/</span>
lrwxrwxrwx root     root              <span class="m">1970</span>-08-30 <span class="m">22</span>:31 DDR -&gt; /dev/block/mmcblk0p24
lrwxrwxrwx root     root              <span class="m">1970</span>-08-30 <span class="m">22</span>:31 aboot -&gt; /dev/block/mmcblk0p6
lrwxrwxrwx root     root              <span class="m">1970</span>-08-30 <span class="m">22</span>:31 abootb -&gt; /dev/block/mmcblk0p11
lrwxrwxrwx root     root              <span class="m">1970</span>-08-30 <span class="m">22</span>:31 boot -&gt; /dev/block/mmcblk0p19
<span class="o">(</span>...<span class="o">)</span>
lrwxrwxrwx root     root              <span class="m">1970</span>-08-30 <span class="m">22</span>:31 userdata -&gt; /dev/block/mmcblk0p28
</code></pre></div>
<p>Then dump the whole thing into a file:</p>
<div class="highlight"><pre><span></span><code>$ adb shell <span class="s2">&quot;su -c dd if=/dev/block/mmcblk0p19 of=/data/local/tmp/boot.img&quot;</span>
$ adb pull /data/local/tmp/boot.img
</code></pre></div>
<p>Next, extract the ramdisk and information about the structure of the boot image. There are various tools that can do this;  I used Gilles Grandou's abootimg tool. Install the tool and run the following command on your boot image:</p>
<div class="highlight"><pre><span></span><code>$ abootimg -x boot.img
</code></pre></div>
<p>This should create the files bootimg.cfg, initrd.img, and zImage (your original kernel) in the local directory.</p>
<p>You can now use fastboot to test the new kernel. The <code>fastboot boot</code> command allows you to run the kernel without actually flashing it (once you're sure everything works, you can make the changes permanent with fastboot flash, but you don't have to). Restart the device in fastboot mode with the following command:</p>
<div class="highlight"><pre><span></span><code>$ adb reboot bootloader
</code></pre></div>
<p>Then use the <code>fastboot boot</code> command to boot Android with the new kernel. Specify the kernel offset, ramdisk offset, tags offset, and command line (use the values listed in your extracted bootimg.cfg) in addition to the newly built kernel and the original ramdisk.</p>
<div class="highlight"><pre><span></span><code>$ fastboot boot zImage-dtb initrd.img --base <span class="m">0</span> --kernel-offset 0x8000 --ramdisk-offset 0x2900000 --tags-offset 0x2700000 -c <span class="s2">&quot;console=ttyHSL0,115200,n8 androidboot.hardware=hammerhead user_debug=31 maxcpus=2 msm_watchdog_v2.enable=1&quot;</span>
</code></pre></div>
<p>The system should now boot normally. To quickly verify that the correct kernel is running, navigate to <strong>Settings</strong> -&gt; <strong>About phone</strong> and check the <strong>kernel version</strong> field.</p>
<p><img src="../../assets/Images/Chapters/0x05c/custom_kernel.jpg" width="400px" /></p>
<h3 id="system-call-hooking-with-kernel-modules">System Call Hooking with Kernel Modules<a class="headerlink" href="#system-call-hooking-with-kernel-modules" title="Permanent link">&para;</a></h3>
<p>System call hooking allows you to attack any anti-reversing defenses that depend on kernel-provided functionality. With your custom kernel in place, you can now use an LKM to load additional code into the kernel. You also have access to the /dev/kmem interface, which you can use to patch kernel memory on-the-fly. This is a classic Linux rootkit technique that has been described for Android by Dong-Hoon You in Phrack Magazine - "Android platform based linux kernel rootkit" on 4 April 2011.</p>
<p><img src="../../assets/Images/Chapters/0x05c/syscall_hooking.jpg" width="400px" /></p>
<p>You first need the address of sys_call_table. Fortunately, it is exported as a symbol in the Android kernel (iOS reversers aren't so lucky). You can look up the address in the /proc/kallsyms file:</p>
<div class="highlight"><pre><span></span><code>$ adb shell <span class="s2">&quot;su -c echo 0 &gt; /proc/sys/kernel/kptr_restrict&quot;</span>
$ adb shell cat /proc/kallsyms <span class="p">|</span> grep sys_call_table
c000f984 T sys_call_table
</code></pre></div>
<p>This is the only memory address you need for writing your kernel module. You can calculate everything else with offsets taken from the kernel headers (hopefully, you didn't delete them yet).</p>
<h4 id="example-file-hiding">Example: File Hiding<a class="headerlink" href="#example-file-hiding" title="Permanent link">&para;</a></h4>
<p>In this how-to, we will use a Kernel module to hide a file. Create a file on the device so you can hide it later:</p>
<div class="highlight"><pre><span></span><code>$ adb shell <span class="s2">&quot;su -c echo ABCD &gt; /data/local/tmp/nowyouseeme&quot;</span>
$ adb shell cat /data/local/tmp/nowyouseeme
ABCD
</code></pre></div>
<p>It's time to write the kernel module. For file-hiding, you'll need to hook one of the system calls used to open (or check for the existence of) files. There are many of these: <code>open</code>, <code>openat</code>, <code>access</code>, <code>accessat</code>, <code>facessat</code>, <code>stat</code>, <code>fstat</code>, etc. For now, you'll only hook the <code>openat</code> system call.  This is the syscall that the /bin/cat program uses when accessing a file, so the call should be suitable for a demonstration.</p>
<p>You can find the function prototypes for all system calls in the kernel header file arch/arm/include/asm/unistd.h. Create a file called kernel_hook.c with the following code:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/module.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/moduleparam.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/slab.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;asm/uaccess.h&gt;</span><span class="cp"></span>

<span class="n">asmlinkage</span><span class="w"> </span><span class="nf">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">real_openat</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="n">sys_call_table</span><span class="p">;</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">new_openat</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">dirfd</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="err">\</span><span class="n">__user</span><span class="o">*</span><span class="w"> </span><span class="n">pathname</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">kbuf</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">kbuf</span><span class="o">=</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">kmalloc</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="n">GFP_KERNEL</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strncpy_from_user</span><span class="p">(</span><span class="n">kbuf</span><span class="p">,</span><span class="n">pathname</span><span class="p">,</span><span class="mi">255</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">kbuf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/data/local/tmp/nowyouseeme&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Hiding file!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">kfree</span><span class="p">(</span><span class="n">kbuf</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">real_openat</span><span class="p">(</span><span class="n">dirfd</span><span class="p">,</span><span class="w"> </span><span class="n">pathname</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">init_module</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="n">sys_call_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mh">0xc000f984</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">real_openat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)(</span><span class="n">sys_call_table</span><span class="p">[</span><span class="err">\</span><span class="n">__NR_openat</span><span class="p">]);</span><span class="w"></span>

<span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>To build the kernel module, you need the kernel sources and a working toolchain. Since you've already built a complete kernel, you're all set. Create a Makefile with the following content:</p>
<div class="highlight"><pre><span></span><code><span class="nv">KERNEL</span><span class="o">=[</span>YOUR KERNEL PATH<span class="o">]</span>
<span class="nv">TOOLCHAIN</span><span class="o">=[</span>YOUR TOOLCHAIN PATH<span class="o">]</span>

<span class="nv">obj-m</span> <span class="o">:=</span> kernel_hook.o

<span class="nf">all</span><span class="o">:</span>
        make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span><span class="k">$(</span>TOOLCHAIN<span class="k">)</span>/bin/arm-eabi- -C <span class="k">$(</span>KERNEL<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>shell <span class="nb">pwd</span><span class="k">)</span> <span class="nv">CFLAGS_MODULE</span><span class="o">=</span>-fno-pic modules

<span class="nf">clean</span><span class="o">:</span>
        make -C <span class="k">$(</span>KERNEL<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>shell <span class="nb">pwd</span><span class="k">)</span> clean
</code></pre></div>
<p>Run <code>make</code> to compile the code, which should create the file kernel_hook.ko. Copy kernel_hook.ko to the device and load it with the <code>insmod</code> command. Using the <code>lsmod</code> command, verify that the module has been loaded successfully.</p>
<div class="highlight"><pre><span></span><code>$ make
<span class="o">(</span>...<span class="o">)</span>
$ adb push kernel_hook.ko /data/local/tmp/
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> /data/local/tmp/kernel_hook.ko
$ adb shell su -c insmod /data/local/tmp/kernel_hook.ko
$ adb shell lsmod
kernel_hook <span class="m">1160</span> <span class="m">0</span> <span class="o">[</span>permanent<span class="o">]</span>, Live 0xbf000000 <span class="o">(</span>PO<span class="o">)</span>
</code></pre></div>
<p>Now you'll access /dev/kmem to overwrite the original function pointer in <code>sys_call_table</code> with the address of your newly injected function (this could have been done directly in the kernel module, but /dev/kmem provides an easy way to toggle your hooks on and off). We've have adapted the code from Dong-Hoon You's Phrack article for this purpose. However, you can use the file interface instead of <code>mmap</code> because the latter might cause kernel panics. Create a file called kmem_util.c with the following code:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;asm/unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp"></span>

<span class="cp">#define MAP_SIZE 4096UL</span>
<span class="cp">#define MAP_MASK (MAP_SIZE - 1)</span>

<span class="kt">int</span><span class="w"> </span><span class="n">kmem</span><span class="p">;</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">read_kmem2</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sz</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">bread</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lseek</span><span class="p">(</span><span class="n">kmem</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_SET</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">bread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">kmem</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">write_kmem2</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">written</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lseek</span><span class="p">(</span><span class="n">kmem</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_SET</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">written</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">write</span><span class="p">(</span><span class="n">kmem</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;Write error&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="kt">off_t</span><span class="w"> </span><span class="n">sys_call_table</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">addr_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">sys_call_number</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">kmem</span><span class="o">=</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/kmem&quot;</span><span class="p">,</span><span class="n">O_RDWR</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">kmem</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;Error opening kmem&quot;</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">sscanf</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;%x&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sys_call_table</span><span class="p">);</span><span class="w"> </span><span class="n">sscanf</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sys_call_number</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">sscanf</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;%x&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">addr_ptr</span><span class="p">);</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">memset</span><span class="w"> </span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">);</span><span class="w"> </span><span class="n">read_kmem2</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">sys_call_table</span><span class="o">+</span><span class="p">(</span><span class="n">sys_call_number</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Original value: %02x%02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">write_kmem2</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr_ptr</span><span class="p">,</span><span class="n">sys_call_table</span><span class="o">+</span><span class="p">(</span><span class="n">sys_call_number</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">read_kmem2</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">sys_call_table</span><span class="o">+</span><span class="p">(</span><span class="n">sys_call_number</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;New value: %02x%02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">close</span><span class="p">(</span><span class="n">kmem</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Beginning with Android 5.0 (API level 21), all executables must be compiled with PIE support. Build kmem_util.c with the prebuilt toolchain and copy it to the device:</p>
<div class="highlight"><pre><span></span><code>$ /tmp/my-android-toolchain/bin/arm-linux-androideabi-gcc -pie -fpie -o kmem_util kmem_util.c
$ adb push kmem_util /data/local/tmp/
$ adb shell chmod <span class="m">755</span> /data/local/tmp/kmem_util
</code></pre></div>
<p>Before you start accessing kernel memory, you still need to know the correct offset into the system call table. The <code>openat</code> system call is defined in unistd.h, which is in the kernel sources:</p>
<div class="highlight"><pre><span></span><code>$ grep -r <span class="s2">&quot;__NR_openat&quot;</span> arch/arm/include/asm/unistd.h
<span class="se">\#</span>define __NR_openat            <span class="o">(</span>__NR_SYSCALL_BASE+322<span class="o">)</span>
</code></pre></div>
<p>The final piece of the puzzle is the address of your replacement-<code>openat</code>. Again, you can get this address from /proc/kallsyms.</p>
<div class="highlight"><pre><span></span><code>$ adb shell cat /proc/kallsyms <span class="p">|</span> grep new_openat
bf000000 t new_openat    <span class="o">[</span>kernel_hook<span class="o">]</span>
</code></pre></div>
<p>Now you have everything you need to overwrite the <code>sys_call_table</code> entry. The syntax for kmem_util is:</p>
<div class="highlight"><pre><span></span><code>$ ./kmem_util &lt;syscall_table_base_address&gt; &lt;offset&gt; &lt;func_addr&gt;
</code></pre></div>
<p>The following command patches the <code>openat</code> system call table so that it points to your new function.</p>
<div class="highlight"><pre><span></span><code>$ adb shell su -c /data/local/tmp/kmem_util c000f984 <span class="m">322</span> bf000000
Original value: c017a390
New value: bf000000
</code></pre></div>
<p>Assuming that everything worked, /bin/cat shouldn't be able to <em>see</em> the file.</p>
<div class="highlight"><pre><span></span><code>$ adb shell su -c cat /data/local/tmp/nowyouseeme
tmp-mksh: cat: /data/local/tmp/nowyouseeme: No such file or directory
</code></pre></div>
<p>Voilà! The file "nowyouseeme" is now somewhat hidden from all <em>user mode</em> processes. Note that the file can easily be found using other syscalls, and you need to do a lot more to properly hide a file, including hooking <code>stat</code>, <code>access</code>, and other system calls.</p>
<p>File-hiding is of course only the tip of the iceberg: you can accomplish a lot using kernel modules, including bypassing many root detection measures, integrity checks, and anti-debugging measures. You can find more examples in the "case studies" section of Bernhard Mueller's Hacking Soft Tokens Paper [#mueller].</p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li>Bionic - <a href="https://github.com/android/platform_bionic">https://github.com/android/platform_bionic</a></li>
<li>Attacking Android Applications with Debuggers (19 January 2015) - <a href="https://blog.netspi.com/attacking-android-applications-with-debuggers/">https://blog.netspi.com/attacking-android-applications-with-debuggers/</a></li>
<li>[#josse] Sébastien Josse, Dynamic Malware Recompilation (6 January 2014) - <a href="http://ieeexplore.ieee.org/document/6759227/">http://ieeexplore.ieee.org/document/6759227/</a></li>
<li>Update on Development of Xposed for Nougat - <a href="https://www.xda-developers.com/rovo89-updates-on-the-situation-regarding-xposed-for-nougat/">https://www.xda-developers.com/rovo89-updates-on-the-situation-regarding-xposed-for-nougat/</a></li>
<li>Android Platform based Linux kernel rootkit (4 April 2011 - Phrack Magazine)</li>
<li>[#mueller] Bernhard Mueller, Hacking Soft Tokens. Advanced Reverse Engineering on Android (2016) - <a href="https://packetstormsecurity.com/files/138504/HITB_Hacking_Soft_Tokens_v1.2.pdf">https://packetstormsecurity.com/files/138504/HITB_Hacking_Soft_Tokens_v1.2.pdf</a></li>
</ul>

              
            </article>
            
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../0x05b-Basic-Security_Testing/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Android Basic Security Testing" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Android Basic Security Testing
            </div>
          </div>
        </a>
      
      
        
        <a href="../0x05d-Testing-Data-Storage/" class="md-footer__link md-footer__link--next" aria-label="Next: Android Data Storage" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Android Data Storage
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <div style="float: left; padding-right: 1em;">
  <a href="https://www.owasp.org"><img src="https://github.com/OWASP/owasp-mstg/blob/master/Document/Images/OWASP_logo_white.png?raw=true" width="100px" /></a>
</div>
<span>
  &#169; OWASP Foundation 2022. This work is licensed under 
  <a href="https://creativecommons.org/licenses/by/4.0">CC-BY-4.0</a>. For any reuse or distribution, you must make clear to others the license terms of this work.
</span>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://owasp.slack.com/messages/project-mobile_omtg/details/" target="_blank" rel="noopener" title="owasp.slack.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/OWASP_MSTG" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/OWASP/owasp-mstg/discussions" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["search.suggest", "search.highlight", "search.share", "navigation.instant", "navigation.expand", "navigation.tabs", "navigation.tabs.sticky", "toc.integrate", "navigation.top"], "search": "../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../../javascripts/tablesort.js"></script>
      
    
  </body>
</html>