
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/logo_circle.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.9">
    
    
      
        <title>iOS Platform APIs - OWASP Mobile Security Project</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ios-platform-apis" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OWASP Mobile Security Project" class="md-header__button md-logo" aria-label="OWASP Mobile Security Project" data-md-component="logo">
      
  <img src="../../assets/logo_circle.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OWASP Mobile Security Project
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              iOS Platform APIs
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/OWASP/owasp-mstg" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    OWASP/owasp-mstg
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Welcome
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../donate/" class="md-tabs__link">
      ♡ Donations
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../news/" class="md-tabs__link">
      News
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../talks/" class="md-tabs__link">
      Talks
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../0x01-Foreword/" class="md-tabs__link md-tabs__link--active">
        MSTG
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../contributing/1_How_Can_You_Contribute/" class="md-tabs__link">
        Contributing
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OWASP Mobile Security Project" class="md-nav__button md-logo" aria-label="OWASP Mobile Security Project" data-md-component="logo">
      
  <img src="../../assets/logo_circle.png" alt="logo">

    </a>
    OWASP Mobile Security Project
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/OWASP/owasp-mstg" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    OWASP/owasp-mstg
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../donate/" class="md-nav__link">
        ♡ Donations
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../news/" class="md-nav__link">
        News
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../talks/" class="md-nav__link">
        Talks
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          MSTG
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="MSTG" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          MSTG
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x01-Foreword/" class="md-nav__link">
        Foreword
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x02a-Frontispiece/" class="md-nav__link">
        Frontispiece
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x02b-MASVS-MSTG-Adoption/" class="md-nav__link">
        OWASP MASVS and MSTG Adoption
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x02c-Acknowledgements/" class="md-nav__link">
        Acknowledgments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x03-Overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04a-Mobile-App-Taxonomy/" class="md-nav__link">
        Mobile App Taxonomy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04b-Mobile-App-Security-Testing/" class="md-nav__link">
        Mobile App Security Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04c-Tampering-and-Reverse-Engineering/" class="md-nav__link">
        Mobile App Tampering and Reverse Engineering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04e-Testing-Authentication-and-Session-Management/" class="md-nav__link">
        Mobile App Authentication Architectures
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04f-Testing-Network-Communication/" class="md-nav__link">
        Mobile App Network Communication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04g-Testing-Cryptography/" class="md-nav__link">
        Mobile App Cryptography
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04h-Testing-Code-Quality/" class="md-nav__link">
        Mobile App Code Quality
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x04i-Testing-User-Privacy-Protection/" class="md-nav__link">
        Mobile App User Privacy Protection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05a-Platform-Overview/" class="md-nav__link">
        Android Platform Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05b-Basic-Security_Testing/" class="md-nav__link">
        Android Basic Security Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05c-Reverse-Engineering-and-Tampering/" class="md-nav__link">
        Android Tampering and Reverse Engineering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05d-Testing-Data-Storage/" class="md-nav__link">
        Android Data Storage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05e-Testing-Cryptography/" class="md-nav__link">
        Android Cryptographic APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05f-Testing-Local-Authentication/" class="md-nav__link">
        Android Local Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05g-Testing-Network-Communication/" class="md-nav__link">
        Android Network APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05h-Testing-Platform-Interaction/" class="md-nav__link">
        Android Platform APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05i-Testing-Code-Quality-and-Build-Settings/" class="md-nav__link">
        Android Code Quality and Build Settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x05j-Testing-Resiliency-Against-Reverse-Engineering/" class="md-nav__link">
        Android Anti-Reversing Defenses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06a-Platform-Overview/" class="md-nav__link">
        iOS Platform Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06b-Basic-Security-Testing/" class="md-nav__link">
        iOS Basic Security Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06c-Reverse-Engineering-and-Tampering/" class="md-nav__link">
        iOS Tampering and Reverse Engineering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06d-Testing-Data-Storage/" class="md-nav__link">
        iOS Data Storage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06e-Testing-Cryptography/" class="md-nav__link">
        iOS Cryptographic APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06f-Testing-Local-Authentication/" class="md-nav__link">
        iOS Local Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06g-Testing-Network-Communication/" class="md-nav__link">
        iOS Network APIs
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          iOS Platform APIs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        iOS Platform APIs
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#testing-app-permissions-mstg-platform-1" class="md-nav__link">
    Testing App Permissions (MSTG-PLATFORM-1)
  </a>
  
    <nav class="md-nav" aria-label="Testing App Permissions (MSTG-PLATFORM-1)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#device-capabilities" class="md-nav__link">
    Device Capabilities
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#entitlements" class="md-nav__link">
    Entitlements
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis" class="md-nav__link">
    Static Analysis
  </a>
  
    <nav class="md-nav" aria-label="Static Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#purpose-strings-in-the-infoplist-file" class="md-nav__link">
    Purpose Strings in the Info.plist File
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-signing-entitlements-file" class="md-nav__link">
    Code Signing Entitlements File
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#embedded-provisioning-profile-file" class="md-nav__link">
    Embedded Provisioning Profile File
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#entitlements-embedded-in-the-compiled-app-binary" class="md-nav__link">
    Entitlements Embedded in the Compiled App Binary
  </a>
  
    <nav class="md-nav" aria-label="Entitlements Embedded in the Compiled App Binary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#extracting-the-entitlements-plist-from-the-app-binary" class="md-nav__link">
    Extracting the Entitlements Plist from the App Binary
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#source-code-inspection" class="md-nav__link">
    Source Code Inspection
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis" class="md-nav__link">
    Dynamic Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-for-sensitive-functionality-exposure-through-ipc-mstg-platform-4" class="md-nav__link">
    Testing for Sensitive Functionality Exposure Through IPC (MSTG-PLATFORM-4)
  </a>
  
    <nav class="md-nav" aria-label="Testing for Sensitive Functionality Exposure Through IPC (MSTG-PLATFORM-4)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#custom-url-schemes" class="md-nav__link">
    Custom URL Schemes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#universal-links" class="md-nav__link">
    Universal Links
  </a>
  
    <nav class="md-nav" aria-label="Universal Links">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_1" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_1" class="md-nav__link">
    Static Analysis
  </a>
  
    <nav class="md-nav" aria-label="Static Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checking-the-associated-domains-entitlement" class="md-nav__link">
    Checking the Associated Domains Entitlement
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retrieving-the-apple-app-site-association-file" class="md-nav__link">
    Retrieving the Apple App Site Association File
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-the-link-receiver-method" class="md-nav__link">
    Checking the Link Receiver Method
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-the-data-handler-method" class="md-nav__link">
    Checking the Data Handler Method
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-if-the-app-is-calling-other-apps-universal-links" class="md-nav__link">
    Checking if the App is Calling Other App's Universal Links
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_1" class="md-nav__link">
    Dynamic Analysis
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#triggering-universal-links" class="md-nav__link">
    Triggering Universal Links
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identifying-valid-universal-links" class="md-nav__link">
    Identifying Valid Universal Links
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tracing-the-link-receiver-method" class="md-nav__link">
    Tracing the Link Receiver Method
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-how-the-links-are-opened" class="md-nav__link">
    Checking How the Links Are Opened
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-notes-about-universal-links-and-handoff" class="md-nav__link">
    Final Notes about Universal Links and Handoff
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uiactivity-sharing" class="md-nav__link">
    UIActivity Sharing
  </a>
  
    <nav class="md-nav" aria-label="UIActivity Sharing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_2" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_2" class="md-nav__link">
    Static Analysis
  </a>
  
    <nav class="md-nav" aria-label="Static Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sending-items" class="md-nav__link">
    Sending Items
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receiving-items" class="md-nav__link">
    Receiving Items
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_2" class="md-nav__link">
    Dynamic Analysis
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sending-items_1" class="md-nav__link">
    Sending Items
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receiving-items_1" class="md-nav__link">
    Receiving Items
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#app-extensions" class="md-nav__link">
    App Extensions
  </a>
  
    <nav class="md-nav" aria-label="App Extensions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_3" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-are-app-extensions" class="md-nav__link">
    What are app extensions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-do-app-extensions-interact-with-other-apps" class="md-nav__link">
    How do app extensions interact with other apps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    Security Considerations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_3" class="md-nav__link">
    Static Analysis
  </a>
  
    <nav class="md-nav" aria-label="Static Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verifying-if-the-app-contains-app-extensions" class="md-nav__link">
    Verifying if the App Contains App Extensions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#determining-the-supported-data-types" class="md-nav__link">
    Determining the Supported Data Types
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-data-sharing-with-the-containing-app" class="md-nav__link">
    Checking Data Sharing with the Containing App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verifying-if-the-app-restricts-the-use-of-app-extensions" class="md-nav__link">
    Verifying if the App Restricts the Use of App Extensions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_3" class="md-nav__link">
    Dynamic Analysis
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inspecting-the-items-being-shared" class="md-nav__link">
    Inspecting the Items Being Shared
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identifying-the-app-extensions-involved" class="md-nav__link">
    Identifying the App Extensions Involved
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uipasteboard" class="md-nav__link">
    UIPasteboard
  </a>
  
    <nav class="md-nav" aria-label="UIPasteboard">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_4" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_4" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_4" class="md-nav__link">
    Dynamic Analysis
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#detect-pasteboard-usage" class="md-nav__link">
    Detect Pasteboard Usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-persistent-pasteboard-usage" class="md-nav__link">
    Detect Persistent Pasteboard Usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-and-inspecting-pasteboard-items" class="md-nav__link">
    Monitoring and Inspecting Pasteboard Items
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-custom-url-schemes-mstg-platform-3" class="md-nav__link">
    Testing Custom URL Schemes (MSTG-PLATFORM-3)
  </a>
  
    <nav class="md-nav" aria-label="Testing Custom URL Schemes (MSTG-PLATFORM-3)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_5" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_5" class="md-nav__link">
    Static Analysis
  </a>
  
    <nav class="md-nav" aria-label="Static Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing-custom-url-schemes-registration" class="md-nav__link">
    Testing Custom URL Schemes Registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-application-query-schemes-registration" class="md-nav__link">
    Testing Application Query Schemes Registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-url-handling-and-validation" class="md-nav__link">
    Testing URL Handling and Validation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-url-requests-to-other-apps" class="md-nav__link">
    Testing URL Requests to Other Apps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-for-deprecated-methods" class="md-nav__link">
    Testing for Deprecated Methods
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_5" class="md-nav__link">
    Dynamic Analysis
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#performing-url-requests" class="md-nav__link">
    Performing URL Requests
  </a>
  
    <nav class="md-nav" aria-label="Performing URL Requests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-safari" class="md-nav__link">
    Using Safari
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-the-notes-app" class="md-nav__link">
    Using the Notes App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-frida" class="md-nav__link">
    Using Frida
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identifying-and-hooking-the-url-handler-method" class="md-nav__link">
    Identifying and Hooking the URL Handler Method
  </a>
  
    <nav class="md-nav" aria-label="Identifying and Hooking the URL Handler Method">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#crafting-the-link-yourself-and-letting-safari-open-it" class="md-nav__link">
    Crafting the Link Yourself and Letting Safari Open It
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamically-opening-the-link-from-the-app-itself" class="md-nav__link">
    Dynamically Opening the Link from the App Itself
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opening-a-link-by-navigating-to-a-page-and-letting-safari-open-it" class="md-nav__link">
    Opening a Link by Navigating to a Page and Letting Safari Open It
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-for-deprecated-methods_1" class="md-nav__link">
    Testing for Deprecated Methods
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-url-schemes-source-validation" class="md-nav__link">
    Testing URL Schemes Source Validation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fuzzing-url-schemes" class="md-nav__link">
    Fuzzing URL Schemes
  </a>
  
    <nav class="md-nav" aria-label="Fuzzing URL Schemes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-frida_1" class="md-nav__link">
    Using Frida
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-ios-webviews-mstg-platform-5" class="md-nav__link">
    Testing iOS WebViews (MSTG-PLATFORM-5)
  </a>
  
    <nav class="md-nav" aria-label="Testing iOS WebViews (MSTG-PLATFORM-5)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_6" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uiwebview" class="md-nav__link">
    UIWebView
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wkwebview" class="md-nav__link">
    WKWebView
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sfsafariviewcontroller" class="md-nav__link">
    SFSafariViewController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safari-web-inspector" class="md-nav__link">
    Safari Web Inspector
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_6" class="md-nav__link">
    Static Analysis
  </a>
  
    <nav class="md-nav" aria-label="Static Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#identifying-webview-usage" class="md-nav__link">
    Identifying WebView Usage
  </a>
  
    <nav class="md-nav" aria-label="Identifying WebView Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uiwebview_1" class="md-nav__link">
    UIWebView
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wkwebview_1" class="md-nav__link">
    WKWebView
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-javascript-configuration" class="md-nav__link">
    Testing JavaScript Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-for-mixed-content" class="md-nav__link">
    Testing for Mixed Content
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_6" class="md-nav__link">
    Dynamic Analysis
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enumerating-webview-instances" class="md-nav__link">
    Enumerating WebView Instances
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-if-javascript-is-enabled" class="md-nav__link">
    Checking if JavaScript is Enabled
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verifying-that-only-secure-content-is-allowed" class="md-nav__link">
    Verifying that Only Secure Content is Allowed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-for-webview-uri-manipulation" class="md-nav__link">
    Testing for WebView URI Manipulation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-webview-protocol-handlers-mstg-platform-6" class="md-nav__link">
    Testing WebView Protocol Handlers (MSTG-PLATFORM-6)
  </a>
  
    <nav class="md-nav" aria-label="Testing WebView Protocol Handlers (MSTG-PLATFORM-6)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_7" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_7" class="md-nav__link">
    Static Analysis
  </a>
  
    <nav class="md-nav" aria-label="Static Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing-how-webviews-are-loaded" class="md-nav__link">
    Testing How WebViews are Loaded
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-webview-file-access" class="md-nav__link">
    Testing WebView File Access
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-telephone-number-detection" class="md-nav__link">
    Checking Telephone Number Detection
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_7" class="md-nav__link">
    Dynamic Analysis
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checking-how-webviews-are-loaded" class="md-nav__link">
    Checking How WebViews are Loaded
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#determining-webview-file-access" class="md-nav__link">
    Determining WebView File Access
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#determining-whether-native-methods-are-exposed-through-webviews-mstg-platform-7" class="md-nav__link">
    Determining Whether Native Methods Are Exposed Through WebViews (MSTG-PLATFORM-7)
  </a>
  
    <nav class="md-nav" aria-label="Determining Whether Native Methods Are Exposed Through WebViews (MSTG-PLATFORM-7)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_8" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_8" class="md-nav__link">
    Static Analysis
  </a>
  
    <nav class="md-nav" aria-label="Static Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing-uiwebview-javascript-to-native-bridges" class="md-nav__link">
    Testing UIWebView JavaScript to Native Bridges
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-wkwebview-javascript-to-native-bridges" class="md-nav__link">
    Testing WKWebView JavaScript to Native Bridges
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_8" class="md-nav__link">
    Dynamic Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-object-persistence-mstg-platform-8" class="md-nav__link">
    Testing Object Persistence (MSTG-PLATFORM-8)
  </a>
  
    <nav class="md-nav" aria-label="Testing Object Persistence (MSTG-PLATFORM-8)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_9" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#object-encoding" class="md-nav__link">
    Object Encoding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#object-archiving-with-nskeyedarchiver" class="md-nav__link">
    Object Archiving with NSKeyedArchiver
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#codable" class="md-nav__link">
    Codable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#json-and-codable" class="md-nav__link">
    JSON and Codable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#property-lists-and-codable" class="md-nav__link">
    Property Lists and Codable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xml" class="md-nav__link">
    XML
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#object-relational-mapping-coredata-and-realm" class="md-nav__link">
    Object-Relational Mapping (CoreData and Realm)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocol-buffers" class="md-nav__link">
    Protocol Buffers
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-analysis_9" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_9" class="md-nav__link">
    Dynamic Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-enforced-updating-mstg-arch-9" class="md-nav__link">
    Testing enforced updating (MSTG-ARCH-9)
  </a>
  
    <nav class="md-nav" aria-label="Testing enforced updating (MSTG-ARCH-9)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#static-analysis_10" class="md-nav__link">
    Static Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-analysis_10" class="md-nav__link">
    Dynamic analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
    <nav class="md-nav" aria-label="References">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#owasp-masvs" class="md-nav__link">
    OWASP MASVS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regarding-object-persistence-in-ios" class="md-nav__link">
    Regarding Object Persistence in iOS
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06i-Testing-Code-Quality-and-Build-Settings/" class="md-nav__link">
        iOS Code Quality and Build Settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x06j-Testing-Resiliency-Against-Reverse-Engineering/" class="md-nav__link">
        iOS Anti-Reversing Defenses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x07-Appendix/" class="md-nav__link">
        Appendix
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x08-Testing-Tools/" class="md-nav__link">
        Testing Tools
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../0x09-Suggested-Reading/" class="md-nav__link">
        Suggested Reading
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Contributing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Contributing" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Contributing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/1_How_Can_You_Contribute/" class="md-nav__link">
        How Can You Contribute?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/2_Getting_Started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/3_PRs_and_Reviews/" class="md-nav__link">
        Pull Requests & Reviews
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/4_Add_new_Language/" class="md-nav__link">
        Add a New Language
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/5_Style_Guide/" class="md-nav__link">
        Style Guide
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/OWASP/owasp-mstg/edit/master/docs/MSTG/0x06h-Testing-Platform-Interaction.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="ios-platform-apis">iOS Platform APIs<a class="headerlink" href="#ios-platform-apis" title="Permanent link">&para;</a></h1>
<h2 id="testing-app-permissions-mstg-platform-1">Testing App Permissions (MSTG-PLATFORM-1)<a class="headerlink" href="#testing-app-permissions-mstg-platform-1" title="Permanent link">&para;</a></h2>
<h3 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h3>
<p>In contrast to Android, where each app runs on its own user ID, iOS makes all third-party apps run under the non-privileged <code>mobile</code> user. Each app has a unique home directory and is sandboxed, so that they cannot access protected system resources or files stored by the system or by other apps. These restrictions are implemented via sandbox policies (aka. <em>profiles</em>), which are enforced by the <a href="http://www.trustedbsd.org/mac.html" title="TrustedBSD Mandatory Access Control (MAC) Framework">Trusted BSD (MAC) Mandatory Access Control Framework</a> via a kernel extension. iOS applies a generic sandbox profile to all third-party apps called <em>container</em>. Access to protected resources or data (some also known as <a href="https://developer.apple.com/support/app-capabilities/" title="Advanced App Capabilities">app capabilities</a>) is possible, but it's strictly controlled via special permissions known as <em>entitlements</em>.</p>
<p>Some permissions can be configured by the app's developers (e.g. Data Protection or Keychain Sharing) and will directly take effect after the installation. However, for others, the user will be explicitly asked the first time the app attempts to access a protected resource, <a href="https://developer.apple.com/library/archive/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/ExpectedAppBehaviors/ExpectedAppBehaviors.html#//apple_ref/doc/uid/TP40007072-CH3-SW7" title="Data and resources protected by system authorization settings">for example</a>:</p>
<ul>
<li>Bluetooth peripherals</li>
<li>Calendar data</li>
<li>Camera</li>
<li>Contacts</li>
<li>Health sharing</li>
<li>Health updating</li>
<li>HomeKit</li>
<li>Location</li>
<li>Microphone</li>
<li>Motion</li>
<li>Music and the media library</li>
<li>Photos</li>
<li>Reminders</li>
<li>Siri</li>
<li>Speech recognition</li>
<li>the TV provider</li>
</ul>
<p>Even though Apple urges to protect the privacy of the user and to be <a href="https://developer.apple.com/design/human-interface-guidelines/ios/app-architecture/requesting-permission/" title="Requesting Permissions">very clear on how to ask permissions</a>, it can still be the case that an app requests too many of them for non-obvious reasons.</p>
<p>Some permissions such as Camera, Photos, Calendar Data, Motion, Contacts or Speech Recognition should be pretty straightforward to verify as it should be obvious if the app requires them to fulfill its tasks. Let's consider the following examples ragarding the Photos permission, which, if granted, gives the app access to all user photos in the "Camera Roll" (the iOS default system-wide location for storing photos):</p>
<ul>
<li>The typical QR Code scanning app obviously requires the camera to function but might be requesting the photos permission as well. If storage is explicitly required, and depending on the sensitivity of the pictures being taken, these apps might better opt to use the app sandbox storage to avoid other apps (having the photos permission) to access them. See the chapter "<a href="../0x06d-Testing-Data-Storage/">Data Storage on iOS</a>" for more information reagarding storage of sensitive data.</li>
<li>Some apps require photo uploads (e.g. for profile pictures). Recent versions of iOS introduce new APIs such as <a href="https://developer.apple.com/documentation/uikit/uiimagepickercontroller" title="UIImagePickerController"><code>UIImagePickerController</code></a> (iOS 11+) and its modern <a href="https://developer.apple.com/videos/play/wwdc2020/10652/" title="replacement">replacement</a> <a href="https://developer.apple.com/documentation/photokit/phpickerviewcontroller" title="PHPickerViewController"><code>PHPickerViewController</code></a> (iOS 14+). These APIs run on a separate process from your app and by using them, the app gets read-only access exclusively to the images selected by the user instead of to the whole "Camera Roll". This is considered a best practice to avoid requesting unnecessary permissions.</li>
</ul>
<p>Other permissions like Bluetooth or Location require deeper verification steps. They may be required for the app to properly function but the data being handled by those tasks might not be properly protected. For more information and some examples please refer to the "<a href="#source-code-inspection" title="Source Code Inspection">Source Code Inspection</a>" in the "Static Analysis" section below and to the "Dynamic Analysis" section.</p>
<p>When collecting or simply handling (e.g. caching) sensitive data, an app should provide proper mechanisms to give the user control over it, e.g. to be able to revoke access or to delete it. However, sensitive data might not only be stored or cached but also sent over the network. In both cases, it has to be ensured that the app properly follows the appropriate best practices, which in this case involve implementing proper data protection and transport security. More information on how to protect this kind of data can be found in the chapter "Network APIs".</p>
<p>As you can see, using app capabilities and permissions mostly involve handling personal data, therefore being a matter of protecting the user's privacy. See the articles <a href="https://developer.apple.com/documentation/uikit/core_app/protecting_the_user_s_privacy" title="Protecting the User\'s Privacy">"Protecting the User's Privacy"</a> and <a href="https://developer.apple.com/documentation/uikit/core_app/protecting_the_user_s_privacy/accessing_protected_resources?language=objc" title="Accessing Protected Resources">"Accessing Protected Resources"</a> in Apple Developer Documentation for more details.</p>
<h4 id="device-capabilities">Device Capabilities<a class="headerlink" href="#device-capabilities" title="Permanent link">&para;</a></h4>
<p>Device capabilities are used by the App Store to ensure that only compatible devices are listed and therefore are allowed to download the app. They are specified in the <code>Info.plist</code> file of the app under the <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/iPhoneOSKeys.html#//apple_ref/doc/plist/info/UIRequiredDeviceCapabilities" title="UIRequiredDeviceCapabilities"><code>UIRequiredDeviceCapabilities</code></a> key.</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;key&gt;</span>UIRequiredDeviceCapabilities<span class="nt">&lt;/key&gt;</span>
<span class="nt">&lt;array&gt;</span>
    <span class="nt">&lt;string&gt;</span>armv7<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;/array&gt;</span>
</code></pre></div>
<blockquote>
<p>Typically you'll find the <code>armv7</code> capability, meaning that the app is compiled only for the armv7 instruction set, or if it’s a 32/64-bit universal app.</p>
</blockquote>
<p>For example, an app might be completely dependent on NFC to work (e.g. a <a href="https://itunes.apple.com/us/app/nfc-taginfo-by-nxp/id1246143596" title="NFC TagInfo by NXP">"NFC Tag Reader"</a> app). According to the <a href="https://developer.apple.com/library/archive/documentation/DeviceInformation/Reference/iOSDeviceCompatibility/DeviceCompatibilityMatrix/DeviceCompatibilityMatrix.html" title="iOS Device Compatibility Matrix">archived iOS Device Compatibility Reference</a>, NFC is only available starting on the iPhone 7 (and iOS 11). A developer might want to exclude all incompatible devices by setting the <code>nfc</code> device capability.</p>
<p>Regarding testing, you can consider <code>UIRequiredDeviceCapabilities</code> as a mere indication that the app is using some specific resources. Unlike the entitlements related to app capabilities, device capabilities do not confer any right or access to protected resources. Additional configuration steps might be required for that, which are very specific to each capability.</p>
<p>For example, if BLE is a core feature of the app, Apple's <a href="https://developer.apple.com/library/archive/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/CoreBluetoothOverview/CoreBluetoothOverview.html#//apple_ref/doc/uid/TP40013257-CH2-SW1" title="Core Bluetooth Overview">Core Bluetooth Programming Guide</a> explains the different things to be considered:</p>
<ul>
<li>The <code>bluetooth-le</code> device capability can be set in order to <em>restrict</em> non-BLE capable devices from downloading their app.</li>
<li>App capabilities like <code>bluetooth-peripheral</code> or <code>bluetooth-central</code> (both <code>UIBackgroundModes</code>) should be added if <a href="https://developer.apple.com/library/archive/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/CoreBluetoothBackgroundProcessingForIOSApps/PerformingTasksWhileYourAppIsInTheBackground.html" title="Core Bluetooth Background Processing for iOS Apps">BLE background processing</a> is required.</li>
</ul>
<p>However, this is not yet enough for the app to get access to the Bluetooth peripheral, the <code>NSBluetoothPeripheralUsageDescription</code> key has to be included in the <code>Info.plist</code> file, meaning that the user has to actively give permission. See "Purpose Strings in the Info.plist File" below for more information.</p>
<h4 id="entitlements">Entitlements<a class="headerlink" href="#entitlements" title="Permanent link">&para;</a></h4>
<p>According to <a href="https://www.apple.com/business/site/docs/iOS_Security_Guide.pdf" title="iOS Security Guide">Apple's iOS Security Guide</a>:</p>
<blockquote>
<p>Entitlements are key value pairs that are signed in to an app and allow authentication beyond runtime factors, like UNIX user ID. Since entitlements are digitally signed, they can’t be changed. Entitlements are used extensively by system apps and daemons to perform specific privileged operations that would otherwise require the process to run as root. This greatly reduces the potential for privilege escalation by a compromised system app or daemon.</p>
</blockquote>
<p>Many entitlements can be set using the "Summary" tab of the Xcode target editor. Other entitlements require editing a target’s entitlements property list file or are inherited from the iOS provisioning profile used to run the app.</p>
<p><a href="https://developer.apple.com/library/archive/technotes/tn2415/_index.html#//apple_ref/doc/uid/DTS40016427-CH1-SOURCES" title="Entitlement Sources">Entitlement Sources</a>:</p>
<ol>
<li>Entitlements embedded in a provisioning profile that is used to code sign the app, which are composed of:</li>
<li>Capabilities defined on the Xcode project's target Capabilities tab, and/or:</li>
<li>Enabled Services on the app's App ID which are configured on the Identifiers section of the Certificates, ID's and Profiles website.</li>
<li>Other entitlements that are injected by the profile generation service.</li>
<li>Entitlements from a code signing entitlements file.</li>
</ol>
<p><a href="https://developer.apple.com/library/archive/technotes/tn2415/_index.html#//apple_ref/doc/uid/DTS40016427-CH1-DESTINATIONS" title="Entitlement Destinations">Entitlement Destinations</a>:</p>
<ol>
<li>The app's signature.</li>
<li>The app's embedded provisioning profile.</li>
</ol>
<p>The <a href="https://developer.apple.com/library/archive/technotes/tn2415/_index.html#//apple_ref/doc/uid/DTS40016427-CH1-APPENTITLEMENTS" title="Inspect the entitlements of a built app">Apple Developer Documentation</a> also explains:</p>
<ul>
<li>During code signing, the entitlements corresponding to the app’s enabled Capabilities/Services are transferred to the app's signature from the provisioning profile Xcode chose to sign the app.</li>
<li>The provisioning profile is embedded into the app bundle during the build (<code>embedded.mobileprovision</code>).</li>
<li>Entitlements from the "Code Signing Entitlements" section in Xcode's "Build Settings" tab are transferred to the app's signature.</li>
</ul>
<p>For example, if you want to set the "Default Data Protection" capability, you would need to go to the <strong>Capabilities</strong> tab in Xcode and enable <strong>Data Protection</strong>. This is directly written by Xcode to the <code>&lt;appname&gt;.entitlements</code> file as the <code>com.apple.developer.default-data-protection</code> entitlement with default value <code>NSFileProtectionComplete</code>. In the IPA we might find this in the <code>embedded.mobileprovision</code> as:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;key&gt;</span>Entitlements<span class="nt">&lt;/key&gt;</span>
<span class="nt">&lt;dict&gt;</span>
    ...
    <span class="nt">&lt;key&gt;</span>com.apple.developer.default-data-protection<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;string&gt;</span>NSFileProtectionComplete<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;/dict&gt;</span>
</code></pre></div>
<p>For other capabilities such as HealthKit, the user has to be asked for permission, therefore it is not enough to add the entitlements, special keys and strings have to be added to the <code>Info.plist</code> file of the app.</p>
<p>The following sections go more into detail about the mentioned files and how to perform static and dynamic analysis using them.</p>
<h3 id="static-analysis">Static Analysis<a class="headerlink" href="#static-analysis" title="Permanent link">&para;</a></h3>
<p>Since iOS 10, these are the main areas which you need to inspect for permissions:</p>
<ul>
<li>Purpose Strings in the Info.plist File</li>
<li>Code Signing Entitlements File</li>
<li>Embedded Provisioning Profile File</li>
<li>Entitlements Embedded in the Compiled App Binary</li>
<li>Source Code Inspection</li>
</ul>
<h4 id="purpose-strings-in-the-infoplist-file">Purpose Strings in the Info.plist File<a class="headerlink" href="#purpose-strings-in-the-infoplist-file" title="Permanent link">&para;</a></h4>
<p><a href="https://developer.apple.com/documentation/uikit/core_app/protecting_the_user_s_privacy/accessing_protected_resources?language=objc#3037322" title="Provide a Purpose String"><em>Purpose strings</em></a> or <em>usage description strings</em> are custom texts that are offered to users in the system's permission request alert when requesting permission to access protected data or resources.</p>
<p><img src="../../assets/Images/Chapters/0x06h/permission_request_alert.png" width="400px" /></p>
<p>If linking on or after iOS 10, developers are required to include purpose strings in their app's <a href="https://developer.apple.com/library/archive/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/ExpectedAppBehaviors/ExpectedAppBehaviors.html#//apple_ref/doc/uid/TP40007072-CH3-SW5" title="The Information Property List File"><code>Info.plist</code></a> file. Otherwise, if the app attempts to access protected data or resources without having provided the corresponding purpose string, <a href="https://developer.apple.com/documentation/uikit/core_app/protecting_the_user_s_privacy/accessing_protected_resources?language=objc" title="Accessing Protected Resources">the access will fail and the app might even crash</a>.</p>
<p>If having the original source code, you can verify the permissions included in the <code>Info.plist</code> file:</p>
<ul>
<li>Open the project with Xcode.</li>
<li>Find and open the <code>Info.plist</code> file in the default editor and search for the keys starting with <code>"Privacy -"</code>.</li>
</ul>
<p>You may switch the view to display the raw values by right-clicking and selecting "Show Raw Keys/Values" (this way for example <code>"Privacy - Location When In Use Usage Description"</code> will turn into <code>NSLocationWhenInUseUsageDescription</code>).</p>
<p><img src="../../assets/Images/Chapters/0x06h/purpose_strings_xcode.png" width="100%" /></p>
<p>If only having the IPA:</p>
<ul>
<li>Unzip the IPA.</li>
<li>The <code>Info.plist</code> is located in <code>Payload/&lt;appname&gt;.app/Info.plist</code>.</li>
<li>Convert it if needed (e.g. <code>plutil -convert xml1 Info.plist</code>) as explained in the chapter "iOS Basic Security Testing", section "The Info.plist File".</li>
<li>
<p>Inspect all <em>purpose strings Info.plist keys</em>, usually ending with <code>UsageDescription</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;dict&gt;</span>
    <span class="nt">&lt;key&gt;</span>NSLocationWhenInUseUsageDescription<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;string&gt;</span>Your location is used to provide turn-by-turn directions to your destination.<span class="nt">&lt;/string&gt;</span>
</code></pre></div>
</li>
</ul>
<p>For an overview of the different <em>purpose strings Info.plist keys</em> available see Table 1-2 at the <a href="https://developer.apple.com/library/archive/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/ExpectedAppBehaviors/ExpectedAppBehaviors.html#//apple_ref/doc/uid/TP40007072-CH3-SW7" title="Data and resources protected by system authorization settings">Apple App Programming Guide for iOS</a>. Click on the provided links to see the full description of each key in the <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html" title="Cocoa Keys">CocoaKeys reference</a>.</p>
<p>Following these guidelines should make it relatively simple to evaluate each and every entry in the <code>Info.plist</code> file to check if the permission makes sense.</p>
<p>For example, imagine the following lines were extracted from a <code>Info.plist</code> file used by a Solitaire game:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;key&gt;</span>NSHealthClinicalHealthRecordsShareUsageDescription<span class="nt">&lt;/key&gt;</span>
<span class="nt">&lt;string&gt;</span>Share your health data with us!<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;key&gt;</span>NSCameraUsageDescription<span class="nt">&lt;/key&gt;</span>
<span class="nt">&lt;string&gt;</span>We want to access your camera<span class="nt">&lt;/string&gt;</span>
</code></pre></div>
<p>It should be suspicious that a regular solitaire game requests this kind of resource access as it probably does not have any need for <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html#//apple_ref/doc/uid/TP40009251-SW24" title="NSCameraUsageDescription">accessing the camera</a> nor a <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html#//apple_ref/doc/uid/TP40009251-SW76" title="NSHealthClinicalHealthRecordsShareUsageDescription">user's health-records</a>.</p>
<p>Apart from simply checking if the permissions make sense, further analysis steps might be derived from analyzing purpose strings e.g. if they are related to storage sensitive data. For example, <code>NSPhotoLibraryUsageDescription</code> can be considered as a storage permission giving access to files that are outside of the app's sandbox and might also be accessible by other apps. In this case, it should be tested that no sensitive data is being stored there (photos in this case). For other purpose strings like <code>NSLocationAlwaysUsageDescription</code>, it must be also considered if the app is storing this data securely. Refer to the "Testing Data Storage" chapter for more information and best practices on securely storing sensitive data.</p>
<h4 id="code-signing-entitlements-file">Code Signing Entitlements File<a class="headerlink" href="#code-signing-entitlements-file" title="Permanent link">&para;</a></h4>
<p>Certain capabilities require a <a href="https://developer.apple.com/library/archive/technotes/tn2415/_index.html#//apple_ref/doc/uid/DTS40016427-CH1-ENTITLEMENTSFILE" title="Code Signing Entitlements files">code signing entitlements file</a> (<code>&lt;appname&gt;.entitlements</code>). It is automatically generated by Xcode but may be manually edited and/or extended by the developer as well.</p>
<p>Here is an example of entitlements file of the <a href="https://github.com/peter-iakovlev/Telegram-iOS/blob/77ee5c4dabdd6eb5f1e2ff76219edf7e18b45c00/Telegram-iOS/Telegram-iOS-AppStoreLLC.entitlements#L23" title="Telegram-iOS-AppStoreLLC.entitlements Line 23">open source app Telegram</a> including the <a href="https://developer.apple.com/documentation/foundation/com_apple_security_application-groups" title="App Groups entitlement">App Groups entitlement</a> (<code>application-groups</code>):</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span>
<span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;dict&gt;</span>
...
    <span class="nt">&lt;key&gt;</span>com.apple.security.application-groups<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;array&gt;</span>
        <span class="nt">&lt;string&gt;</span>group.ph.telegra.Telegraph<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;/array&gt;</span>
<span class="nt">&lt;/dict&gt;</span>
...
<span class="nt">&lt;/plist&gt;</span>
</code></pre></div>
<p>The entitlement outlined above does not require any additional permissions from the user. However, it is always a good practice to check all entitlements, as the app might overask the user in terms of permissions and thereby leak information.</p>
<p>As documented at <a href="https://developer.apple.com/library/archive/documentation/Miscellaneous/Reference/EntitlementKeyReference/Chapters/EnablingAppSandbox.html#//apple_ref/doc/uid/TP40011195-CH4-SW19" title="Adding an App to an App Group">Apple Developer Documentation</a>, the App Groups entitlement is required to share information between different apps through IPC or a shared file container, which means that data can be shared on the device directly between the apps.
This entitlement is also required if an app extension requires to <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html" title="Sharing Data with Your Containing App">share information with its containing app</a>.</p>
<p>Depending on the data to-be-shared it might be more appropriate to share it using another method such as through a backend where this data could be potentially verified, avoiding tampering by e.g. the user himself.</p>
<h4 id="embedded-provisioning-profile-file">Embedded Provisioning Profile File<a class="headerlink" href="#embedded-provisioning-profile-file" title="Permanent link">&para;</a></h4>
<p>When you do not have the original source code, you should analyze the IPA and search inside for the <em>embedded provisioning profile</em> that is usually located in the root app bundle folder (<code>Payload/&lt;appname&gt;.app/</code>) under the name <code>embedded.mobileprovision</code>.</p>
<p>This file is not a <code>.plist</code>, it is encoded using <a href="https://en.wikipedia.org/wiki/Cryptographic_Message_Syntax" title="Cryptographic Message Syntax">Cryptographic Message Syntax</a>. On macOS you can <a href="https://developer.apple.com/library/archive/technotes/tn2415/_index.html#//apple_ref/doc/uid/DTS40016427-CH1-PROFILESENTITLEMENTS" title="Inspecting a profile\'s entitlements">inspect an embedded provisioning profile's entitlements</a> using the following command:</p>
<div class="highlight"><pre><span></span><code>$ security cms -D -i embedded.mobileprovision
</code></pre></div>
<p>and then search for the Entitlements key region (<code>&lt;key&gt;Entitlements&lt;/key&gt;</code>).</p>
<h4 id="entitlements-embedded-in-the-compiled-app-binary">Entitlements Embedded in the Compiled App Binary<a class="headerlink" href="#entitlements-embedded-in-the-compiled-app-binary" title="Permanent link">&para;</a></h4>
<p>If you only have the app's IPA or simply the installed app on a jailbroken device, you normally won't be able to find <code>.entitlements</code> files. This could be also the case for the <code>embedded.mobileprovision</code> file. Still, you should be able to extract the entitlements property lists from the app binary yourself (which you've previously obtained as explained in the "iOS Basic Security Testing" chapter, section <a href="../0x06b-Basic-Security-Testing/#acquiring-the-app-binary">"Acquiring the App Binary"</a>).</p>
<p>The following steps should work even when targeting an encrypted binary. If for some reason they don't, you'll have to decrypt and extract the app with e.g. Clutch (if compatible with your iOS version), frida-ios-dump or similar.</p>
<h5 id="extracting-the-entitlements-plist-from-the-app-binary">Extracting the Entitlements Plist from the App Binary<a class="headerlink" href="#extracting-the-entitlements-plist-from-the-app-binary" title="Permanent link">&para;</a></h5>
<p>If you have the app binary in your computer, one approach is to use binwalk to extract (<code>-e</code>) all XML files (<code>-y=xml</code>):</p>
<div class="highlight"><pre><span></span><code>$ binwalk -e -y<span class="o">=</span>xml ./Telegram<span class="se">\ </span>X

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
<span class="m">1430180</span>       0x15D2A4        XML document, version: <span class="s2">&quot;1.0&quot;</span>
<span class="m">1458814</span>       0x16427E        XML document, version: <span class="s2">&quot;1.0&quot;</span>
</code></pre></div>
<p>Or you can use radare2 (<code>-qc</code> to <em>quietly</em> run one command and exit) to search all strings on the app binary (<code>izz</code>) containing "PropertyList" (<code>~PropertyList</code>):</p>
<div class="highlight"><pre><span></span><code>$ r2 -qc <span class="s1">&#39;izz~PropertyList&#39;</span> ./Telegram<span class="se">\ </span>X

0x0015d2a4 ascii &lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span> <span class="nv">standalone</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>?&gt;<span class="se">\n</span>&lt;!DOCTYPE plist PUBLIC
<span class="s2">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="s2">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;<span class="se">\n</span>&lt;plist <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span>&gt;
...&lt;key&gt;com.apple.security.application-groups&lt;/key&gt;<span class="se">\n\t\t</span>&lt;array&gt;
<span class="se">\n\t\t\t</span>&lt;string&gt;group.ph.telegra.Telegraph&lt;/string&gt;...

0x0016427d ascii H&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span>?&gt;<span class="se">\n</span>&lt;!DOCTYPE plist PUBLIC
<span class="s2">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="s2">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;<span class="se">\n</span>&lt;plist <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span>&gt;<span class="se">\n</span>
&lt;dict&gt;<span class="se">\n\t</span>&lt;key&gt;cdhashes&lt;/key&gt;...
</code></pre></div>
<p>In both cases (binwalk or radare2) we were able to extract the same two <code>plist</code> files. If we inspect the first one (0x0015d2a4) we see that we were able to completely recover the <a href="https://github.com/peter-iakovlev/Telegram-iOS/blob/77ee5c4dabdd6eb5f1e2ff76219edf7e18b45c00/Telegram-iOS/Telegram-iOS-AppStoreLLC.entitlements" title="Telegram-iOS-AppStoreLLC.entitlements original file">original entitlements file from Telegram</a>.</p>
<blockquote>
<p>Note: the <code>strings</code> command will not help here as it will not be able to find this information. Better use grep with the <code>-a</code> flag directly on the binary or use radare2 (<code>izz</code>)/rabin2 (<code>-zz</code>).</p>
</blockquote>
<p>If you access the app binary on the jailbroken device (e.g via SSH), you can use grep with the <code>-a, --text</code> flag (treats all files as ASCII text):</p>
<div class="highlight"><pre><span></span><code>$ grep -a -A <span class="m">5</span> <span class="s1">&#39;PropertyList&#39;</span> /var/containers/Bundle/Application/
    15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35/Telegram X.app/Telegram<span class="se">\ </span>X

&lt;!DOCTYPE plist PUBLIC <span class="s2">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="s2">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;
&lt;plist <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span>&gt;
    &lt;dict&gt;
        &lt;key&gt;com.apple.security.application-groups&lt;/key&gt;
        &lt;array&gt;
        ...
</code></pre></div>
<p>Play with the <code>-A num, --after-context=num</code> flag to display more or less lines. You may use tools like the ones we presented above as well, if you have them also installed on your jailbroken iOS device.</p>
<blockquote>
<p>This method should work even if the app binary is still encrypted (it was tested against several App Store apps).</p>
</blockquote>
<h4 id="source-code-inspection">Source Code Inspection<a class="headerlink" href="#source-code-inspection" title="Permanent link">&para;</a></h4>
<p>After having checked the <code>&lt;appname&gt;.entitlements</code> file and the <code>Info.plist</code> file, it is time to verify how the requested permissions and assigned capabilities are put to use. For this, a source code review should be enough. However, if you don't have the original source code, verifying the use of permissions might be specially challenging as you might need to reverse engineer the app, refer to the "Dynamic Analysis" for more details on how to proceed.</p>
<p>When doing a source code review, pay attention to:</p>
<ul>
<li>whether the <em>purpose strings</em> in the <code>Info.plist</code> file match the programmatic implementations.</li>
<li>whether the registered capabilities are used in such a way that no confidential information is leaking.</li>
</ul>
<p>Users can grant or revoke authorization at any time via "Settings", therefore apps normally check the authorization status of a feature before accessing it. This can be done by using dedicated APIs available for many system frameworks that provide access to protected resources.</p>
<p>You can use the <a href="https://developer.apple.com/documentation/uikit/core_app/protecting_the_user_s_privacy/accessing_protected_resources?language=objc#3037319" title="Check for Authorization">Apple Developer Documentation</a> as a starting point. For example:</p>
<ul>
<li>Bluetooth: the <a href="https://developer.apple.com/documentation/corebluetooth/cbmanager/1648600-state?language=objc" title="CBManager state"><code>state</code></a> property of the <a href="https://developer.apple.com/documentation/corebluetooth/cbcentralmanager?language=objc" title="CBCentralManager"><code>CBCentralManager</code></a> class is used to check system-authorization status for using Bluetooth peripherals.</li>
<li>
<p>Location: search for methods of <code>CLLocationManager</code>, e.g. <a href="https://developer.apple.com/documentation/corelocation/cllocationmanager/1423648-locationservicesenabled?language=objc" title="CLLocationManager locationServicesEnabled"><code>locationServicesEnabled</code></a>.</p>
<div class="highlight"><pre><span></span><code>func checkForLocationServices() {
    if CLLocationManager.locationServicesEnabled() {
        // Location services are available, so query the user’s location.
    } else {
        // Update your app’s UI to show that the location is unavailable.
    }
}
</code></pre></div>
<p>See Table1 in <a href="https://developer.apple.com/documentation/corelocation/adding_location_services_to_your_app" title="Getting the availability of Core Location services">"Determining the Availability of Location Services"</a> (Apple Developer Documentation) for a complete list.</p>
</li>
</ul>
<p>Go through the application searching for usages of these APIs and check what happens to sensitive data that might be obtained from them. For example, it might be stored or transmitted over the network, if this is the case, proper data protection and transport security should be additionally verified.</p>
<h3 id="dynamic-analysis">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis" title="Permanent link">&para;</a></h3>
<p>With help of the static analysis you should already have a list of the included permissions and app capabilities in use. However, as mentioned in "Source Code Inspection", spotting the sensitive data and APIs related to those permissions and app capabilities might be a challenging task when you don't have the original source code. Dynamic analysis can help here getting inputs to iterate onto the static analysis.</p>
<p>Following an approach like the one presented below should help you spotting the mentioned sensitive data and APIs:</p>
<ol>
<li>Consider the list of permissions / capabilities identified in the static analysis (e.g. <code>NSLocationWhenInUseUsageDescription</code>).</li>
<li>Map them to the dedicated APIs available for the corresponding system frameworks (e.g. <code>Core Location</code>). You may use the <a href="https://developer.apple.com/documentation/uikit/core_app/protecting_the_user_s_privacy/accessing_protected_resources?language=objc#3037319" title="Check for Authorization">Apple Developer Documentation</a> for this.</li>
<li>Trace classes or specific methods of those APIs (e.g. <code>CLLocationManager</code>), for example, using <a href="https://www.frida.re/docs/frida-trace/" title="frida-trace"><code>frida-trace</code></a>.</li>
<li>Identify which methods are being really used by the app while accessing the related feature (e.g. "Share your location").</li>
<li>Get a backtrace for those methods and try to build a call graph.</li>
</ol>
<p>Once all methods were identified, you might use this knowledge to reverse engineer the app and try to find out how the data is being handled. While doing that you might spot new methods involved in the process which you can again feed to step 3. above and keep iterating between static and dynamic analysis.</p>
<p>In the following example we use Telegram to open the share dialog from a chat and frida-trace to identify which methods are being called.</p>
<p>First we launch Telegram and start a trace for all methods matching the string "authorizationStatus" (this is a general approach because more classes apart from <code>CLLocationManager</code> implement this method):</p>
<div class="highlight"><pre><span></span><code>$ frida-trace -U <span class="s2">&quot;Telegram&quot;</span> -m <span class="s2">&quot;*[* *authorizationStatus*]&quot;</span>
</code></pre></div>
<blockquote>
<p><code>-U</code> connects to the USB device. <code>-m</code> includes an Objective-C method to the traces. You can use a <a href="https://en.wikipedia.org/wiki/Glob_%28programming%29" title="Glob (programming)">glob pattern</a> (e.g. with the "*" wildcard, <code>-m "*[* *authorizationStatus*]"</code> means "include any Objective-C method of any class containing 'authorizationStatus'"). Type <code>frida-trace -h</code> for more information.</p>
</blockquote>
<p>Now we open the share dialog:</p>
<p><img src="../../assets/Images/Chapters/0x06h/telegram_share_something.png" width="400px" /></p>
<p>The following methods are displayed:</p>
<div class="highlight"><pre><span></span><code>  <span class="m">1942</span> ms  +<span class="o">[</span>PHPhotoLibrary authorizationStatus<span class="o">]</span>
  <span class="m">1959</span> ms  +<span class="o">[</span>TGMediaAssetsLibrary authorizationStatusSignal<span class="o">]</span>
  <span class="m">1959</span> ms     <span class="p">|</span> +<span class="o">[</span>TGMediaAssetsModernLibrary authorizationStatusSignal<span class="o">]</span>
</code></pre></div>
<p>If we click on <strong>Location</strong>, another method will be traced:</p>
<div class="highlight"><pre><span></span><code> <span class="m">11186</span> ms  +<span class="o">[</span>CLLocationManager authorizationStatus<span class="o">]</span>
 <span class="m">11186</span> ms     <span class="p">|</span> +<span class="o">[</span>CLLocationManager _authorizationStatus<span class="o">]</span>
 <span class="m">11186</span> ms     <span class="p">|</span>    <span class="p">|</span> +<span class="o">[</span>CLLocationManager _authorizationStatusForBundleIdentifier:0x0 bundle:0x0<span class="o">]</span>
</code></pre></div>
<p>Use the auto-generated stubs of frida-trace to get more information like the return values and a backtrace. Do the following modifications to the JavaScript file below (the path is relative to the current directory):</p>
<div class="highlight"><pre><span></span><code><span class="c1">// __handlers__/__CLLocationManager_authorizationStatus_.js</span><span class="w"></span>

<span class="w">  </span><span class="nx">onEnter</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">log</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;+[CLLocationManager authorizationStatus]&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Called from:\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">        </span><span class="nx">Thread</span><span class="p">.</span><span class="nx">backtrace</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span><span class="w"> </span><span class="nx">Backtracer</span><span class="p">.</span><span class="nx">ACCURATE</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">DebugSymbol</span><span class="p">.</span><span class="nx">fromAddress</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n\t&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;\n&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nx">onLeave</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">log</span><span class="p">,</span><span class="w"> </span><span class="nx">retval</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;RET :&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">retval</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Clicking again on "Location" reveals more information:</p>
<div class="highlight"><pre><span></span><code>  <span class="m">3630</span> ms  -<span class="o">[</span>CLLocationManager init<span class="o">]</span>
  <span class="m">3630</span> ms     <span class="p">|</span> -<span class="o">[</span>CLLocationManager initWithEffectiveBundleIdentifier:0x0 bundle:0x0<span class="o">]</span>
  <span class="m">3634</span> ms  -<span class="o">[</span>CLLocationManager setDelegate:0x14c9ab000<span class="o">]</span>
  <span class="m">3641</span> ms  +<span class="o">[</span>CLLocationManager authorizationStatus<span class="o">]</span>
RET: 0x4
  <span class="m">3641</span> ms  Called from:
0x1031aa158 TelegramUI!+<span class="o">[</span>TGLocationUtils requestWhenInUserLocationAuthorizationWithLocationManager:<span class="o">]</span>
    0x10337e2c0 TelegramUI!-<span class="o">[</span>TGLocationPickerController initWithContext:intent:<span class="o">]</span>
    0x101ee93ac TelegramUI!0x1013ac
</code></pre></div>
<p>We see that <code>+[CLLocationManager authorizationStatus]</code> returned <code>0x4</code> (<a href="https://developer.apple.com/documentation/corelocation/clauthorizationstatus/authorizedwheninuse" title="CLAuthorizationStatus.authorizedWhenInUse">CLAuthorizationStatus.authorizedWhenInUse</a>) and was called by <code>+[TGLocationUtils requestWhenInUserLocationAuthorizationWithLocationManager:]</code>. As we anticipated before, you might use this kind of information as an entry point when reverse engineering the app and from there get inputs (e.g. names of classes or methods) to keep feeding the dynamic analysis.</p>
<p>Next, there is a <em>visual</em> way to inspect the status of some app permissions when using the iPhone/iPad by opening "Settings" and scrolling down until you find the app you're interested in. When clicking on it, this will open the "ALLOW APP_NAME TO ACCESS" screen. However, not all permissions might be displayed yet. You will have to <em>trigger</em> them in order to be listed on that screen.</p>
<p><img src="../../assets/Images/Chapters/0x06h/settings_allow_screen.png" width="100%" /></p>
<p>For example, in the previous example, the "Location" entry was not being listed until we triggered the permission dialogue for the first time. Once we did it, no matter if we allowed the access or not, the the "Location" entry will be displayed.</p>
<h2 id="testing-for-sensitive-functionality-exposure-through-ipc-mstg-platform-4">Testing for Sensitive Functionality Exposure Through IPC (MSTG-PLATFORM-4)<a class="headerlink" href="#testing-for-sensitive-functionality-exposure-through-ipc-mstg-platform-4" title="Permanent link">&para;</a></h2>
<p>During implementation of a mobile application, developers may apply traditional techniques for IPC (such as using shared files or network sockets). The IPC system functionality offered by mobile application platforms should be used because it is much more mature than traditional techniques. Using IPC mechanisms with no security in mind may cause the application to leak or expose sensitive data.</p>
<p>In contrast to Android's rich Inter-Process Communication (IPC) capability, iOS offers some rather limited options for communication between apps. In fact, there's no way for apps to communicate directly. In this section we will present the different types of indirect communication offered by iOS and how to test them. Here's an overview:</p>
<ul>
<li>Custom URL Schemes</li>
<li>Universal Links</li>
<li>UIActivity Sharing</li>
<li>App Extensions</li>
<li>UIPasteboard</li>
</ul>
<h3 id="custom-url-schemes">Custom URL Schemes<a class="headerlink" href="#custom-url-schemes" title="Permanent link">&para;</a></h3>
<p>Please refer to the section "<a href="#testing-custom-url-schemes-mstg-platform-3" title="Testing Custom URL Schemes">Testing Custom URL Schemes</a>" for more information on what custom URL schemes are and how to test them.</p>
<h3 id="universal-links">Universal Links<a class="headerlink" href="#universal-links" title="Permanent link">&para;</a></h3>
<h4 id="overview_1">Overview<a class="headerlink" href="#overview_1" title="Permanent link">&para;</a></h4>
<p>Universal links are the iOS equivalent to Android App Links (aka. Digital Asset Links) and are used for deep linking. When tapping a universal link (to the app's website), the user will seamlessly be redirected to the corresponding installed app without going through Safari. If the app isn’t installed, the link will open in Safari.</p>
<p>Universal links are standard web links (HTTP/HTTPS) and are not to be confused with custom URL schemes, which originally were also used for deep linking.</p>
<p>For example, the Telegram app supports both custom URL schemes and universal links:</p>
<ul>
<li><code>tg://resolve?domain=fridadotre</code> is a custom URL scheme and uses the <code>tg://</code> scheme.</li>
<li><code>https://telegram.me/fridadotre</code> is a universal link and uses the <code>https://</code> scheme.</li>
</ul>
<p>Both result in the same action, the user will be redirected to the specified chat in Telegram ("fridadotre" in this case). However, universal links give several key benefits that are not applicable when using custom URL schemes and are the recommended way to implement deep linking, according to the <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/AppSearch/UniversalLinks.html" title="Universal Links">Apple Developer Documentation</a>. Specifically, universal links are:</p>
<ul>
<li><strong>Unique</strong>: Unlike custom URL schemes, universal links can’t be claimed by other apps, because they use standard HTTP or HTTPS links to the app's website. They were introduced as a way to <em>prevent</em> URL scheme hijacking attacks (an app installed after the original app may declare the same scheme and the system might target all new requests to the last installed app).</li>
<li><strong>Secure</strong>: When users install the app, iOS downloads and checks a file (the Apple App Site Association or AASA) that was uploaded to the web server to make sure that the website allows the app to open URLs on its behalf. Only the legitimate owners of the URL can upload this file, so the association of their website with the app is secure.</li>
<li><strong>Flexible</strong>: Universal links work even when the app is not installed. Tapping a link to the website would open the content in Safari, as users expect.</li>
<li><strong>Simple</strong>: One URL works for both the website and the app.</li>
<li><strong>Private</strong>: Other apps can communicate with the app without needing to know whether it is installed.</li>
</ul>
<h4 id="static-analysis_1">Static Analysis<a class="headerlink" href="#static-analysis_1" title="Permanent link">&para;</a></h4>
<p>Testing universal links on a static approach includes doing the following:</p>
<ul>
<li>Checking the Associated Domains entitlement</li>
<li>Retrieving the Apple App Site Association file</li>
<li>Checking the link receiver method</li>
<li>Checking the data handler method</li>
<li>Checking if the app is calling other app's universal links</li>
</ul>
<h5 id="checking-the-associated-domains-entitlement">Checking the Associated Domains Entitlement<a class="headerlink" href="#checking-the-associated-domains-entitlement" title="Permanent link">&para;</a></h5>
<p>Universal links require the developer to add the Associated Domains entitlement and include in it a list of the domains that the app supports.</p>
<p>In Xcode, go to the <strong>Capabilities</strong> tab and search for <strong>Associated Domains</strong>. You can also inspect the <code>.entitlements</code> file looking for <code>com.apple.developer.associated-domains</code>. Each of the domains must be prefixed with <code>applinks:</code>, such as <code>applinks:www.mywebsite.com</code>.</p>
<p>Here's an example from Telegram's <code>.entitlements</code> file:</p>
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;key&gt;</span>com.apple.developer.associated-domains<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;array&gt;</span>
        <span class="nt">&lt;string&gt;</span>applinks:telegram.me<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;string&gt;</span>applinks:t.me<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;/array&gt;</span>
</code></pre></div>
<p>More detailed information can be found in the <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/AppSearch/UniversalLinks.html#//apple_ref/doc/uid/TP40016308-CH12-SW2" title="Preparing Your App to Handle Universal Links">archived Apple Developer Documentation</a>.</p>
<p>If you don't have the original source code you can still search for them, as explained in "Entitlements Embedded in the Compiled App Binary".</p>
<h5 id="retrieving-the-apple-app-site-association-file">Retrieving the Apple App Site Association File<a class="headerlink" href="#retrieving-the-apple-app-site-association-file" title="Permanent link">&para;</a></h5>
<p>Try to retrieve the <code>apple-app-site-association</code> file from the server using the associated domains you got from the previous step. This file needs to be accessible via HTTPS, without any redirects, at <code>https://&lt;domain&gt;/apple-app-site-association</code> or <code>https://&lt;domain&gt;/.well-known/apple-app-site-association</code>.</p>
<p>You can retrieve it yourself with your browser or use the <a href="https://branch.io/resources/aasa-validator/" title="AASA">Apple App Site Association (AASA) Validator</a>. After entering the domain, it will display the file, verify it for you and show the results (e.g. if it is not being properly served over HTTPS). See the following example from <a href="https://www.apple.com/.well-known/apple-app-site-association" title="Apple\'s apple-app-site-association file">apple.com</a>:</p>
<p><img src="../../assets/Images/Chapters/0x06h/apple-app-site-association-file_validation.png" width="100%" /></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;activitycontinuation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;apps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;W74U47NE8E.com.apple.store.Jolly&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;applinks&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;apps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;appID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;W74U47NE8E.com.apple.store.Jolly&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;paths&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;NOT /shop/buy-iphone/*&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;NOT /us/shop/buy-iphone/*&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;/xc/*&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;/shop/buy-*&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;/shop/product/*&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;/shop/bag/shared_bag/*&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;/shop/order/list&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;/today&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;/shop/watch/watch-accessories&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;/shop/watch/watch-accessories/*&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;/shop/watch/bands&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The "details" key inside "applinks" contains a JSON representation of an array that might contain one or more apps. The "appID" should match the "application-identifier" key from the app’s entitlements. Next, using the "paths" key, the developers can specify certain paths to be handled on a per app basis. Some apps, like Telegram use a standalone * (<code>"paths": ["*"]</code>) in order to allow all possible paths. Only if specific areas of the website should <strong>not</strong> be handled by some app, the developer can restrict access by excluding them by prepending a <code>"NOT "</code> (note the whitespace after the T) to the corresponding path. Also remember that the system will look for matches by following the order of the dictionaries in the array (first match wins).</p>
<p>This path exclusion mechanism is not to be seen as a security feature but rather as a filter that developer might use to specify which apps open which links. By default, iOS does not open any unverified links.</p>
<p>Remember that universal links verification occurs at installation time. iOS retrieves the AASA file for the declared domains (<code>applinks</code>) in its <code>com.apple.developer.associated-domains</code> entitlement. iOS will refuse to open those links if the verification did not succeed. Some reasons to fail verification might include:</p>
<ul>
<li>The AASA file is not served over HTTPS.</li>
<li>The AASA is not available.</li>
<li>The <code>appID</code>s do not match (this would be the case of a <em>malicious</em> app). iOS would successfully prevent any possible hijacking attacks.</li>
</ul>
<h5 id="checking-the-link-receiver-method">Checking the Link Receiver Method<a class="headerlink" href="#checking-the-link-receiver-method" title="Permanent link">&para;</a></h5>
<p>In order to receive links and handle them appropriately, the app delegate has to implement <a href="https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623072-application" title="UIApplicationDelegate application:continueUserActivity:restorationHandler:"><code>application:continueUserActivity:restorationHandler:</code></a>. If you have the original project try searching for this method.</p>
<p>Please note that if the app uses <a href="https://developer.apple.com/documentation/uikit/uiapplication/1648685-openurl?language=objc" title="UIApplication openURL:options:completionHandler:"><code>openURL:options:completionHandler:</code></a> to open a universal link to the app's website, the link won't open in the app. As the call originates from the app, it won't be handled as a universal link.</p>
<blockquote>
<p>From Apple Docs: When iOS launches your app after a user taps a universal link, you receive an <code>NSUserActivity</code> object with an <code>activityType</code> value of <code>NSUserActivityTypeBrowsingWeb</code>. The activity object’s <code>webpageURL</code> property contains the URL that the user is accessing. The webpage URL property always contains an HTTP or HTTPS URL, and you can use <code>NSURLComponents</code> APIs to manipulate the components of the URL. [...] To protect users’ privacy and security, you should not use HTTP when you need to transport data; instead, use a secure transport protocol such as HTTPS.</p>
</blockquote>
<p>From the note above we can highlight that:</p>
<ul>
<li>The mentioned <code>NSUserActivity</code> object comes from the <code>continueUserActivity</code> parameter, as seen in the method above.</li>
<li>The scheme of the <code>webpageURL</code> must be HTTP or HTTPS (any other scheme should throw an exception). The <a href="https://developer.apple.com/documentation/foundation/urlcomponents/1779624-scheme" title="URLComponents scheme"><code>scheme</code> instance property</a> of <code>URLComponents</code> / <code>NSURLComponents</code> can be used to verify this.</li>
</ul>
<p>If you don't have the original source code you can use radare2 or rabin2 to search the binary strings for the link receiver method:</p>
<div class="highlight"><pre><span></span><code>$ rabin2 -zq Telegram<span class="se">\ </span>X.app/Telegram<span class="se">\ </span>X <span class="p">|</span> grep restorationHan

0x1000deea9 <span class="m">53</span> <span class="m">52</span> application:continueUserActivity:restorationHandler:
</code></pre></div>
<h5 id="checking-the-data-handler-method">Checking the Data Handler Method<a class="headerlink" href="#checking-the-data-handler-method" title="Permanent link">&para;</a></h5>
<p>You should check how the received data is validated. Apple <a href="https://developer.apple.com/documentation/uikit/core_app/allowing_apps_and_websites_to_link_to_your_content/handling_universal_links" title="Handling Universal Links">explicitly warns about this</a>:</p>
<blockquote>
<p>Universal links offer a potential attack vector into your app, so make sure to validate all URL parameters and discard any malformed URLs. In addition, limit the available actions to those that do not risk the user’s data. For example, do not allow universal links to directly delete content or access sensitive information about the user. When testing your URL-handling code, make sure your test cases include improperly formatted URLs.</p>
</blockquote>
<p>As stated in the <a href="https://developer.apple.com/documentation/uikit/core_app/allowing_apps_and_websites_to_link_to_your_content/handling_universal_links" title="Handling Universal Links">Apple Developer Documentation</a>, when iOS opens an app as the result of a universal link, the app receives an <code>NSUserActivity</code> object with an <code>activityType</code> value of <code>NSUserActivityTypeBrowsingWeb</code>. The activity object’s <code>webpageURL</code> property contains the HTTP or HTTPS URL that the user accesses. The following example in Swift verifies exactly this before opening the URL:</p>
<div class="highlight"><pre><span></span><code>func application(_ application: UIApplication, continue userActivity: NSUserActivity,
                 restorationHandler: @escaping ([UIUserActivityRestoring]?) -&gt; Void) -&gt; Bool {
    // ...
    if userActivity.activityType == NSUserActivityTypeBrowsingWeb, let url = userActivity.webpageURL {
        application.open(url, options: [:], completionHandler: nil)
    }

    return true
}
</code></pre></div>
<p>In addition, remember that if the URL includes parameters, they should not be trusted before being carefully sanitized and validated (even when coming from trusted domain). For example, they might have been spoofed by an attacker or might include malformed data. If that is the case, the whole URL and therefore the universal link request must be discarded.</p>
<p>The <code>NSURLComponents</code> API can be used to parse and manipulate the components of the URL. This can be also part of the method <code>application:continueUserActivity:restorationHandler:</code> itself or might occur on a separate method being called from it. The following <a href="https://developer.apple.com/documentation/uikit/core_app/allowing_apps_and_websites_to_link_to_your_content/handling_universal_links#3001935" title="An example of handling a universal link">example</a> demonstrates this:</p>
<div class="highlight"><pre><span></span><code>func application(_ application: UIApplication,
                 continue userActivity: NSUserActivity,
                 restorationHandler: @escaping ([Any]?) -&gt; Void) -&gt; Bool {
    guard userActivity.activityType == NSUserActivityTypeBrowsingWeb,
        let incomingURL = userActivity.webpageURL,
        let components = NSURLComponents(url: incomingURL, resolvingAgainstBaseURL: true),
        let path = components.path,
        let params = components.queryItems else {
        return false
    }

    if let albumName = params.first(where: { $0.name == &quot;albumname&quot; })?.value,
        let photoIndex = params.first(where: { $0.name == &quot;index&quot; })?.value {
        // Interact with album name and photo index

        return true

    } else {
        // Handle when album and/or album name or photo index missing

        return false
    }
}
</code></pre></div>
<p>Finally, as stated above, be sure to verify that the actions triggered by the URL do not expose sensitive information or risk the user’s data on any way.</p>
<h5 id="checking-if-the-app-is-calling-other-apps-universal-links">Checking if the App is Calling Other App's Universal Links<a class="headerlink" href="#checking-if-the-app-is-calling-other-apps-universal-links" title="Permanent link">&para;</a></h5>
<p>An app might be calling other apps via universal links in order to simply trigger some actions or to transfer information, in that case, it should be verified that it is not leaking sensitive information.</p>
<p>If you have the original source code, you can search it for the <code>openURL:options: completionHandler:</code> method and check the data being handled.</p>
<blockquote>
<p>Note that the <code>openURL:options:completionHandler:</code> method is not only used to open universal links but also to call custom URL schemes.</p>
</blockquote>
<p>This is an example from the Telegram app:</p>
<div class="highlight"><pre><span></span><code>}, openUniversalUrl: { url, completion in
    if #available(iOS 10.0, *) {
        var parsedUrl = URL(string: url)
        if let parsed = parsedUrl {
            if parsed.scheme == nil || parsed.scheme!.isEmpty {
                parsedUrl = URL(string: &quot;https://\(url)&quot;)
            }
        }

        if let parsedUrl = parsedUrl {
            return UIApplication.shared.open(parsedUrl,
                        options: [UIApplicationOpenURLOptionUniversalLinksOnly: true as NSNumber],
                        completionHandler: { value in completion.completion(value)}
            )
</code></pre></div>
<p>Note how the app adapts the <code>scheme</code> to "https" before opening it and how it uses the option <code>UIApplicationOpenURLOptionUniversalLinksOnly: true</code> that <a href="https://developer.apple.com/documentation/uikit/uiapplicationopenurloptionuniversallinksonly?language=objc" title="UIApplicationOpenURLOptionUniversalLinksOnly">opens the URL only if the URL is a valid universal link and there is an installed app capable of opening that URL</a>.</p>
<p>If you don't have the original source code, search in the symbols and in the strings of the app binary. For example, we will search for Objective-C methods that contain "openURL":</p>
<div class="highlight"><pre><span></span><code>$ rabin2 -zq Telegram<span class="se">\ </span>X.app/Telegram<span class="se">\ </span>X <span class="p">|</span> grep openURL

0x1000dee3f <span class="m">50</span> <span class="m">49</span> application:openURL:sourceApplication:annotation:
0x1000dee71 <span class="m">29</span> <span class="m">28</span> application:openURL:options:
0x1000df2c9 <span class="m">9</span> <span class="m">8</span> openURL:
0x1000df772 <span class="m">35</span> <span class="m">34</span> openURL:options:completionHandler:
</code></pre></div>
<p>As expected, <code>openURL:options:completionHandler:</code> is among the ones found (remember that it might be also present because the app opens custom URL schemes). Next, to ensure that no sensitive information is being leaked you'll have to perform dynamic analysis and inspect the data being transmitted. Please refer to "<a href="#identifying-and-hooking-the-url-handler-method" title="Identifying and Hooking the URL Handler Method">Identifying and Hooking the URL Handler Method</a>" in the "Dynamic Analysis" of "Testing Custom URL Schemes" section for some examples on hooking and tracing this method.</p>
<h4 id="dynamic-analysis_1">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_1" title="Permanent link">&para;</a></h4>
<p>If an app is implementing universal links, you should have the following outputs from the static analysis:</p>
<ul>
<li>the associated domains</li>
<li>the Apple App Site Association file</li>
<li>the link receiver method</li>
<li>the data handler method</li>
</ul>
<p>You can use this now to dynamically test them:</p>
<ul>
<li>Triggering universal links</li>
<li>Identifying valid universal links</li>
<li>Tracing the link receiver method</li>
<li>Checking how the links are opened</li>
</ul>
<h5 id="triggering-universal-links">Triggering Universal Links<a class="headerlink" href="#triggering-universal-links" title="Permanent link">&para;</a></h5>
<p>Unlike custom URL schemes, unfortunately you cannot test universal links from Safari just by typing them in the search bar directly as this is not allowed by Apple. But you can test them anytime using other apps like the Notes app:</p>
<ul>
<li>Open the Notes app and create a new note.</li>
<li>Write the links including the domain.</li>
<li>Leave the editing mode in the Notes app.</li>
<li>Long press the links to open them (remember that a standard click triggers the default option).</li>
</ul>
<blockquote>
<p>To do it from Safari you will have to find an existing link on a website that once clicked, it will be recognized as a Universal Link. This can be a bit time consuming.</p>
</blockquote>
<p>Alternatively you can also use Frida for this, see the section "<a href="#performing-url-requests" title="Performing URL Requests">Performing URL Requests</a>" for more details.</p>
<h5 id="identifying-valid-universal-links">Identifying Valid Universal Links<a class="headerlink" href="#identifying-valid-universal-links" title="Permanent link">&para;</a></h5>
<p>First of all we will see the difference between opening an allowed Universal Link and one that shouldn't be allowed.</p>
<p>From the <code>apple-app-site-association</code> of apple.com we have seen above we chose the following paths:</p>
<div class="highlight"><pre><span></span><code>&quot;paths&quot;: [
    &quot;NOT /shop/buy-iphone/*&quot;,
    ...
    &quot;/today&quot;,
</code></pre></div>
<p>One of them should offer the "Open in app" option and the other should not.</p>
<p>If we long press on the first one (<code>http://www.apple.com/shop/buy-iphone/iphone-xr</code>) it only offers the option to open it (in the browser).</p>
<p><img src="../../assets/Images/Chapters/0x06h/forbidden_universal_link.png" width="400px" /></p>
<p>If we long press on the second (<code>http://www.apple.com/today</code>) it shows options to open it in Safari and in "Apple Store":</p>
<p><img src="../../assets/Images/Chapters/0x06h/allowed_universal_link.png" width="400px" /></p>
<blockquote>
<p>Note that there is a difference between a click and a long press. Once we long press a link and select an option, e.g. "Open in Safari", this will become the default option for all future clicks until we long press again and select another option.</p>
</blockquote>
<p>If we repeat the process on the method <code>application:continueUserActivity: restorationHandler:</code> by either hooking or tracing, we will see how it gets called as soon as we open the allowed universal link. For this you can use for example <code>frida-trace</code>:</p>
<div class="highlight"><pre><span></span><code>$ frida-trace -U <span class="s2">&quot;Apple Store&quot;</span> -m <span class="s2">&quot;*[* *restorationHandler*]&quot;</span>
</code></pre></div>
<h5 id="tracing-the-link-receiver-method">Tracing the Link Receiver Method<a class="headerlink" href="#tracing-the-link-receiver-method" title="Permanent link">&para;</a></h5>
<p>This section explains how to trace the link receiver method and how to extract additional information. For this example, we will use Telegram, as there are no restrictions in its <code>apple-app-site-association</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;applinks&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;apps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;appID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;X834Q8SBVP.org.telegram.TelegramEnterprise&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;paths&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">                    </span><span class="s2">&quot;*&quot;</span><span class="w"></span>
<span class="w">                </span><span class="p">]</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;appID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;C67CF9S4VU.ph.telegra.Telegraph&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;paths&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">                    </span><span class="s2">&quot;*&quot;</span><span class="w"></span>
<span class="w">                </span><span class="p">]</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;appID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;X834Q8SBVP.org.telegram.Telegram-iOS&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;paths&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">                    </span><span class="s2">&quot;*&quot;</span><span class="w"></span>
<span class="w">                </span><span class="p">]</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>In order to open the links we will also use the Notes app and frida-trace with the following pattern:</p>
<div class="highlight"><pre><span></span><code>$ frida-trace -U Telegram -m <span class="s2">&quot;*[* *restorationHandler*]&quot;</span>
</code></pre></div>
<p>Write <code>https://t.me/addstickers/radare</code> (found through a quick Internet research) and open it from the Notes app.</p>
<p><img src="../../assets/Images/Chapters/0x06h/telegram_add_stickers_universal_link.png" width="400px" /></p>
<p>First we let frida-trace generate the stubs in <code>__handlers__/</code>:</p>
<div class="highlight"><pre><span></span><code>$ frida-trace -U Telegram -m <span class="s2">&quot;*[* *restorationHandler*]&quot;</span>
Instrumenting functions...
-<span class="o">[</span>AppDelegate application:continueUserActivity:restorationHandler:<span class="o">]</span>
</code></pre></div>
<p>You can see that only one function was found and is being instrumented. Trigger now the universal link and observe the traces.</p>
<div class="highlight"><pre><span></span><code><span class="m">298382</span> ms  -<span class="o">[</span>AppDelegate application:0x10556b3c0 continueUserActivity:0x1c4237780
                restorationHandler:0x16f27a898<span class="o">]</span>
</code></pre></div>
<p>You can observe that the function is in fact being called. You can now add code to the stubs in <code>__handlers__/</code> to obtain more details:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// __handlers__/__AppDelegate_application_contin_8e36bbb1.js</span><span class="w"></span>

<span class="w">  </span><span class="nx">onEnter</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">log</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;-[AppDelegate application: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; continueUserActivity: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                     </span><span class="s2">&quot; restorationHandler: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mf">4</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;]&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\tapplication: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">2</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\tcontinueUserActivity: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">3</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\t\twebpageURL: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">3</span><span class="p">]).</span><span class="nx">webpageURL</span><span class="p">().</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\t\tactivityType: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">3</span><span class="p">]).</span><span class="nx">activityType</span><span class="p">().</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\t\tuserInfo: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">3</span><span class="p">]).</span><span class="nx">userInfo</span><span class="p">().</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\trestorationHandler: &quot;</span><span class="w"> </span><span class="o">+</span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">4</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
</code></pre></div>
<p>The new output is:</p>
<div class="highlight"><pre><span></span><code><span class="m">298382</span> ms  -<span class="o">[</span>AppDelegate application:0x10556b3c0 continueUserActivity:0x1c4237780
                restorationHandler:0x16f27a898<span class="o">]</span>
<span class="m">298382</span> ms  application:&lt;Application: 0x10556b3c0&gt;
<span class="m">298382</span> ms  continueUserActivity:&lt;NSUserActivity: 0x1c4237780&gt;
<span class="m">298382</span> ms       webpageURL:http://t.me/addstickers/radare
<span class="m">298382</span> ms       activityType:NSUserActivityTypeBrowsingWeb
<span class="m">298382</span> ms       userInfo:<span class="o">{</span>
<span class="o">}</span>
<span class="m">298382</span> ms  restorationHandler:&lt;__NSStackBlock__: 0x16f27a898&gt;
</code></pre></div>
<p>Apart from the function parameters we have added more information by calling some methods from them to get more details, in this case about the <code>NSUserActivity</code>. If we look in the <a href="https://developer.apple.com/documentation/foundation/nsuseractivity?language=objc" title="NSUserActivity">Apple Developer Documentation</a> we can see what else we can call from this object.</p>
<h5 id="checking-how-the-links-are-opened">Checking How the Links Are Opened<a class="headerlink" href="#checking-how-the-links-are-opened" title="Permanent link">&para;</a></h5>
<p>If you want to know more about which function actually opens the URL and how the data is actually being handled you should keep investigating.</p>
<p>Extend the previous command in order to find out if there are any other functions involved into opening the URL.</p>
<div class="highlight"><pre><span></span><code>$ frida-trace -U Telegram -m <span class="s2">&quot;*[* *restorationHandler*]&quot;</span> -i <span class="s2">&quot;*open*Url*&quot;</span>
</code></pre></div>
<blockquote>
<p><code>-i</code> includes any method. You can also use a glob pattern here (e.g. <code>-i "*open*Url*"</code> means "include any function containing 'open', then 'Url' and something else")</p>
</blockquote>
<p>Again, we first let frida-trace generate the stubs in <code>__handlers__/</code>:</p>
<div class="highlight"><pre><span></span><code>$ frida-trace -U Telegram -m <span class="s2">&quot;*[* *restorationHandler*]&quot;</span> -i <span class="s2">&quot;*open*Url*&quot;</span>
Instrumenting functions...
-<span class="o">[</span>AppDelegate application:continueUserActivity:restorationHandler:<span class="o">]</span>
<span class="nv">$S10TelegramUI0A19ApplicationBindingsC16openUniversalUrlyySS_AA0ac4OpenG10Completion</span>...
<span class="nv">$S10TelegramUI15openExternalUrl7account7context3url05forceD016presentationData18application</span>...
<span class="nv">$S10TelegramUI31AuthorizationSequenceControllerC7account7strings7openUrl5apiId0J4HashAC0A4Core19</span>...
...
</code></pre></div>
<p>Now you can see a long list of functions but we still don't know which ones will be called. Trigger the universal link again and observe the traces.</p>
<div class="highlight"><pre><span></span><code>           /* TID 0x303 */
<span class="m">298382</span> ms  -<span class="o">[</span>AppDelegate application:0x10556b3c0 continueUserActivity:0x1c4237780
                restorationHandler:0x16f27a898<span class="o">]</span>
<span class="m">298619</span> ms     <span class="p">|</span> <span class="nv">$S10TelegramUI15openExternalUrl7account7context3url05forceD016presentationData</span>
                18applicationContext20navigationController12dismissInputy0A4Core7AccountC_AA
                14OpenURLContextOSSSbAA012PresentationK0CAA0a11ApplicationM0C7Display0
                10NavigationO0CSgyyctF<span class="o">()</span>
</code></pre></div>
<p>Apart from the Objective-C method, now there is one Swift function that is also of your interest.</p>
<p>There is probably no documentation for that Swift function but you can just demangle its symbol using <code>swift-demangle</code> via <a href="http://www.manpagez.com/man/1/xcrun/" title="xcrun man page"><code>xcrun</code></a>:</p>
<blockquote>
<p>xcrun can be used invoke Xcode developer tools from the command-line, without having them in the path. In this case it will locate and run swift-demangle, an Xcode tool that demangles Swift symbols.</p>
</blockquote>
<div class="highlight"><pre><span></span><code>$ xcrun swift-demangle S10TelegramUI15openExternalUrl7account7context3url05forceD016presentationData
18applicationContext20navigationController12dismissInputy0A4Core7AccountC_AA14OpenURLContextOSSSbAA0
12PresentationK0CAA0a11ApplicationM0C7Display010NavigationO0CSgyyctF
</code></pre></div>
<p>Resulting in:</p>
<div class="highlight"><pre><span></span><code>---&gt; TelegramUI.openExternalUrl(
    account: TelegramCore.Account, context: TelegramUI.OpenURLContext, url: Swift.String,
    forceExternal: Swift.Bool, presentationData: TelegramUI.PresentationData,
    applicationContext: TelegramUI.TelegramApplicationContext,
    navigationController: Display.NavigationController?, dismissInput: () -&gt; ()) -&gt; ()
</code></pre></div>
<p>This not only gives you the class (or module) of the method, its name and the parameters but also reveals the parameter types and return type, so in case you need to dive deeper now you know where to start.</p>
<p>For now we will use this information to properly print the parameters by editing the stub file:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// __handlers__/TelegramUI/_S10TelegramUI15openExternalUrl7_b1a3234e.js</span><span class="w"></span>

<span class="w">  </span><span class="nx">onEnter</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">log</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;TelegramUI.openExternalUrl(account: TelegramCore.Account,</span>
<span class="s2">        context: TelegramUI.OpenURLContext, url: Swift.String, forceExternal: Swift.Bool,</span>
<span class="s2">        presentationData: TelegramUI.PresentationData,</span>
<span class="s2">        applicationContext: TelegramUI.TelegramApplicationContext,</span>
<span class="s2">        navigationController: Display.NavigationController?, dismissInput: () -&gt; ()) -&gt; ()&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\taccount: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">0</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\tcontext: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">1</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\turl: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">2</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\tpresentationData: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mf">3</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\tapplicationContext: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">4</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\tnavigationController: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">5</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
</code></pre></div>
<p>This way, the next time we run it we get a much more detailed output:</p>
<div class="highlight"><pre><span></span><code><span class="m">298382</span> ms  -<span class="o">[</span>AppDelegate application:0x10556b3c0 continueUserActivity:0x1c4237780
                restorationHandler:0x16f27a898<span class="o">]</span>
<span class="m">298382</span> ms  application:&lt;Application: 0x10556b3c0&gt;
<span class="m">298382</span> ms  continueUserActivity:&lt;NSUserActivity: 0x1c4237780&gt;
<span class="m">298382</span> ms       webpageURL:http://t.me/addstickers/radare
<span class="m">298382</span> ms       activityType:NSUserActivityTypeBrowsingWeb
<span class="m">298382</span> ms       userInfo:<span class="o">{</span>
<span class="o">}</span>
<span class="m">298382</span> ms  restorationHandler:&lt;__NSStackBlock__: 0x16f27a898&gt;

<span class="m">298619</span> ms     <span class="p">|</span> TelegramUI.openExternalUrl<span class="o">(</span>account: TelegramCore.Account,
context: TelegramUI.OpenURLContext, url: Swift.String, forceExternal: Swift.Bool,
presentationData: TelegramUI.PresentationData, applicationContext:
TelegramUI.TelegramApplicationContext, navigationController: Display.NavigationController?,
dismissInput: <span class="o">()</span> -&gt; <span class="o">())</span> -&gt; <span class="o">()</span>
<span class="m">298619</span> ms     <span class="p">|</span>     account: TelegramCore.Account
<span class="m">298619</span> ms     <span class="p">|</span>     context: nil
<span class="m">298619</span> ms     <span class="p">|</span>     url: http://t.me/addstickers/radare
<span class="m">298619</span> ms     <span class="p">|</span>     presentationData: 0x1c4e40fd1
<span class="m">298619</span> ms     <span class="p">|</span>     applicationContext: nil
<span class="m">298619</span> ms     <span class="p">|</span>     navigationController: TelegramUI.PresentationData
</code></pre></div>
<p>There you can observe the following:</p>
<ul>
<li>It calls <code>application:continueUserActivity:restorationHandler:</code> from the app delegate as expected.</li>
<li><code>application:continueUserActivity:restorationHandler:</code> handles the URL but does not open it, it calls <code>TelegramUI.openExternalUrl</code> for that.</li>
<li>The URL being opened is <code>https://t.me/addstickers/radare</code>.</li>
</ul>
<p>You can now keep going and try to trace and verify how the data is being validated. For example, if you have two apps that <em>communicate</em> via universal links you can use this to see if the sending app is leaking sensitive data by hooking these methods in the receiving app. This is especially useful when you don't have the source code as you will be able to retrieve the full URL that you wouldn't see other way as it might be the result of clicking some button or triggering some functionality.</p>
<p>In some cases, you might find data in <code>userInfo</code> of the <code>NSUserActivity</code> object. In the previous case there was no data being transferred but it might be the case for other scenarios. To see this, be sure to hook the <code>userInfo</code> property or access it directly from the <code>continueUserActivity</code> object in your hook (e.g. by adding a line like this <code>log("userInfo:" + ObjC.Object(args[3]).userInfo().toString());</code>).</p>
<h5 id="final-notes-about-universal-links-and-handoff">Final Notes about Universal Links and Handoff<a class="headerlink" href="#final-notes-about-universal-links-and-handoff" title="Permanent link">&para;</a></h5>
<p>Universal links and Apple's <a href="https://developer.apple.com/library/archive/documentation/UserExperience/Conceptual/Handoff/HandoffFundamentals/HandoffFundamentals.html#//apple_ref/doc/uid/TP40014338" title="Handoff Fundamentals: About Handoff">Handoff feature</a> are related:</p>
<ul>
<li>Both rely on the same method when receiving data:</li>
</ul>
<div class="highlight"><pre><span></span><code>application:continueUserActivity:restorationHandler:
</code></pre></div>
<ul>
<li>Like universal links, the Handoff's Activity Continuation must be declared in the <code>com.apple.developer.associated-domains</code> entitlement and in the server's <code>apple-app-site-association</code> file (in both cases via the keyword <code>"activitycontinuation":</code>). See "Retrieving the Apple App Site Association File" above for an example.</li>
</ul>
<p>Actually, the previous example in "Checking How the Links Are Opened" is very similar to the "Web Browser-to-Native App Handoff" scenario described in the <a href="https://developer.apple.com/library/archive/documentation/UserExperience/Conceptual/Handoff/AdoptingHandoff/AdoptingHandoff.html#//apple_ref/doc/uid/TP40014338-CH2-SW10" title="Adopting Handoff: Web Browser-to-Native App">"Handoff Programming Guide"</a>:</p>
<blockquote>
<p>If the user is using a web browser on the originating device, and the receiving device is an iOS device with a native app that claims the domain portion of the <code>webpageURL</code> property, then iOS launches the native app and sends it an <code>NSUserActivity</code> object with an <code>activityType</code> value of <code>NSUserActivityTypeBrowsingWeb</code>. The <code>webpageURL</code> property contains the URL the user was visiting, while the <code>userInfo</code> dictionary is empty.</p>
</blockquote>
<p>In the detailed output above you can see that <code>NSUserActivity</code> object we've received meets exactly the mentioned points:</p>
<div class="highlight"><pre><span></span><code><span class="m">298382</span> ms  -<span class="o">[</span>AppDelegate application:0x10556b3c0 continueUserActivity:0x1c4237780
                restorationHandler:0x16f27a898<span class="o">]</span>
<span class="m">298382</span> ms  application:&lt;Application: 0x10556b3c0&gt;
<span class="m">298382</span> ms  continueUserActivity:&lt;NSUserActivity: 0x1c4237780&gt;
<span class="m">298382</span> ms       webpageURL:http://t.me/addstickers/radare
<span class="m">298382</span> ms       activityType:NSUserActivityTypeBrowsingWeb
<span class="m">298382</span> ms       userInfo:<span class="o">{</span>
<span class="o">}</span>
<span class="m">298382</span> ms  restorationHandler:&lt;__NSStackBlock__: 0x16f27a898&gt;
</code></pre></div>
<p>This knowledge should help you when testing apps supporting Handoff.</p>
<h3 id="uiactivity-sharing">UIActivity Sharing<a class="headerlink" href="#uiactivity-sharing" title="Permanent link">&para;</a></h3>
<h4 id="overview_2">Overview<a class="headerlink" href="#overview_2" title="Permanent link">&para;</a></h4>
<p>Starting on iOS 6 it is possible for third-party apps to share data (items) via specific mechanisms <a href="https://developer.apple.com/library/archive/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/Inter-AppCommunication/Inter-AppCommunication.html#//apple_ref/doc/uid/TP40007072-CH6-SW3" title="Supporting AirDrop">like AirDrop, for example</a>. From a user perspective, this feature is the well-known system-wide <em>share activity sheet</em> that appears after clicking on the "Share" button.</p>
<p><img src="../../assets/Images/Chapters/0x06h/share_activity_sheet.png" width="100%" /></p>
<p>The available built-in sharing mechanisms (aka. Activity Types) include:</p>
<ul>
<li>airDrop</li>
<li>assignToContact</li>
<li>copyToPasteboard</li>
<li>mail</li>
<li>message</li>
<li>postToFacebook</li>
<li>postToTwitter</li>
</ul>
<p>A full list can be found in <a href="https://developer.apple.com/documentation/uikit/uiactivity/activitytype" title="UIActivity ActivityType">UIActivity.ActivityType</a>. If not considered appropriate for the app, the developers have the possibility to exclude some of these sharing mechanisms.</p>
<h4 id="static-analysis_2">Static Analysis<a class="headerlink" href="#static-analysis_2" title="Permanent link">&para;</a></h4>
<h5 id="sending-items">Sending Items<a class="headerlink" href="#sending-items" title="Permanent link">&para;</a></h5>
<p>When testing <code>UIActivity</code> Sharing you should pay special attention to:</p>
<ul>
<li>the data (items) being shared,</li>
<li>the custom activities,</li>
<li>the excluded activity types.</li>
</ul>
<p>Data sharing via <code>UIActivity</code> works by creating a <code>UIActivityViewController</code> and passing it the desired items (URLs, text, a picture) on <a href="https://developer.apple.com/documentation/uikit/uiactivityviewcontroller/1622019-init" title="UIActivityViewController init(activityItems:applicationActivities:)"><code>init(activityItems: applicationActivities:)</code></a>.</p>
<p>As we mentioned before, it is possible to exclude some of the sharing mechanisms via the controller's <a href="https://developer.apple.com/documentation/uikit/uiactivityviewcontroller/1622009-excludedactivitytypes" title="UIActivityViewController excludedActivityTypes"><code>excludedActivityTypes</code> property</a>. It is highly recommended to do the tests using the latest versions of iOS as the number of activity types that can be excluded can increase. The developers have to be aware of this and <strong>explicitly exclude</strong> the ones that are not appropriate for the app data. Some activity types might not be even documented like "Create Watch Face".</p>
<p>If having the source code, you should take a look at the <code>UIActivityViewController</code>:</p>
<ul>
<li>Inspect the activities passed to the <code>init(activityItems:applicationActivities:)</code> method.</li>
<li>Check if it defines custom activities (also being passed to the previous method).</li>
<li>Verify the <code>excludedActivityTypes</code>, if any.</li>
</ul>
<p>If you only have the compiled/installed app, try searching for the previous method and property, for example:</p>
<div class="highlight"><pre><span></span><code>$ rabin2 -zq Telegram<span class="se">\ </span>X.app/Telegram<span class="se">\ </span>X <span class="p">|</span> grep -i activityItems
0x1000df034 <span class="m">45</span> <span class="m">44</span> initWithActivityItems:applicationActivities:
</code></pre></div>
<h5 id="receiving-items">Receiving Items<a class="headerlink" href="#receiving-items" title="Permanent link">&para;</a></h5>
<p>When receiving items, you should check:</p>
<ul>
<li>if the app declares <em>custom document types</em> by looking into Exported/Imported UTIs ("Info" tab of the Xcode project). The list of all system declared UTIs (Uniform Type Identifiers) can be found in the <a href="https://developer.apple.com/library/archive/documentation/Miscellaneous/Reference/UTIRef/Articles/System-DeclaredUniformTypeIdentifiers.html#//apple_ref/doc/uid/TP40009259" title="System-Declared Uniform Type Identifiers">archived Apple Developer Documentation</a>.</li>
<li>if the app specifies any <em>document types that it can open</em> by looking into Document Types ("Info" tab of the Xcode project). If present, they consist of name and one or more UTIs that represent the data type (e.g. "public.png" for PNG files). iOS uses this to determine if the app is eligible to open a given document (specifying Exported/Imported UTIs is not enough).</li>
<li>if the app properly <em>verifies the received data</em> by looking into the implementation of <a href="https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623112-application?language=objc" title="UIApplicationDelegate application:openURL:options:"><code>application:openURL:options:</code></a> (or its deprecated version <a href="https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623073-application?language=objc" title="UIApplicationDelegate application:openURL:sourceApplication:annotation:"><code>UIApplicationDelegate application:openURL:sourceApplication:annotation:</code></a>) in the app delegate.</li>
</ul>
<p>If not having the source code you can still take a look into the <code>Info.plist</code> file and search for:</p>
<ul>
<li><code>UTExportedTypeDeclarations</code>/<code>UTImportedTypeDeclarations</code> if the app declares exported/imported <em>custom document types</em>.</li>
<li><code>CFBundleDocumentTypes</code> to see if the app specifies any <em>document types that it can open</em>.</li>
</ul>
<p>A very complete explanation about the use of these keys can be found <a href="https://stackoverflow.com/questions/21937978/what-are-utimportedtypedeclarations-and-utexportedtypedeclarations-used-for-on-i" title="What are UTImportedTypeDeclarations and UTExportedTypeDeclarations used for on iOS?">on Stackoverflow</a>.</p>
<p>Let's see a real-world example. We will take a File Manager app and take a look at these keys. We used <a href="https://github.com/sensepost/objection" title="objection">objection</a> here to read the <code>Info.plist</code> file.</p>
<div class="highlight"><pre><span></span><code>objection --gadget SomeFileManager run ios plist cat Info.plist
</code></pre></div>
<blockquote>
<p>Note that this is the same as if we would retrieve the IPA from the phone or accessed via e.g. SSH and navigated to the corresponding folder in the IPA / app sandbox. However, with objection we are just <em>one command away</em> from our goal and this can be still considered static analysis.</p>
</blockquote>
<p>The first thing we noticed is that app does not declare any imported custom document types but we could find a couple of exported ones:</p>
<div class="highlight"><pre><span></span><code>UTExportedTypeDeclarations =     (
            {
        UTTypeConformsTo =             (
            &quot;public.data&quot;
        );
        UTTypeDescription = &quot;SomeFileManager Files&quot;;
        UTTypeIdentifier = &quot;com.some.filemanager.custom&quot;;
        UTTypeTagSpecification =             {
            &quot;public.filename-extension&quot; =                 (
                ipa,
                deb,
                zip,
                rar,
                tar,
                gz,
                ...
                key,
                pem,
                p12,
                cer
            );
        };
    }
);
</code></pre></div>
<p>The app also declares the document types it opens as we can find the key <code>CFBundleDocumentTypes</code>:</p>
<div class="highlight"><pre><span></span><code>CFBundleDocumentTypes =     (
        {
        ...
        CFBundleTypeName = &quot;SomeFileManager Files&quot;;
        LSItemContentTypes =             (
            &quot;public.content&quot;,
            &quot;public.data&quot;,
            &quot;public.archive&quot;,
            &quot;public.item&quot;,
            &quot;public.database&quot;,
            &quot;public.calendar-event&quot;,
            ...
        );
    }
);
</code></pre></div>
<p>We can see that this File Manager will try to open anything that conforms to any of the UTIs listed in <code>LSItemContentTypes</code> and it's ready to open files with the extensions listed in <code>UTTypeTagSpecification/"public.filename-extension"</code>. Please take a note of this because it will be useful if you want to search for vulnerabilities when dealing with the different types of files when performing dynamic analysis.</p>
<h4 id="dynamic-analysis_2">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_2" title="Permanent link">&para;</a></h4>
<h5 id="sending-items_1">Sending Items<a class="headerlink" href="#sending-items_1" title="Permanent link">&para;</a></h5>
<p>There are three main things you can easily inspect by performing dynamic instrumentation:</p>
<ul>
<li>The <code>activityItems</code>: an array of the items being shared. They might be of different types, e.g. one string and one picture to be shared via a messaging app.</li>
<li>The <code>applicationActivities</code>: an array of <code>UIActivity</code> objects representing the app's custom services.</li>
<li>The <code>excludedActivityTypes</code>: an array of the Activity Types that are not supported, e.g. <code>postToFacebook</code>.</li>
</ul>
<p>To achieve this you can do two things:</p>
<ul>
<li>Hook the method we have seen in the static analysis (<a href="https://developer.apple.com/documentation/uikit/uiactivityviewcontroller/1622019-init" title="UIActivityViewController init(activityItems:applicationActivities:)"><code>init(activityItems: applicationActivities:)</code></a>) to get the <code>activityItems</code> and <code>applicationActivities</code>.</li>
<li>Find out the excluded activities by hooking <a href="https://developer.apple.com/documentation/uikit/uiactivityviewcontroller/1622009-excludedactivitytypes" title="UIActivityViewController excludedActivityTypes"><code>excludedActivityTypes</code> property</a>.</li>
</ul>
<p>Let's see an example using Telegram to share a picture and a text file. First prepare the hooks, we will use the Frida REPL and write a script for this:</p>
<div class="highlight"><pre><span></span><code><span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="w"></span>
<span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="w"></span>
<span class="w">    </span><span class="nx">UIActivityViewController</span><span class="p">[</span><span class="s1">&#39;- initWithActivityItems:applicationActivities:&#39;</span><span class="p">].</span><span class="nx">implementation</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">onEnter</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="nx">printHeader</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">initWithActivityItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">applicationActivities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">3</span><span class="p">]);</span><span class="w"></span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;initWithActivityItems: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">initWithActivityItems</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;applicationActivities: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">applicationActivities</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nx">onLeave</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">printRet</span><span class="p">(</span><span class="nx">retval</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>

<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="w"></span>
<span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">UIActivityViewController</span><span class="p">[</span><span class="s1">&#39;- excludedActivityTypes&#39;</span><span class="p">].</span><span class="nx">implementation</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">onEnter</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">printHeader</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nx">onLeave</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">printRet</span><span class="p">(</span><span class="nx">retval</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>

<span class="kd">function</span><span class="w"> </span><span class="nx">printHeader</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">readUtf8String</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">1</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; @ &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mf">1</span><span class="p">])</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="kd">function</span><span class="w"> </span><span class="nx">printRet</span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;RET @ &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">retval</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;: &#39;</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">retval</span><span class="p">).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">retval</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>You can store this as a JavaScript file, e.g. <code>inspect_send_activity_data.js</code> and load it like this:</p>
<div class="highlight"><pre><span></span><code>$ frida -U Telegram -l inspect_send_activity_data.js
</code></pre></div>
<p>Now observe the output when you first share a picture:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="nx">initWithActivityItems</span><span class="o">:</span><span class="nx">applicationActivities</span><span class="o">:</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x18c130c07</span><span class="w"></span>
<span class="nx">initWithActivityItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;&lt;UIImage: 0x1c4aa0b40&gt; size {571, 264} orientation 0 scale 1.000000&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="nx">applicationActivities</span><span class="o">:</span><span class="w"> </span><span class="nx">nil</span><span class="w"></span>
<span class="nx">RET</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x13cb2b800</span><span class="o">:</span><span class="w"></span>
<span class="o">&lt;</span><span class="nx">UIActivityViewController</span><span class="o">:</span><span class="w"> </span><span class="mh">0x13cb2b800</span><span class="o">&gt;</span><span class="w"></span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="nx">excludedActivityTypes</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x18c0f8429</span><span class="w"></span>
<span class="nx">RET</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x0</span><span class="o">:</span><span class="w"></span>
<span class="nx">nil</span><span class="w"></span>
</code></pre></div>
<p>and then a text file:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="nx">initWithActivityItems</span><span class="o">:</span><span class="nx">applicationActivities</span><span class="o">:</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x18c130c07</span><span class="w"></span>
<span class="nx">initWithActivityItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;&lt;QLActivityItemProvider: 0x1c4a30140&gt;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;&lt;UIPrintInfo: 0x1c0699a50&gt;&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="nx">applicationActivities</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="nx">RET</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x13c4bdc00</span><span class="o">:</span><span class="w"></span>
<span class="o">&lt;</span><span class="nx">_UIDICActivityViewController</span><span class="o">:</span><span class="w"> </span><span class="mh">0x13c4bdc00</span><span class="o">&gt;</span><span class="w"></span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="nx">excludedActivityTypes</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x18c0f8429</span><span class="w"></span>
<span class="nx">RET</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x1c001b1d0</span><span class="o">:</span><span class="w"></span>
<span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;com.apple.UIKit.activity.MarkupAsPDF&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>You can see that:</p>
<ul>
<li>For the picture, the activity item is a <code>UIImage</code> and there are no excluded activities.</li>
<li>For the text file there are two different activity items and <code>com.apple.UIKit.activity. MarkupAsPDF</code> is excluded.</li>
</ul>
<p>In the previous example, there were no custom <code>applicationActivities</code> and only one excluded activity. However, to better illustrate what you can expect from other apps we have shared a picture using another app, here you can see a bunch of application activities and excluded activities (output was edited to hide the name of the originating app):</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="nx">initWithActivityItems</span><span class="o">:</span><span class="nx">applicationActivities</span><span class="o">:</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x18c130c07</span><span class="w"></span>
<span class="nx">initWithActivityItems</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;&lt;SomeActivityItemProvider: 0x1c04bd580&gt;&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="nx">applicationActivities</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;&lt;SomeActionItemActivityAdapter: 0x141de83b0&gt;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;&lt;SomeActionItemActivityAdapter: 0x147971cf0&gt;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;&lt;SomeOpenInSafariActivity: 0x1479f0030&gt;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;&lt;SomeOpenInChromeActivity: 0x1c0c8a500&gt;&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="nx">RET</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x142138a00</span><span class="o">:</span><span class="w"></span>
<span class="o">&lt;</span><span class="nx">SomeActivityViewController</span><span class="o">:</span><span class="w"> </span><span class="mh">0x142138a00</span><span class="o">&gt;</span><span class="w"></span>

<span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="nx">excludedActivityTypes</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x18c0f8429</span><span class="w"></span>
<span class="nx">RET</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x14797c3e0</span><span class="o">:</span><span class="w"></span>
<span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;com.apple.UIKit.activity.Print&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;com.apple.UIKit.activity.AssignToContact&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;com.apple.UIKit.activity.SaveToCameraRoll&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;com.apple.UIKit.activity.CopyToPasteboard&quot;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</code></pre></div>
<h5 id="receiving-items_1">Receiving Items<a class="headerlink" href="#receiving-items_1" title="Permanent link">&para;</a></h5>
<p>After performing the static analysis you would know the <em>document types that the app can open</em> and <em>if it declares any custom document types</em> and (part of) the methods involved. You can use this now to test the receiving part:</p>
<ul>
<li><em>Share</em> a file with the app from another app or send it via AirDrop or e-mail. Choose the file so that it will trigger the "Open with..." dialogue (that is, there is no default app that will open the file, a PDF for example).</li>
<li>Hook <code>application:openURL:options:</code> and any other methods that were identified in a previous static analysis.</li>
<li>Observe the app behavior.</li>
<li>In addition, you could send specific malformed files and/or use a fuzzing technique.</li>
</ul>
<p>To illustrate this with an example we have chosen the same real-world file manager app from the static analysis section and followed these steps:</p>
<ol>
<li>Send a PDF file from another Apple device (e.g. a MacBook) via Airdrop.</li>
<li>Wait for the <strong>AirDrop</strong> popup to appear and click on <strong>Accept</strong>.</li>
<li>
<p>As there is no default app that will open the file, it switches to the <strong>Open with...</strong> popup. There, we can select the app that will open our file. The next screenshot shows this (we have modified the display name using Frida to conceal the app's real name):</p>
<p><img src="../../assets/Images/Chapters/0x06h/airdrop_openwith.png" width="400px" /></p>
</li>
<li>
<p>After selecting <strong>SomeFileManager</strong> we can see the following:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>0x1c4077000<span class="o">)</span>  -<span class="o">[</span>AppDelegate application:openURL:options:<span class="o">]</span>
application: &lt;UIApplication: 0x101c00950&gt;
openURL: file:///var/mobile/Library/Application%20Support
                    /Containers/com.some.filemanager/Documents/Inbox/OWASP_MASVS.pdf
options: <span class="o">{</span>
    <span class="nv">UIApplicationOpenURLOptionsAnnotationKey</span> <span class="o">=</span>     <span class="o">{</span>
        <span class="nv">LSMoveDocumentOnOpen</span> <span class="o">=</span> <span class="m">1</span><span class="p">;</span>
    <span class="o">}</span><span class="p">;</span>
    <span class="nv">UIApplicationOpenURLOptionsOpenInPlaceKey</span> <span class="o">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="nv">UIApplicationOpenURLOptionsSourceApplicationKey</span> <span class="o">=</span> <span class="s2">&quot;com.apple.sharingd&quot;</span><span class="p">;</span>
    <span class="s2">&quot;_UIApplicationOpenURLOptionsSourceProcessHandleKey&quot;</span> <span class="o">=</span> <span class="s2">&quot;&lt;FBSProcessHandle: 0x1c3a63140;</span>
<span class="s2">                                                                sharingd:605; valid: YES&gt;&quot;</span><span class="p">;</span>
<span class="o">}</span>
0x18c7930d8 UIKit!__58-<span class="o">[</span>UIApplication _applicationOpenURLAction:payload:origin:<span class="o">]</span>_block_invoke
...
0x1857cdc34 FrontBoardServices!-<span class="o">[</span>FBSSerialQueue _performNextFromRunLoopSource<span class="o">]</span>
RET: 0x1
</code></pre></div>
</li>
</ol>
<p>As you can see, the sending application is <code>com.apple.sharingd</code> and the URL's scheme is <code>file://</code>. Note that once we select the app that should open the file, the system already moved the file to the corresponding destination, that is to the app's Inbox. The apps are then responsible for deleting the files inside their Inboxes. This app, for example, moves the file to <code>/var/mobile/Documents/</code> and removes it from the Inbox.</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>0x1c002c760<span class="o">)</span>  -<span class="o">[</span>XXFileManager moveItemAtPath:toPath:error:<span class="o">]</span>
moveItemAtPath: /var/mobile/Library/Application Support/Containers
                            /com.some.filemanager/Documents/Inbox/OWASP_MASVS.pdf
toPath: /var/mobile/Documents/OWASP_MASVS <span class="o">(</span><span class="m">1</span><span class="o">)</span>.pdf
error: 0x16f095bf8
0x100f24e90 SomeFileManager!-<span class="o">[</span>AppDelegate __handleOpenURL:<span class="o">]</span>
0x100f25198 SomeFileManager!-<span class="o">[</span>AppDelegate application:openURL:options:<span class="o">]</span>
0x18c7930d8 UIKit!__58-<span class="o">[</span>UIApplication _applicationOpenURLAction:payload:origin:<span class="o">]</span>_block_invoke
...
0x1857cd9f4 FrontBoardServices!__FBSSERIALQUEUE_IS_CALLING_OUT_TO_A_BLOCK__
RET: 0x1
</code></pre></div>
<p>If you look at the stack trace, you can see how <code>application:openURL:options:</code> called <code>__handleOpenURL:</code>, which called <code>moveItemAtPath:toPath:error:</code>. Notice that we have now this information without having the source code for the target app. The first thing that we had to do was clear: hook <code>application:openURL:options:</code>. Regarding the rest, we had to think a little bit and come up with methods that we could start tracing and are related to the file manager, for example, all methods containing the strings "copy", "move", "remove", etc. until we have found that the one being called was <code>moveItemAtPath:toPath:error:</code>.</p>
<p>A final thing worth noticing here is that this way of handling incoming files is the same for custom URL schemes. Please refer to the "<a href="#testing-custom-url-schemes-mstg-platform-3" title="Testing Custom URL Schemes">Testing Custom URL Schemes</a>" section for more information.</p>
<h3 id="app-extensions">App Extensions<a class="headerlink" href="#app-extensions" title="Permanent link">&para;</a></h3>
<h4 id="overview_3">Overview<a class="headerlink" href="#overview_3" title="Permanent link">&para;</a></h4>
<h5 id="what-are-app-extensions">What are app extensions<a class="headerlink" href="#what-are-app-extensions" title="Permanent link">&para;</a></h5>
<p>Together with iOS 8, Apple introduced App Extensions. According to <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/index.html#//apple_ref/doc/uid/TP40014214-CH20-SW1" title="App Extensions Increase Your Impact">Apple App Extension Programming Guide</a>, app extensions let apps offer custom functionality and content to users while they’re interacting with other apps or the system. In order to do this, they implement specific, well scoped tasks like, for example, define what happens after the user clicks on the "Share" button and selects some app or action, provide the content for a Today widget or enable a custom keyboard.</p>
<p>Depending on the task, the app extension will have a particular type (and only one), the so-called <em>extension points</em>. Some notable ones are:</p>
<ul>
<li>Custom Keyboard: replaces the iOS system keyboard with a custom keyboard for use in all apps.</li>
<li>Share: post to a sharing website or share content with others.</li>
<li>Today: also called widgets, they offer content or perform quick tasks in the Today view of Notification Center.</li>
</ul>
<h5 id="how-do-app-extensions-interact-with-other-apps">How do app extensions interact with other apps<a class="headerlink" href="#how-do-app-extensions-interact-with-other-apps" title="Permanent link">&para;</a></h5>
<p>There are three important elements here:</p>
<ul>
<li>App extension: is the one bundled inside a containing app. Host apps interact with it.</li>
<li>Host app: is the (third-party) app that triggers the app extension of another app.</li>
<li>Containing app: is the app that contains the app extension bundled into it.</li>
</ul>
<p>For example, the user selects text in the <em>host app</em>, clicks on the "Share" button and selects one "app" or action from the list. This triggers the <em>app extension</em> of the <em>containing app</em>. The app extension displays its view within the context of the host app and uses the items provided by the host app, the selected text in this case, to perform a specific task (post it on a social network, for example). See this picture from the <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionOverview.html#//apple_ref/doc/uid/TP40014214-CH2-SW13" title="An app extension can communicate indirectly with its containing app">Apple App Extension Programming Guide</a> which pretty good summarizes this:</p>
<p><img src="../../assets/Images/Chapters/0x06h/app_extensions_communication.png" width="100%" /></p>
<h5 id="security-considerations">Security Considerations<a class="headerlink" href="#security-considerations" title="Permanent link">&para;</a></h5>
<p>From the security point of view it is important to note that:</p>
<ul>
<li>An app extension does never communicate directly with its containing app (typically, it isn’t even running while the contained app extension is running).</li>
<li>An app extension and the host app communicate via inter-process communication.</li>
<li>An app extension’s containing app and the host app don’t communicate at all.</li>
<li>A Today widget (and no other app extension type) can ask the system to open its containing app by calling the <code>openURL:completionHandler:</code> method of the <code>NSExtensionContext</code> class.</li>
<li>Any app extension and its containing app can access shared data in a privately defined shared container.</li>
</ul>
<p>In addition:</p>
<ul>
<li>App extensions cannot access some APIs, for example, HealthKit.</li>
<li>They cannot receive data using AirDrop but do can send data.</li>
<li>No long-running background tasks are allowed but uploads or downloads can be initiated.</li>
<li>App extensions cannot access the camera or microphone on an iOS device (except for iMessage app extensions).</li>
</ul>
<h4 id="static-analysis_3">Static Analysis<a class="headerlink" href="#static-analysis_3" title="Permanent link">&para;</a></h4>
<p>The static analysis will take care of:</p>
<ul>
<li>Verifying if the app contains app extensions</li>
<li>Determining the supported data types</li>
<li>Checking data sharing with the containing app</li>
<li>Verifying if the app restricts the use of app extensions</li>
</ul>
<h5 id="verifying-if-the-app-contains-app-extensions">Verifying if the App Contains App Extensions<a class="headerlink" href="#verifying-if-the-app-contains-app-extensions" title="Permanent link">&para;</a></h5>
<p>If you have the original source code you can search for all occurrences of <code>NSExtensionPointIdentifier</code> with Xcode (cmd+shift+f) or take a look into "Build Phases / Embed App extensions":</p>
<p><img src="../../assets/Images/Chapters/0x06h/xcode_embed_app_extensions.png" width="100%" /></p>
<p>There you can find the names of all embedded app extensions followed by <code>.appex</code>, now you can navigate to the individual app extensions in the project.</p>
<p>If not having the original source code:</p>
<p>Grep for <code>NSExtensionPointIdentifier</code> among all files inside the app bundle (IPA or installed app):</p>
<div class="highlight"><pre><span></span><code>$ grep -nr NSExtensionPointIdentifier Payload/Telegram<span class="se">\ </span>X.app/
Binary file Payload/Telegram X.app//PlugIns/SiriIntents.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/Share.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/NotificationContent.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/Widget.appex/Info.plist matches
Binary file Payload/Telegram X.app//Watch/Watch.app/PlugIns/Watch Extension.appex/Info.plist matches
</code></pre></div>
<p>You can also access per SSH, find the app bundle and list all inside PlugIns (they are placed there by default) or do it with objection:</p>
<div class="highlight"><pre><span></span><code>ph.telegra.Telegraph on <span class="o">(</span>iPhone: <span class="m">11</span>.1.2<span class="o">)</span> <span class="o">[</span>usb<span class="o">]</span> <span class="c1"># cd PlugIns</span>
    /var/containers/Bundle/Application/15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35/
    Telegram X.app/PlugIns

ph.telegra.Telegraph on <span class="o">(</span>iPhone: <span class="m">11</span>.1.2<span class="o">)</span> <span class="o">[</span>usb<span class="o">]</span> <span class="c1"># ls</span>
NSFileType      Perms  NSFileProtection    Read    Write     Name
------------  -------  ------------------  ------  -------   -------------------------
Directory         <span class="m">493</span>  None                True    False     NotificationContent.appex
Directory         <span class="m">493</span>  None                True    False     Widget.appex
Directory         <span class="m">493</span>  None                True    False     Share.appex
Directory         <span class="m">493</span>  None                True    False     SiriIntents.appex
</code></pre></div>
<p>We can see now the same four app extensions that we saw in Xcode before.</p>
<h5 id="determining-the-supported-data-types">Determining the Supported Data Types<a class="headerlink" href="#determining-the-supported-data-types" title="Permanent link">&para;</a></h5>
<p>This is important for data being shared with host apps (e.g. via Share or Action Extensions). When the user selects some data type in a host app and it matches the data types define here, the host app will offer the extension. It is worth noticing the difference between this and data sharing via <code>UIActivity</code> where we had to define the document types, also using UTIs. An app does not need to have an extension for that. It is possible to share data using only <code>UIActivity</code>.</p>
<p>Inspect the app extension's <code>Info.plist</code> file and search for <code>NSExtensionActivationRule</code>. That key specifies the data being supported as well as e.g. maximum of items supported. For example:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;key&gt;</span>NSExtensionAttributes<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;dict&gt;</span>
        <span class="nt">&lt;key&gt;</span>NSExtensionActivationRule<span class="nt">&lt;/key&gt;</span>
        <span class="nt">&lt;dict&gt;</span>
            <span class="nt">&lt;key&gt;</span>NSExtensionActivationSupportsImageWithMaxCount<span class="nt">&lt;/key&gt;</span>
            <span class="nt">&lt;integer&gt;</span>10<span class="nt">&lt;/integer&gt;</span>
            <span class="nt">&lt;key&gt;</span>NSExtensionActivationSupportsMovieWithMaxCount<span class="nt">&lt;/key&gt;</span>
            <span class="nt">&lt;integer&gt;</span>1<span class="nt">&lt;/integer&gt;</span>
            <span class="nt">&lt;key&gt;</span>NSExtensionActivationSupportsWebURLWithMaxCount<span class="nt">&lt;/key&gt;</span>
            <span class="nt">&lt;integer&gt;</span>1<span class="nt">&lt;/integer&gt;</span>
        <span class="nt">&lt;/dict&gt;</span>
    <span class="nt">&lt;/dict&gt;</span>
</code></pre></div>
<p>Only the data types present here and not having <code>0</code> as <code>MaxCount</code> will be supported. However, more complex filtering is possible by using a so-called predicate string that will evaluate the UTIs given. Please refer to the <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple_ref/doc/uid/TP40014214-CH21-SW8" title="Declaring Supported Data Types for a Share or Action Extension">Apple App Extension Programming Guide</a> for more detailed information about this.</p>
<h5 id="checking-data-sharing-with-the-containing-app">Checking Data Sharing with the Containing App<a class="headerlink" href="#checking-data-sharing-with-the-containing-app" title="Permanent link">&para;</a></h5>
<p>Remember that app extensions and their containing apps do not have direct access to each other’s containers. However, data sharing can be enabled. This is done via <a href="https://developer.apple.com/library/archive/documentation/Miscellaneous/Reference/EntitlementKeyReference/Chapters/EnablingAppSandbox.html#//apple_ref/doc/uid/TP40011195-CH4-SW19" title="Adding an App to an App Group">"App Groups"</a> and the <a href="https://developer.apple.com/documentation/foundation/nsuserdefaults" title="NSUserDefaults"><code>NSUserDefaults</code></a> API. See this figure from <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple_ref/doc/uid/TP40014214-CH21-SW11" title="An app extension’s container is distinct from its containing app’s container">Apple App Extension Programming Guide</a>:</p>
<p><img src="../../assets/Images/Chapters/0x06h/app_extensions_container_restrictions.png" width="400px" /></p>
<p>As also mentioned in the guide, the app must set up a shared container if the app extension uses the <code>NSURLSession</code> class to perform a background upload or download, so that both the extension and its containing app can access the transferred data.</p>
<h5 id="verifying-if-the-app-restricts-the-use-of-app-extensions">Verifying if the App Restricts the Use of App Extensions<a class="headerlink" href="#verifying-if-the-app-restricts-the-use-of-app-extensions" title="Permanent link">&para;</a></h5>
<p>It is possible to reject a specific type of app extension by using the following method:</p>
<ul>
<li><a href="https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623122-application?language=objc" title="UIApplicationDelegate application:shouldAllowExtensionPointIdentifier:"><code>application:shouldAllowExtensionPointIdentifier:</code></a></li>
</ul>
<p>However, it is currently only possible for "custom keyboard" app extensions (and should be verified when testing apps handling sensitive data via the keyboard like e.g. banking apps).</p>
<h4 id="dynamic-analysis_3">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_3" title="Permanent link">&para;</a></h4>
<p>For the dynamic analysis we can do the following to gain knowledge without having the source code:</p>
<ul>
<li>Inspecting the items being shared</li>
<li>Identifying the app extensions involved</li>
</ul>
<h5 id="inspecting-the-items-being-shared">Inspecting the Items Being Shared<a class="headerlink" href="#inspecting-the-items-being-shared" title="Permanent link">&para;</a></h5>
<p>For this we should hook <code>NSExtensionContext - inputItems</code> in the data originating app.</p>
<p>Following the previous example of Telegram we will now use the "Share" button on a text file (that was received from a chat) to create a note in the Notes app with it:</p>
<p><img src="../../assets/Images/Chapters/0x06h/telegram_share_extension.png" width="400px" /></p>
<p>If we run a trace, we'd see the following output:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>0x1c06bb420<span class="o">)</span> NSExtensionContext - inputItems
0x18284355c Foundation!-<span class="o">[</span>NSExtension _itemProviderForPayload:extensionContext:<span class="o">]</span>
0x1828447a4 Foundation!-<span class="o">[</span>NSExtension _loadItemForPayload:contextIdentifier:completionHandler:<span class="o">]</span>
0x182973224 Foundation!__NSXPCCONNECTION_IS_CALLING_OUT_TO_EXPORTED_OBJECT_S3__
0x182971968 Foundation!-<span class="o">[</span>NSXPCConnection _decodeAndInvokeMessageWithEvent:flags:<span class="o">]</span>
0x182748830 Foundation!message_handler
0x181ac27d0 libxpc.dylib!_xpc_connection_call_event_handler
0x181ac0168 libxpc.dylib!_xpc_connection_mach_event
...
RET: <span class="o">(</span>
<span class="s2">&quot;&lt;NSExtensionItem: 0x1c420a540&gt; - userInfo:</span>
<span class="s2">{</span>
<span class="s2">    NSExtensionItemAttachmentsKey =     (</span>
<span class="s2">    &quot;</span>&lt;NSItemProvider: 0x1c46b30e0&gt; <span class="o">{</span><span class="nv">types</span> <span class="o">=</span> <span class="o">(</span><span class="se">\n</span> <span class="se">\&quot;</span>public.plain-text<span class="se">\&quot;</span>,<span class="se">\n</span> <span class="se">\&quot;</span>public.file-url<span class="se">\&quot;\n</span><span class="o">)}</span><span class="s2">&quot;</span>
<span class="s2">    );</span>
<span class="s2">}&quot;</span>
<span class="o">)</span>
</code></pre></div>
<p>Here we can observe that:</p>
<ul>
<li>This occurred under-the-hood via XPC, concretely it is implemented via a <code>NSXPCConnection</code> that uses the <code>libxpc.dylib</code> Framework.</li>
<li>The UTIs included in the <code>NSItemProvider</code> are <code>public.plain-text</code> and <code>public.file-url</code>, the latter being included in <code>NSExtensionActivationRule</code> from the <a href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/Telegram/Share/Info.plist" title="Info.plist of the \'Share Extension\' of Telegram"><code>Info.plist</code> of the "Share Extension" of Telegram</a>.</li>
</ul>
<h5 id="identifying-the-app-extensions-involved">Identifying the App Extensions Involved<a class="headerlink" href="#identifying-the-app-extensions-involved" title="Permanent link">&para;</a></h5>
<p>You can also find out which app extension is taking care of your the requests and responses by hooking <code>NSExtension - _plugIn</code>:</p>
<p>We run the same example again:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>0x1c0370200<span class="o">)</span> NSExtension - _plugIn
RET: &lt;PKPlugin: 0x1163637f0 ph.telegra.Telegraph.Share<span class="o">(</span><span class="m">5</span>.3<span class="o">)</span> 5B6DE177-F09B-47DA-90CD-34D73121C785
<span class="m">1</span><span class="o">(</span><span class="m">2</span><span class="o">)</span> /private/var/containers/Bundle/Application/15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35
/Telegram X.app/PlugIns/Share.appex&gt;

<span class="o">(</span>0x1c0372300<span class="o">)</span>  -<span class="o">[</span>NSExtension _plugIn<span class="o">]</span>
RET: &lt;PKPlugin: 0x10bff7910 com.apple.mobilenotes.SharingExtension<span class="o">(</span><span class="m">1</span>.5<span class="o">)</span> 73E4F137-5184-4459-A70A-83
F90A1414DC <span class="m">1</span><span class="o">(</span><span class="m">2</span><span class="o">)</span> /private/var/containers/Bundle/Application/5E267B56-F104-41D0-835B-F1DAB9AE076D
/MobileNotes.app/PlugIns/com.apple.mobilenotes.SharingExtension.appex&gt;
</code></pre></div>
<p>As you can see there are two app extensions involved:</p>
<ul>
<li><code>Share.appex</code> is sending the text file (<code>public.plain-text</code> and <code>public.file-url</code>).</li>
<li><code>com.apple.mobilenotes.SharingExtension.appex</code> which is receiving and will process the text file.</li>
</ul>
<p>If you want to learn more about what's happening under-the-hood in terms of XPC, we recommend to take a look at the internal calls from "libxpc.dylib". For example you can use <a href="https://www.frida.re/docs/frida-trace/" title="frida-trace"><code>frida-trace</code></a> and then dig deeper into the methods that you find more interesting by extending the automatically generated stubs.</p>
<h3 id="uipasteboard">UIPasteboard<a class="headerlink" href="#uipasteboard" title="Permanent link">&para;</a></h3>
<h4 id="overview_4">Overview<a class="headerlink" href="#overview_4" title="Permanent link">&para;</a></h4>
<p>The <a href="https://developer.apple.com/documentation/uikit/uipasteboard" title="UIPasteboard"><code>UIPasteboard</code></a> enables sharing data within an app, and from an app to other apps. There are two kinds of pasteboards:</p>
<ul>
<li><strong>systemwide general pasteboard</strong>: for sharing data with any app. Persistent by default across device restarts and app uninstalls (since iOS 10).</li>
<li><strong>custom / named pasteboards</strong>: for sharing data with another app (having the same team ID as the app to share from) or with the app itself (they are only available in the process that creates them). Non-persistent by default (since iOS 10), that is, they exist only until the owning (creating) app quits.</li>
</ul>
<p>Some security considerations:</p>
<ul>
<li>Users cannot grant or deny permission for apps to read the pasteboard.</li>
<li>Since iOS 9, apps <a href="https://forums.developer.apple.com/thread/13760" title="UIPasteboard returning null from Today extension">cannot access the pasteboard while in background</a>, this mitigates background pasteboard monitoring. However, if the <em>malicious</em> app is brought to foreground again and the data remains in the pasteboard, it will be able to retrieve it programmatically without the knowledge nor the consent of the user.</li>
<li><a href="https://developer.apple.com/documentation/uikit/uipasteboard?language=objc" title="Pasteboard Security and Privacy Changes in iOS 10">Apple warns about persistent named pasteboards</a> and discourages their use. Instead, shared containers should be used.</li>
<li>Starting in iOS 10 there is a new Handoff feature called Universal Clipboard that is enabled by default. It allows the general pasteboard contents to automatically transfer between devices. This feature can be disabled if the developer chooses to do so and it is also possible to set an expiration time and date for copied data.</li>
</ul>
<h4 id="static-analysis_4">Static Analysis<a class="headerlink" href="#static-analysis_4" title="Permanent link">&para;</a></h4>
<p>The <strong>systemwide general pasteboard</strong> can be obtained by using <a href="https://developer.apple.com/documentation/uikit/uipasteboard/1622106-generalpasteboard?language=objc" title="UIPasteboard generalPasteboard"><code>generalPasteboard</code></a>, search the source code or the compiled binary for this method. Using the systemwide general pasteboard should be avoided when dealing with sensitive data.</p>
<p><strong>Custom pasteboards</strong> can be created with <a href="https://developer.apple.com/documentation/uikit/uipasteboard/1622074-pasteboardwithname?language=objc" title="UIPasteboard pasteboardWithName:create:"><code>pasteboardWithName:create:</code></a> or <a href="https://developer.apple.com/documentation/uikit/uipasteboard/1622087-pasteboardwithuniquename?language=objc" title="UIPasteboard pasteboardWithUniqueName"><code>pasteboardWithUniqueName</code></a>. Verify if custom pasteboards are set to be persistent as this is deprecated since iOS 10. A shared container should be used instead.</p>
<p>In addition, the following can be inspected:</p>
<ul>
<li>Check if pasteboards are being removed with <a href="https://developer.apple.com/documentation/uikit/uipasteboard/1622072-removepasteboardwithname?language=objc" title="UIPasteboard removePasteboardWithName:"><code>removePasteboardWithName:</code></a>, which invalidates an app pasteboard, freeing up all resources used by it (no effect for the general pasteboard).</li>
<li>Check if there are excluded pasteboards, there should be a call to <code>setItems:options:</code> with the <code>UIPasteboardOptionLocalOnly</code> option.</li>
<li>Check if there are expiring pasteboards, there should be a call to <code>setItems:options:</code> with the <code>UIPasteboardOptionExpirationDate</code> option.</li>
<li>Check if the app swipes the pasteboard items when going to background or when terminating. This is done by some password manager apps trying to restrict sensitive data exposure.</li>
</ul>
<h4 id="dynamic-analysis_4">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_4" title="Permanent link">&para;</a></h4>
<h5 id="detect-pasteboard-usage">Detect Pasteboard Usage<a class="headerlink" href="#detect-pasteboard-usage" title="Permanent link">&para;</a></h5>
<p>Hook or trace the following:</p>
<ul>
<li><code>generalPasteboard</code> for the system-wide general pasteboard.</li>
<li><code>pasteboardWithName:create:</code> and <code>pasteboardWithUniqueName</code> for custom pasteboards.</li>
</ul>
<h5 id="detect-persistent-pasteboard-usage">Detect Persistent Pasteboard Usage<a class="headerlink" href="#detect-persistent-pasteboard-usage" title="Permanent link">&para;</a></h5>
<p>Hook or trace the deprecated <a href="https://developer.apple.com/documentation/uikit/uipasteboard/1622096-setpersistent?language=objc" title="UIPasteboard setPersistent:"><code>setPersistent:</code></a> method and verify if it's being called.</p>
<h5 id="monitoring-and-inspecting-pasteboard-items">Monitoring and Inspecting Pasteboard Items<a class="headerlink" href="#monitoring-and-inspecting-pasteboard-items" title="Permanent link">&para;</a></h5>
<p>When monitoring the pasteboards, there is several details that may be dynamically retrieved:</p>
<ul>
<li>Obtain pasteboard name by hooking <code>pasteboardWithName:create:</code> and inspecting its input parameters or <code>pasteboardWithUniqueName</code> and inspecting its return value.</li>
<li>Get the first available pasteboard item: e.g. for strings use <code>string</code> method. Or use any of the other methods for the <a href="https://developer.apple.com/documentation/uikit/uipasteboard?language=objc#1654275" title="Getting and Setting Pasteboard Items of Standard Data Types">standard data types</a>.</li>
<li>Get the number of items with <code>numberOfItems</code>.</li>
<li>Check for existence of standard data types with the <a href="https://developer.apple.com/documentation/uikit/uipasteboard?language=objc#2107142" title="Checking for Data Types on a Pasteboard">convenience methods</a>, e.g. <code>hasImages</code>, <code>hasStrings</code>, <code>hasURLs</code> (starting in iOS 10).</li>
<li>Check for other data types (typically UTIs) with <a href="https://developer.apple.com/documentation/uikit/uipasteboard/1622100-containspasteboardtypes?language=objc" title="UIPasteboard containsPasteboardTypes:inItemSet:"><code>containsPasteboardTypes: inItemSet:</code></a>. You may inspect for more concrete data types like, for example an picture as public.png and public.tiff (<a href="http://web.archive.org/web/20190616231857/https://developer.apple.com/documentation/mobilecoreservices/uttype" title="MobileCoreServices UTType">UTIs</a>) or for custom data such as com.mycompany.myapp.mytype. Remember that, in this case, only those apps that <em>declare knowledge</em> of the type are able to understand the data written to the pasteboard. This is the same as we have seen in the "<a href="#uiactivity-sharing" title="UIActivity Sharing">UIActivity Sharing</a>" section. Retrieve them using <a href="https://developer.apple.com/documentation/uikit/uipasteboard/1622071-itemsetwithpasteboardtypes?language=objc" title="UIPasteboard itemSetWithPasteboardTypes:"><code>itemSetWithPasteboardTypes:</code></a> and setting the corresponding UTIs.</li>
<li>Check for excluded or expiring items by hooking <code>setItems:options:</code> and inspecting its options for <code>UIPasteboardOptionLocalOnly</code> or <code>UIPasteboardOptionExpirationDate</code>.</li>
</ul>
<p>If only looking for strings you may want to use objection's command <code>ios pasteboard monitor</code>:</p>
<blockquote>
<p>Hooks into the iOS UIPasteboard class and polls the generalPasteboard every 5 seconds for data. If new data is found, different from the previous poll, that data will be dumped to screen.</p>
</blockquote>
<p>You may also build your own pasteboard monitor that monitors specific information as seen above.</p>
<p>For example, this script (inspired from the script behind <a href="https://github.com/sensepost/objection/blob/b39ee53b5ba2e9a271797d2f3931d79c46dccfdb/agent/src/ios/pasteboard.ts" title="pasteboard.ts">objection's pasteboard monitor</a>) reads the pasteboard items every 5 seconds, if there's something new it will print it:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">UIPasteboard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">UIPasteboard</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">Pasteboard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">UIPasteboard</span><span class="p">.</span><span class="nx">generalPasteboard</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Pasteboard</span><span class="p">.</span><span class="nx">changeCount</span><span class="p">().</span><span class="nx">toString</span><span class="p">();</span><span class="w"></span>

<span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Pasteboard</span><span class="p">.</span><span class="nx">changeCount</span><span class="p">().</span><span class="nx">toString</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Pasteboard</span><span class="p">.</span><span class="nx">items</span><span class="p">().</span><span class="nx">toString</span><span class="p">();</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">currentCount</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentItems</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="nx">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">currentCount</span><span class="p">;</span><span class="w"></span>

<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[* Pasteboard changed] count: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">      </span><span class="s1">&#39; hasStrings: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">Pasteboard</span><span class="p">.</span><span class="nx">hasStrings</span><span class="p">().</span><span class="nx">toString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">      </span><span class="s1">&#39; hasURLs: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">Pasteboard</span><span class="p">.</span><span class="nx">hasURLs</span><span class="p">().</span><span class="nx">toString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">      </span><span class="s1">&#39; hasImages: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">Pasteboard</span><span class="p">.</span><span class="nx">hasImages</span><span class="p">().</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">items</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">5</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>In the output we can see the following:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>* Pasteboard changed<span class="o">]</span> count: <span class="m">64</span> hasStrings: <span class="nb">true</span> hasURLs: <span class="nb">false</span> hasImages: <span class="nb">false</span>
<span class="o">(</span>
    <span class="o">{</span>
        <span class="s2">&quot;public.utf8-plain-text&quot;</span> <span class="o">=</span> hola<span class="p">;</span>
    <span class="o">}</span>
<span class="o">)</span>
<span class="o">[</span>* Pasteboard changed<span class="o">]</span> count: <span class="m">65</span> hasStrings: <span class="nb">true</span> hasURLs: <span class="nb">true</span> hasImages: <span class="nb">false</span>
<span class="o">(</span>
    <span class="o">{</span>
        <span class="s2">&quot;public.url&quot;</span> <span class="o">=</span> <span class="s2">&quot;https://codeshare.frida.re/&quot;</span><span class="p">;</span>
        <span class="s2">&quot;public.utf8-plain-text&quot;</span> <span class="o">=</span> <span class="s2">&quot;https://codeshare.frida.re/&quot;</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">)</span>
<span class="o">[</span>* Pasteboard changed<span class="o">]</span> count: <span class="m">66</span> hasStrings: <span class="nb">false</span> hasURLs: <span class="nb">false</span> hasImages: <span class="nb">true</span>
<span class="o">(</span>
    <span class="o">{</span>
        <span class="s2">&quot;com.apple.uikit.image&quot;</span> <span class="o">=</span> <span class="s2">&quot;&lt;UIImage: 0x1c42b23c0&gt; size {571, 264} orientation 0 scale 1.000000&quot;</span><span class="p">;</span>
        <span class="s2">&quot;public.jpeg&quot;</span> <span class="o">=</span> <span class="s2">&quot;&lt;UIImage: 0x1c44a1260&gt; size {571, 264} orientation 0 scale 1.000000&quot;</span><span class="p">;</span>
        <span class="s2">&quot;public.png&quot;</span> <span class="o">=</span> <span class="s2">&quot;&lt;UIImage: 0x1c04aaaa0&gt; size {571, 264} orientation 0 scale 1.000000&quot;</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">)</span>
</code></pre></div>
<p>You see that first a text was copied including the string "hola", after that a URL was copied and finally a picture was copied. Some of them are available via different UTIs. Other apps will consider these UTIs to allow pasting of this data or not.</p>
<h2 id="testing-custom-url-schemes-mstg-platform-3">Testing Custom URL Schemes (MSTG-PLATFORM-3)<a class="headerlink" href="#testing-custom-url-schemes-mstg-platform-3" title="Permanent link">&para;</a></h2>
<h3 id="overview_5">Overview<a class="headerlink" href="#overview_5" title="Permanent link">&para;</a></h3>
<p>Custom URL schemes <a href="https://developer.apple.com/library/content/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/Inter-AppCommunication/Inter-AppCommunication.html#//apple_ref/doc/uid/TP40007072-CH6-SW1" title="Using URL Schemes to Communicate with Apps">allow apps to communicate via a custom protocol</a>. An app must declare support for the schemes and handle incoming URLs that use those schemes.</p>
<p>Apple warns about the improper use of custom URL schemes in the <a href="https://developer.apple.com/documentation/uikit/core_app/allowing_apps_and_websites_to_link_to_your_content/defining_a_custom_url_scheme_for_your_app" title="Defining a Custom URL Scheme for Your App">Apple Developer Documentation</a>:</p>
<blockquote>
<p>URL schemes offer a potential attack vector into your app, so make sure to validate all URL parameters and discard any malformed URLs. In addition, limit the available actions to those that do not risk the user’s data. For example, do not allow other apps to directly delete content or access sensitive information about the user. When testing your URL-handling code, make sure your test cases include improperly formatted URLs.</p>
</blockquote>
<p>They also suggest using universal links instead, if the purpose is to implement deep linking:</p>
<blockquote>
<p>While custom URL schemes are an acceptable form of deep linking, universal links are strongly recommended as a best practice.</p>
</blockquote>
<p>Supporting a custom URL scheme is done by:</p>
<ul>
<li>defining the format for the app's URLs,</li>
<li>registering the scheme so that the system directs appropriate URLs to the app,</li>
<li>handling the URLs that the app receives.</li>
</ul>
<p>Security issues arise when an app processes calls to its URL scheme without properly validating the URL and its parameters and when users aren't prompted for confirmation before triggering an important action.</p>
<p>One example is the following <a href="http://www.dhanjani.com/blog/2010/11/insecure-handling-of-url-schemes-in-apples-ios.html" title="Insecure Handling of URL Schemes in Apple’s iOS">bug in the Skype Mobile app</a>, discovered in 2010: The Skype app registered the <code>skype://</code> protocol handler, which allowed other apps to trigger calls to other Skype users and phone numbers. Unfortunately, Skype didn't ask users for permission before placing the calls, so any app could call arbitrary numbers without the user's knowledge. Attackers exploited this vulnerability by putting an invisible <code>&lt;iframe src="skype://xxx?call"&gt;&lt;/iframe&gt;</code> (where <code>xxx</code> was replaced by a premium number), so any Skype user who inadvertently visited a malicious website called the premium number.</p>
<p>As a developer, you should carefully validate any URL before calling it. You can allow only certain applications which may be opened via the registered protocol handler. Prompting users to confirm the URL-invoked action is another helpful control.</p>
<p>All URLs are passed to the app delegate, either at launch time or while the app is running or in the background. To handle incoming URLs, the delegate should implement methods to:</p>
<ul>
<li>retrieve information about the URL and decide whether you want to open it,</li>
<li>open the resource specified by the URL.</li>
</ul>
<p>More information can be found in the <a href="https://developer.apple.com/library/archive/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/Inter-AppCommunication/Inter-AppCommunication.html#//apple_ref/doc/uid/TP40007072-CH6-SW13" title="Handling URL Requests">archived App Programming Guide for iOS</a> and in the <a href="https://developer.apple.com/library/archive/documentation/Security/Conceptual/SecureCodingGuide/Articles/ValidatingInput.html" title="Validating Input and Interprocess Communication">Apple Secure Coding Guide</a>.</p>
<p>In addition, an app may also want to send URL requests (aka. queries) to other apps. This is done by:</p>
<ul>
<li>registering the application query schemes that the app wants to query,</li>
<li>optionally querying other apps to know if they can open a certain URL,</li>
<li>sending the URL requests.</li>
</ul>
<p>All of this presents a wide attack surface that we will address in the static and dynamic analysis sections.</p>
<h3 id="static-analysis_5">Static Analysis<a class="headerlink" href="#static-analysis_5" title="Permanent link">&para;</a></h3>
<p>There are a couple of things that we can do in the static analysis. In the next sections we will see the following:</p>
<ul>
<li>Testing custom URL schemes registration</li>
<li>Testing application query schemes registration</li>
<li>Testing URL handling and validation</li>
<li>Testing URL requests to other apps</li>
<li>Testing for deprecated methods</li>
</ul>
<h4 id="testing-custom-url-schemes-registration">Testing Custom URL Schemes Registration<a class="headerlink" href="#testing-custom-url-schemes-registration" title="Permanent link">&para;</a></h4>
<p>The first step to test custom URL schemes is finding out whether an application registers any protocol handlers.</p>
<p>If you have the original source code and want to view registered protocol handlers, simply open the project in Xcode, go to the <strong>Info</strong> tab and open the <strong>URL Types</strong> section as presented in the screenshot below:</p>
<p><img src="../../assets/Images/Chapters/0x06h/URL_scheme.png" width="100%" /></p>
<p>Also in Xcode you can find this by searching for the <code>CFBundleURLTypes</code> key in the app’s <code>Info.plist</code> file (example from <a href="https://github.com/OWASP/iGoat-Swift" title="iGoat-Swift">iGoat-Swift</a>):</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;key&gt;</span>CFBundleURLTypes<span class="nt">&lt;/key&gt;</span>
<span class="nt">&lt;array&gt;</span>
    <span class="nt">&lt;dict&gt;</span>
        <span class="nt">&lt;key&gt;</span>CFBundleURLName<span class="nt">&lt;/key&gt;</span>
        <span class="nt">&lt;string&gt;</span>com.iGoat.myCompany<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;key&gt;</span>CFBundleURLSchemes<span class="nt">&lt;/key&gt;</span>
        <span class="nt">&lt;array&gt;</span>
            <span class="nt">&lt;string&gt;</span>iGoat<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;/array&gt;</span>
    <span class="nt">&lt;/dict&gt;</span>
<span class="nt">&lt;/array&gt;</span>
</code></pre></div>
<p>In a compiled application (or IPA), registered protocol handlers are found in the file <code>Info.plist</code> in the app bundle's root folder. Open it and search for the <code>CFBundleURLSchemes</code> key, if present, it should contain an array of strings (example from <a href="https://github.com/OWASP/iGoat-Swift" title="iGoat-Swift">iGoat-Swift</a>):</p>
<div class="highlight"><pre><span></span><code>grep -A 5 -nri urlsch Info.plist
Info.plist:45:    <span class="nt">&lt;key&gt;</span>CFBundleURLSchemes<span class="nt">&lt;/key&gt;</span>
Info.plist-46-    <span class="nt">&lt;array&gt;</span>
Info.plist-47-        <span class="nt">&lt;string&gt;</span>iGoat<span class="nt">&lt;/string&gt;</span>
Info.plist-48-    <span class="nt">&lt;/array&gt;</span>
</code></pre></div>
<p>Once the URL scheme is registered, other apps can open the app that registered the scheme, and pass parameters by creating appropriately formatted URLs and opening them with the <a href="https://developer.apple.com/documentation/uikit/uiapplication/1648685-openurl?language=objc" title="UIApplication openURL:options:completionHandler:"><code>UIApplication openURL:options:completionHandler:</code></a> method.</p>
<p>Note from the <a href="https://developer.apple.com/library/archive/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/Inter-AppCommunication/Inter-AppCommunication.html#//apple_ref/doc/uid/TP40007072-CH6-SW7" title="Registering Custom URL Schemes">App Programming Guide for iOS</a>:</p>
<blockquote>
<p>If more than one third-party app registers to handle the same URL scheme, there is currently no process for determining which app will be given that scheme.</p>
</blockquote>
<p>This could lead to a URL scheme hijacking attack (see page 136 in [#thiel2]).</p>
<h4 id="testing-application-query-schemes-registration">Testing Application Query Schemes Registration<a class="headerlink" href="#testing-application-query-schemes-registration" title="Permanent link">&para;</a></h4>
<p>Before calling the <code>openURL:options:completionHandler:</code> method, apps can call <a href="https://developer.apple.com/documentation/uikit/uiapplication/1622952-canopenurl?language=objc" title="UIApplication canOpenURL:"><code>canOpenURL:</code></a> to verify that the target app is available. However, as this method was being used by malicious app as a way to enumerate installed apps, <a href="https://developer.apple.com/documentation/uikit/uiapplication/1622952-canopenurl?language=objc#discussion" title="Discussion about UIApplication canOpenURL:">from iOS 9.0 the URL schemes passed to it must be also declared</a> by adding the <code>LSApplicationQueriesSchemes</code> key to the app's <code>Info.plist</code> file and an array of up to 50 URL schemes.</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;key&gt;</span>LSApplicationQueriesSchemes<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;array&gt;</span>
        <span class="nt">&lt;string&gt;</span>url_scheme1<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;string&gt;</span>url_scheme2<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;/array&gt;</span>
</code></pre></div>
<p><code>canOpenURL</code> will always return <code>NO</code> for undeclared schemes, whether or not an appropriate app is installed. However, this restriction only applies to <code>canOpenURL</code>.</p>
<p><strong>The <code>openURL:options:completionHandler:</code> method will still open any URL scheme, even if the <code>LSApplicationQueriesSchemes</code> array was declared</strong>, and return <code>YES</code> / <code>NO</code> depending on the result.</p>
<p>As an example, Telegram declares in its <a href="https://github.com/TelegramMessenger/Telegram-iOS/blob/master/Telegram/Telegram-iOS/Info.plist#L233" title="Telegram\'s Info.plist Line 63"><code>Info.plist</code></a> these Queries Schemes, among others:</p>
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;key&gt;</span>LSApplicationQueriesSchemes<span class="nt">&lt;/key&gt;</span>
    <span class="nt">&lt;array&gt;</span>
        <span class="nt">&lt;string&gt;</span>dbapi-3<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;string&gt;</span>instagram<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;string&gt;</span>googledrive<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;string&gt;</span>comgooglemaps-x-callback<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;string&gt;</span>foursquare<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;string&gt;</span>here-location<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;string&gt;</span>yandexmaps<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;string&gt;</span>yandexnavi<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;string&gt;</span>comgooglemaps<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;string&gt;</span>youtube<span class="nt">&lt;/string&gt;</span>
        <span class="nt">&lt;string&gt;</span>twitter<span class="nt">&lt;/string&gt;</span>
        ...
</code></pre></div>
<h4 id="testing-url-handling-and-validation">Testing URL Handling and Validation<a class="headerlink" href="#testing-url-handling-and-validation" title="Permanent link">&para;</a></h4>
<p>In order to determine how a URL path is built and validated, if you have the original source code, you can search for the following methods:</p>
<ul>
<li><code>application:didFinishLaunchingWithOptions:</code> method or <code>application:will-FinishLaunchingWithOptions:</code>: verify how the decision is made and how the information about the URL is retrieved.</li>
<li><a href="https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623112-application?language=objc" title="UIApplicationDelegate application:openURL:options:"><code>application:openURL:options:</code></a>: verify how the resource is being opened, i.e. how the data is being parsed, verify the <a href="https://developer.apple.com/documentation/uikit/uiapplication/openurloptionskey" title="UIApplicationOpenURLOptionsKey">options</a>, especially if access by the calling app (<a href="https://developer.apple.com/documentation/uikit/uiapplication/openurloptionskey/1623128-sourceapplication" title="UIApplicationOpenURLOptionsSourceApplicationKey"><code>sourceApplication</code></a>) should be allowed or denied. The app might also need user permission when using the custom URL scheme.</li>
</ul>
<p>In Telegram you will <a href="https://github.com/peter-iakovlev/Telegram-iOS/blob/87e0a33ac438c1d702f2a0b75bf21f26866e346f/Telegram-iOS/AppDelegate.swift#L1250" title="Telegram\'s AppDelegate.swift Line 1250">find four different methods being used</a>:</p>
<div class="highlight"><pre><span></span><code>func application(_ application: UIApplication, open url: URL, sourceApplication: String?) -&gt; Bool {
    self.openUrl(url: url)
    return true
}

func application(_ application: UIApplication, open url: URL, sourceApplication: String?,
annotation: Any) -&gt; Bool {
    self.openUrl(url: url)
    return true
}

func application(_ app: UIApplication, open url: URL,
options: [UIApplicationOpenURLOptionsKey : Any] = [:]) -&gt; Bool {
    self.openUrl(url: url)
    return true
}

func application(_ application: UIApplication, handleOpen url: URL) -&gt; Bool {
    self.openUrl(url: url)
    return true
}
</code></pre></div>
<p>We can observe some things here:</p>
<ul>
<li>The app implements also deprecated methods like <a href="https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1622964-application?language=objc" title="UIApplicationDelegate application:handleOpenURL:"><code>application:handleOpenURL:</code></a> and <a href="https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623073-application" title="UIApplicationDelegate application:openURL:sourceApplication:annotation:"><code>application:openURL:sourceApplication:annotation:</code></a>.</li>
<li>The source application is not being verified in any of those methods.</li>
<li>All of them call a private <code>openUrl</code> method. You can <a href="https://github.com/peter-iakovlev/Telegram-iOS/blob/87e0a33ac438c1d702f2a0b75bf21f26866e346f/Telegram-iOS/AppDelegate.swift#L1270" title="Telegram\'s AppDelegate.swift Line 1270">inspect it</a> to learn more about how the URL request is handled.</li>
</ul>
<h4 id="testing-url-requests-to-other-apps">Testing URL Requests to Other Apps<a class="headerlink" href="#testing-url-requests-to-other-apps" title="Permanent link">&para;</a></h4>
<p>The method <a href="https://developer.apple.com/documentation/uikit/uiapplication/1648685-openurl?language=objc" title="UIApplication openURL:options:completionHandler:"><code>openURL:options:completionHandler:</code></a> and the <a href="https://developer.apple.com/documentation/uikit/uiapplication/1622961-openurl?language=objc" title="UIApplication openURL:">deprecated <code>openURL:</code> method of <code>UIApplication</code></a> are responsible for opening URLs (i.e. to send requests / make queries to other apps) that may be local to the current app or it may be one that must be provided by a different app. If you have the original source code you can search directly for usages of those methods.</p>
<p>Additionally, if you are interested into knowing if the app is querying specific services or apps, and if the app is well-known, you can also search for common URL schemes online and include them in your greps. For example, a <a href="https://ios.gadgethacks.com/news/always-updated-list-ios-app-url-scheme-names-0184033/" title="Always-Updated List of iOS App URL Scheme Names">quick Google search reveals</a>:</p>
<div class="highlight"><pre><span></span><code>Apple Music - music:// or musics:// or audio-player-event://
Calendar - calshow:// or x-apple-calevent://
Contacts - contacts://
Diagnostics - diagnostics:// or diags://
GarageBand - garageband://
iBooks - ibooks:// or itms-books:// or itms-bookss://
Mail - message:// or mailto://emailaddress
Messages - sms://phonenumber
Notes - mobilenotes://
...
</code></pre></div>
<p>We search for this method in the Telegram source code, this time without using Xcode, just with <code>egrep</code>:</p>
<div class="highlight"><pre><span></span><code>$ egrep -nr <span class="s2">&quot;open.*options.*completionHandler&quot;</span> ./Telegram-iOS/

./AppDelegate.swift:552: <span class="k">return</span> UIApplication.shared.open<span class="o">(</span>parsedUrl,
    options: <span class="o">[</span>UIApplicationOpenURLOptionUniversalLinksOnly: <span class="nb">true</span> as NSNumber<span class="o">]</span>,
    completionHandler: <span class="o">{</span> value <span class="k">in</span>
./AppDelegate.swift:556: <span class="k">return</span> UIApplication.shared.open<span class="o">(</span>parsedUrl,
    options: <span class="o">[</span>UIApplicationOpenURLOptionUniversalLinksOnly: <span class="nb">true</span> as NSNumber<span class="o">]</span>,
    completionHandler: <span class="o">{</span> value <span class="k">in</span>
</code></pre></div>
<p>If we inspect the results we will see that <code>openURL:options:completionHandler:</code> is actually being used for universal links, so we have to keep searching. For example, we can search for <code>openURL(</code>:</p>
<div class="highlight"><pre><span></span><code>$ egrep -nr <span class="s2">&quot;openURL\(&quot;</span> ./Telegram-iOS/

./ApplicationContext.swift:763:  UIApplication.shared.openURL<span class="o">(</span>parsedUrl<span class="o">)</span>
./ApplicationContext.swift:792:  UIApplication.shared.openURL<span class="o">(</span>URL<span class="o">(</span>
                                        string: <span class="s2">&quot;https://telegram.org/deactivate?phone=\(phone)&quot;</span><span class="o">)</span>!
                                 <span class="o">)</span>
./AppDelegate.swift:423:         UIApplication.shared.openURL<span class="o">(</span>url<span class="o">)</span>
./AppDelegate.swift:538:         UIApplication.shared.openURL<span class="o">(</span>parsedUrl<span class="o">)</span>
...
</code></pre></div>
<p>If we inspect those lines we will see how this method is also being used to open "Settings" or to open the "App Store Page".</p>
<p>When just searching for <code>://</code> we see:</p>
<div class="highlight"><pre><span></span><code>if documentUri.hasPrefix(&quot;file://&quot;), let path = URL(string: documentUri)?.path {
if !url.hasPrefix(&quot;mt-encrypted-file://?&quot;) {
guard let dict = TGStringUtils.argumentDictionary(inUrlString: String(url[url.index(url.startIndex,
    offsetBy: &quot;mt-encrypted-file://?&quot;.count)...])) else {
parsedUrl = URL(string: &quot;https://\(url)&quot;)
if let url = URL(string: &quot;itms-apps://itunes.apple.com/app/id\(appStoreId)&quot;) {
} else if let url = url as? String, url.lowercased().hasPrefix(&quot;tg://&quot;) {
[[WKExtension sharedExtension] openSystemURL:[NSURL URLWithString:[NSString
    stringWithFormat:@&quot;tel://%@&quot;, userHandle.data]]];
</code></pre></div>
<p>After combining the results of both searches and carefully inspecting the source code we find the following piece of code:</p>
<div class="highlight"><pre><span></span><code>openUrl: { url in
            var parsedUrl = URL(string: url)
            if let parsed = parsedUrl {
                if parsed.scheme == nil || parsed.scheme!.isEmpty {
                    parsedUrl = URL(string: &quot;https://\(url)&quot;)
                }
                if parsed.scheme == &quot;tg&quot; {
                    return
                }
            }

            if let parsedUrl = parsedUrl {
                UIApplication.shared.openURL(parsedUrl)
</code></pre></div>
<p>Before opening a URL, the scheme is validated, "https" will be added if necessary and it won't open any URL with the "tg" scheme. When ready it will use the deprecated <code>openURL</code> method.</p>
<p>If only having the compiled application (IPA) you can still try to identify which URL schemes are being used to query other apps:</p>
<ul>
<li>Check if <code>LSApplicationQueriesSchemes</code> was declared or search for common URL schemes.</li>
<li>Also use the string <code>://</code> or build a regular expression to match URLs as the app might not be declaring some schemes.</li>
</ul>
<p>You can do that by first verifying that the app binary contains those strings by e.g. using unix <code>strings</code> command:</p>
<div class="highlight"><pre><span></span><code>$ strings &lt;yourapp&gt; <span class="p">|</span> grep <span class="s2">&quot;someURLscheme://&quot;</span>
</code></pre></div>
<p>or even better, use radare2's <code>iz/izz</code> command or rafind2, both will find strings where the unix <code>strings</code> command won't. Example from iGoat-Swift:</p>
<div class="highlight"><pre><span></span><code>$ r2 -qc izz~iGoat:// iGoat-Swift
<span class="m">37436</span> 0x001ee610 0x001ee610  <span class="m">23</span>  <span class="m">24</span> <span class="o">(</span><span class="m">4</span>.__TEXT.__cstring<span class="o">)</span> ascii iGoat://?contactNumber<span class="o">=</span>
</code></pre></div>
<h4 id="testing-for-deprecated-methods">Testing for Deprecated Methods<a class="headerlink" href="#testing-for-deprecated-methods" title="Permanent link">&para;</a></h4>
<p>Search for deprecated methods like:</p>
<ul>
<li><a href="https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1622964-application?language=objc" title="UIApplicationDelegate application:handleOpenURL:"><code>application:handleOpenURL:</code></a></li>
<li><a href="https://developer.apple.com/documentation/uikit/uiapplication/1622961-openurl?language=objc" title="UIApplication openURL:"><code>openURL:</code></a></li>
<li><a href="https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623073-application" title="UIApplicationDelegate application:openURL:sourceApplication:annotation:"><code>application:openURL:sourceApplication:annotation:</code></a></li>
</ul>
<p>For example, here we find those three:</p>
<div class="highlight"><pre><span></span><code>$ rabin2 -zzq Telegram<span class="se">\ </span>X.app/Telegram<span class="se">\ </span>X <span class="p">|</span> grep -i <span class="s2">&quot;openurl&quot;</span>

0x1000d9e90 <span class="m">31</span> <span class="m">30</span> UIApplicationOpenURLOptionsKey
0x1000dee3f <span class="m">50</span> <span class="m">49</span> application:openURL:sourceApplication:annotation:
0x1000dee71 <span class="m">29</span> <span class="m">28</span> application:openURL:options:
0x1000dee8e <span class="m">27</span> <span class="m">26</span> application:handleOpenURL:
0x1000df2c9 <span class="m">9</span> <span class="m">8</span> openURL:
0x1000df766 <span class="m">12</span> <span class="m">11</span> canOpenURL:
0x1000df772 <span class="m">35</span> <span class="m">34</span> openURL:options:completionHandler:
...
</code></pre></div>
<h3 id="dynamic-analysis_5">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_5" title="Permanent link">&para;</a></h3>
<p>Once you've identified the custom URL schemes the app has registered, there are several methods that you can use to test them:</p>
<ul>
<li>Performing URL requests</li>
<li>Identifying and hooking the URL handler method</li>
<li>Testing URL schemes source validation</li>
<li>Fuzzing URL schemes</li>
</ul>
<h4 id="performing-url-requests">Performing URL Requests<a class="headerlink" href="#performing-url-requests" title="Permanent link">&para;</a></h4>
<h5 id="using-safari">Using Safari<a class="headerlink" href="#using-safari" title="Permanent link">&para;</a></h5>
<p>To quickly test one URL scheme you can open the URLs on Safari and observe how the app behaves. For example, if you write <code>tel://123456789</code> in the address bar of Safari, a pop up will appear with the <em>telephone number</em> and the options "Cancel" and "Call". If you press "Call" it will open the Phone app and directly make the call.</p>
<p>You may also know already about pages that trigger custom URL schemes, you can just navigate normally to those pages and Safari will automatically ask when it finds a custom URL scheme.</p>
<h5 id="using-the-notes-app">Using the Notes App<a class="headerlink" href="#using-the-notes-app" title="Permanent link">&para;</a></h5>
<p>As already seen in "Triggering Universal Links", you may use the Notes app and long press the links you've written in order to test custom URL schemes. Remember to exit the editing mode in order to be able to open them. Note that you can click or long press links including custom URL schemes only if the app is installed, if not they won't be highlighted as <em>clickable links</em>.</p>
<h5 id="using-frida">Using Frida<a class="headerlink" href="#using-frida" title="Permanent link">&para;</a></h5>
<p>If you simply want to open the URL scheme you can do it using Frida:</p>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="w"> </span><span class="nx">frida</span><span class="w"> </span><span class="o">-</span><span class="nx">U</span><span class="w"> </span><span class="nx">iGoat</span><span class="o">-</span><span class="nx">Swift</span><span class="w"></span>

<span class="p">[</span><span class="nx">iPhone</span><span class="o">::</span><span class="nx">iGoat</span><span class="o">-</span><span class="nx">Swift</span><span class="p">]</span><span class="o">-&gt;</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">openURL</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="kd">var</span><span class="w"> </span><span class="nx">UIApplication</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">UIApplication</span><span class="p">.</span><span class="nx">sharedApplication</span><span class="p">();</span><span class="w"></span>
<span class="w">                            </span><span class="kd">var</span><span class="w"> </span><span class="nx">toOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">NSURL</span><span class="p">.</span><span class="nx">URLWithString_</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span><span class="w"></span>
<span class="w">                            </span><span class="k">return</span><span class="w"> </span><span class="nx">UIApplication</span><span class="p">.</span><span class="nx">openURL_</span><span class="p">(</span><span class="nx">toOpen</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="p">[</span><span class="nx">iPhone</span><span class="o">::</span><span class="nx">iGoat</span><span class="o">-</span><span class="nx">Swift</span><span class="p">]</span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">openURL</span><span class="p">(</span><span class="s2">&quot;tel://234234234&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kc">true</span><span class="w"></span>
</code></pre></div>
<p>In this example from <a href="https://codeshare.frida.re/@dki/ios-url-scheme-fuzzing/" title="iOS URL Scheme Fuzzing Script">Frida CodeShare</a> the author uses the non-public API <code>LSApplication Workspace.openSensitiveURL:withOptions:</code> to open the URLs (from the SpringBoard app):</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">openURL</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">LSApplicationWorkspace</span><span class="p">.</span><span class="nx">defaultWorkspace</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">toOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">NSURL</span><span class="p">.</span><span class="nx">URLWithString_</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">openSensitiveURL_withOptions_</span><span class="p">(</span><span class="nx">toOpen</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<blockquote>
<p>Note that the use of non-public APIs is not permitted on the App Store, that's why we don't even test these but we are allowed to use them for our dynamic analysis.</p>
</blockquote>
<h4 id="identifying-and-hooking-the-url-handler-method">Identifying and Hooking the URL Handler Method<a class="headerlink" href="#identifying-and-hooking-the-url-handler-method" title="Permanent link">&para;</a></h4>
<p>If you can't look into the original source code you will have to find out yourself which method does the app use to handle the URL scheme requests that it receives. You cannot know if it is an Objective-C method or a Swift one, or even if the app is using a deprecated one.</p>
<h5 id="crafting-the-link-yourself-and-letting-safari-open-it">Crafting the Link Yourself and Letting Safari Open It<a class="headerlink" href="#crafting-the-link-yourself-and-letting-safari-open-it" title="Permanent link">&para;</a></h5>
<p>For this we will use the <a href="https://codeshare.frida.re/@mrmacete/objc-method-observer/" title="ObjC method observer">ObjC method observer</a> from Frida CodeShare, which is an extremely handy script that allows you to quickly observe any collection of methods or classes just by providing a simple pattern.</p>
<p>In this case we are interested into all methods containing "openURL", therefore our pattern will be <code>*[* *openURL*]</code>:</p>
<ul>
<li>The first asterisk will match all instance <code>-</code> and class <code>+</code> methods.</li>
<li>The second matches all Objective-C classes.</li>
<li>The third and forth allow to match any method containing the string <code>openURL</code>.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="w"> </span><span class="nx">frida</span><span class="w"> </span><span class="o">-</span><span class="nx">U</span><span class="w"> </span><span class="nx">iGoat</span><span class="o">-</span><span class="nx">Swift</span><span class="w"> </span><span class="o">--</span><span class="nx">codeshare</span><span class="w"> </span><span class="nx">mrmacete</span><span class="o">/</span><span class="nx">objc</span><span class="o">-</span><span class="nx">method</span><span class="o">-</span><span class="nx">observer</span><span class="w"></span>

<span class="p">[</span><span class="nx">iPhone</span><span class="o">::</span><span class="nx">iGoat</span><span class="o">-</span><span class="nx">Swift</span><span class="p">]</span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">observeSomething</span><span class="p">(</span><span class="s2">&quot;*[* *openURL*]&quot;</span><span class="p">);</span><span class="w"></span>
<span class="nx">Observing</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">_UIDICActivityItemProvider</span><span class="w"> </span><span class="nx">activityViewController</span><span class="o">:</span><span class="nx">openURLAnnotationForActivityType</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">Observing</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">CNQuickActionsManager</span><span class="w"> </span><span class="nx">_openURL</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">Observing</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">SUClientController</span><span class="w"> </span><span class="nx">openURL</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">Observing</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">SUClientController</span><span class="w"> </span><span class="nx">openURL</span><span class="o">:</span><span class="nx">inClientWithIdentifier</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">Observing</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">FBSSystemService</span><span class="w"> </span><span class="nx">openURL</span><span class="o">:</span><span class="nx">application</span><span class="o">:</span><span class="nx">options</span><span class="o">:</span><span class="nx">clientPort</span><span class="o">:</span><span class="nx">withResult</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">Observing</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">iGoat_Swift</span><span class="p">.</span><span class="nx">AppDelegate</span><span class="w"> </span><span class="nx">application</span><span class="o">:</span><span class="nx">openURL</span><span class="o">:</span><span class="nx">options</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">Observing</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">PrefsUILinkLabel</span><span class="w"> </span><span class="nx">openURL</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">Observing</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">UIApplication</span><span class="w"> </span><span class="nx">openURL</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">Observing</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">UIApplication</span><span class="w"> </span><span class="nx">_openURL</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">Observing</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">UIApplication</span><span class="w"> </span><span class="nx">openURL</span><span class="o">:</span><span class="nx">options</span><span class="o">:</span><span class="nx">completionHandler</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">Observing</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">UIApplication</span><span class="w"> </span><span class="nx">openURL</span><span class="o">:</span><span class="nx">withCompletionHandler</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">Observing</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">UIApplication</span><span class="w"> </span><span class="nx">_openURL</span><span class="o">:</span><span class="nx">originatingView</span><span class="o">:</span><span class="nx">completionHandler</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">Observing</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">SUApplication</span><span class="w"> </span><span class="nx">application</span><span class="o">:</span><span class="nx">openURL</span><span class="o">:</span><span class="nx">sourceApplication</span><span class="o">:</span><span class="nx">annotation</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</code></pre></div>
<p>The list is very long and includes the methods we have already mentioned. If we trigger now one URL scheme, for example "igoat://" from Safari and accept to open it in the app we will see the following:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="nx">iPhone</span><span class="o">::</span><span class="nx">iGoat</span><span class="o">-</span><span class="nx">Swift</span><span class="p">]</span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x1c4038280</span><span class="p">)</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">iGoat_Swift</span><span class="p">.</span><span class="nx">AppDelegate</span><span class="w"> </span><span class="nx">application</span><span class="o">:</span><span class="nx">openURL</span><span class="o">:</span><span class="nx">options</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">application</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">UIApplication</span><span class="o">:</span><span class="w"> </span><span class="mh">0x101d0fad0</span><span class="o">&gt;</span><span class="w"></span>
<span class="nx">openURL</span><span class="o">:</span><span class="w"> </span><span class="nx">igoat</span><span class="o">:</span><span class="c1">//</span><span class="w"></span>
<span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">UIApplicationOpenURLOptionsOpenInPlaceKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nx">UIApplicationOpenURLOptionsSourceApplicationKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;com.apple.mobilesafari&quot;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="mh">0x18b5030d8</span><span class="w"> </span><span class="nx">UIKit</span><span class="o">!</span><span class="nx">__58</span><span class="o">-</span><span class="p">[</span><span class="nx">UIApplication</span><span class="w"> </span><span class="nx">_applicationOpenURLAction</span><span class="o">:</span><span class="nx">payload</span><span class="o">:</span><span class="nx">origin</span><span class="o">:</span><span class="p">]</span><span class="nx">_block_invoke</span><span class="w"></span>
<span class="mh">0x18b502a94</span><span class="w"> </span><span class="nx">UIKit</span><span class="o">!-</span><span class="p">[</span><span class="nx">UIApplication</span><span class="w"> </span><span class="nx">_applicationOpenURLAction</span><span class="o">:</span><span class="nx">payload</span><span class="o">:</span><span class="nx">origin</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="mh">0x1817e1048</span><span class="w"> </span><span class="nx">libdispatch</span><span class="p">.</span><span class="nx">dylib</span><span class="o">!</span><span class="nx">_dispatch_client_callout</span><span class="w"></span>
<span class="mh">0x1817e86c8</span><span class="w"> </span><span class="nx">libdispatch</span><span class="p">.</span><span class="nx">dylib</span><span class="o">!</span><span class="nx">_dispatch_block_invoke_direct$VARIANT$mp</span><span class="w"></span>
<span class="mh">0x18453d9f4</span><span class="w"> </span><span class="nx">FrontBoardServices</span><span class="o">!</span><span class="nx">__FBSSERIALQUEUE_IS_CALLING_OUT_TO_A_BLOCK__</span><span class="w"></span>
<span class="mh">0x18453d698</span><span class="w"> </span><span class="nx">FrontBoardServices</span><span class="o">!-</span><span class="p">[</span><span class="nx">FBSSerialQueue</span><span class="w"> </span><span class="nx">_performNext</span><span class="p">]</span><span class="w"></span>
<span class="nx">RET</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1</span><span class="w"></span>
</code></pre></div>
<p>Now we know that:</p>
<ul>
<li>The method <code>-[iGoat_Swift.AppDelegate application:openURL:options:]</code> gets called. As we have seen before, it is the recommended way and it is not deprecated.</li>
<li>It receives our URL as a parameter: <code>igoat://</code>.</li>
<li>We also can verify the source application: <code>com.apple.mobilesafari</code>.</li>
<li>We can also know from where it was called, as expected from <code>-[UIApplication _applicationOpenURLAction:payload:origin:]</code>.</li>
<li>The method returns <code>0x1</code> which means <code>YES</code> (<a href="https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623112-application?language=objc#return-value" title="application:openURL:options: Return Value">the delegate successfully handled the request</a>).</li>
</ul>
<p>The call was successful and we see now that the iGoat app was open:</p>
<p><img src="../../assets/Images/Chapters/0x06h/iGoat_opened_via_url_scheme.jpg" width="400px" /></p>
<p>Notice that we can also see that the caller (source application) was Safari if we look in the upper-left corner of the screenshot.</p>
<h5 id="dynamically-opening-the-link-from-the-app-itself">Dynamically Opening the Link from the App Itself<a class="headerlink" href="#dynamically-opening-the-link-from-the-app-itself" title="Permanent link">&para;</a></h5>
<p>It is also interesting to see which other methods get called on the way. To change the result a little bit we will call the same URL scheme from the iGoat app itself. We will use again ObjC method observer and the Frida REPL:</p>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="w"> </span><span class="nx">frida</span><span class="w"> </span><span class="o">-</span><span class="nx">U</span><span class="w"> </span><span class="nx">iGoat</span><span class="o">-</span><span class="nx">Swift</span><span class="w"> </span><span class="o">--</span><span class="nx">codeshare</span><span class="w"> </span><span class="nx">mrmacete</span><span class="o">/</span><span class="nx">objc</span><span class="o">-</span><span class="nx">method</span><span class="o">-</span><span class="nx">observer</span><span class="w"></span>

<span class="p">[</span><span class="nx">iPhone</span><span class="o">::</span><span class="nx">iGoat</span><span class="o">-</span><span class="nx">Swift</span><span class="p">]</span><span class="o">-&gt;</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">openURL</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="kd">var</span><span class="w"> </span><span class="nx">UIApplication</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">UIApplication</span><span class="p">.</span><span class="nx">sharedApplication</span><span class="p">();</span><span class="w"></span>
<span class="w">                            </span><span class="kd">var</span><span class="w"> </span><span class="nx">toOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">NSURL</span><span class="p">.</span><span class="nx">URLWithString_</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span><span class="w"></span>
<span class="w">                            </span><span class="k">return</span><span class="w"> </span><span class="nx">UIApplication</span><span class="p">.</span><span class="nx">openURL_</span><span class="p">(</span><span class="nx">toOpen</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>

<span class="p">[</span><span class="nx">iPhone</span><span class="o">::</span><span class="nx">iGoat</span><span class="o">-</span><span class="nx">Swift</span><span class="p">]</span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">observeSomething</span><span class="p">(</span><span class="s2">&quot;*[* *openURL*]&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">[</span><span class="nx">iPhone</span><span class="o">::</span><span class="nx">iGoat</span><span class="o">-</span><span class="nx">Swift</span><span class="p">]</span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">openURL</span><span class="p">(</span><span class="s2">&quot;iGoat://?contactNumber=123456789&amp;message=hola&quot;</span><span class="p">)</span><span class="w"></span>

<span class="p">(</span><span class="mh">0x1c409e460</span><span class="p">)</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">__NSXPCInterfaceProxy__LSDOpenProtocol</span><span class="w"> </span><span class="nx">openURL</span><span class="o">:</span><span class="nx">options</span><span class="o">:</span><span class="nx">completionHandler</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">openURL</span><span class="o">:</span><span class="w"> </span><span class="nx">iGoat</span><span class="o">:</span><span class="c1">//?contactNumber=123456789&amp;message=hola</span><span class="w"></span>
<span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="nx">nil</span><span class="w"></span>
<span class="nx">completionHandler</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">__NSStackBlock__</span><span class="o">:</span><span class="w"> </span><span class="mh">0x16fc89c38</span><span class="o">&gt;</span><span class="w"></span>
<span class="mh">0x183befbec</span><span class="w"> </span><span class="nx">MobileCoreServices</span><span class="o">!-</span><span class="p">[</span><span class="nx">LSApplicationWorkspace</span><span class="w"> </span><span class="nx">openURL</span><span class="o">:</span><span class="nx">withOptions</span><span class="o">:</span><span class="nx">error</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="mh">0x10ba6400c</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="nx">RET</span><span class="o">:</span><span class="w"> </span><span class="nx">nil</span><span class="w"></span>

<span class="p">...</span><span class="w"></span>

<span class="p">(</span><span class="mh">0x101d0fad0</span><span class="p">)</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">UIApplication</span><span class="w"> </span><span class="nx">openURL</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">openURL</span><span class="o">:</span><span class="w"> </span><span class="nx">iGoat</span><span class="o">:</span><span class="c1">//?contactNumber=123456789&amp;message=hola</span><span class="w"></span>
<span class="mh">0x10a610044</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="nx">RET</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1</span><span class="w"></span>

<span class="kc">true</span><span class="w"></span>
<span class="p">(</span><span class="mh">0x1c4038280</span><span class="p">)</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">iGoat_Swift</span><span class="p">.</span><span class="nx">AppDelegate</span><span class="w"> </span><span class="nx">application</span><span class="o">:</span><span class="nx">openURL</span><span class="o">:</span><span class="nx">options</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="nx">application</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">UIApplication</span><span class="o">:</span><span class="w"> </span><span class="mh">0x101d0fad0</span><span class="o">&gt;</span><span class="w"></span>
<span class="nx">openURL</span><span class="o">:</span><span class="w"> </span><span class="nx">iGoat</span><span class="o">:</span><span class="c1">//?contactNumber=123456789&amp;message=hola</span><span class="w"></span>
<span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">UIApplicationOpenURLOptionsOpenInPlaceKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nx">UIApplicationOpenURLOptionsSourceApplicationKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;OWASP.iGoat-Swift&quot;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="mh">0x18b5030d8</span><span class="w"> </span><span class="nx">UIKit</span><span class="o">!</span><span class="nx">__58</span><span class="o">-</span><span class="p">[</span><span class="nx">UIApplication</span><span class="w"> </span><span class="nx">_applicationOpenURLAction</span><span class="o">:</span><span class="nx">payload</span><span class="o">:</span><span class="nx">origin</span><span class="o">:</span><span class="p">]</span><span class="nx">_block_invoke</span><span class="w"></span>
<span class="mh">0x18b502a94</span><span class="w"> </span><span class="nx">UIKit</span><span class="o">!-</span><span class="p">[</span><span class="nx">UIApplication</span><span class="w"> </span><span class="nx">_applicationOpenURLAction</span><span class="o">:</span><span class="nx">payload</span><span class="o">:</span><span class="nx">origin</span><span class="o">:</span><span class="p">]</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="nx">RET</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1</span><span class="w"></span>
</code></pre></div>
<p>The output is truncated for better readability. This time you see that <code>UIApplicationOpenURLOptionsSourceApplicationKey</code> has changed to <code>OWASP.iGoat-Swift</code>, which makes sense. In addition, a long list of <code>openURL</code>-like methods were called. Considering this information can be very useful for some scenarios as it will help you to decide what you next steps will be, e.g. which method you will hook or tamper with next.</p>
<h5 id="opening-a-link-by-navigating-to-a-page-and-letting-safari-open-it">Opening a Link by Navigating to a Page and Letting Safari Open It<a class="headerlink" href="#opening-a-link-by-navigating-to-a-page-and-letting-safari-open-it" title="Permanent link">&para;</a></h5>
<p>You can now test the same situation when clicking on a link contained on a page. Safari will identify and process the URL scheme and choose which action to execute. Opening this link "<a href="https://telegram.me/fridadotre">https://telegram.me/fridadotre</a>" will trigger this behavior.</p>
<p><img src="../../assets/Images/Chapters/0x06h/open_in_telegram_via_urlscheme.png" width="400px" /></p>
<p>First of all we let frida-trace generate the stubs for us:</p>
<div class="highlight"><pre><span></span><code>$ frida-trace -U Telegram -m <span class="s2">&quot;*[* *restorationHandler*]&quot;</span> -i <span class="s2">&quot;*open*Url*&quot;</span>
    -m <span class="s2">&quot;*[* *application*URL*]&quot;</span> -m <span class="s2">&quot;*[* openURL]&quot;</span>

...
<span class="m">7310</span> ms  -<span class="o">[</span>UIApplication _applicationOpenURLAction: 0x1c44ff900 payload: 0x10c5ee4c0 origin: 0x0<span class="o">]</span>
<span class="m">7311</span> ms     <span class="p">|</span> -<span class="o">[</span>AppDelegate application: 0x105a59980 openURL: 0x1c46ebb80 options: 0x1c0e222c0<span class="o">]</span>
<span class="m">7312</span> ms     <span class="p">|</span> <span class="nv">$S10TelegramUI15openExternalUrl7account7context3url05forceD016presentationData</span>
            18applicationContext20navigationController12dismissInputy0A4Core7AccountC_AA14Open
            URLContextOSSSbAA012PresentationK0CAA0a11ApplicationM0C7Display010NavigationO0CSgyyctF<span class="o">()</span>
</code></pre></div>
<p>Now we can simply modify by hand the stubs we are interested in:</p>
<ul>
<li>
<p>The Objective-C method <code>application:openURL:options:</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// __handlers__/__AppDelegate_application_openUR_3679fadc.js</span><span class="w"></span>

<span class="nx">onEnter</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">log</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;-[AppDelegate application: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot; openURL: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; options: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mf">4</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;]&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\tapplication :&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">2</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\topenURL :&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">3</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\toptions :&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">4</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
</code></pre></div>
</li>
<li>
<p>The Swift method <code>$S10TelegramUI15openExternalUrl...</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// __handlers__/TelegramUI/_S10TelegramUI15openExternalUrl7_b1a3234e.js</span><span class="w"></span>

<span class="nx">onEnter</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">log</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;TelegramUI.openExternalUrl(account, url, presentationData,&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;applicationContext, navigationController, dismissInput)&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\taccount: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">1</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\turl: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">2</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\tpresentationData: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">args</span><span class="p">[</span><span class="mf">3</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\tapplicationContext: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">4</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\tnavigationController: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">5</span><span class="p">]).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
</code></pre></div>
</li>
</ul>
<p>The next time we run it, we see the following output:</p>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="w"> </span><span class="nx">frida</span><span class="o">-</span><span class="nx">trace</span><span class="w"> </span><span class="o">-</span><span class="nx">U</span><span class="w"> </span><span class="nx">Telegram</span><span class="w"> </span><span class="o">-</span><span class="nx">m</span><span class="w"> </span><span class="s2">&quot;*[* *restorationHandler*]&quot;</span><span class="w"> </span><span class="o">-</span><span class="nx">i</span><span class="w"> </span><span class="s2">&quot;*open*Url*&quot;</span><span class="w"></span>
<span class="w">    </span><span class="o">-</span><span class="nx">m</span><span class="w"> </span><span class="s2">&quot;*[* *application*URL*]&quot;</span><span class="w"> </span><span class="o">-</span><span class="nx">m</span><span class="w"> </span><span class="s2">&quot;*[* openURL]&quot;</span><span class="w"></span>

<span class="w">  </span><span class="mf">8144</span><span class="w"> </span><span class="nx">ms</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">UIApplication</span><span class="w"> </span><span class="nx">_applicationOpenURLAction</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1c44ff900</span><span class="w"> </span><span class="nx">payload</span><span class="o">:</span><span class="w"> </span><span class="mh">0x10c5ee4c0</span><span class="w"> </span><span class="nx">origin</span><span class="o">:</span><span class="w"> </span><span class="mh">0x0</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="mf">8145</span><span class="w"> </span><span class="nx">ms</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="p">[</span><span class="nx">AppDelegate</span><span class="w"> </span><span class="nx">application</span><span class="o">:</span><span class="w"> </span><span class="mh">0x105a59980</span><span class="w"> </span><span class="nx">openURL</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1c46ebb80</span><span class="w"> </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1c0e222c0</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="mf">8145</span><span class="w"> </span><span class="nx">ms</span><span class="w">     </span><span class="o">|</span><span class="w">     </span><span class="nx">application</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">Application</span><span class="o">:</span><span class="w"> </span><span class="mh">0x105a59980</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="mf">8145</span><span class="w"> </span><span class="nx">ms</span><span class="w">     </span><span class="o">|</span><span class="w">     </span><span class="nx">openURL</span><span class="o">:</span><span class="w"> </span><span class="nx">tg</span><span class="o">:</span><span class="c1">//resolve?domain=fridadotre</span><span class="w"></span>
<span class="w">  </span><span class="mf">8145</span><span class="w"> </span><span class="nx">ms</span><span class="w">     </span><span class="o">|</span><span class="w">     </span><span class="nx">options</span><span class="w"> </span><span class="o">:</span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nx">UIApplicationOpenURLOptionsOpenInPlaceKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="nx">UIApplicationOpenURLOptionsSourceApplicationKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;com.apple.mobilesafari&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="mf">8269</span><span class="w"> </span><span class="nx">ms</span><span class="w">     </span><span class="o">|</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">TelegramUI</span><span class="p">.</span><span class="nx">openExternalUrl</span><span class="p">(</span><span class="nx">account</span><span class="p">,</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">presentationData</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="nx">applicationContext</span><span class="p">,</span><span class="w"> </span><span class="nx">navigationController</span><span class="p">,</span><span class="w"> </span><span class="nx">dismissInput</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="mf">8269</span><span class="w"> </span><span class="nx">ms</span><span class="w">     </span><span class="o">|</span><span class="w">    </span><span class="o">|</span><span class="w">    </span><span class="nx">account</span><span class="o">:</span><span class="w"> </span><span class="nx">nil</span><span class="w"></span>
<span class="w">  </span><span class="mf">8269</span><span class="w"> </span><span class="nx">ms</span><span class="w">     </span><span class="o">|</span><span class="w">    </span><span class="o">|</span><span class="w">    </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">tg</span><span class="o">:</span><span class="c1">//resolve?domain=fridadotre</span><span class="w"></span>
<span class="w">  </span><span class="mf">8269</span><span class="w"> </span><span class="nx">ms</span><span class="w">     </span><span class="o">|</span><span class="w">    </span><span class="o">|</span><span class="w">    </span><span class="nx">presentationData</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1c4c51741</span><span class="w"></span>
<span class="w">  </span><span class="mf">8269</span><span class="w"> </span><span class="nx">ms</span><span class="w">     </span><span class="o">|</span><span class="w">    </span><span class="o">|</span><span class="w">    </span><span class="nx">applicationContext</span><span class="o">:</span><span class="w"> </span><span class="nx">nil</span><span class="w"></span>
<span class="w">  </span><span class="mf">8269</span><span class="w"> </span><span class="nx">ms</span><span class="w">     </span><span class="o">|</span><span class="w">    </span><span class="o">|</span><span class="w">    </span><span class="nx">navigationController</span><span class="o">:</span><span class="w"> </span><span class="nx">TelegramUI</span><span class="p">.</span><span class="nx">PresentationData</span><span class="w"></span>
<span class="w">  </span><span class="mf">8274</span><span class="w"> </span><span class="nx">ms</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="p">[</span><span class="nx">UIApplication</span><span class="w"> </span><span class="nx">applicationOpenURL</span><span class="o">:</span><span class="mh">0x1c46ebb80</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>There you can observe the following:</p>
<ul>
<li>It calls <code>application:openURL:options:</code> from the app delegate as expected.</li>
<li>The source application is Safari ("com.apple.mobilesafari").</li>
<li><code>application:openURL:options:</code> handles the URL but does not open it, it calls <code>TelegramUI.openExternalUrl</code> for that.</li>
<li>The URL being opened is <code>tg://resolve?domain=fridadotre</code>.</li>
<li>It uses the <code>tg://</code> custom URL scheme from Telegram.</li>
</ul>
<p>It is interesting to see that if you navigate again to "<a href="https://telegram.me/fridadotre">https://telegram.me/fridadotre</a>", click on <strong>cancel</strong> and then click on the link offered by the page itself ("Open in the Telegram app"), instead of opening via custom URL scheme it will open via universal links.</p>
<p><img src="../../assets/Images/Chapters/0x06h/open_in_telegram_via_universallink.png" width="400px" /></p>
<p>You can try this while tracing both methods:</p>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="w"> </span><span class="nx">frida</span><span class="o">-</span><span class="nx">trace</span><span class="w"> </span><span class="o">-</span><span class="nx">U</span><span class="w"> </span><span class="nx">Telegram</span><span class="w"> </span><span class="o">-</span><span class="nx">m</span><span class="w"> </span><span class="s2">&quot;*[* *restorationHandler*]&quot;</span><span class="w"> </span><span class="o">-</span><span class="nx">m</span><span class="w"> </span><span class="s2">&quot;*[* *application*openURL*options*]&quot;</span><span class="w"></span>

<span class="c1">// After clicking &quot;Open&quot; on the pop-up</span><span class="w"></span>

<span class="w"> </span><span class="mf">16374</span><span class="w"> </span><span class="nx">ms</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">AppDelegate</span><span class="w"> </span><span class="nx">application</span><span class="w"> </span><span class="o">:</span><span class="mh">0x10556b3c0</span><span class="w"> </span><span class="nx">openURL</span><span class="w"> </span><span class="o">:</span><span class="mh">0x1c4ae0080</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">:</span><span class="mh">0x1c7a28400</span><span class="p">]</span><span class="w"></span>
<span class="w"> </span><span class="mf">16374</span><span class="w"> </span><span class="nx">ms</span><span class="w">   </span><span class="nx">application</span><span class="w"> </span><span class="o">:&lt;</span><span class="nx">Application</span><span class="o">:</span><span class="w"> </span><span class="mh">0x10556b3c0</span><span class="o">&gt;</span><span class="w"></span>
<span class="w"> </span><span class="mf">16374</span><span class="w"> </span><span class="nx">ms</span><span class="w">   </span><span class="nx">openURL</span><span class="w"> </span><span class="o">:</span><span class="nx">tg</span><span class="o">:</span><span class="c1">//resolve?domain=fridadotre</span><span class="w"></span>
<span class="w"> </span><span class="mf">16374</span><span class="w"> </span><span class="nx">ms</span><span class="w">   </span><span class="nx">options</span><span class="w"> </span><span class="o">:</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">UIApplicationOpenURLOptionsOpenInPlaceKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nx">UIApplicationOpenURLOptionsSourceApplicationKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;com.apple.mobilesafari&quot;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// After clicking &quot;Cancel&quot; on the pop-up and &quot;OPEN&quot; in the page</span><span class="w"></span>

<span class="mf">406575</span><span class="w"> </span><span class="nx">ms</span><span class="w">  </span><span class="o">-</span><span class="p">[</span><span class="nx">AppDelegate</span><span class="w"> </span><span class="nx">application</span><span class="o">:</span><span class="mh">0x10556b3c0</span><span class="w"> </span><span class="nx">continueUserActivity</span><span class="o">:</span><span class="mh">0x1c063d0c0</span><span class="w"></span>
<span class="w">                </span><span class="nx">restorationHandler</span><span class="o">:</span><span class="mh">0x16f27a898</span><span class="p">]</span><span class="w"></span>
<span class="mf">406575</span><span class="w"> </span><span class="nx">ms</span><span class="w">  </span><span class="nx">application</span><span class="o">:&lt;</span><span class="nx">Application</span><span class="o">:</span><span class="w"> </span><span class="mh">0x10556b3c0</span><span class="o">&gt;</span><span class="w"></span>
<span class="mf">406575</span><span class="w"> </span><span class="nx">ms</span><span class="w">  </span><span class="nx">continueUserActivity</span><span class="o">:&lt;</span><span class="nx">NSUserActivity</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1c063d0c0</span><span class="o">&gt;</span><span class="w"></span>
<span class="mf">406575</span><span class="w"> </span><span class="nx">ms</span><span class="w">       </span><span class="nx">webpageURL</span><span class="o">:</span><span class="nx">https</span><span class="o">:</span><span class="c1">//telegram.me/fridadotre</span><span class="w"></span>
<span class="mf">406575</span><span class="w"> </span><span class="nx">ms</span><span class="w">       </span><span class="nx">activityType</span><span class="o">:</span><span class="nx">NSUserActivityTypeBrowsingWeb</span><span class="w"></span>
<span class="mf">406575</span><span class="w"> </span><span class="nx">ms</span><span class="w">       </span><span class="nx">userInfo</span><span class="o">:</span><span class="p">{</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="mf">406575</span><span class="w"> </span><span class="nx">ms</span><span class="w">  </span><span class="nx">restorationHandler</span><span class="o">:&lt;</span><span class="nx">__NSStackBlock__</span><span class="o">:</span><span class="w"> </span><span class="mh">0x16f27a898</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>
<h5 id="testing-for-deprecated-methods_1">Testing for Deprecated Methods<a class="headerlink" href="#testing-for-deprecated-methods_1" title="Permanent link">&para;</a></h5>
<p>Search for deprecated methods like:</p>
<ul>
<li><a href="https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1622964-application?language=objc" title="UIApplicationDelegate application:handleOpenURL:"><code>application:handleOpenURL:</code></a></li>
<li><a href="https://developer.apple.com/documentation/uikit/uiapplication/1622961-openurl?language=objc" title="UIApplication openURL:"><code>openURL:</code></a></li>
<li><a href="https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623073-application" title="UIApplicationDelegate application:openURL:sourceApplication:annotation:"><code>application:openURL:sourceApplication:annotation:</code></a></li>
</ul>
<p>You may simply use frida-trace for this, to see if any of those methods are being used.</p>
<h4 id="testing-url-schemes-source-validation">Testing URL Schemes Source Validation<a class="headerlink" href="#testing-url-schemes-source-validation" title="Permanent link">&para;</a></h4>
<p>A way to discard or confirm validation could be by hooking typical methods that might be used for that. For example <a href="https://developer.apple.com/documentation/foundation/nsstring/1407803-isequaltostring" title="NSString isEqualToString:"><code>isEqualToString:</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// - (BOOL)isEqualToString:(NSString *)aString;</span><span class="w"></span>

<span class="kd">var</span><span class="w"> </span><span class="nx">isEqualToString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">NSString</span><span class="p">[</span><span class="s2">&quot;- isEqualToString:&quot;</span><span class="p">];</span><span class="w"></span>

<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">isEqualToString</span><span class="p">.</span><span class="nx">implementation</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">onEnter</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</code></pre></div>
<p>If we apply this hook and call the URL scheme again:</p>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="w"> </span><span class="nx">frida</span><span class="w"> </span><span class="o">-</span><span class="nx">U</span><span class="w"> </span><span class="nx">iGoat</span><span class="o">-</span><span class="nx">Swift</span><span class="w"></span>

<span class="p">[</span><span class="nx">iPhone</span><span class="o">::</span><span class="nx">iGoat</span><span class="o">-</span><span class="nx">Swift</span><span class="p">]</span><span class="o">-&gt;</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nx">isEqualToString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">.</span><span class="nx">NSString</span><span class="p">[</span><span class="s2">&quot;- isEqualToString:&quot;</span><span class="p">];</span><span class="w"></span>

<span class="w">                    </span><span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">isEqualToString</span><span class="p">.</span><span class="nx">implementation</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="nx">onEnter</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="kd">var</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ObjC</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mf">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"></span>
<span class="w">                      </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">});</span><span class="w"></span>
<span class="p">{}</span><span class="w"></span>
<span class="p">[</span><span class="nx">iPhone</span><span class="o">::</span><span class="nx">iGoat</span><span class="o">-</span><span class="nx">Swift</span><span class="p">]</span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">openURL</span><span class="p">(</span><span class="s2">&quot;iGoat://?contactNumber=123456789&amp;message=hola&quot;</span><span class="p">)</span><span class="w"></span>
<span class="kc">true</span><span class="w"></span>
<span class="nx">nil</span><span class="w"></span>
</code></pre></div>
<p>Nothing happens. This tells us already that this method is not being used for that as we cannot find any <em>app-package-looking</em> string like <code>OWASP.iGoat-Swift</code> or <code>com.apple.mobilesafari</code> between the hook and the text of the tweet. However, consider that we are just probing one method, the app might be using other approach for the comparison.</p>
<h4 id="fuzzing-url-schemes">Fuzzing URL Schemes<a class="headerlink" href="#fuzzing-url-schemes" title="Permanent link">&para;</a></h4>
<p>If the app parses parts of the URL, you can also perform input fuzzing to detect memory corruption bugs.</p>
<p>What we have learned above can be now used to build your own fuzzer on the language of your choice, e.g. in Python and call the <code>openURL</code> using <a href="https://www.frida.re/docs/javascript-api/#rpc" title="Frida\'s RPC (JavaScript API)">Frida's RPC</a>. That fuzzer should do the following:</p>
<ul>
<li>Generate payloads.</li>
<li>For each of them call <code>openURL</code>.</li>
<li>Check if the app generates a crash report (<code>.ips</code>) in <code>/private/var/mobile/Library/Logs/CrashReporter</code>.</li>
</ul>
<p>The <a href="https://github.com/fuzzdb-project/fuzzdb" title="FuzzDB">FuzzDB</a> project offers fuzzing dictionaries that you can use as payloads.</p>
<h5 id="using-frida_1">Using Frida<a class="headerlink" href="#using-frida_1" title="Permanent link">&para;</a></h5>
<p>Doing this with Frida is pretty easy, you can refer to this <a href="https://grepharder.github.io/blog/0x03_learning_about_universal_links_and_fuzzing_url_schemes_on_ios_with_frida.html" title="Learning about Universal Links and Fuzzing URL Schemes on iOS with Frida">blog post</a> to see an example that fuzzes the iGoat-Swift app (working on iOS 11.1.2).</p>
<p>Before running the fuzzer we need the URL schemes as inputs. From the static analysis we know that the iGoat-Swift app supports the following URL scheme and parameters: <code>iGoat://?contactNumber={0}&amp;message={0}</code>.</p>
<div class="highlight"><pre><span></span><code>$ frida -U SpringBoard -l ios-url-scheme-fuzzing.js
<span class="o">[</span>iPhone::SpringBoard<span class="o">]</span>-&gt; fuzz<span class="o">(</span><span class="s2">&quot;iGoat&quot;</span>, <span class="s2">&quot;iGoat://?contactNumber={0}&amp;message={0}&quot;</span><span class="o">)</span>
Watching <span class="k">for</span> crashes from iGoat...
No logs were moved.
Opened URL: iGoat://?contactNumber<span class="o">=</span><span class="m">0</span><span class="p">&amp;</span><span class="nv">message</span><span class="o">=</span><span class="m">0</span>
OK!
Opened URL: iGoat://?contactNumber<span class="o">=</span><span class="m">1</span><span class="p">&amp;</span><span class="nv">message</span><span class="o">=</span><span class="m">1</span>
OK!
Opened URL: iGoat://?contactNumber<span class="o">=</span>-1<span class="p">&amp;</span><span class="nv">message</span><span class="o">=</span>-1
OK!
Opened URL: iGoat://?contactNumber<span class="o">=</span>null<span class="p">&amp;</span><span class="nv">message</span><span class="o">=</span>null
OK!
Opened URL: iGoat://?contactNumber<span class="o">=</span>nil<span class="p">&amp;</span><span class="nv">message</span><span class="o">=</span>nil
OK!
Opened URL: iGoat://?contactNumber<span class="o">=</span><span class="m">99999999999999999999999999999999999</span>
<span class="p">&amp;</span><span class="nv">message</span><span class="o">=</span><span class="m">99999999999999999999999999999999999</span>
OK!
Opened URL: iGoat://?contactNumber<span class="o">=</span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
...
<span class="p">&amp;</span><span class="nv">message</span><span class="o">=</span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
...
OK!
Opened URL: iGoat://?contactNumber<span class="o">=</span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
...
<span class="p">&amp;</span><span class="nv">message</span><span class="o">=</span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
...
OK!
Opened URL: iGoat://?contactNumber<span class="o">=</span><span class="s1">&#39;&amp;message=&#39;</span>
OK!
Opened URL: iGoat://?contactNumber<span class="o">=</span>%20d<span class="p">&amp;</span><span class="nv">message</span><span class="o">=</span>%20d
OK!
Opened URL: iGoat://?contactNumber<span class="o">=</span>%20n<span class="p">&amp;</span><span class="nv">message</span><span class="o">=</span>%20n
OK!
Opened URL: iGoat://?contactNumber<span class="o">=</span>%20x<span class="p">&amp;</span><span class="nv">message</span><span class="o">=</span>%20x
OK!
Opened URL: iGoat://?contactNumber<span class="o">=</span>%20s<span class="p">&amp;</span><span class="nv">message</span><span class="o">=</span>%20s
OK!
</code></pre></div>
<p>The script will detect if a crash occurred. On this run it did not detect any crashed but for other apps this could be the case. We would be able to inspect the crash reports in <code>/private/var/mobile/Library/Logs/CrashReporter</code> or in <code>/tmp</code> if it was moved by the script.</p>
<h2 id="testing-ios-webviews-mstg-platform-5">Testing iOS WebViews (MSTG-PLATFORM-5)<a class="headerlink" href="#testing-ios-webviews-mstg-platform-5" title="Permanent link">&para;</a></h2>
<h3 id="overview_6">Overview<a class="headerlink" href="#overview_6" title="Permanent link">&para;</a></h3>
<p>WebViews are in-app browser components for displaying interactive web content. They can be used to embed web content directly into an app's user interface. iOS WebViews support JavaScript execution by default, so script injection and Cross-Site Scripting attacks can affect them.</p>
<h4 id="uiwebview">UIWebView<a class="headerlink" href="#uiwebview" title="Permanent link">&para;</a></h4>
<p><a href="https://developer.apple.com/reference/uikit/uiwebview" title="UIWebView"><code>UIWebView</code></a> is deprecated starting on iOS 12 and should not be used. Make sure that either <code>WKWebView</code> or <code>SFSafariViewController</code> are used to embed web content. In addition to that, JavaScript cannot be disabled for <code>UIWebView</code> which is another reason to refrain from using it.</p>
<h4 id="wkwebview">WKWebView<a class="headerlink" href="#wkwebview" title="Permanent link">&para;</a></h4>
<p><a href="https://developer.apple.com/reference/webkit/wkwebview" title="WKWebView"><code>WKWebView</code></a> was introduced with iOS 8 and is the appropriate choice for extending app functionality, controlling displayed content (i.e., prevent the user from navigating to arbitrary URLs) and customizing. <code>WKWebView</code> also increases the performance of apps that are using WebViews significantly, through the Nitro JavaScript engine [#thiel2].</p>
<p><code>WKWebView</code> comes with several security advantages over <code>UIWebView</code>:</p>
<ul>
<li>JavaScript is enabled by default but thanks to the <code>javaScriptEnabled</code> property of <code>WKWebView</code>, it can be completely disabled, preventing all script injection flaws.</li>
<li>The <code>JavaScriptCanOpenWindowsAutomatically</code> can be used to prevent JavaScript from opening new windows, such as pop-ups.</li>
<li>The <code>hasOnlySecureContent</code> property can be used to verify resources loaded by the WebView are retrieved through encrypted connections.</li>
<li><code>WKWebView</code> implements out-of-process rendering, so memory corruption bugs won't affect the main app process.</li>
</ul>
<p>A JavaScript Bridge can be enabled when using <code>WKWebView</code>s (and <code>UIWebView</code>s). See Section "<a href="#determining-whether-native-methods-are-exposed-through-webviews-mstg-platform-7" title="Determining Whether Native Methods Are Exposed Through WebViews">Determining Whether Native Methods Are Exposed Through WebViews</a>" below for more information.</p>
<h4 id="sfsafariviewcontroller">SFSafariViewController<a class="headerlink" href="#sfsafariviewcontroller" title="Permanent link">&para;</a></h4>
<p><a href="https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller" title="SFSafariViewController"><code>SFSafariViewController</code></a> is available starting on iOS 9 and should be used to provide a generalized web viewing experience. These WebViews can be easily spotted as they have a characteristic layout which includes the following elements:</p>
<ul>
<li>A read-only address field with a security indicator.</li>
<li>An Action ("Share") button.</li>
<li>A Done button, back and forward navigation buttons, and a "Safari" button to open the page directly in Safari.</li>
</ul>
<p><img src="../../assets/Images/Chapters/0x06h/sfsafariviewcontroller.png" width="400px" /></p>
<p>There are a couple of things to consider:</p>
<ul>
<li>JavaScript cannot be disabled in <code>SFSafariViewController</code> and this is one of the reasons why the usage of <code>WKWebView</code> is recommended when the goal is extending the app's user interface.</li>
<li><code>SFSafariViewController</code> also shares cookies and other website data with Safari.</li>
<li>The user's activity and interaction with a <code>SFSafariViewController</code> are not visible to the app, which cannot access AutoFill data, browsing history, or website data.</li>
<li>According to the App Store Review Guidelines, <code>SFSafariViewController</code>s may not be hidden or obscured by other views or layers.</li>
</ul>
<p>This should be sufficient for an app analysis and therefore, <code>SFSafariViewController</code>s are out of scope for the Static and Dynamic Analysis sections.</p>
<h4 id="safari-web-inspector">Safari Web Inspector<a class="headerlink" href="#safari-web-inspector" title="Permanent link">&para;</a></h4>
<p>Enabling Safari web inspection on iOS allows you to inspect the contents of a WebView remotely from a macOS device and it does not require a jailbroken iOS device.
Enabling the <a href="https://developer.apple.com/library/archive/documentation/AppleApplications/Conceptual/Safari_Developer_Guide/GettingStarted/GettingStarted.html">Safari Web Inspector</a> is especially interesting in applications that expose native APIs using a JavaScript bridge, for example in hybrid applications.</p>
<p>To activate the web inspection you have to follow these steps:</p>
<ol>
<li>On the iOS device open the Settings app: Go to <strong>Safari -&gt; Advanced</strong> and toggle on <em>Web Inspector</em>.</li>
<li>On the macOS device, open Safari: in the menu bar, go to <strong>Safari -&gt; Preferences -&gt; Advanced</strong> and enable <em>Show Develop menu in menu bar</em>.</li>
<li>Connect your iOS device to the macOS device and unlock it: the iOS device name should appear in the <em>Develop</em> menu.</li>
<li>(If not yet trusted) On macOS's Safari, go to the <em>Develop</em> menu, click on the iOS device name, then on "Use for Development" and enable trust.</li>
</ol>
<p>To open the web inspector and debug a WebView:</p>
<ol>
<li>In iOS, open the app and navigate to the screen that should contain a WebView.</li>
<li>In macOS Safari, go to <strong>Developer -&gt; 'iOS Device Name'</strong> and you should see the name of the WebView based context. Click on it to open the Web Inspector.</li>
</ol>
<p>Now you're able to debug the WebView as you would with a regular web page on your desktop browser.</p>
<h3 id="static-analysis_6">Static Analysis<a class="headerlink" href="#static-analysis_6" title="Permanent link">&para;</a></h3>
<p>For the static analysis we will focus mostly on the following points having <code>UIWebView</code> and <code>WKWebView</code> under scope.</p>
<ul>
<li>Identifying WebView usage</li>
<li>Testing JavaScript configuration</li>
<li>Testing for mixed content</li>
<li>Testing for WebView URI manipulation</li>
</ul>
<h4 id="identifying-webview-usage">Identifying WebView Usage<a class="headerlink" href="#identifying-webview-usage" title="Permanent link">&para;</a></h4>
<p>Look out for usages of the above mentioned WebView classes by searching in Xcode.</p>
<p>In the compiled binary you can search in its symbols or strings like this:</p>
<h5 id="uiwebview_1">UIWebView<a class="headerlink" href="#uiwebview_1" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>$ rabin2 -zz ./WheresMyBrowser <span class="p">|</span> egrep <span class="s2">&quot;UIWebView</span>$<span class="s2">&quot;</span>
<span class="m">489</span> 0x0002fee9 0x10002fee9   <span class="m">9</span>  <span class="m">10</span> <span class="o">(</span><span class="m">5</span>.__TEXT.__cstring<span class="o">)</span> ascii UIWebView
<span class="m">896</span> 0x0003c813 0x0003c813  <span class="m">24</span>  <span class="m">25</span> <span class="o">()</span> ascii @_OBJC_CLASS_<span class="nv">$_UIWebView</span>
<span class="m">1754</span> 0x00059599 0x00059599  <span class="m">23</span>  <span class="m">24</span> <span class="o">()</span> ascii _OBJC_CLASS_<span class="nv">$_UIWebView</span>
</code></pre></div>
<h5 id="wkwebview_1">WKWebView<a class="headerlink" href="#wkwebview_1" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>$ rabin2 -zz ./WheresMyBrowser <span class="p">|</span> egrep <span class="s2">&quot;WKWebView</span>$<span class="s2">&quot;</span>
<span class="m">490</span> 0x0002fef3 0x10002fef3   <span class="m">9</span>  <span class="m">10</span> <span class="o">(</span><span class="m">5</span>.__TEXT.__cstring<span class="o">)</span> ascii WKWebView
<span class="m">625</span> 0x00031670 0x100031670  <span class="m">17</span>  <span class="m">18</span> <span class="o">(</span><span class="m">5</span>.__TEXT.__cstring<span class="o">)</span> ascii unwindToWKWebView
<span class="m">904</span> 0x0003c960 0x0003c960  <span class="m">24</span>  <span class="m">25</span> <span class="o">()</span> ascii @_OBJC_CLASS_<span class="nv">$_WKWebView</span>
<span class="m">1757</span> 0x000595e4 0x000595e4  <span class="m">23</span>  <span class="m">24</span> <span class="o">()</span> ascii _OBJC_CLASS_<span class="nv">$_WKWebView</span>
</code></pre></div>
<p>Alternatively you can also search for known methods of these WebView classes. For example, search for the method used to initialize a WKWebView (<a href="https://developer.apple.com/documentation/webkit/wkwebview/1414998-init" title="WKWebView init(frame:configuration:)"><code>init(frame:configuration:)</code></a>):</p>
<div class="highlight"><pre><span></span><code>$ rabin2 -zzq ./WheresMyBrowser <span class="p">|</span> egrep <span class="s2">&quot;WKWebView.*frame&quot;</span>
0x5c3ac <span class="m">77</span> <span class="m">76</span> __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfC
0x5d97a <span class="m">79</span> <span class="m">78</span> __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfcTO
0x6b5d5 <span class="m">77</span> <span class="m">76</span> __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfC
0x6c3fa <span class="m">79</span> <span class="m">78</span> __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfcTO
</code></pre></div>
<p>You can also demangle it:</p>
<div class="highlight"><pre><span></span><code>$ xcrun swift-demangle __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfcTO

---&gt; @nonobjc __C.WKWebView.init<span class="o">(</span>frame: __C_Synthesized.CGRect,
                                configuration: __C.WKWebViewConfiguration<span class="o">)</span> -&gt; __C.WKWebView
</code></pre></div>
<h4 id="testing-javascript-configuration">Testing JavaScript Configuration<a class="headerlink" href="#testing-javascript-configuration" title="Permanent link">&para;</a></h4>
<p>First of all, remember that JavaScript cannot be disabled for <code>UIWebVIews</code>.</p>
<p>For <code>WKWebView</code>s, as a best practice, JavaScript should be disabled unless it is explicitly required. To verify that JavaScript was properly disabled search the project for usages of <code>WKPreferences</code> and ensure that the <a href="https://developer.apple.com/documentation/webkit/wkpreferences/1536203-javascriptenabled" title="WKPreferences javaScriptEnabled"><code>javaScriptEnabled</code></a> property is set to <code>false</code>:</p>
<div class="highlight"><pre><span></span><code>let webPreferences = WKPreferences()
webPreferences.javaScriptEnabled = false
</code></pre></div>
<p>If only having the compiled binary you can search for this in it:</p>
<div class="highlight"><pre><span></span><code>$ rabin2 -zz ./WheresMyBrowser <span class="p">|</span> grep -i <span class="s2">&quot;javascriptenabled&quot;</span>
<span class="m">391</span> 0x0002f2c7 0x10002f2c7  <span class="m">17</span>  <span class="m">18</span> <span class="o">(</span><span class="m">4</span>.__TEXT.__objc_methname<span class="o">)</span> ascii javaScriptEnabled
<span class="m">392</span> 0x0002f2d9 0x10002f2d9  <span class="m">21</span>  <span class="m">22</span> <span class="o">(</span><span class="m">4</span>.__TEXT.__objc_methname<span class="o">)</span> ascii setJavaScriptEnabled:
</code></pre></div>
<p>If user scripts were defined, they will continue running as the <code>javaScriptEnabled</code> property won't affect them. See <a href="https://developer.apple.com/documentation/webkit/wkusercontentcontroller" title="WKUserContentController">WKUserContentController</a> and <a href="https://developer.apple.com/documentation/webkit/wkuserscript" title="WKUserScript">WKUserScript</a> for more information on injecting user scripts to WKWebViews.</p>
<h4 id="testing-for-mixed-content">Testing for Mixed Content<a class="headerlink" href="#testing-for-mixed-content" title="Permanent link">&para;</a></h4>
<p>In contrast to <code>UIWebView</code>s, when using <code>WKWebView</code>s it is possible to detect <a href="https://developers.google.com/web/fundamentals/security/prevent-mixed-content/fixing-mixed-content?hl=en" title="Preventing Mixed Content">mixed content</a> (HTTP content loaded from a HTTPS page). By using the method <a href="https://developer.apple.com/documentation/webkit/wkwebview/1415002-hasonlysecurecontent" title="WKWebView hasOnlySecureContent"><code>hasOnlySecureContent</code></a> it can be verified whether all resources on the page have been loaded through securely encrypted connections. This example from [#thiel2] (see page 159 and 160) uses this to ensure that only content loaded via HTTPS is shown to the user, otherwise an alert is displayed telling the user that mixed content was detected.</p>
<p>In the compiled binary:</p>
<div class="highlight"><pre><span></span><code>$ rabin2 -zz ./WheresMyBrowser <span class="p">|</span> grep -i <span class="s2">&quot;hasonlysecurecontent&quot;</span>

<span class="c1"># nothing found</span>
</code></pre></div>
<p>In this case, the app does not make use of this.</p>
<p>In addition, if you have the original source code or the IPA, you can inspect the embedded HTML files and verify that they do not include mixed content. Search for <code>http://</code> in the source and inside tag attributes, but remember that this might give false positives as, for example, finding an anchor tag <code>&lt;a&gt;</code> that includes a <code>http://</code> inside its <code>href</code> attribute does not always present a mixed content issue. Learn more about mixed content in the <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Mixed_content" title="Mixed Content">MDN Web Docs</a>.</p>
<h3 id="dynamic-analysis_6">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_6" title="Permanent link">&para;</a></h3>
<p>For the dynamic analysis we will address the same points from the static analysis.</p>
<ul>
<li>Enumerating WebView instances</li>
<li>Checking if JavaScript is enabled</li>
<li>Verifying that only secure content is allowed</li>
</ul>
<p>It is possible to identify WebViews and obtain all their properties on runtime by performing dynamic instrumentation. This is very useful when you don't have the original source code.</p>
<p>For the following examples, we will keep using the <a href="https://github.com/authenticationfailure/WheresMyBrowser.iOS/" title="Where\'s My Browser? GitHub Repository">"Where's My Browser?"</a> app and Frida REPL.</p>
<h4 id="enumerating-webview-instances">Enumerating WebView Instances<a class="headerlink" href="#enumerating-webview-instances" title="Permanent link">&para;</a></h4>
<p>Once you've identified a WebView in the app, you may inspect the heap in order to find instances of one or several of the WebViews that we have seen above.</p>
<p>For example, if you use Frida you can do so by inspecting the heap via "ObjC.choose()"</p>
<div class="highlight"><pre><span></span><code><span class="nx">ObjC</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">[</span><span class="s1">&#39;UIWebView&#39;</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">onMatch</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">ui</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;onMatch: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">ui</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;URL: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">ui</span><span class="p">.</span><span class="nx">request</span><span class="p">().</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nx">onComplete</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;done for UIWebView!&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>

<span class="nx">ObjC</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">[</span><span class="s1">&#39;WKWebView&#39;</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">onMatch</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">wk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;onMatch: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">wk</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;URL: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">wk</span><span class="p">.</span><span class="nx">URL</span><span class="p">().</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nx">onComplete</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;done for WKWebView!&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>

<span class="nx">ObjC</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">[</span><span class="s1">&#39;SFSafariViewController&#39;</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">onMatch</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">sf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;onMatch: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sf</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nx">onComplete</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;done for SFSafariViewController!&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</code></pre></div>
<p>For the <code>UIWebView</code> and <code>WKWebView</code> WebViews we also print the associated URL for the sake of completion.</p>
<p>In order to ensure that you will be able to find the instances of the WebViews in the heap, be sure to first navigate to the WebView you've found. Once there, run the code above, e.g. by copying into the Frida REPL:</p>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="w"> </span><span class="nx">frida</span><span class="w"> </span><span class="o">-</span><span class="nx">U</span><span class="w"> </span><span class="nx">com</span><span class="p">.</span><span class="nx">authenticationfailure</span><span class="p">.</span><span class="nx">WheresMyBrowser</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="nx">copy</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">wait</span><span class="w"> </span><span class="p">...</span><span class="w"></span>

<span class="nx">onMatch</span><span class="o">:</span><span class="w">  </span><span class="o">&lt;</span><span class="nx">UIWebView</span><span class="o">:</span><span class="w"> </span><span class="mh">0x14fd25e50</span><span class="p">;</span><span class="w"> </span><span class="nx">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">0</span><span class="w"> </span><span class="mf">126</span><span class="p">;</span><span class="w"> </span><span class="mf">320</span><span class="w"> </span><span class="mf">393</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="nx">autoresize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">RM</span><span class="o">+</span><span class="nx">BM</span><span class="p">;</span><span class="w"> </span><span class="nx">layer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">CALayer</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1c422d100</span><span class="o">&gt;&gt;</span><span class="w"></span>
<span class="nx">URL</span><span class="o">:</span><span class="w">  </span><span class="o">&lt;</span><span class="nx">NSMutableURLRequest</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1c000ef00</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">URL</span><span class="o">:</span><span class="w"> </span><span class="nx">file</span><span class="o">:</span><span class="c1">///var/mobile/Containers/Data/Application/A654D169-1DB7-429C-9DB9-A871389A8BAA/</span><span class="w"></span>
<span class="w">          </span><span class="nx">Library</span><span class="o">/</span><span class="nx">UIWebView</span><span class="o">/</span><span class="nx">scenario1</span><span class="p">.</span><span class="nx">html</span><span class="p">,</span><span class="w"> </span><span class="nx">Method</span><span class="w"> </span><span class="nx">GET</span><span class="p">,</span><span class="w"> </span><span class="nx">Headers</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">Accept</span><span class="w"> </span><span class="o">=</span><span class="w">     </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;Upgrade-Insecure-Requests&quot;</span><span class="w"> </span><span class="o">=</span><span class="w">     </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="mf">1</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;User-Agent&quot;</span><span class="w"> </span><span class="o">=</span><span class="w">     </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;Mozilla/5.0 (iPhone; CPU iPhone ... AppleWebKit/604.3.5 (KHTML, like Gecko) Mobile/...&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Now we quit with <code>q</code> and open another WebView (<code>WKWebView</code> in this case). It also gets detected if we repeat the previous steps:</p>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="w"> </span><span class="nx">frida</span><span class="w"> </span><span class="o">-</span><span class="nx">U</span><span class="w"> </span><span class="nx">com</span><span class="p">.</span><span class="nx">authenticationfailure</span><span class="p">.</span><span class="nx">WheresMyBrowser</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="nx">copy</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">wait</span><span class="w"> </span><span class="p">...</span><span class="w"></span>

<span class="nx">onMatch</span><span class="o">:</span><span class="w">  </span><span class="o">&lt;</span><span class="nx">WKWebView</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1508b1200</span><span class="p">;</span><span class="w"> </span><span class="nx">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">0</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="mf">320</span><span class="w"> </span><span class="mf">393</span><span class="p">);</span><span class="w"> </span><span class="nx">layer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">CALayer</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1c4238f20</span><span class="o">&gt;&gt;</span><span class="w"></span>
<span class="nx">URL</span><span class="o">:</span><span class="w">  </span><span class="nx">file</span><span class="o">:</span><span class="c1">///var/mobile/Containers/Data/Application/A654D169-1DB7-429C-9DB9-A871389A8BAA/</span><span class="w"></span>
<span class="w">            </span><span class="nx">Library</span><span class="o">/</span><span class="nx">WKWebView</span><span class="o">/</span><span class="nx">scenario1</span><span class="p">.</span><span class="nx">html</span><span class="w"></span>
</code></pre></div>
<p>We will extend this example in the following sections in order to get more information from the WebViews. We recommend to store this code to a file, e.g. webviews_inspector.js and run it like this:</p>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="w"> </span><span class="nx">frida</span><span class="w"> </span><span class="o">-</span><span class="nx">U</span><span class="w"> </span><span class="nx">com</span><span class="p">.</span><span class="nx">authenticationfailure</span><span class="p">.</span><span class="nx">WheresMyBrowser</span><span class="w"> </span><span class="o">-</span><span class="nx">l</span><span class="w"> </span><span class="nx">webviews_inspector</span><span class="p">.</span><span class="nx">js</span><span class="w"></span>
</code></pre></div>
<h4 id="checking-if-javascript-is-enabled">Checking if JavaScript is Enabled<a class="headerlink" href="#checking-if-javascript-is-enabled" title="Permanent link">&para;</a></h4>
<p>Remember that if a <code>UIWebView</code> is being used, JavaScript is enabled by default and there's no possibility to disable it.</p>
<p>For <code>WKWebView</code>, you should verify if JavaScript is enabled. Use <a href="https://developer.apple.com/documentation/webkit/wkpreferences/1536203-javascriptenabled" title="WKPreferences javaScriptEnabled"><code>javaScriptEnabled</code></a> from <code>WKPreferences</code> for this.</p>
<p>Extend the previous script with the following line:</p>
<div class="highlight"><pre><span></span><code><span class="nx">ObjC</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">[</span><span class="s1">&#39;WKWebView&#39;</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">onMatch</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">wk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;onMatch: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">wk</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;javaScriptEnabled:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">wk</span><span class="p">.</span><span class="nx">configuration</span><span class="p">().</span><span class="nx">preferences</span><span class="p">().</span><span class="nx">javaScriptEnabled</span><span class="p">());</span><span class="w"></span>
<span class="c1">//...</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</code></pre></div>
<p>The output shows now that, in fact, JavaScript is enabled:</p>
<div class="highlight"><pre><span></span><code>$ frida -U com.authenticationfailure.WheresMyBrowser -l webviews_inspector.js

onMatch:  &lt;WKWebView: 0x1508b1200<span class="p">;</span> <span class="nv">frame</span> <span class="o">=</span> <span class="o">(</span><span class="m">0</span> <span class="m">0</span><span class="p">;</span> <span class="m">320</span> <span class="m">393</span><span class="o">)</span><span class="p">;</span> <span class="nv">layer</span> <span class="o">=</span> &lt;CALayer: 0x1c4238f20&gt;&gt;

javaScriptEnabled:  <span class="nb">true</span>
</code></pre></div>
<h4 id="verifying-that-only-secure-content-is-allowed">Verifying that Only Secure Content is Allowed<a class="headerlink" href="#verifying-that-only-secure-content-is-allowed" title="Permanent link">&para;</a></h4>
<p><code>UIWebView</code>'s do not provide a method for this. However, you may inspect if the system enables the "Upgrade-Insecure-Requests" CSP (Content Security Policy) directive by calling the <code>request</code> method of each <code>UIWebView</code> instance ("Upgrade-Insecure-Requests" <a href="https://www.thesslstore.com/blog/ios-10-will-support-upgrade-insecure-requests/" title="iOS 10 Will Support Upgrade-Insecure-Requests">should be available starting on iOS 10</a> which included a new version of WebKit, the browser engine powering the iOS WebViews). See an example in the previous section "<a href="#enumerating-webview-instances" title="Enumerating WebView Instances">Enumerating WebView Instances</a>".</p>
<p>For <code>WKWebView</code>'s, you may call the method <a href="https://developer.apple.com/documentation/webkit/wkwebview/1415002-hasonlysecurecontent" title="WKWebView hasOnlySecureContent"><code>hasOnlySecureContent</code></a> for each of the <code>WKWebView</code>s found in the heap. Remember to do so once the WebView has loaded.</p>
<p>Extend the previous script with the following line:</p>
<div class="highlight"><pre><span></span><code><span class="nx">ObjC</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">[</span><span class="s1">&#39;WKWebView&#39;</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">onMatch</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">wk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;onMatch: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">wk</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;hasOnlySecureContent: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">wk</span><span class="p">.</span><span class="nx">hasOnlySecureContent</span><span class="p">().</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="c1">//...</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
</code></pre></div>
<p>The output shows that some of the resources on the page have been loaded through insecure connections:</p>
<div class="highlight"><pre><span></span><code>$ frida -U com.authenticationfailure.WheresMyBrowser -l webviews_inspector.js

onMatch:  &lt;WKWebView: 0x1508b1200<span class="p">;</span> <span class="nv">frame</span> <span class="o">=</span> <span class="o">(</span><span class="m">0</span> <span class="m">0</span><span class="p">;</span> <span class="m">320</span> <span class="m">393</span><span class="o">)</span><span class="p">;</span> <span class="nv">layer</span> <span class="o">=</span> &lt;CALayer: 0x1c4238f20&gt;&gt;

hasOnlySecureContent:  <span class="nb">false</span>
</code></pre></div>
<h4 id="testing-for-webview-uri-manipulation">Testing for WebView URI Manipulation<a class="headerlink" href="#testing-for-webview-uri-manipulation" title="Permanent link">&para;</a></h4>
<p>Make sure that the WebView's URI cannot be manipulated by the user in order to load other types of resources than necessary for the functioning of the WebView. This can be specifically dangerous when the WebView's content is loaded from the local file system, allowing the user to navigate to other resources within the application.</p>
<h2 id="testing-webview-protocol-handlers-mstg-platform-6">Testing WebView Protocol Handlers (MSTG-PLATFORM-6)<a class="headerlink" href="#testing-webview-protocol-handlers-mstg-platform-6" title="Permanent link">&para;</a></h2>
<h3 id="overview_7">Overview<a class="headerlink" href="#overview_7" title="Permanent link">&para;</a></h3>
<p>Several default schemes are available that are being interpreted in a WebView on iOS, for example:</p>
<ul>
<li>http(s)://</li>
<li>file://</li>
<li>tel://</li>
</ul>
<p>WebViews can load remote content from an endpoint, but they can also load local content from the app data directory. If the local content is loaded, the user shouldn't be able to influence the filename or the path used to load the file, and users shouldn't be able to edit the loaded file.</p>
<p>Use the following best practices as defensive-in-depth measures:</p>
<ul>
<li>Create a list that defines local and remote web pages and URL schemes that are allowed to be loaded.</li>
<li>Create checksums of the local HTML/JavaScript files and check them while the app is starting up. <a href="https://en.wikipedia.org/wiki/Minification_%28programming%29">Minify JavaScript files</a> "Minification (programming)") to make them harder to read.</li>
</ul>
<h3 id="static-analysis_7">Static Analysis<a class="headerlink" href="#static-analysis_7" title="Permanent link">&para;</a></h3>
<ul>
<li>Testing how WebViews are loaded</li>
<li>Testing WebView file access</li>
<li>Checking telephone number detection</li>
</ul>
<h4 id="testing-how-webviews-are-loaded">Testing How WebViews are Loaded<a class="headerlink" href="#testing-how-webviews-are-loaded" title="Permanent link">&para;</a></h4>
<p>If a WebView is loading content from the app data directory, users should not be able to change the filename or path from which the file is loaded, and they shouldn't be able to edit the loaded file.</p>
<p>This presents an issue especially in <code>UIWebView</code>s loading untrusted content via the deprecated methods <a href="https://developer.apple.com/documentation/uikit/uiwebview/1617979-loadhtmlstring?language=objc" title="UIWebView loadHTMLString:baseURL:"><code>loadHTMLString:baseURL:</code></a> or <a href="https://developer.apple.com/documentation/uikit/uiwebview/1617941-loaddata?language=objc" title="UIWebView loadData:MIMEType:textEncodingName:baseURL:"><code>loadData:MIMEType:textEncodingName: baseURL:</code></a> and setting the <code>baseURL</code> parameter to <code>nil</code> or to a <code>file:</code> or <code>applewebdata:</code> URL schemes. In this case, in order to prevent unauthorized access to local files, the best option is to set it instead to <code>about:blank</code>. However, the recommendation is to avoid the use of <code>UIWebView</code>s and switch to <code>WKWebView</code>s instead.</p>
<p>Here's an example of a vulnerable <code>UIWebView</code> from <a href="https://github.com/authenticationfailure/WheresMyBrowser.iOS/blob/master/WheresMyBrowser/UIWebViewController.swift#L219" title="Where\'s My Browser? UIWebViewController.swift Line 219">"Where's My Browser?"</a>:</p>
<div class="highlight"><pre><span></span><code>let scenario2HtmlPath = Bundle.main.url(forResource: &quot;web/UIWebView/scenario2.html&quot;, withExtension: nil)
do {
    let scenario2Html = try String(contentsOf: scenario2HtmlPath!, encoding: .utf8)
    uiWebView.loadHTMLString(scenario2Html, baseURL: nil)
} catch {}
</code></pre></div>
<p>The page loads resources from the internet using HTTP, enabling a potential MITM to exfiltrate secrets contained in local files, e.g. in shared preferences.</p>
<p>When working with <code>WKWebView</code>s, Apple recommends using <a href="https://developer.apple.com/documentation/webkit/wkwebview/1415004-loadhtmlstring?language=objc" title="WKWebView loadHTMLString:baseURL:"><code>loadHTMLString:baseURL:</code></a> or <a href="https://developer.apple.com/documentation/webkit/wkwebview/1415011-loaddata?language=objc" title="WKWebView loadData:MIMEType:textEncodingName:baseURL:"><code>loadData:MIMEType:textEncodingName:baseURL:</code></a> to load local HTML files and <code>loadRequest:</code> for web content. Typically, the local files are loaded in combination with methods including, among others: <a href="https://developer.apple.com/documentation/foundation/nsbundle/1410989-pathforresource" title="NSBundle pathForResource:ofType:"><code>pathForResource:ofType:</code></a>, <a href="https://developer.apple.com/documentation/foundation/nsbundle/1411540-urlforresource?language=objc" title="NSBundle URLForResource:withExtension:"><code>URLForResource:withExtension:</code></a> or <a href="https://developer.apple.com/documentation/swift/string/3126736-init" title="String init(contentsOf:encoding:)"><code>init(contentsOf:encoding:)</code></a>.</p>
<p>Search the source code for the mentioned methods and inspect their parameters.</p>
<p>Example in Objective-C:</p>
<div class="highlight"><pre><span></span><code><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="nb">super</span><span class="w"> </span><span class="n">viewDidLoad</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="bp">WKWebViewConfiguration</span><span class="w"> </span><span class="o">*</span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[[</span><span class="bp">WKWebViewConfiguration</span><span class="w"> </span><span class="n">alloc</span><span class="p">]</span><span class="w"> </span><span class="n">init</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="nb">self</span><span class="p">.</span><span class="n">webView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[[</span><span class="bp">WKWebView</span><span class="w"> </span><span class="n">alloc</span><span class="p">]</span><span class="w"> </span><span class="n">initWithFrame</span><span class="o">:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">CGRectGetWidth</span><span class="p">([</span><span class="bp">UIScreen</span><span class="w"> </span><span class="n">mainScreen</span><span class="p">].</span><span class="n">bounds</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">CGRectGetHeight</span><span class="p">([</span><span class="bp">UIScreen</span><span class="w"> </span><span class="n">mainScreen</span><span class="p">].</span><span class="n">bounds</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">84</span><span class="p">)</span><span class="w"> </span><span class="n">configuration</span><span class="o">:</span><span class="n">configuration</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="nb">self</span><span class="p">.</span><span class="n">webView</span><span class="p">.</span><span class="n">navigationDelegate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">self</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="w"> </span><span class="n">addSubview</span><span class="o">:</span><span class="nb">self</span><span class="p">.</span><span class="n">webView</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="bp">NSString</span><span class="w"> </span><span class="o">*</span><span class="n">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[[</span><span class="bp">NSBundle</span><span class="w"> </span><span class="n">mainBundle</span><span class="p">]</span><span class="w"> </span><span class="n">pathForResource</span><span class="o">:</span><span class="s">@&quot;example_file&quot;</span><span class="w"> </span><span class="n">ofType</span><span class="o">:</span><span class="s">@&quot;html&quot;</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="bp">NSString</span><span class="w"> </span><span class="o">*</span><span class="n">html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="bp">NSString</span><span class="w"> </span><span class="n">stringWithContentsOfFile</span><span class="o">:</span><span class="n">filePath</span><span class="w"></span>
<span class="w">                                </span><span class="nl">encoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="w"> </span><span class="n">error</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">webView</span><span class="w"> </span><span class="n">loadHTMLString</span><span class="o">:</span><span class="n">html</span><span class="w"> </span><span class="n">baseURL</span><span class="o">:</span><span class="p">[</span><span class="bp">NSBundle</span><span class="w"> </span><span class="n">mainBundle</span><span class="p">].</span><span class="n">resourceURL</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Example in Swift from <a href="https://github.com/authenticationfailure/WheresMyBrowser.iOS/blob/master/WheresMyBrowser/WKWebViewController.swift#L196" title="Where\'s My Browser? WKWebViewController.swift Line 196">"Where's My Browser?"</a>:</p>
<div class="highlight"><pre><span></span><code>let scenario2HtmlPath = Bundle.main.url(forResource: &quot;web/WKWebView/scenario2.html&quot;, withExtension: nil)
do {
    let scenario2Html = try String(contentsOf: scenario2HtmlPath!, encoding: .utf8)
    wkWebView.loadHTMLString(scenario2Html, baseURL: nil)
} catch {}
</code></pre></div>
<p>If only having the compiled binary, you can also search for these methods, e.g.:</p>
<div class="highlight"><pre><span></span><code>$ rabin2 -zz ./WheresMyBrowser <span class="p">|</span> grep -i <span class="s2">&quot;loadHTMLString&quot;</span>
<span class="m">231</span> 0x0002df6c <span class="m">24</span> <span class="o">(</span><span class="m">4</span>.__TEXT.__objc_methname<span class="o">)</span> ascii loadHTMLString:baseURL:
</code></pre></div>
<p>In a case like this, it is recommended to perform dynamic analysis to ensure that this is in fact being used and from which kind of WebView. The <code>baseURL</code> parameter here doesn't present an issue as it will be set to "null" but could be an issue if not set properly when using a <code>UIWebView</code>. See "Checking How WebViews are Loaded" for an example about this.</p>
<p>In addition, you should also verify if the app is using the method <a href="https://developer.apple.com/documentation/webkit/wkwebview/1414973-loadfileurl?language=objc" title="WKWebView loadFileURL:allowingReadAccessToURL:"><code>loadFileURL: allowingReadAccessToURL:</code></a>. Its first parameter is <code>URL</code> and contains the URL to be loaded in the WebView, its second parameter <code>allowingReadAccessToURL</code> may contain a single file or a directory. If containing a single file, that file will be available to the WebView. However, if it contains a directory, all files on that directory will be made available to the WebView. Therefore, it is worth inspecting this and in case it is a directory, verifying that no sensitive data can be found inside it.</p>
<p>Example in Swift from <a href="https://github.com/authenticationfailure/WheresMyBrowser.iOS/blob/master/WheresMyBrowser/WKWebViewController.swift#L186" title="Where\'s My Browser? WKWebViewController.swift Line 186">"Where's My Browser?"</a>:</p>
<div class="highlight"><pre><span></span><code>var scenario1Url = FileManager.default.urls(for: .libraryDirectory, in: .userDomainMask)[0]
scenario1Url = scenario1Url.appendingPathComponent(&quot;WKWebView/scenario1.html&quot;)
wkWebView.loadFileURL(scenario1Url, allowingReadAccessTo: scenario1Url)
</code></pre></div>
<p>In this case, the parameter <code>allowingReadAccessToURL</code> contains a single file "WKWebView/scenario1.html", meaning that the WebView has exclusively access to that file.</p>
<p>In the compiled binary:</p>
<div class="highlight"><pre><span></span><code>$ rabin2 -zz ./WheresMyBrowser <span class="p">|</span> grep -i <span class="s2">&quot;loadFileURL&quot;</span>
<span class="m">237</span> 0x0002dff1 <span class="m">37</span> <span class="o">(</span><span class="m">4</span>.__TEXT.__objc_methname<span class="o">)</span> ascii loadFileURL:allowingReadAccessToURL:
</code></pre></div>
<h4 id="testing-webview-file-access">Testing WebView File Access<a class="headerlink" href="#testing-webview-file-access" title="Permanent link">&para;</a></h4>
<p>If you have found a <code>UIWebView</code> being used, then the following applies:</p>
<ul>
<li>The <code>file://</code> scheme is always enabled.</li>
<li>File access from <code>file://</code> URLs is always enabled.</li>
<li>Universal access from <code>file://</code> URLs is always enabled.</li>
</ul>
<p>Regarding <code>WKWebView</code>s:</p>
<ul>
<li>The <code>file://</code> scheme is also always enabled and it <strong>cannot be disabled</strong>.</li>
<li>It disables file access from <code>file://</code> URLs by default but it can be enabled.</li>
</ul>
<p>The following WebView properties can be used to configure file access:</p>
<ul>
<li><code>allowFileAccessFromFileURLs</code> (<code>WKPreferences</code>, <code>false</code> by default): it enables JavaScript running in the context of a <code>file://</code> scheme URL to access content from other <code>file://</code> scheme URLs.</li>
<li><code>allowUniversalAccessFromFileURLs</code> (<code>WKWebViewConfiguration</code>, <code>false</code> by default): it enables JavaScript running in the context of a <code>file://</code> scheme URL to access content from any origin.</li>
</ul>
<p>For example, it is possible to set the <strong><a href="https://github.com/WebKit/webkit/blob/master/Source/WebKit/UIProcess/API/Cocoa/WKPreferences.mm#L470" title="WebKit WKPreferences.mm Line 470">undocumented property</a></strong> <code>allowFileAccessFromFileURLs</code> by doing this:</p>
<p>Objective-C:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">webView</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="n">preferences</span><span class="w"> </span><span class="n">setValue</span><span class="o">:</span><span class="m">@YES</span><span class="w"> </span><span class="n">forKey</span><span class="o">:</span><span class="s">@&quot;allowFileAccessFromFileURLs&quot;</span><span class="p">];</span><span class="w"></span>
</code></pre></div>
<p>Swift:</p>
<div class="highlight"><pre><span></span><code>webView.configuration.preferences.setValue(true, forKey: &quot;allowFileAccessFromFileURLs&quot;)
</code></pre></div>
<p>If one or more of the above properties are activated, you should determine whether they are really necessary for the app to work properly.</p>
<h4 id="checking-telephone-number-detection">Checking Telephone Number Detection<a class="headerlink" href="#checking-telephone-number-detection" title="Permanent link">&para;</a></h4>
<p>In Safari on iOS, telephone number detection is on by default. However, you might want to turn it off if your HTML page contains numbers that can be interpreted as phone numbers, but are not phone numbers, or to prevent the DOM document from being modified when parsed by the browser. To turn off telephone number detection in Safari on iOS, use the format-detection meta tag (<code>&lt;meta name = "format-detection" content = "telephone=no"&gt;</code>). An example of this can be found in the <a href="https://developer.apple.com/library/archive/featuredarticles/iPhoneURLScheme_Reference/PhoneLinks/PhoneLinks.html#//apple_ref/doc/uid/TP40007899-CH6-SW2" title="Phone Links: Turning telephone number detection off">Apple developer documentation</a>. Phone links should be then used (e.g. <code>&lt;a href="tel:1-408-555-5555"&gt;1-408-555-5555&lt;/a&gt;</code>) to explicitly create a link.</p>
<h3 id="dynamic-analysis_7">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_7" title="Permanent link">&para;</a></h3>
<p>If it's possible to load local files via a WebView, the app might be vulnerable to directory traversal attacks. This would allow access to all files within the sandbox or even to escape the sandbox with full access to the file system (if the device is jailbroken). It should therefore be verified if a user can change the filename or path from which the file is loaded, and they shouldn't be able to edit the loaded file.</p>
<p>To simulate an attack, you may inject your own JavaScript into the WebView with an interception proxy or simply by using dynamic instrumentation. Attempt to access local storage and any native methods and properties that might be exposed to the JavaScript context.</p>
<p>In a real-world scenario, JavaScript can only be injected through a permanent backend Cross-Site Scripting vulnerability or a MITM attack. See the OWASP <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html" title="XSS (Cross-Site Scripting) Prevention Cheat Sheet">XSS Prevention Cheat Sheet</a> and the chapter "<a href="../0x06g-Testing-Network-Communication/">iOS Network APIs</a>" for more information.</p>
<p>For what concerns this section we will learn about:</p>
<ul>
<li>Checking how WebViews are loaded</li>
<li>Determining WebView file access</li>
</ul>
<h4 id="checking-how-webviews-are-loaded">Checking How WebViews are Loaded<a class="headerlink" href="#checking-how-webviews-are-loaded" title="Permanent link">&para;</a></h4>
<p>As we have seen above in "Testing How WebViews are Loaded", if "scenario 2" of the WKWebViews is loaded, the app will do so by calling <a href="https://developer.apple.com/documentation/foundation/nsbundle/1411540-urlforresource?language=objc" title="NSBundle URLForResource:withExtension:"><code>URLForResource:withExtension:</code></a> and <code>loadHTMLString:baseURL</code>.</p>
<p>To quicky inspect this, you can use frida-trace and trace all "loadHTMLString" and "URLForResource:withExtension:" methods.</p>
<div class="highlight"><pre><span></span><code>$ frida-trace -U <span class="s2">&quot;Where&#39;s My Browser?&quot;</span>
    -m <span class="s2">&quot;*[WKWebView *loadHTMLString*]&quot;</span> -m <span class="s2">&quot;*[* URLForResource:withExtension:]&quot;</span>

 <span class="m">14131</span> ms  -<span class="o">[</span>NSBundle URLForResource:0x1c0255390 withExtension:0x0<span class="o">]</span>
 <span class="m">14131</span> ms  URLForResource: web/WKWebView/scenario2.html
 <span class="m">14131</span> ms  withExtension: 0x0
 <span class="m">14190</span> ms  -<span class="o">[</span>WKWebView loadHTMLString:0x1c0255390 baseURL:0x0<span class="o">]</span>
 <span class="m">14190</span> ms   HTMLString: &lt;!DOCTYPE html&gt;
    &lt;html&gt;
        ...
        &lt;/html&gt;

 <span class="m">14190</span> ms  baseURL: nil
</code></pre></div>
<p>In this case, <code>baseURL</code> is set to <code>nil</code>, meaning that the effective origin is "null". You can obtain the effective origin by running <code>window.origin</code> from the JavaScript of the page (this app has an exploitation helper that allows to write and run JavaScript, but you could also implement a MITM or simply use Frida to inject JavaScript, e.g. via <code>evaluateJavaScript:completionHandler</code> of <code>WKWebView</code>).</p>
<p>As an additional note regarding <code>UIWebView</code>s, if you retrieve the effective origin from a <code>UIWebView</code> where <code>baseURL</code> is also set to <code>nil</code> you will see that it is not set to "null", instead you'll obtain something similar to the following:</p>
<div class="highlight"><pre><span></span><code>applewebdata://5361016c-f4a0-4305-816b-65411fc1d780
</code></pre></div>
<p>This origin "applewebdata://" is similar to the "file://" origin as it does not implement Same-Origin Policy and allow access to local files and any web resources. In this case, it would be better to set <code>baseURL</code> to "about:blank", this way, the Same-Origin Policy would prevent cross-origin access. However, the recommendation here is to completely avoid using <code>UIWebView</code>s and go for <code>WKWebView</code>s instead.</p>
<h4 id="determining-webview-file-access">Determining WebView File Access<a class="headerlink" href="#determining-webview-file-access" title="Permanent link">&para;</a></h4>
<p>Even if not having the original source code, you can quickly determine if the app's WebViews do allow file access and which kind. For this, simply navigate to the target WebView in the app and inspect all its instances, for each of them get the values mentioned in the static analysis, that is, <code>allowFileAccessFromFileURLs</code> and <code>allowUniversalAccessFromFileURLs</code>. This only applies to <code>WKWebView</code>s (<code>UIWebVIew</code>s always allow file access).</p>
<p>We continue with our example using the <a href="https://github.com/authenticationfailure/WheresMyBrowser.iOS/" title="Where\'s My Browser?">"Where's My Browser?"</a> app and Frida REPL, extend the script with the following content:</p>
<div class="highlight"><pre><span></span><code><span class="nx">ObjC</span><span class="p">.</span><span class="nx">choose</span><span class="p">(</span><span class="nx">ObjC</span><span class="p">.</span><span class="nx">classes</span><span class="p">[</span><span class="s1">&#39;WKWebView&#39;</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">onMatch</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">wk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;onMatch: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">wk</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;URL: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">wk</span><span class="p">.</span><span class="nx">URL</span><span class="p">().</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;javaScriptEnabled: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">wk</span><span class="p">.</span><span class="nx">configuration</span><span class="p">().</span><span class="nx">preferences</span><span class="p">().</span><span class="nx">javaScriptEnabled</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;allowFileAccessFromFileURLs: &#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nx">wk</span><span class="p">.</span><span class="nx">configuration</span><span class="p">().</span><span class="nx">preferences</span><span class="p">().</span><span class="nx">valueForKey_</span><span class="p">(</span><span class="s1">&#39;allowFileAccessFromFileURLs&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;hasOnlySecureContent: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">wk</span><span class="p">.</span><span class="nx">hasOnlySecureContent</span><span class="p">().</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;allowUniversalAccessFromFileURLs: &#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nx">wk</span><span class="p">.</span><span class="nx">configuration</span><span class="p">().</span><span class="nx">valueForKey_</span><span class="p">(</span><span class="s1">&#39;allowUniversalAccessFromFileURLs&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="nx">onComplete</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;done for WKWebView!&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</code></pre></div>
<p>If you run it now, you'll have all the information you need:</p>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="w"> </span><span class="nx">frida</span><span class="w"> </span><span class="o">-</span><span class="nx">U</span><span class="w"> </span><span class="o">-</span><span class="nx">f</span><span class="w"> </span><span class="nx">com</span><span class="p">.</span><span class="nx">authenticationfailure</span><span class="p">.</span><span class="nx">WheresMyBrowser</span><span class="w"> </span><span class="o">-</span><span class="nx">l</span><span class="w"> </span><span class="nx">webviews_inspector</span><span class="p">.</span><span class="nx">js</span><span class="w"></span>

<span class="nx">onMatch</span><span class="o">:</span><span class="w">  </span><span class="o">&lt;</span><span class="nx">WKWebView</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1508b1200</span><span class="p">;</span><span class="w"> </span><span class="nx">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">0</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="mf">320</span><span class="w"> </span><span class="mf">393</span><span class="p">);</span><span class="w"> </span><span class="nx">layer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">CALayer</span><span class="o">:</span><span class="w"> </span><span class="mh">0x1c4238f20</span><span class="o">&gt;&gt;</span><span class="w"></span>
<span class="nx">URL</span><span class="o">:</span><span class="w">  </span><span class="nx">file</span><span class="o">:</span><span class="c1">///var/mobile/Containers/Data/Application/A654D169-1DB7-429C-9DB9-A871389A8BAA/</span><span class="w"></span>
<span class="w">        </span><span class="nx">Library</span><span class="o">/</span><span class="nx">WKWebView</span><span class="o">/</span><span class="nx">scenario1</span><span class="p">.</span><span class="nx">html</span><span class="w"></span>
<span class="nx">javaScriptEnabled</span><span class="o">:</span><span class="w">  </span><span class="kc">true</span><span class="w"></span>
<span class="nx">allowFileAccessFromFileURLs</span><span class="o">:</span><span class="w">  </span><span class="mf">0</span><span class="w"></span>
<span class="nx">hasOnlySecureContent</span><span class="o">:</span><span class="w">  </span><span class="kc">false</span><span class="w"></span>
<span class="nx">allowUniversalAccessFromFileURLs</span><span class="o">:</span><span class="w">  </span><span class="mf">0</span><span class="w"></span>
</code></pre></div>
<p>Both <code>allowFileAccessFromFileURLs</code> and <code>allowUniversalAccessFromFileURLs</code> are set to "0", meaning that they are disabled. In this app we can go to the WebView configuration and enable <code>allowFileAccessFromFileURLs</code>. If we do so and re-run the script we will see how it is set to "1" this time:</p>
<div class="highlight"><pre><span></span><code>$ frida -U -f com.authenticationfailure.WheresMyBrowser -l webviews_inspector.js
...

allowFileAccessFromFileURLs:  <span class="m">1</span>
</code></pre></div>
<h2 id="determining-whether-native-methods-are-exposed-through-webviews-mstg-platform-7">Determining Whether Native Methods Are Exposed Through WebViews (MSTG-PLATFORM-7)<a class="headerlink" href="#determining-whether-native-methods-are-exposed-through-webviews-mstg-platform-7" title="Permanent link">&para;</a></h2>
<h3 id="overview_8">Overview<a class="headerlink" href="#overview_8" title="Permanent link">&para;</a></h3>
<p>Since iOS 7, Apple introduced APIs that allow communication between the JavaScript runtime in the WebView and the native Swift or Objective-C objects. If these APIs are used carelessly, important functionality might be exposed to attackers who manage to inject malicious scripts into the WebView (e.g., through a successful Cross-Site Scripting attack).</p>
<h3 id="static-analysis_8">Static Analysis<a class="headerlink" href="#static-analysis_8" title="Permanent link">&para;</a></h3>
<p>Both <code>UIWebView</code> and <code>WKWebView</code> provide a means of communication between the WebView and the native app. Any important data or native functionality exposed to the WebView JavaScript engine would also be accessible to rogue JavaScript running in the WebView.</p>
<h4 id="testing-uiwebview-javascript-to-native-bridges">Testing UIWebView JavaScript to Native Bridges<a class="headerlink" href="#testing-uiwebview-javascript-to-native-bridges" title="Permanent link">&para;</a></h4>
<p>There are two fundamental ways of how native code and JavaScript can communicate:</p>
<ul>
<li><strong>JSContext</strong>: When an Objective-C or Swift block is assigned to an identifier in a <code>JSContext</code>, JavaScriptCore automatically wraps the block in a JavaScript function.</li>
<li><strong>JSExport protocol</strong>: Properties, instance methods and class methods declared in a <code>JSExport</code>-inherited protocol are mapped to JavaScript objects that are available to all JavaScript code. Modifications of objects that are in the JavaScript environment are reflected in the native environment.</li>
</ul>
<p>Note that only class members defined in the <code>JSExport</code> protocol are made accessible to JavaScript code.</p>
<p>Look out for code that maps native objects to the <code>JSContext</code> associated with a WebView and analyze what functionality it exposes, for example no sensitive data should be accessible and exposed to WebViews.</p>
<p>In Objective-C, the <code>JSContext</code> associated with a <code>UIWebView</code> is obtained as follows:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">webView</span><span class="w"> </span><span class="n">valueForKeyPath</span><span class="o">:</span><span class="s">@&quot;documentView.webView.mainFrame.javaScriptContext&quot;</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<h4 id="testing-wkwebview-javascript-to-native-bridges">Testing WKWebView JavaScript to Native Bridges<a class="headerlink" href="#testing-wkwebview-javascript-to-native-bridges" title="Permanent link">&para;</a></h4>
<p>JavaScript code in a <code>WKWebView</code> can still send messages back to the native app but in contrast to <code>UIWebView</code>, it is not possible to directly reference the <code>JSContext</code> of a <code>WKWebView</code>. Instead, communication is implemented using a messaging system and using the <code>postMessage</code> function, which automatically serializes JavaScript objects into native Objective-C or Swift objects. Message handlers are configured using the method <a href="https://developer.apple.com/documentation/webkit/wkusercontentcontroller/1537172-add" title="WKUserContentController add(_ scriptMessageHandler:name:)"><code>add(_ scriptMessageHandler:name:)</code></a>.</p>
<p>Verify if a JavaScript to native bridge exists by searching for <code>WKScriptMessageHandler</code> and check all exposed methods. Then verify how the methods are called.</p>
<p>The following example from <a href="https://github.com/authenticationfailure/WheresMyBrowser.iOS/blob/b8d4abda4000aa509c7a5de79e5c90360d1d0849/WheresMyBrowser/WKWebViewPreferencesManager.swift#L98" title="Where\'s My Browser? WKWebViewPreferencesManager.swift Line 98">"Where's My Browser?"</a> demonstrates this.</p>
<p>First we see how the JavaScript bridge is enabled:</p>
<div class="highlight"><pre><span></span><code>func enableJavaScriptBridge(_ enabled: Bool) {
    options_dict[&quot;javaScriptBridge&quot;]?.value = enabled
    let userContentController = wkWebViewConfiguration.userContentController
    userContentController.removeScriptMessageHandler(forName: &quot;javaScriptBridge&quot;)

    if enabled {
            let javaScriptBridgeMessageHandler = JavaScriptBridgeMessageHandler()
            userContentController.add(javaScriptBridgeMessageHandler, name: &quot;javaScriptBridge&quot;)
    }
}
</code></pre></div>
<p>Adding a script message handler with name <code>"name"</code> (or <code>"javaScriptBridge"</code> in the example above) causes the JavaScript function <code>window.webkit.messageHandlers.myJavaScriptMessageHandler.postMessage</code> to be defined in all frames in all web views that use the user content controller. It can be then <a href="https://github.com/authenticationfailure/WheresMyBrowser.iOS/blob/d4e2d9efbde8841bf7e4a8800418dda6bb116ec6/WheresMyBrowser/web/WKWebView/scenario3.html#L33" title="Where\'s My Browser? WKWebView/scenario3.html Line 33">used from the HTML file like this</a>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">invokeNativeOperation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">value1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;value1&quot;</span><span class="p">).</span><span class="nx">value</span><span class="w"></span>
<span class="w">    </span><span class="nx">value2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;value2&quot;</span><span class="p">).</span><span class="nx">value</span><span class="w"></span>
<span class="w">    </span><span class="nb">window</span><span class="p">.</span><span class="nx">webkit</span><span class="p">.</span><span class="nx">messageHandlers</span><span class="p">.</span><span class="nx">javaScriptBridge</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">([</span><span class="s2">&quot;multiplyNumbers&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">value1</span><span class="p">,</span><span class="w"> </span><span class="nx">value2</span><span class="p">]);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The called function resides in <a href="https://github.com/authenticationfailure/WheresMyBrowser.iOS/blob/b8d4abda4000aa509c7a5de79e5c90360d1d0849/WheresMyBrowser/JavaScriptBridgeMessageHandler.swift#L29" title="Where\'s My Browser? JavaScriptBridgeMessageHandler.swift Line 29"><code>JavaScriptBridgeMessageHandler.swift</code></a>:</p>
<div class="highlight"><pre><span></span><code>class JavaScriptBridgeMessageHandler: NSObject, WKScriptMessageHandler {

//...

case &quot;multiplyNumbers&quot;:

        let arg1 = Double(messageArray[1])!
        let arg2 = Double(messageArray[2])!
        result = String(arg1 * arg2)
//...

let javaScriptCallBack = &quot;javascriptBridgeCallBack(&#39;\(functionFromJS)&#39;,&#39;\(result)&#39;)&quot;
message.webView?.evaluateJavaScript(javaScriptCallBack, completionHandler: nil)
</code></pre></div>
<p>The problem here is that the <code>JavaScriptBridgeMessageHandler</code> not only contains that function, it also exposes a sensitive function:</p>
<div class="highlight"><pre><span></span><code>case &quot;getSecret&quot;:
        result = &quot;XSRSOGKC342&quot;
</code></pre></div>
<h3 id="dynamic-analysis_8">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_8" title="Permanent link">&para;</a></h3>
<p>At this point you've surely identified all potentially interesting WebViews in the iOS app and got an overview of the potential attack surface (via static analysis, the dynamic analysis techniques that we have seen in previous sections or a combination of them). This would include HTML and JavaScript files, usage of the <code>JSContext</code> / <code>JSExport</code> for <code>UIWebView</code> and <code>WKScriptMessageHandler</code> for <code>WKWebView</code>, as well as which functions are exposed and present in a WebView.</p>
<p>Further dynamic analysis can help you exploit those functions and get sensitive data that they might be exposing. As we have seen in the static analysis, in the previous example it was trivial to get the secret value by performing reverse engineering (the secret value was found in plain text inside the source code) but imagine that the exposed function retrieves the secret from secure storage. In this case, only dynamic analysis and exploitation would help.</p>
<p>The procedure for exploiting the functions starts with producing a JavaScript payload and injecting it into the file that the app is requesting. The injection can be accomplished via various techniques, for example:</p>
<ul>
<li>If some of the content is loaded insecurely from the Internet over HTTP (mixed content), you can try to implement a MITM attack.</li>
<li>You can always perform dynamic instrumentation and inject the JavaScript payload by using frameworks like Frida and the corresponding JavaScript evaluation functions available for the iOS WebViews (<a href="https://developer.apple.com/documentation/uikit/uiwebview/1617963-stringbyevaluatingjavascriptfrom?language=objc" title="UIWebView stringByEvaluatingJavaScriptFromString:"><code>stringByEvaluatingJavaScriptFromString:</code></a> for <code>UIWebView</code> and <a href="https://developer.apple.com/documentation/webkit/wkwebview/1415017-evaluatejavascript?language=objc" title="WKWebView evaluateJavaScript:completionHandler:"><code>evaluateJavaScript:completionHandler:</code></a> for <code>WKWebView</code>).</li>
</ul>
<p>In order to get the secret from the previous example of the "Where's My Browser?" app, you can use one of these techniques to inject the following payload that will reveal the secret by writing it to the "result" field of the WebView:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">javascriptBridgeCallBack</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">).</span><span class="nx">innerHTML</span><span class="o">=</span><span class="nx">value</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="nb">window</span><span class="p">.</span><span class="nx">webkit</span><span class="p">.</span><span class="nx">messageHandlers</span><span class="p">.</span><span class="nx">javaScriptBridge</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">([</span><span class="s2">&quot;getSecret&quot;</span><span class="p">]);</span><span class="w"></span>
</code></pre></div>
<p>Of course, you may also use the Exploitation Helper it provides:</p>
<p><img src="../../assets/Images/Chapters/0x06h/exploit_javascript_bridge.png" width="400px" /></p>
<p>See another example for a vulnerable iOS app and function that is exposed to a WebView in [#thiel2] page 156.</p>
<h2 id="testing-object-persistence-mstg-platform-8">Testing Object Persistence (MSTG-PLATFORM-8)<a class="headerlink" href="#testing-object-persistence-mstg-platform-8" title="Permanent link">&para;</a></h2>
<h3 id="overview_9">Overview<a class="headerlink" href="#overview_9" title="Permanent link">&para;</a></h3>
<p>There are several ways to persist an object on iOS:</p>
<h4 id="object-encoding">Object Encoding<a class="headerlink" href="#object-encoding" title="Permanent link">&para;</a></h4>
<p>iOS comes with two protocols for object encoding and decoding for Objective-C or <code>NSObject</code>s: <code>NSCoding</code> and <code>NSSecureCoding</code>. When a class conforms to either of the protocols, the data is serialized to <code>NSData</code>: a wrapper for byte buffers. Note that <code>Data</code> in Swift is the same as <code>NSData</code> or its mutable counterpart: <code>NSMutableData</code>. The <code>NSCoding</code> protocol declares the two methods that must be implemented in order to encode/decode its instance-variables. A class using <code>NSCoding</code> needs to implement <code>NSObject</code> or be annotated as an @objc class. The <code>NSCoding</code> protocol requires to implement encode and init as shown below.</p>
<div class="highlight"><pre><span></span><code>class CustomPoint: NSObject, NSCoding {

    //required by NSCoding:
    func encode(with aCoder: NSCoder) {
        aCoder.encode(x, forKey: &quot;x&quot;)
        aCoder.encode(name, forKey: &quot;name&quot;)
    }

    var x: Double = 0.0
    var name: String = &quot;&quot;

    init(x: Double, name: String) {
            self.x = x
            self.name = name
    }

    // required by NSCoding: initialize members using a decoder.
    required convenience init?(coder aDecoder: NSCoder) {
            guard let name = aDecoder.decodeObject(forKey: &quot;name&quot;) as? String
                    else {return nil}
            self.init(x:aDecoder.decodeDouble(forKey:&quot;x&quot;),
                                name:name)
    }

    //getters/setters/etc.
}
</code></pre></div>
<p>The issue with <code>NSCoding</code> is that the object is often already constructed and inserted before you can evaluate the class-type. This allows an attacker to easily inject all sorts of data. Therefore, the <code>NSSecureCoding</code> protocol has been introduced. When conforming to <a href="https://developer.apple.com/documentation/foundation/NSSecureCoding" title="NSSecureCoding"><code>NSSecureCoding</code></a> you need to include:</p>
<div class="highlight"><pre><span></span><code>static var supportsSecureCoding: Bool {
        return true
}
</code></pre></div>
<p>when <code>init(coder:)</code> is part of the class. Next, when decoding the object, a check should be made, e.g.:</p>
<div class="highlight"><pre><span></span><code>let obj = decoder.decodeObject(of:MyClass.self, forKey: &quot;myKey&quot;)
</code></pre></div>
<p>The conformance to <code>NSSecureCoding</code> ensures that objects being instantiated are indeed the ones that were expected. However, there are no additional integrity checks done over the data and the data is not encrypted. Therefore, any secret data needs additional encryption and data of which the integrity must be protected, should get an additional HMAC.</p>
<p>Note, when <code>NSData</code> (Objective-C) or the keyword <code>let</code> (Swift) is used: then the data is immutable in memory and cannot be easily removed.</p>
<h4 id="object-archiving-with-nskeyedarchiver">Object Archiving with NSKeyedArchiver<a class="headerlink" href="#object-archiving-with-nskeyedarchiver" title="Permanent link">&para;</a></h4>
<p><code>NSKeyedArchiver</code> is a concrete subclass of <code>NSCoder</code> and provides a way to encode objects and store them in a file. The <code>NSKeyedUnarchiver</code> decodes the data and recreates the original data. Let's take the example of the <code>NSCoding</code> section and now archive and unarchive them:</p>
<div class="highlight"><pre><span></span><code>// archiving:
NSKeyedArchiver.archiveRootObject(customPoint, toFile: &quot;/path/to/archive&quot;)

// unarchiving:
guard let customPoint = NSKeyedUnarchiver.unarchiveObjectWithFile(&quot;/path/to/archive&quot;) as?
    CustomPoint else { return nil }
</code></pre></div>
<p>When decoding a keyed archive, because values are requested by name, values can be decoded out of sequence or not at all. Keyed archives, therefore, provide better support for forward and backward compatibility. This means that an archive on disk could actually contain additional data which is not detected by the program, unless the key for that given data is provided at a later stage.</p>
<p>Note that additional protection needs to be in place to secure the file in case of confidential data, as the data is not encrypted within the file. See the chapter "<a href="../0x06d-Testing-Data-Storage/">Data Storage on iOS</a>" for more details.</p>
<h4 id="codable">Codable<a class="headerlink" href="#codable" title="Permanent link">&para;</a></h4>
<p>With Swift 4, the <code>Codable</code> type alias arrived: it is a combination of the <code>Decodable</code> and <code>Encodable</code> protocols. A <code>String</code>, <code>Int</code>, <code>Double</code>, <code>Date</code>, <code>Data</code> and <code>URL</code> are <code>Codable</code> by nature: meaning they can easily be encoded and decoded without any additional work. Let's take the following example:</p>
<div class="highlight"><pre><span></span><code>struct CustomPointStruct:Codable {
    var x: Double
    var name: String
}
</code></pre></div>
<p>By adding <code>Codable</code> to the inheritance list for the <code>CustomPointStruct</code> in the example, the methods <code>init(from:)</code> and <code>encode(to:)</code> are automatically supported. Fore more details about the workings of <code>Codable</code> check <a href="https://developer.apple.com/documentation/foundation/archives_and_serialization/encoding_and_decoding_custom_types" title="Encoding and Decoding Custom Types">the Apple Developer Documentation</a>.
The <code>Codable</code>s can easily be encoded / decoded into various representations: <code>NSData</code> using <code>NSCoding</code>/<code>NSSecureCoding</code>, JSON, Property Lists, XML, etc. See the subsections below for more details.</p>
<h4 id="json-and-codable">JSON and Codable<a class="headerlink" href="#json-and-codable" title="Permanent link">&para;</a></h4>
<p>There are various ways to encode and decode JSON within iOS by using different 3rd party libraries:</p>
<ul>
<li><a href="https://github.com/Mantle/Mantle" title="Mantle">Mantle</a></li>
<li><a href="https://github.com/jsonmodel/jsonmodel" title="JSONModel">JSONModel library</a></li>
<li><a href="https://github.com/SwiftyJSON/SwiftyJSON" title="SwiftyJSON">SwiftyJSON library</a></li>
<li><a href="https://github.com/Hearst-DD/ObjectMapper" title="ObjectMapper library">ObjectMapper library</a></li>
<li><a href="https://github.com/johnezang/JSONKit" title="JSONKit">JSONKit</a></li>
<li><a href="https://github.com/JSONModel/JSONModel" title="JSONModel">JSONModel</a></li>
<li><a href="https://github.com/ibireme/YYModel" title="YYModel">YYModel</a></li>
<li><a href="https://github.com/ibireme/YYModel" title="SBJson 5">SBJson 5</a></li>
<li><a href="https://github.com/JohnSundell/Unbox" title="Unbox">Unbox</a></li>
<li><a href="https://github.com/hkellaway/Gloss" title="Gloss">Gloss</a></li>
<li><a href="https://github.com/lyft/mapper" title="Mapper">Mapper</a></li>
<li><a href="https://github.com/delba/JASON" title="JASON">JASON</a></li>
<li><a href="https://github.com/freshOS/Arrow" title="Arrow">Arrow</a></li>
</ul>
<p>The libraries differ in their support for certain versions of Swift and Objective-C, whether they return (im)mutable results, speed, memory consumption and actual library size.
Again, note in case of immutability: confidential information cannot be removed from memory easily.</p>
<p>Next, Apple provides support for JSON encoding/decoding directly by combining <code>Codable</code> together with a <code>JSONEncoder</code> and a <code>JSONDecoder</code>:</p>
<div class="highlight"><pre><span></span><code>struct CustomPointStruct: Codable {
    var point: Double
    var name: String
}

let encoder = JSONEncoder()
encoder.outputFormatting = .prettyPrinted

let test = CustomPointStruct(point: 10, name: &quot;test&quot;)
let data = try encoder.encode(test)
let stringData = String(data: data, encoding: .utf8)

// stringData = Optional ({
// &quot;point&quot; : 10,
// &quot;name&quot; : &quot;test&quot;
// })
</code></pre></div>
<p>JSON itself can be stored anywhere, e.g., a (NoSQL) database or a file. You just need to make sure that any JSON that contains secrets has been appropriately protected (e.g., encrypted/HMACed). See the chapter "<a href="../0x06d-Testing-Data-Storage/">Data Storage on iOS</a>" for more details.</p>
<h4 id="property-lists-and-codable">Property Lists and Codable<a class="headerlink" href="#property-lists-and-codable" title="Permanent link">&para;</a></h4>
<p>You can persist objects to <em>property lists</em> (also called plists in previous sections). You can find two examples below of how to use it:</p>
<div class="highlight"><pre><span></span><code>// archiving:
let data = NSKeyedArchiver.archivedDataWithRootObject(customPoint)
NSUserDefaults.standardUserDefaults().setObject(data, forKey: &quot;customPoint&quot;)

// unarchiving:

if let data = NSUserDefaults.standardUserDefaults().objectForKey(&quot;customPoint&quot;) as? NSData {
    let customPoint = NSKeyedUnarchiver.unarchiveObjectWithData(data)
}
</code></pre></div>
<p>In this first example, the <code>NSUserDefaults</code> are used, which is the primary <em>property list</em>. We can do the same with the <code>Codable</code> version:</p>
<div class="highlight"><pre><span></span><code>struct CustomPointStruct: Codable {
        var point: Double
        var name: String
    }

    var points: [CustomPointStruct] = [
        CustomPointStruct(point: 1, name: &quot;test&quot;),
        CustomPointStruct(point: 2, name: &quot;test&quot;),
        CustomPointStruct(point: 3, name: &quot;test&quot;),
    ]

    UserDefaults.standard.set(try? PropertyListEncoder().encode(points), forKey: &quot;points&quot;)
    if let data = UserDefaults.standard.value(forKey: &quot;points&quot;) as? Data {
        let points2 = try? PropertyListDecoder().decode([CustomPointStruct].self, from: data)
    }
</code></pre></div>
<p>Note that <strong><code>plist</code> files are not meant to store secret information</strong>. They are designed to hold user preferences for an app.</p>
<h4 id="xml">XML<a class="headerlink" href="#xml" title="Permanent link">&para;</a></h4>
<p>There are multiple ways to do XML encoding. Similar to JSON parsing, there are various third party libraries, such as:</p>
<ul>
<li><a href="https://github.com/cezheng/Fuzi" title="Fuzi">Fuzi</a></li>
<li><a href="https://github.com/mattt/Ono" title="Ono">Ono</a></li>
<li><a href="https://github.com/tadija/AEXML" title="AEXML">AEXML</a></li>
<li><a href="https://github.com/ZaBlanc/RaptureXML" title="RaptureXML">RaptureXML</a></li>
<li><a href="https://github.com/yahoojapan/SwiftyXMLParser" title="SwiftyXMLParser">SwiftyXMLParser</a></li>
<li><a href="https://github.com/drmohundro/SWXMLHash" title="SWXMLHash">SWXMLHash</a></li>
</ul>
<p>They vary in terms of speed, memory usage, object persistence and more important: differ in how they handle XML external entities. See <a href="https://nvd.nist.gov/vuln/detail/CVE-2015-3784" title="CVE-2015-3784">XXE in the Apple iOS Office viewer</a> as an example. Therefore, it is key to disable external entity parsing if possible. See the <a href="https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html" title="XXE Prevention Cheatsheet">OWASP XXE prevention cheatsheet</a> for more details.
Next to the libraries, you can make use of Apple's <a href="https://developer.apple.com/documentation/foundation/xmlparser" title="XMLParser"><code>XMLParser</code> class</a></p>
<p>When not using third party libraries, but Apple's <code>XMLParser</code>, be sure to let <code>shouldResolveExternalEntities</code> return <code>false</code>.</p>
<h4 id="object-relational-mapping-coredata-and-realm">Object-Relational Mapping (CoreData and Realm)<a class="headerlink" href="#object-relational-mapping-coredata-and-realm" title="Permanent link">&para;</a></h4>
<p>There are various ORM-like solutions for iOS. The first one is <a href="https://realm.io/docs/swift/latest/" title="Realm">Realm</a>, which comes with its own storage engine. Realm has settings to encrypt the data as explained in <a href="https://academy.realm.io/posts/tim-oliver-realm-cocoa-tutorial-on-encryption-with-realm/" title="Encryption with Realm">Realm's documentation</a>. This allows for handling secure data. Note that the encryption is turned off by default.</p>
<p>Apple itself supplies <code>CoreData</code>, which is well explained in the <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreData/index.html#//apple_ref/doc/uid/TP40001075-CH2-SW1," title="CoreData">Apple Developer Documentation</a>. It supports various storage backends as described in <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreData/PersistentStoreFeatures.html" title="PersistentStoreFeatures">Apple's Persistent Store Types and Behaviors documentation</a>. The issue with the storage backends recommended by Apple, is that none of the type of data stores is encrypted, nor checked for integrity. Therefore, additional actions are necessary in case of confidential data. An alternative can be found in <a href="https://github.com/project-imas/encrypted-core-data" title="Encrypted Core Data">project iMas</a>, which does supply out of the box encryption.</p>
<h4 id="protocol-buffers">Protocol Buffers<a class="headerlink" href="#protocol-buffers" title="Permanent link">&para;</a></h4>
<p><a href="https://developers.google.com/protocol-buffers/" title="Google Documentation">Protocol Buffers</a> by Google, are a platform- and language-neutral mechanism for serializing structured data by means of the <a href="https://developers.google.com/protocol-buffers/docs/encoding" title="Protocol Buffers Encoding">Binary Data Format</a>. They are available for iOS by means of the <a href="https://github.com/apple/swift-protobuf" title="Apple\'s swift-protobuf Plugin and Runtime library">Protobuf</a> library.
There have been a few vulnerabilities with Protocol Buffers, such as <a href="https://www.cvedetails.com/cve/CVE-2015-5237/" title="CVE-2015-5237">CVE-2015-5237</a>.
Note that <strong>Protocol Buffers do not provide any protection for confidentiality</strong> as no built-in encryption is available.</p>
<h3 id="static-analysis_9">Static Analysis<a class="headerlink" href="#static-analysis_9" title="Permanent link">&para;</a></h3>
<p>All different flavors of object persistence share the following concerns:</p>
<ul>
<li>If you use object persistence to store sensitive information on the device, then make sure that the data is encrypted: either at the database level, or specifically at the value level.</li>
<li>Need to guarantee the integrity of the information? Use an HMAC mechanism or sign the information stored. Always verify the HMAC/signature before processing the actual information stored in the objects.</li>
<li>Make sure that keys used in the two notions above are safely stored in the KeyChain and well protected. See the chapter "<a href="../0x06d-Testing-Data-Storage/">Data Storage on iOS</a>" for more details.</li>
<li>Ensure that the data within the deserialized object is carefully validated before it is actively used (e.g., no exploit of business/application logic is possible).</li>
<li>Do not use persistence mechanisms that use <a href="https://developer.apple.com/library/archive/#documentation/Cocoa/Reference/ObjCRuntimeRef/Reference/reference.html" title="Objective-C Runtime Reference">Runtime Reference</a> to serialize/deserialize objects in high-risk applications, as the attacker might be able to manipulate the steps to execute business logic via this mechanism (see the chapter "<a href="../0x06j-Testing-Resiliency-Against-Reverse-Engineering/">iOS Anti-Reversing Defenses</a>" for more details).</li>
<li>Note that in Swift 2 and beyond, a <a href="https://developer.apple.com/documentation/swift/mirror" title="Mirror">Mirror</a> can be used to read parts of an object, but cannot be used to write against the object.</li>
</ul>
<h3 id="dynamic-analysis_9">Dynamic Analysis<a class="headerlink" href="#dynamic-analysis_9" title="Permanent link">&para;</a></h3>
<p>There are several ways to perform dynamic analysis:</p>
<ul>
<li>For the actual persistence: Use the techniques described in the "Data Storage on iOS" chapter.</li>
<li>For the serialization itself: Use a debug build or use Frida / objection to see how the serialization methods are handled (e.g., whether the application crashes or extra information can be extracted by enriching the objects).</li>
</ul>
<h2 id="testing-enforced-updating-mstg-arch-9">Testing enforced updating (MSTG-ARCH-9)<a class="headerlink" href="#testing-enforced-updating-mstg-arch-9" title="Permanent link">&para;</a></h2>
<p>Enforced updating can be really helpful when it comes to public key pinning (see the Testing Network communication for more details) when a pin has to be refreshed due to a certificate/public key rotation. Next, vulnerabilities are easily patched by means of forced updates.
The challenge with iOS however, is that Apple does not provide any APIs yet to automate this process, instead, developers will have to create their own mechanism, such as described at various <a href="https://mobikul.com/show-update-application-latest-version-functionality-ios-app-swift-3/" title="Updating version in Swift 3">blogs</a> which boil down to looking up properties of the app using <code>http://itunes.apple.com/lookup\?id\&lt;BundleId&gt;</code> or third party libraries, such as <a href="https://github.com/ArtSabintsev/Siren" title="Siren">Siren</a> and <a href="https://www.npmjs.com/package/react-native-appstore-version-checker" title="Update checker for React">react-native-appstore-version-checker</a>. Most of these implementations will require a certain given version offered by an API or just "latest in the appstore", which means users can be frustrated with having to update the app, even though no business/security need for an update is truly there.</p>
<p>Please note that newer versions of an application will not fix security issues that are living in the backends to which the app communicates. Allowing an app not to communicate with it might not be enough. Having proper API-lifecycle management is key here.
Similarly, when a user is not forced to update, do not forget to test older versions of your app against your API and/or use proper API versioning.</p>
<h3 id="static-analysis_10">Static Analysis<a class="headerlink" href="#static-analysis_10" title="Permanent link">&para;</a></h3>
<p>First see whether there is an update mechanism at all: if it is not yet present, it might mean that users cannot be forced to update.
If the mechanism is present, see whether it enforces "always latest" and whether that is indeed in line with the business strategy. Otherwise check if the mechanism is supporting to update to a given version.
Make sure that every entry of the application goes through the updating mechanism in order to make sure that the update-mechanism cannot be bypassed.</p>
<h3 id="dynamic-analysis_10">Dynamic analysis<a class="headerlink" href="#dynamic-analysis_10" title="Permanent link">&para;</a></h3>
<p>In order to test for proper updating: try downloading an older version of the application with a security vulnerability, either by a release from the developers or by using a third party app-store.
Next, verify whether or not you can continue to use the application without updating it. If an update prompt is given, verify if you can still use the application by canceling the prompt or otherwise circumventing it through normal application usage. This includes validating whether the backend will stop calls to vulnerable backends and/or whether the vulnerable app-version itself is blocked by the backend.
Finally, see if you can play with the version number of a man-in-the-middled app and see how the backend responds to this (and if it is recorded at all for instance).</p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li>[#thiel2] David Thiel, iOS Application Security: The Definitive Guide for Hackers and Developers (Kindle Locations 3394-3399), No Starch Press, Kindle Edition.</li>
<li>Security Flaw with UIWebView - <a href="https://medium.com/ios-os-x-development/security-flaw-with-uiwebview-95bbd8508e3c">https://medium.com/ios-os-x-development/security-flaw-with-uiwebview-95bbd8508e3c</a></li>
<li>Learning about Universal Links and Fuzzing URL Schemes on iOS with Frida - <a href="https://grepharder.github.io/blog/0x03_learning_about_universal_links_and_fuzzing_url_schemes_on_ios_with_frida.html">https://grepharder.github.io/blog/0x03_learning_about_universal_links_and_fuzzing_url_schemes_on_ios_with_frida.html</a></li>
</ul>
<h3 id="owasp-masvs">OWASP MASVS<a class="headerlink" href="#owasp-masvs" title="Permanent link">&para;</a></h3>
<ul>
<li>MSTG-ARCH-9: "A mechanism for enforcing updates of the mobile app exists."</li>
<li>MSTG-PLATFORM-1: "The app only requests the minimum set of permissions necessary."</li>
<li>MSTG-PLATFORM-3: "The app does not export sensitive functionality via custom URL schemes, unless these mechanisms are properly protected."</li>
<li>MSTG-PLATFORM-4: "The app does not export sensitive functionality through IPC facilities, unless these mechanisms are properly protected."</li>
<li>MSTG-PLATFORM-5: "JavaScript is disabled in WebViews unless explicitly required."</li>
<li>MSTG-PLATFORM-6: "WebViews are configured to allow only the minimum set of protocol handlers required (ideally, only https is supported). Potentially dangerous handlers, such as file, tel and app-id, are disabled."</li>
<li>MSTG-PLATFORM-7: "If native methods of the app are exposed to a WebView, verify that the WebView only renders JavaScript contained within the app package."</li>
<li>MSTG-PLATFORM-8: "Object deserialization, if any, is implemented using safe serialization APIs."</li>
</ul>
<h3 id="regarding-object-persistence-in-ios">Regarding Object Persistence in iOS<a class="headerlink" href="#regarding-object-persistence-in-ios" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://developer.apple.com/documentation/foundation/NSSecureCoding">https://developer.apple.com/documentation/foundation/NSSecureCoding</a></li>
<li><a href="https://developer.apple.com/documentation/foundation/archives_and_serialization?language=swift">https://developer.apple.com/documentation/foundation/archives_and_serialization?language=swift</a></li>
<li><a href="https://developer.apple.com/documentation/foundation/nskeyedarchiver">https://developer.apple.com/documentation/foundation/nskeyedarchiver</a></li>
<li><a href="https://developer.apple.com/documentation/foundation/nscoding?language=swift">https://developer.apple.com/documentation/foundation/nscoding?language=swift</a></li>
<li><a href="https://developer.apple.com/documentation/foundation/NSSecureCoding?language=swift">https://developer.apple.com/documentation/foundation/NSSecureCoding?language=swift</a></li>
<li><a href="https://developer.apple.com/documentation/foundation/archives_and_serialization/encoding_and_decoding_custom_types">https://developer.apple.com/documentation/foundation/archives_and_serialization/encoding_and_decoding_custom_types</a></li>
<li><a href="https://developer.apple.com/documentation/foundation/archives_and_serialization/using_json_with_custom_types">https://developer.apple.com/documentation/foundation/archives_and_serialization/using_json_with_custom_types</a></li>
<li><a href="https://developer.apple.com/documentation/foundation/jsonencoder">https://developer.apple.com/documentation/foundation/jsonencoder</a></li>
<li><a href="https://medium.com/if-let-swift-programming/migrating-to-codable-from-nscoding-ddc2585f28a4">https://medium.com/if-let-swift-programming/migrating-to-codable-from-nscoding-ddc2585f28a4</a></li>
<li><a href="https://developer.apple.com/documentation/foundation/xmlparser">https://developer.apple.com/documentation/foundation/xmlparser</a></li>
</ul>

              
            </article>
            
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../0x06g-Testing-Network-Communication/" class="md-footer__link md-footer__link--prev" aria-label="Previous: iOS Network APIs" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              iOS Network APIs
            </div>
          </div>
        </a>
      
      
        
        <a href="../0x06i-Testing-Code-Quality-and-Build-Settings/" class="md-footer__link md-footer__link--next" aria-label="Next: iOS Code Quality and Build Settings" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              iOS Code Quality and Build Settings
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <div style="float: left; padding-right: 1em;">
  <a href="https://www.owasp.org"><img src="https://github.com/OWASP/owasp-mstg/blob/master/Document/Images/OWASP_logo_white.png?raw=true" width="100px" /></a>
</div>
<span>
  &#169; OWASP Foundation 2022. This work is licensed under 
  <a href="https://creativecommons.org/licenses/by/4.0">CC-BY-4.0</a>. For any reuse or distribution, you must make clear to others the license terms of this work.
</span>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://owasp.slack.com/messages/project-mobile_omtg/details/" target="_blank" rel="noopener" title="owasp.slack.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/OWASP_MSTG" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/OWASP/owasp-mstg/discussions" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["search.suggest", "search.highlight", "search.share", "navigation.instant", "navigation.expand", "navigation.tabs", "navigation.tabs.sticky", "toc.integrate", "navigation.top"], "search": "../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../../javascripts/tablesort.js"></script>
      
    
  </body>
</html>